<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Nacos | 王小红的笔记</title><meta name=keywords content><meta name=description content><meta name=author content><link rel=canonical href=https://wangxiaohong123.github.io/tags/nacos/><link crossorigin=anonymous href=/assets/css/stylesheet.08f7d74f0ada0f975d29ae436285b61ed7a719d05f350cb888d00341642995a2.css integrity="sha256-CPfXTwraD5ddKa5DYoW2HtenGdBfNQy4iNADQWQplaI=" rel="preload stylesheet" as=style><link rel=icon href=https://wangxiaohong123.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://wangxiaohong123.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://wangxiaohong123.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://wangxiaohong123.github.io/apple-touch-icon.png><link rel=mask-icon href=https://wangxiaohong123.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=https://wangxiaohong123.github.io/tags/nacos/index.xml><link rel=alternate hreflang=en href=https://wangxiaohong123.github.io/tags/nacos/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=/katex/katex.min.css><script defer src=/katex/katex.min.js></script><script defer src=/katex/auto-render.min.js onload=renderMathInElement(document.body)></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script><meta property="og:url" content="https://wangxiaohong123.github.io/tags/nacos/"><meta property="og:site_name" content="王小红的笔记"><meta property="og:title" content="Nacos"><meta property="og:locale" content="zh-CN"><meta property="og:type" content="website"><meta name=twitter:card content="summary"><meta name=twitter:title content="Nacos"><meta name=twitter:description content></head><body class=list id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wangxiaohong123.github.io/ accesskey=h title="王小红的笔记 (Alt + H)">王小红的笔记</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://wangxiaohong123.github.io/posts/ title=笔记><span>笔记</span></a></li><li><a href=https://wangxiaohong123.github.io/categories/ title=分类><span>分类</span></a></li><li><a href=https://wangxiaohong123.github.io/tags/ title=标签><span>标签</span></a></li></ul></nav></header><main class=main><header class=page-header><h1>Nacos</h1></header><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>nacos-1.集群搭建</h2></header><div class=entry-content><p>官网推荐vip模式集群，VIP是指虚拟ip，单点故障的时候会自动漂移到可用节点。 三台机器分别安装keepalived和nacos：
先整个jdk；
安装keepalived：
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 yum install -y gcc openssl-devel popt-devel yum install -y libnl libnl-devel yum install -y libnfnetlink-devel yum install -y curl gcc openssl-devel libnl3-devel net-snmp-devel libnfnetlink-devel # 解压安装 tar -xzvf keepalived-2.1.5.tar.gz cd keepalived-2.1.5/ ./configure --prefix=/usr/local/keepalived make && make install # 创建启动文件 cd /usr/local/ cp -a keepalived/etc/keepalived /etc/init.d/ cp -a keepalived/etc/sysconfig/keepalived /etc/sysconfig/ cp -a keepalived/sbin/keepalived /usr/sbin/ # 创建配置文件 mkdir /etc/keepalived cd /etc/keepalived ##复制配置文件 cp /usr/local/keepalived/etc/keepalived/keepalived.conf /etc/keepalived 修改keeplived.conf
...</p></div><footer class=entry-footer>2 min</footer><a class=entry-link aria-label="post link to nacos-1.集群搭建" href=https://wangxiaohong123.github.io/posts/%E6%A1%86%E6%9E%B6/spring/cloud-alibaba/nacos/1.%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>nacos-2.基础</h2></header><div class=entry-content><p>一 概念 命名空间：用来区分不同的开发环境，生产(prod)、预发布(staging)、联调测试(test)、开发自测(beta)、开发(dev) 分开，防止配置、服务错乱。 分组：一个完整的大系统由很多服务组成，一般分组名称由系统名称命名。 健康探测机制：dubbo服务注册到nacos时，如果ephemeral是true表示临时节点(默认)： 临时节点：每个服务都会定时向nacos发送心跳，默认5s，如果15s没收到心跳就会把这个实例标记成不健康实例，30s没收到心跳会摘除这个服务实例。 持久节点：nacos每20s主动探测实例是否可用，如果不可用标记成不健康状态，不会摘除实例。 保护阈值：比如一个下游服务的实例中宕机了一半，这个时候剩下的一半也可能因为流量变大被打死，保护阈值的作用是健康实例的比例低于这个阈值就会让不健康的服务实例也参与被调用，可以防止服务雪崩，取值范围是0~1。触发保护阈值虽然可以保证可用性，但是会导致一致性问题，因为会有部分请求打到不可用的服务上，如果这个时候触发了熔断降级，拿到的数据就是不一致的。 二 元数据 每个服务、集群、实例都有自己的元数据，格式就是key=value。默认服务、集群的元数据是空，实例的元数据：
1 2 3 4 5 6 7 8 # dubbo服务url元数据 dubbo.metadata-service.urls=[ "dubbo://172.30.60.105:20886/com.alibaba.cloud.dubbo.service.DubboMetadataService?anyhost=true&amp;application=stars-report-service&amp;bind.ip=172.30.60.105&amp;bind.port=20886&amp;deprecated=false&amp;dubbo=2.0.2&amp;dynamic=true&amp;generic=false&amp;group=stars-report-service&amp;interface=com.alibaba.cloud.dubbo.service.DubboMetadataService&amp;metadata-type=remote&amp;methods=getAllServiceKeys,getServiceRestMetadata,getExportedURLs,getAllExportedURLs&amp;pid=8518&amp;qos.enable=false&amp;release=2.7.8&amp;revision=2.2.6.RELEASE&amp;service.filter=customerExceptionFilter&amp;side=provider&amp;timestamp=1664088868313&amp;version=1.0.0" ] dubbo.metadata.revision=722115F0F6F280A931188D6CEB16F05C dubbo.protocols.dubbo.port=20886 preserved.register.source=SPRING_CLOUD 三 distro协议（ap，保证最终一致） nacos集群需要维护服务实例的信息、状态等数据，但是服务实例找那个nacos节点发起注册？实例数据存储在哪个nacos节点上？服务发现的时候去找那个nacos节点？nacos自研的distro分布式一致性协议就是解决这3个问题的。
1.注册流程 服务在启动的时候会随机拿到一个nacos实例的地址发起注册请求，nacos收到注册请求之后根据服务实例的ip+port计算这个服务应该由哪个nacos节点负责，然后转发给对应的nacos实例。目标nacos会把服务实例信息缓存到内存里，然后返回响应给转发的nacos节点，转发的nacos节点在把响应返回给服务实例。
2.数据分片和订阅处理 按照注册的流程，每个nacos节点只会保存一部分服务实例的数据，这样的话会有两个问题，服务实例获取订阅节点信息怎么获取，怎么订阅；nacos节点宕机怎么办。
distro的实现是nacos节点会定时把自己的服务数据发送给其他节点，也会收到其他节点上的服务信息，相当于是推模式的全量保存实现了最终一致性。订阅时随机选择一个nacos节点，这里可能有个时间差：当服务刚注册的时候，其他nacos节点时没有这个服务的信息的，此时获取服务信息的请求会失败，然后添加一个监听，数据同步完之后会去回调监听。
3.数据补偿 nacos各个节点之间会定期发送心跳，当发现自己保存的其他节点上的数据和发心跳这个节点的数据不一致，会全量同步一下，这样可以解决网络分区导致的长时间定时同步失败的情况。
四 raft协议（弱cp，保证一致） raft协议下要求nacos集群选举一个leader，只能leader写入，但是当节点写完之后需要全量同步所有服务信息到其他节点，当过半节点都成功了之后才会返回注册成功，这样会大大降低nacos的吞吐。弱cp就是因为过半而不是全量。</p></div><footer class=entry-footer>1 min</footer><a class=entry-link aria-label="post link to nacos-2.基础" href=https://wangxiaohong123.github.io/posts/%E6%A1%86%E6%9E%B6/spring/cloud-alibaba/nacos/2.%E5%9F%BA%E7%A1%80/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>nacos-3.核心源码</h2></header><div class=entry-content><p>1.服务注册源码 服务注册、订阅什么的接口是NamingClientProxy，这个接口主要有两个实现类：NamingGrpcClientProxy和NamingHttpClientProxy，注册的方法是registerService，NamingGrpcClientProxy的流程：
1 2 3 4 5 6 7 8 9 10 11 12 13 /** * Register a instance to service with specified instance properties. * * @param serviceName 服务名 * @param groupName 服务分组 * @param instance 实例信息，保存实例id、ip、端口、权重等信息 */ public void registerService(String serviceName, String groupName, Instance instance) throws NacosException { // 先把实例存储到NamingGrpcRedoService的registeredInstances（ConcurrentMap）里 redoService.cacheInstanceForRedo(serviceName, groupName, instance); // 注册服务 doRegisterService(serviceName, groupName, instance); } 注册服务的方法：
...</p></div><footer class=entry-footer>7 min</footer><a class=entry-link aria-label="post link to nacos-3.核心源码" href=https://wangxiaohong123.github.io/posts/%E6%A1%86%E6%9E%B6/spring/cloud-alibaba/nacos/3.%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81/></a></article></main><footer class=footer><span>&copy; 2025 <a href=https://wangxiaohong123.github.io/>王小红的笔记</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>