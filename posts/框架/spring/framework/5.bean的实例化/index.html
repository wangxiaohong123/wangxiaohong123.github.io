<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>5.Bean的实例化 | 王小红的笔记</title><meta name=keywords content="spring-framework"><meta name=description content='1.单例池
在BeanFactory中beanDefinitionMap存放的是bean的名字作为key，类对应的BeanDefinition作为value，还有一个singletonObjects用来存放已经实例化好的Bean，Spring中叫单例池。
2.实例化源码
在启动容器结束后就已经完成了Bean的扫描，ApplicationContext的refresh()方法中会调用下面的方法，就是Bean实例化的入口：


1
2


// 完成不是懒加载的单例Bean的实例化
finishBeanFactoryInitialization(beanFactory);


真正的入口在finishBeanFactoryInitialization(beanFactory);方法里的最后一行：


1


beanFactory.preInstantiateSingletons();


这个类里先校验，然后把name前面拼上"&&ldquo;去调用getBean()方法，这个方法中会判断如果单例池中没有这个Bean回去创建：


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60


public void preInstantiateSingletons() throws BeansException {
   if (logger.isTraceEnabled()) {
      logger.trace("Pre-instantiating singletons in " + this);
   }
    
   // 这个beanDefinitionNames存的是beanDefinitionMap的key
   List<String> beanNames = new ArrayList<>(this.beanDefinitionNames);

   for (String beanName : beanNames) {
      // 先从mergedBeanDefinitions(map)中根据name拿到BeanDefinition
      // todo mergedBeanDefinitions和beanDefinitionMap有什么区别
      // todo 为什么获取BeanDefinition要搞得真么复杂，直接遍历beanDefinitionMap不可以吗
      RootBeanDefinition bd = getMergedLocalBeanDefinition(beanName);
      // 抽象类或者非单例类或者懒加载的类不会实例化
      if (!bd.isAbstract() && bd.isSingleton() && !bd.isLazyInit()) {
         // 验证是否是FactoryBean
         if (isFactoryBean(beanName)) {
            // 把name前面拼上"&"，然后获取Bean
            Object bean = getBean(FACTORY_BEAN_PREFIX + beanName);
            if (bean instanceof FactoryBean) {
               FactoryBean<?> factory = (FactoryBean<?>) bean;
               boolean isEagerInit;
               if (System.getSecurityManager() != null && factory instanceof SmartFactoryBean) {
                  isEagerInit = AccessController.doPrivileged(
                        (PrivilegedAction<Boolean>) ((SmartFactoryBean<?>) factory)::isEagerInit,
                        getAccessControlContext());
               }
               else {
                  isEagerInit = (factory instanceof SmartFactoryBean &&
                        ((SmartFactoryBean<?>) factory).isEagerInit());
               }
               if (isEagerInit) {
                  getBean(beanName);
               }
            }
         }
         else {
             // 非FactoryBean得话走这里
            getBean(beanName);
         }
      }
   }

   // Trigger post-initialization callback for all applicable beans...
   for (String beanName : beanNames) {
      Object singletonInstance = getSingleton(beanName);
      if (singletonInstance instanceof SmartInitializingSingleton) {
         SmartInitializingSingleton smartSingleton = (SmartInitializingSingleton) singletonInstance;
         if (System.getSecurityManager() != null) {
            AccessController.doPrivileged((PrivilegedAction<Object>) () -> {
               smartSingleton.afterSingletonsInstantiated();
               return null;
            }, getAccessControlContext());
         }
         else {
            smartSingleton.afterSingletonsInstantiated();
         }
      }
   }
}


getBean()方法里直接调用了doGetBean()方法：'><meta name=author content><link rel=canonical href=https://wangxiaohong123.github.io/posts/%E6%A1%86%E6%9E%B6/spring/framework/5.bean%E7%9A%84%E5%AE%9E%E4%BE%8B%E5%8C%96/><link crossorigin=anonymous href=/assets/css/stylesheet.08f7d74f0ada0f975d29ae436285b61ed7a719d05f350cb888d00341642995a2.css integrity="sha256-CPfXTwraD5ddKa5DYoW2HtenGdBfNQy4iNADQWQplaI=" rel="preload stylesheet" as=style><link rel=icon href=https://wangxiaohong123.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://wangxiaohong123.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://wangxiaohong123.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://wangxiaohong123.github.io/apple-touch-icon.png><link rel=mask-icon href=https://wangxiaohong123.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://wangxiaohong123.github.io/posts/%E6%A1%86%E6%9E%B6/spring/framework/5.bean%E7%9A%84%E5%AE%9E%E4%BE%8B%E5%8C%96/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://wangxiaohong123.github.io/posts/%E6%A1%86%E6%9E%B6/spring/framework/5.bean%E7%9A%84%E5%AE%9E%E4%BE%8B%E5%8C%96/"><meta property="og:site_name" content="王小红的笔记"><meta property="og:title" content="5.Bean的实例化"><meta property="og:description" content='1.单例池 在BeanFactory中beanDefinitionMap存放的是bean的名字作为key，类对应的BeanDefinition作为value，还有一个singletonObjects用来存放已经实例化好的Bean，Spring中叫单例池。
2.实例化源码 在启动容器结束后就已经完成了Bean的扫描，ApplicationContext的refresh()方法中会调用下面的方法，就是Bean实例化的入口：
1 2 // 完成不是懒加载的单例Bean的实例化 finishBeanFactoryInitialization(beanFactory); 真正的入口在finishBeanFactoryInitialization(beanFactory);方法里的最后一行：
1 beanFactory.preInstantiateSingletons(); 这个类里先校验，然后把name前面拼上"&“去调用getBean()方法，这个方法中会判断如果单例池中没有这个Bean回去创建：
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 public void preInstantiateSingletons() throws BeansException { if (logger.isTraceEnabled()) { logger.trace("Pre-instantiating singletons in " + this); } // 这个beanDefinitionNames存的是beanDefinitionMap的key List<String> beanNames = new ArrayList<>(this.beanDefinitionNames); for (String beanName : beanNames) { // 先从mergedBeanDefinitions(map)中根据name拿到BeanDefinition // todo mergedBeanDefinitions和beanDefinitionMap有什么区别 // todo 为什么获取BeanDefinition要搞得真么复杂，直接遍历beanDefinitionMap不可以吗 RootBeanDefinition bd = getMergedLocalBeanDefinition(beanName); // 抽象类或者非单例类或者懒加载的类不会实例化 if (!bd.isAbstract() && bd.isSingleton() && !bd.isLazyInit()) { // 验证是否是FactoryBean if (isFactoryBean(beanName)) { // 把name前面拼上"&"，然后获取Bean Object bean = getBean(FACTORY_BEAN_PREFIX + beanName); if (bean instanceof FactoryBean) { FactoryBean<?> factory = (FactoryBean<?>) bean; boolean isEagerInit; if (System.getSecurityManager() != null && factory instanceof SmartFactoryBean) { isEagerInit = AccessController.doPrivileged( (PrivilegedAction<Boolean>) ((SmartFactoryBean<?>) factory)::isEagerInit, getAccessControlContext()); } else { isEagerInit = (factory instanceof SmartFactoryBean && ((SmartFactoryBean<?>) factory).isEagerInit()); } if (isEagerInit) { getBean(beanName); } } } else { // 非FactoryBean得话走这里 getBean(beanName); } } } // Trigger post-initialization callback for all applicable beans... for (String beanName : beanNames) { Object singletonInstance = getSingleton(beanName); if (singletonInstance instanceof SmartInitializingSingleton) { SmartInitializingSingleton smartSingleton = (SmartInitializingSingleton) singletonInstance; if (System.getSecurityManager() != null) { AccessController.doPrivileged((PrivilegedAction<Object>) () -> { smartSingleton.afterSingletonsInstantiated(); return null; }, getAccessControlContext()); } else { smartSingleton.afterSingletonsInstantiated(); } } } } getBean()方法里直接调用了doGetBean()方法：'><meta property="og:locale" content="zh-CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:tag" content="Spring-Framework"><meta name=twitter:card content="summary"><meta name=twitter:title content="5.Bean的实例化"><meta name=twitter:description content='1.单例池
在BeanFactory中beanDefinitionMap存放的是bean的名字作为key，类对应的BeanDefinition作为value，还有一个singletonObjects用来存放已经实例化好的Bean，Spring中叫单例池。
2.实例化源码
在启动容器结束后就已经完成了Bean的扫描，ApplicationContext的refresh()方法中会调用下面的方法，就是Bean实例化的入口：


1
2


// 完成不是懒加载的单例Bean的实例化
finishBeanFactoryInitialization(beanFactory);


真正的入口在finishBeanFactoryInitialization(beanFactory);方法里的最后一行：


1


beanFactory.preInstantiateSingletons();


这个类里先校验，然后把name前面拼上"&&ldquo;去调用getBean()方法，这个方法中会判断如果单例池中没有这个Bean回去创建：


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60


public void preInstantiateSingletons() throws BeansException {
   if (logger.isTraceEnabled()) {
      logger.trace("Pre-instantiating singletons in " + this);
   }
    
   // 这个beanDefinitionNames存的是beanDefinitionMap的key
   List<String> beanNames = new ArrayList<>(this.beanDefinitionNames);

   for (String beanName : beanNames) {
      // 先从mergedBeanDefinitions(map)中根据name拿到BeanDefinition
      // todo mergedBeanDefinitions和beanDefinitionMap有什么区别
      // todo 为什么获取BeanDefinition要搞得真么复杂，直接遍历beanDefinitionMap不可以吗
      RootBeanDefinition bd = getMergedLocalBeanDefinition(beanName);
      // 抽象类或者非单例类或者懒加载的类不会实例化
      if (!bd.isAbstract() && bd.isSingleton() && !bd.isLazyInit()) {
         // 验证是否是FactoryBean
         if (isFactoryBean(beanName)) {
            // 把name前面拼上"&"，然后获取Bean
            Object bean = getBean(FACTORY_BEAN_PREFIX + beanName);
            if (bean instanceof FactoryBean) {
               FactoryBean<?> factory = (FactoryBean<?>) bean;
               boolean isEagerInit;
               if (System.getSecurityManager() != null && factory instanceof SmartFactoryBean) {
                  isEagerInit = AccessController.doPrivileged(
                        (PrivilegedAction<Boolean>) ((SmartFactoryBean<?>) factory)::isEagerInit,
                        getAccessControlContext());
               }
               else {
                  isEagerInit = (factory instanceof SmartFactoryBean &&
                        ((SmartFactoryBean<?>) factory).isEagerInit());
               }
               if (isEagerInit) {
                  getBean(beanName);
               }
            }
         }
         else {
             // 非FactoryBean得话走这里
            getBean(beanName);
         }
      }
   }

   // Trigger post-initialization callback for all applicable beans...
   for (String beanName : beanNames) {
      Object singletonInstance = getSingleton(beanName);
      if (singletonInstance instanceof SmartInitializingSingleton) {
         SmartInitializingSingleton smartSingleton = (SmartInitializingSingleton) singletonInstance;
         if (System.getSecurityManager() != null) {
            AccessController.doPrivileged((PrivilegedAction<Object>) () -> {
               smartSingleton.afterSingletonsInstantiated();
               return null;
            }, getAccessControlContext());
         }
         else {
            smartSingleton.afterSingletonsInstantiated();
         }
      }
   }
}


getBean()方法里直接调用了doGetBean()方法：'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://wangxiaohong123.github.io/posts/"},{"@type":"ListItem","position":2,"name":"5.Bean的实例化","item":"https://wangxiaohong123.github.io/posts/%E6%A1%86%E6%9E%B6/spring/framework/5.bean%E7%9A%84%E5%AE%9E%E4%BE%8B%E5%8C%96/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"5.Bean的实例化","name":"5.Bean的实例化","description":"1.单例池 在BeanFactory中beanDefinitionMap存放的是bean的名字作为key，类对应的BeanDefinition作为value，还有一个singletonObjects用来存放已经实例化好的Bean，Spring中叫单例池。\n2.实例化源码 在启动容器结束后就已经完成了Bean的扫描，ApplicationContext的refresh()方法中会调用下面的方法，就是Bean实例化的入口：\n1 2 // 完成不是懒加载的单例Bean的实例化 finishBeanFactoryInitialization(beanFactory); 真正的入口在finishBeanFactoryInitialization(beanFactory);方法里的最后一行：\n1 beanFactory.preInstantiateSingletons(); 这个类里先校验，然后把name前面拼上\u0026quot;\u0026amp;\u0026ldquo;去调用getBean()方法，这个方法中会判断如果单例池中没有这个Bean回去创建：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 public void preInstantiateSingletons() throws BeansException { if (logger.isTraceEnabled()) { logger.trace(\u0026#34;Pre-instantiating singletons in \u0026#34; + this); } // 这个beanDefinitionNames存的是beanDefinitionMap的key List\u0026lt;String\u0026gt; beanNames = new ArrayList\u0026lt;\u0026gt;(this.beanDefinitionNames); for (String beanName : beanNames) { // 先从mergedBeanDefinitions(map)中根据name拿到BeanDefinition // todo mergedBeanDefinitions和beanDefinitionMap有什么区别 // todo 为什么获取BeanDefinition要搞得真么复杂，直接遍历beanDefinitionMap不可以吗 RootBeanDefinition bd = getMergedLocalBeanDefinition(beanName); // 抽象类或者非单例类或者懒加载的类不会实例化 if (!bd.isAbstract() \u0026amp;\u0026amp; bd.isSingleton() \u0026amp;\u0026amp; !bd.isLazyInit()) { // 验证是否是FactoryBean if (isFactoryBean(beanName)) { // 把name前面拼上\u0026#34;\u0026amp;\u0026#34;，然后获取Bean Object bean = getBean(FACTORY_BEAN_PREFIX + beanName); if (bean instanceof FactoryBean) { FactoryBean\u0026lt;?\u0026gt; factory = (FactoryBean\u0026lt;?\u0026gt;) bean; boolean isEagerInit; if (System.getSecurityManager() != null \u0026amp;\u0026amp; factory instanceof SmartFactoryBean) { isEagerInit = AccessController.doPrivileged( (PrivilegedAction\u0026lt;Boolean\u0026gt;) ((SmartFactoryBean\u0026lt;?\u0026gt;) factory)::isEagerInit, getAccessControlContext()); } else { isEagerInit = (factory instanceof SmartFactoryBean \u0026amp;\u0026amp; ((SmartFactoryBean\u0026lt;?\u0026gt;) factory).isEagerInit()); } if (isEagerInit) { getBean(beanName); } } } else { // 非FactoryBean得话走这里 getBean(beanName); } } } // Trigger post-initialization callback for all applicable beans... for (String beanName : beanNames) { Object singletonInstance = getSingleton(beanName); if (singletonInstance instanceof SmartInitializingSingleton) { SmartInitializingSingleton smartSingleton = (SmartInitializingSingleton) singletonInstance; if (System.getSecurityManager() != null) { AccessController.doPrivileged((PrivilegedAction\u0026lt;Object\u0026gt;) () -\u0026gt; { smartSingleton.afterSingletonsInstantiated(); return null; }, getAccessControlContext()); } else { smartSingleton.afterSingletonsInstantiated(); } } } } getBean()方法里直接调用了doGetBean()方法：\n","keywords":["spring-framework"],"articleBody":"1.单例池 在BeanFactory中beanDefinitionMap存放的是bean的名字作为key，类对应的BeanDefinition作为value，还有一个singletonObjects用来存放已经实例化好的Bean，Spring中叫单例池。\n2.实例化源码 在启动容器结束后就已经完成了Bean的扫描，ApplicationContext的refresh()方法中会调用下面的方法，就是Bean实例化的入口：\n1 2 // 完成不是懒加载的单例Bean的实例化 finishBeanFactoryInitialization(beanFactory); 真正的入口在finishBeanFactoryInitialization(beanFactory);方法里的最后一行：\n1 beanFactory.preInstantiateSingletons(); 这个类里先校验，然后把name前面拼上\"\u0026“去调用getBean()方法，这个方法中会判断如果单例池中没有这个Bean回去创建：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 public void preInstantiateSingletons() throws BeansException { if (logger.isTraceEnabled()) { logger.trace(\"Pre-instantiating singletons in \" + this); } // 这个beanDefinitionNames存的是beanDefinitionMap的key List\u003cString\u003e beanNames = new ArrayList\u003c\u003e(this.beanDefinitionNames); for (String beanName : beanNames) { // 先从mergedBeanDefinitions(map)中根据name拿到BeanDefinition // todo mergedBeanDefinitions和beanDefinitionMap有什么区别 // todo 为什么获取BeanDefinition要搞得真么复杂，直接遍历beanDefinitionMap不可以吗 RootBeanDefinition bd = getMergedLocalBeanDefinition(beanName); // 抽象类或者非单例类或者懒加载的类不会实例化 if (!bd.isAbstract() \u0026\u0026 bd.isSingleton() \u0026\u0026 !bd.isLazyInit()) { // 验证是否是FactoryBean if (isFactoryBean(beanName)) { // 把name前面拼上\"\u0026\"，然后获取Bean Object bean = getBean(FACTORY_BEAN_PREFIX + beanName); if (bean instanceof FactoryBean) { FactoryBean\u003c?\u003e factory = (FactoryBean\u003c?\u003e) bean; boolean isEagerInit; if (System.getSecurityManager() != null \u0026\u0026 factory instanceof SmartFactoryBean) { isEagerInit = AccessController.doPrivileged( (PrivilegedAction\u003cBoolean\u003e) ((SmartFactoryBean\u003c?\u003e) factory)::isEagerInit, getAccessControlContext()); } else { isEagerInit = (factory instanceof SmartFactoryBean \u0026\u0026 ((SmartFactoryBean\u003c?\u003e) factory).isEagerInit()); } if (isEagerInit) { getBean(beanName); } } } else { // 非FactoryBean得话走这里 getBean(beanName); } } } // Trigger post-initialization callback for all applicable beans... for (String beanName : beanNames) { Object singletonInstance = getSingleton(beanName); if (singletonInstance instanceof SmartInitializingSingleton) { SmartInitializingSingleton smartSingleton = (SmartInitializingSingleton) singletonInstance; if (System.getSecurityManager() != null) { AccessController.doPrivileged((PrivilegedAction\u003cObject\u003e) () -\u003e { smartSingleton.afterSingletonsInstantiated(); return null; }, getAccessControlContext()); } else { smartSingleton.afterSingletonsInstantiated(); } } } } getBean()方法里直接调用了doGetBean()方法：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 protected \u003cT\u003e T doGetBean( String name, @Nullable Class\u003cT\u003e requiredType, @Nullable Object[] args, boolean typeCheckOnly) throws BeansException { // 1.验证名字的合法性 String beanName = transformedBeanName(name); Object bean; // Eagerly check singleton cache for manually registered singletons. // 1.尝试从单例池中获取Bean Object sharedInstance = getSingleton(beanName); if (sharedInstance != null \u0026\u0026 args == null) { if (logger.isTraceEnabled()) { if (isSingletonCurrentlyInCreation(beanName)) { logger.trace(\"Returning eagerly cached instance of singleton bean '\" + beanName + \"' that is not fully initialized yet - a consequence of a circular reference\"); } else { logger.trace(\"Returning cached instance of singleton bean '\" + beanName + \"'\"); } } bean = getObjectForBeanInstance(sharedInstance, name, beanName, null); } // 如果Bean还没被创建会走到这个分支 else { // 如果这个Bean在正在创建的原型集合中就抛异常 if (isPrototypeCurrentlyInCreation(beanName)) { throw new BeanCurrentlyInCreationException(beanName); } // 处理父子容器 BeanFactory parentBeanFactory = getParentBeanFactory(); if (parentBeanFactory != null \u0026\u0026 !containsBeanDefinition(beanName)) { // Not found -\u003e check parent. String nameToLookup = originalBeanName(name); if (parentBeanFactory instanceof AbstractBeanFactory) { return ((AbstractBeanFactory) parentBeanFactory).doGetBean( nameToLookup, requiredType, args, typeCheckOnly); } else if (args != null) { // Delegation to parent with explicit args. return (T) parentBeanFactory.getBean(nameToLookup, args); } else if (requiredType != null) { // No args -\u003e delegate to standard getBean method. return parentBeanFactory.getBean(nameToLookup, requiredType); } else { return (T) parentBeanFactory.getBean(nameToLookup); } } if (!typeCheckOnly) { markBeanAsCreated(beanName); } try { RootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName); checkMergedBeanDefinition(mbd, beanName, args); // Guarantee initialization of beans that the current bean depends on. // 处理@DependsOn注解 String[] dependsOn = mbd.getDependsOn(); if (dependsOn != null) { for (String dep : dependsOn) { if (isDependent(beanName, dep)) { throw new BeanCreationException(mbd.getResourceDescription(), beanName, \"Circular depends-on relationship between '\" + beanName + \"' and '\" + dep + \"'\"); } //先去处理@DependsOn注解里的类 registerDependentBean(dep, beanName); try { getBean(dep); } catch (NoSuchBeanDefinitionException ex) { throw new BeanCreationException(mbd.getResourceDescription(), beanName, \"'\" + beanName + \"' depends on missing bean '\" + dep + \"'\", ex); } } } // Create bean instance. // 如果是单例的就创建Bean if (mbd.isSingleton()) { sharedInstance = getSingleton(beanName, () -\u003e { try { // 开始创建 return createBean(beanName, mbd, args); } catch (BeansException ex) { // Explicitly remove instance from singleton cache: It might have been put there // eagerly by the creation process, to allow for circular reference resolution. // Also remove any beans that received a temporary reference to the bean. destroySingleton(beanName); throw ex; } }); bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd); } else if (mbd.isPrototype()) { // It's a prototype -\u003e create a new instance. Object prototypeInstance = null; try { beforePrototypeCreation(beanName); prototypeInstance = createBean(beanName, mbd, args); } finally { afterPrototypeCreation(beanName); } bean = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd); } else { String scopeName = mbd.getScope(); if (!StringUtils.hasLength(scopeName)) { throw new IllegalStateException(\"No scope name defined for bean '\" + beanName + \"'\"); } Scope scope = this.scopes.get(scopeName); if (scope == null) { throw new IllegalStateException(\"No Scope registered for scope name '\" + scopeName + \"'\"); } try { Object scopedInstance = scope.get(beanName, () -\u003e { beforePrototypeCreation(beanName); try { return createBean(beanName, mbd, args); } finally { afterPrototypeCreation(beanName); } }); bean = getObjectForBeanInstance(scopedInstance, name, beanName, mbd); } catch (IllegalStateException ex) { throw new BeanCreationException(beanName, \"Scope '\" + scopeName + \"' is not active for the current thread; consider \" + \"defining a scoped proxy for this bean if you intend to refer to it from a singleton\", ex); } } } catch (BeansException ex) { cleanupAfterBeanCreationFailure(beanName); throw ex; } } // Check if required type matches the type of the actual bean instance. if (requiredType != null \u0026\u0026 !requiredType.isInstance(bean)) { try { T convertedBean = getTypeConverter().convertIfNecessary(bean, requiredType); if (convertedBean == null) { throw new BeanNotOfRequiredTypeException(name, requiredType, bean.getClass()); } return convertedBean; } catch (TypeMismatchException ex) { if (logger.isTraceEnabled()) { logger.trace(\"Failed to convert bean '\" + name + \"' to required type '\" + ClassUtils.getQualifiedName(requiredType) + \"'\", ex); } throw new BeanNotOfRequiredTypeException(name, requiredType, bean.getClass()); } } return (T) bean; } 真正创建Bean的代码在**createBean(beanName, mbd, args);里，但是这个方法显示通过resolveBeforeInstantiation(beanName, mbdToUse);处理了一下AOP的@Before，然后通过doCreateBean(beanName, mbdToUse, args);**创建Bean：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 protected Object doCreateBean(String beanName, RootBeanDefinition mbd, @Nullable Object[] args) throws BeanCreationException { // Instantiate the bean. // 这个BeanWrapper属于对Bean的一层包裹 BeanWrapper instanceWrapper = null; if (mbd.isSingleton()) { // 移除单例的缓存 instanceWrapper = this.factoryBeanInstanceCache.remove(beanName); } if (instanceWrapper == null) { // 推断supplier、推断构造方法，创建对象 instanceWrapper = createBeanInstance(beanName, mbd, args); } Object bean = instanceWrapper.getWrappedInstance(); Class\u003c?\u003e beanType = instanceWrapper.getWrappedClass(); if (beanType != NullBean.class) { mbd.resolvedTargetType = beanType; } // Allow post-processors to modify the merged bean definition. synchronized (mbd.postProcessingLock) { if (!mbd.postProcessed) { try { // 这里就会执行所有MergedBeanDefinitionPostProcessor的实现类 // 比如AutowiredAnnotationBeanPostProcessor就会在这个时候找到所有@Autowired注解的属性或者方法缓存起来 applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName); } catch (Throwable ex) { throw new BeanCreationException(mbd.getResourceDescription(), beanName, \"Post-processing of merged bean definition failed\", ex); } mbd.postProcessed = true; } } // Eagerly cache singletons to be able to resolve circular references // even when triggered by lifecycle interfaces like BeanFactoryAware. boolean earlySingletonExposure = (mbd.isSingleton() \u0026\u0026 this.allowCircularReferences \u0026\u0026 isSingletonCurrentlyInCreation(beanName)); if (earlySingletonExposure) { if (logger.isTraceEnabled()) { logger.trace(\"Eagerly caching bean '\" + beanName + \"' to allow for resolving potential circular references\"); } // 把Bean封装成BeanFactory缓存到singletonFactories中 // 这个是为了做循环依赖的支撑 addSingletonFactory(beanName, () -\u003e getEarlyBeanReference(beanName, mbd, bean)); } // Initialize the bean instance. Object exposedObject = bean; try { // 完成属性填充 populateBean(beanName, mbd, instanceWrapper); // 初始化Bean exposedObject = initializeBean(beanName, exposedObject, mbd); } catch (Throwable ex) { if (ex instanceof BeanCreationException \u0026\u0026 beanName.equals(((BeanCreationException) ex).getBeanName())) { throw (BeanCreationException) ex; } else { throw new BeanCreationException( mbd.getResourceDescription(), beanName, \"Initialization of bean failed\", ex); } } if (earlySingletonExposure) { Object earlySingletonReference = getSingleton(beanName, false); if (earlySingletonReference != null) { if (exposedObject == bean) { exposedObject = earlySingletonReference; } else if (!this.allowRawInjectionDespiteWrapping \u0026\u0026 hasDependentBean(beanName)) { String[] dependentBeans = getDependentBeans(beanName); Set\u003cString\u003e actualDependentBeans = new LinkedHashSet\u003c\u003e(dependentBeans.length); for (String dependentBean : dependentBeans) { if (!removeSingletonIfCreatedForTypeCheckOnly(dependentBean)) { actualDependentBeans.add(dependentBean); } } if (!actualDependentBeans.isEmpty()) { throw new BeanCurrentlyInCreationException(beanName, \"Bean with name '\" + beanName + \"' has been injected into other beans [\" + StringUtils.collectionToCommaDelimitedString(actualDependentBeans) + \"] in its raw version as part of a circular reference, but has eventually been \" + \"wrapped. This means that said other beans do not use the final version of the \" + \"bean. This is often the result of over-eager type matching - consider using \" + \"'getBeanNamesForType' with the 'allowEagerInit' flag turned off, for example.\"); } } } } // Register bean as disposable. try { registerDisposableBeanIfNecessary(beanName, bean, mbd); } catch (BeanDefinitionValidationException ex) { throw new BeanCreationException( mbd.getResourceDescription(), beanName, \"Invalid destruction signatrue\", ex); } return exposedObject; } 属性填充会先去判断我们有没有重写过InstantiationAwareBeanPostProcessor的postProcessAfterInstantiation()方法，这个方法可以控制是否进行属性填充，然后对@Autowired和@Resource进行注入，最后在实现自动注入：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 protected void populateBean(String beanName, RootBeanDefinition mbd, @Nullable BeanWrapper bw) { if (bw == null) { if (mbd.hasPropertyValues()) { throw new BeanCreationException( mbd.getResourceDescription(), beanName, \"Cannot apply property values to null instance\"); } else { // Skip property population phase for null instance. return; } } // Give any InstantiationAwareBeanPostProcessors the opportunity to modify the // state of the bean before properties are set. This can be used, for example, // to support styles of field injection. if (!mbd.isSynthetic() \u0026\u0026 hasInstantiationAwareBeanPostProcessors()) { for (BeanPostProcessor bp : getBeanPostProcessors()) { // 这里会执行InstantiationAwareBeanPostProcessor的所有实现类 // 如果postProcessAfterInstantiation()方法返回的是false，是不会继续填充属性的 if (bp instanceof InstantiationAwareBeanPostProcessor) { InstantiationAwareBeanPostProcessor ibp = (InstantiationAwareBeanPostProcessor) bp; if (!ibp.postProcessAfterInstantiation(bw.getWrappedInstance(), beanName)) { return; } } } } PropertyValues pvs = (mbd.hasPropertyValues() ? mbd.getPropertyValues() : null); int resolvedAutowireMode = mbd.getResolvedAutowireMode(); if (resolvedAutowireMode == AUTOWIRE_BY_NAME || resolvedAutowireMode == AUTOWIRE_BY_TYPE) { MutablePropertyValues newPvs = new MutablePropertyValues(pvs); // Add property values based on autowire by name if applicable. if (resolvedAutowireMode == AUTOWIRE_BY_NAME) { autowireByName(beanName, mbd, bw, newPvs); } // Add property values based on autowire by type if applicable. if (resolvedAutowireMode == AUTOWIRE_BY_TYPE) { autowireByType(beanName, mbd, bw, newPvs); } pvs = newPvs; } boolean hasInstAwareBpps = hasInstantiationAwareBeanPostProcessors(); boolean needsDepCheck = (mbd.getDependencyCheck() != AbstractBeanDefinition.DEPENDENCY_CHECK_NONE); PropertyDescriptor[] filteredPds = null; if (hasInstAwareBpps) { if (pvs == null) { pvs = mbd.getPropertyValues(); } for (BeanPostProcessor bp : getBeanPostProcessors()) { if (bp instanceof InstantiationAwareBeanPostProcessor) { // 执行InstantiationAwareBeanPostProcessor的postProcessProperties()方法 // @Autowired和@Resource就是在这里处理的 InstantiationAwareBeanPostProcessor ibp = (InstantiationAwareBeanPostProcessor) bp; PropertyValues pvsToUse = ibp.postProcessProperties(pvs, bw.getWrappedInstance(), beanName); if (pvsToUse == null) { if (filteredPds == null) { filteredPds = filterPropertyDescriptorsForDependencyCheck(bw, mbd.allowCaching); } pvsToUse = ibp.postProcessPropertyValues(pvs, filteredPds, bw.getWrappedInstance(), beanName); if (pvsToUse == null) { return; } } pvs = pvsToUse; } } } if (needsDepCheck) { if (filteredPds == null) { filteredPds = filterPropertyDescriptorsForDependencyCheck(bw, mbd.allowCaching); } checkDependencies(beanName, mbd, filteredPds, pvs); } if (pvs != null) { // 实现自动注入 applyPropertyValues(beanName, mbd, bw, pvs); } } 回过头看初始化Bean的代码，这里主要是处理一些Aware接口、@PostConstruct注解或者方法，最后执行BeanPostProcessor的postProcessAfterInitialization()方法，AOP通过这个方法生成的代理：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 protected Object initializeBean(String beanName, Object bean, @Nullable RootBeanDefinition mbd) { if (System.getSecurityManager() != null) { AccessController.doPrivileged((PrivilegedAction\u003cObject\u003e) () -\u003e { invokeAwareMethods(beanName, bean); return null; }, getAccessControlContext()); } else { // 这里会判断这个Bean是否实现了Aware接口，然后执行里面的方法 // 判断是否继承BeanNameAware、BeanClassLoaderAware、BeanFactoryAware invokeAwareMethods(beanName, bean); } Object wrappedBean = bean; if (mbd == null || !mbd.isSynthetic()) { // 这里主要是处理一些生命周期的注解，比如@PostConstruct wrappedBean = applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName); } try { // 这个和上面对应，他是处理方法的 invokeInitMethods(beanName, wrappedBean, mbd); } catch (Throwable ex) { throw new BeanCreationException( (mbd != null ? mbd.getResourceDescription() : null), beanName, \"Invocation of init method failed\", ex); } if (mbd == null || !mbd.isSynthetic()) { // 这里执行postProcessAfterInitialization()方法 // 大部分的BeanPostProcessors都没有实现这个方法 wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName); } return wrappedBean; } 这里一个半成品的Bean就创建完了，但是还没有放进单例池中。\n很少对Bean生命周期的前半部分扩展，很少在干扰Bean的初始化和干扰Bean的注入。大部分都是对BeanPostProcessor的postProcessorafterInitialization()方法进行扩展，比如AOP。\n3.循环依赖 循环依赖就是A依赖B，B依赖A。Spring是不支持非单例Bean或者通过构造方法注入的循环依赖的。\n当扫描完Bean开始实例化的时候，会去调用BeanFactory的getBean()方法然后再调用到doGetBean()方法，这个方法里会先尝试从第3级缓存获取Bean：\n1 Object sharedInstance = getSingleton(beanName); 假设现在是第一次获取Bean A，此时拿到的一定是null，然后回往下走到创建Bean A的分支，真正创建Bean A的代码是下面这段：\n1 2 3 4 5 6 7 8 9 10 11 12 13 sharedInstance = getSingleton(beanName, () -\u003e { try { // 开始创建 return createBean(beanName, mbd, args); } catch (BeansException ex) { // Explicitly remove instance from singleton cache: It might have been put there // eagerly by the creation process, to allow for circular reference resolution. // Also remove any beans that received a temporary reference to the bean. destroySingleton(beanName); throw ex; } }); 注意这里先调用的是getSingleton()方法，getSingleton()方法需要两个参数，bean名字和ObjectFactory对象，上面创建了一个新的ObjectFactory对象，然后重写了getObject()方法，在getObject()方法里调用的createBean()方法。\ngetSingleton()方法关键代码：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 /** * DefaultSingletonBeanRegistry类 */ public Object getSingleton(String beanName, ObjectFactory\u003c?\u003e singletonFactory) { synchronized (this.singletonObjects) { // this.singletonObjects就是单例池，我也把他叫做1级缓存 // 尝试从1级缓存中拿 Object singletonObject = this.singletonObjects.get(beanName); if (singletonObject == null) { if (this.singletonsCurrentlyInDestruction) { // 正在被销毁就抛出异常 } // 把这个Bean加到singletonsCurrentlyInCreation集合中 // 标记为正在被创建的Bean beforeSingletonCreation(beanName); try { // 因为上面重写了getObject()方法，所以这里调用了上面的是createBean()方法 singletonObject = singletonFactory.getObject(); newSingleton = true; } finally { // 把Bean名字从singletonsCurrentlyInCreation集合里移出 // 意思就是取消标记为正在被创建的Bean afterSingletonCreation(beanName); } if (newSingleton) { // 把实例化好的Bean放到单例池中 // 就是删掉2、3级缓存，添加到1级缓存 addSingleton(beanName, singletonObject); } } return singletonObject; } } 通过singletonFactory.getObject()一定会走到createBean()方法，然后再走到doCreateBean()方法，doCreateBean()方法的关键代码：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 protected Object doCreateBean(String beanName, RootBeanDefinition mbd, @Nullable Object[] args) throws BeanCreationException { if (instanceWrapper == null) { // 推断supplier、推断构造方法，创建对象 instanceWrapper = createBeanInstance(beanName, mbd, args); } synchronized (mbd.postProcessingLock) { if (!mbd.postProcessed) { // 这里就会执行所有MergedBeanDefinitionPostProcessor的实现类 // 比如AutowiredAnnotationBeanPostProcessor就会在这个时候找到所有@Autowired注解的属性或者方法缓存起来 applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName); } } // 单例并且正在创建 boolean earlySingletonExposure = (mbd.isSingleton() \u0026\u0026 this.allowCircularReferences \u0026\u0026 isSingletonCurrentlyInCreation(beanName)); if (earlySingletonExposure) { // 把Bean封装成ObjectFactory(BeanFactory) // 添加到singletonFactories和registeredSingletons，从earlySingletonObjects移出 // Map","wordCount":"2637","inLanguage":"en","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://wangxiaohong123.github.io/posts/%E6%A1%86%E6%9E%B6/spring/framework/5.bean%E7%9A%84%E5%AE%9E%E4%BE%8B%E5%8C%96/"},"publisher":{"@type":"Organization","name":"王小红的笔记","logo":{"@type":"ImageObject","url":"https://wangxiaohong123.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wangxiaohong123.github.io/ accesskey=h title="王小红的笔记 (Alt + H)">王小红的笔记</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://wangxiaohong123.github.io/posts/ title=笔记><span>笔记</span></a></li><li><a href=https://wangxiaohong123.github.io/categories/ title=分类><span>分类</span></a></li><li><a href=https://wangxiaohong123.github.io/tags/ title=标签><span>标签</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">5.Bean的实例化</h1><div class=post-meta>13 min</div></header><div class=post-content><h5 id=1单例池>1.单例池<a hidden class=anchor aria-hidden=true href=#1单例池>#</a></h5><p>在BeanFactory中beanDefinitionMap存放的是bean的名字作为key，类对应的BeanDefinition作为value，还有一个singletonObjects用来存放已经实例化好的Bean，Spring中叫单例池。</p><h6 id=2实例化源码>2.实例化源码<a hidden class=anchor aria-hidden=true href=#2实例化源码>#</a></h6><p>在启动容器结束后就已经完成了Bean的扫描，ApplicationContext的refresh()方法中会调用下面的方法，就是Bean实例化的入口：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#6272a4>// 完成不是懒加载的单例Bean的实例化</span>
</span></span><span style=display:flex><span>finishBeanFactoryInitialization(beanFactory);
</span></span></code></pre></td></tr></table></div></div><p>真正的入口在finishBeanFactoryInitialization(beanFactory);方法里的最后一行：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>beanFactory.<span style=color:#50fa7b>preInstantiateSingletons</span>();
</span></span></code></pre></td></tr></table></div></div><p>这个类里先校验，然后把name前面拼上"&&ldquo;去调用getBean()方法，这个方法中会判断如果单例池中没有这个Bean回去创建：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>preInstantiateSingletons</span>() <span style=color:#8be9fd;font-style:italic>throws</span> BeansException {
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>if</span> (logger.<span style=color:#50fa7b>isTraceEnabled</span>()) {
</span></span><span style=display:flex><span>      logger.<span style=color:#50fa7b>trace</span>(<span style=color:#f1fa8c>&#34;Pre-instantiating singletons in &#34;</span> <span style=color:#ff79c6>+</span> <span style=color:#ff79c6>this</span>);
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>   <span style=color:#6272a4>// 这个beanDefinitionNames存的是beanDefinitionMap的key</span>
</span></span><span style=display:flex><span>   List<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span> beanNames <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ArrayList<span style=color:#ff79c6>&lt;&gt;</span>(<span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>beanDefinitionNames</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>for</span> (String beanName : beanNames) {
</span></span><span style=display:flex><span>      <span style=color:#6272a4>// 先从mergedBeanDefinitions(map)中根据name拿到BeanDefinition</span>
</span></span><span style=display:flex><span>      <span style=color:#6272a4>// todo mergedBeanDefinitions和beanDefinitionMap有什么区别</span>
</span></span><span style=display:flex><span>      <span style=color:#6272a4>// todo 为什么获取BeanDefinition要搞得真么复杂，直接遍历beanDefinitionMap不可以吗</span>
</span></span><span style=display:flex><span>      RootBeanDefinition bd <span style=color:#ff79c6>=</span> getMergedLocalBeanDefinition(beanName);
</span></span><span style=display:flex><span>      <span style=color:#6272a4>// 抽象类或者非单例类或者懒加载的类不会实例化</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>bd.<span style=color:#50fa7b>isAbstract</span>() <span style=color:#ff79c6>&amp;&amp;</span> bd.<span style=color:#50fa7b>isSingleton</span>() <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!</span>bd.<span style=color:#50fa7b>isLazyInit</span>()) {
</span></span><span style=display:flex><span>         <span style=color:#6272a4>// 验证是否是FactoryBean</span>
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>if</span> (isFactoryBean(beanName)) {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 把name前面拼上&#34;&amp;&#34;，然后获取Bean</span>
</span></span><span style=display:flex><span>            Object bean <span style=color:#ff79c6>=</span> getBean(FACTORY_BEAN_PREFIX <span style=color:#ff79c6>+</span> beanName);
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (bean <span style=color:#ff79c6>instanceof</span> FactoryBean) {
</span></span><span style=display:flex><span>               FactoryBean<span style=color:#ff79c6>&lt;?&gt;</span> factory <span style=color:#ff79c6>=</span> (FactoryBean<span style=color:#ff79c6>&lt;?&gt;</span>) bean;
</span></span><span style=display:flex><span>               <span style=color:#8be9fd>boolean</span> isEagerInit;
</span></span><span style=display:flex><span>               <span style=color:#ff79c6>if</span> (System.<span style=color:#50fa7b>getSecurityManager</span>() <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> factory <span style=color:#ff79c6>instanceof</span> SmartFactoryBean) {
</span></span><span style=display:flex><span>                  isEagerInit <span style=color:#ff79c6>=</span> AccessController.<span style=color:#50fa7b>doPrivileged</span>(
</span></span><span style=display:flex><span>                        (PrivilegedAction<span style=color:#ff79c6>&lt;</span>Boolean<span style=color:#ff79c6>&gt;</span>) ((SmartFactoryBean<span style=color:#ff79c6>&lt;?&gt;</span>) factory)::isEagerInit,
</span></span><span style=display:flex><span>                        getAccessControlContext());
</span></span><span style=display:flex><span>               }
</span></span><span style=display:flex><span>               <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>                  isEagerInit <span style=color:#ff79c6>=</span> (factory <span style=color:#ff79c6>instanceof</span> SmartFactoryBean <span style=color:#ff79c6>&amp;&amp;</span>
</span></span><span style=display:flex><span>                        ((SmartFactoryBean<span style=color:#ff79c6>&lt;?&gt;</span>) factory).<span style=color:#50fa7b>isEagerInit</span>());
</span></span><span style=display:flex><span>               }
</span></span><span style=display:flex><span>               <span style=color:#ff79c6>if</span> (isEagerInit) {
</span></span><span style=display:flex><span>                  getBean(beanName);
</span></span><span style=display:flex><span>               }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>         }
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>             <span style=color:#6272a4>// 非FactoryBean得话走这里</span>
</span></span><span style=display:flex><span>            getBean(beanName);
</span></span><span style=display:flex><span>         }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#6272a4>// Trigger post-initialization callback for all applicable beans...</span>
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>for</span> (String beanName : beanNames) {
</span></span><span style=display:flex><span>      Object singletonInstance <span style=color:#ff79c6>=</span> getSingleton(beanName);
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>if</span> (singletonInstance <span style=color:#ff79c6>instanceof</span> SmartInitializingSingleton) {
</span></span><span style=display:flex><span>         SmartInitializingSingleton smartSingleton <span style=color:#ff79c6>=</span> (SmartInitializingSingleton) singletonInstance;
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>if</span> (System.<span style=color:#50fa7b>getSecurityManager</span>() <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>            AccessController.<span style=color:#50fa7b>doPrivileged</span>((PrivilegedAction<span style=color:#ff79c6>&lt;</span>Object<span style=color:#ff79c6>&gt;</span>) () <span style=color:#ff79c6>-&gt;</span> {
</span></span><span style=display:flex><span>               smartSingleton.<span style=color:#50fa7b>afterSingletonsInstantiated</span>();
</span></span><span style=display:flex><span>               <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span>            }, getAccessControlContext());
</span></span><span style=display:flex><span>         }
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>            smartSingleton.<span style=color:#50fa7b>afterSingletonsInstantiated</span>();
</span></span><span style=display:flex><span>         }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>getBean()方法里直接调用了doGetBean()方法：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">127
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">128
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">129
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">130
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">131
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">132
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">133
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">134
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">135
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">136
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">137
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">138
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">139
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">140
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">141
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">142
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">143
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">144
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">145
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">146
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">147
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">148
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">149
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">150
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">151
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">152
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">153
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">154
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">155
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">156
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">157
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">158
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">159
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">160
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">161
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">162
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">163
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">164
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">165
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">166
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>protected</span> <span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> T <span style=color:#50fa7b>doGetBean</span>(
</span></span><span style=display:flex><span>      String name, @Nullable Class<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> requiredType, @Nullable Object<span style=color:#ff79c6>[]</span> args, <span style=color:#8be9fd>boolean</span> typeCheckOnly)
</span></span><span style=display:flex><span>      <span style=color:#8be9fd;font-style:italic>throws</span> BeansException {
</span></span><span style=display:flex><span>   <span style=color:#6272a4>// 1.验证名字的合法性</span>
</span></span><span style=display:flex><span>   String beanName <span style=color:#ff79c6>=</span> transformedBeanName(name);
</span></span><span style=display:flex><span>   Object bean;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#6272a4>// Eagerly check singleton cache for manually registered singletons.</span>
</span></span><span style=display:flex><span>   <span style=color:#6272a4>// 1.尝试从单例池中获取Bean</span>
</span></span><span style=display:flex><span>   Object sharedInstance <span style=color:#ff79c6>=</span> getSingleton(beanName);
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>if</span> (sharedInstance <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> args <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>if</span> (logger.<span style=color:#50fa7b>isTraceEnabled</span>()) {
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>if</span> (isSingletonCurrentlyInCreation(beanName)) {
</span></span><span style=display:flex><span>            logger.<span style=color:#50fa7b>trace</span>(<span style=color:#f1fa8c>&#34;Returning eagerly cached instance of singleton bean &#39;&#34;</span> <span style=color:#ff79c6>+</span> beanName <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>                  <span style=color:#f1fa8c>&#34;&#39; that is not fully initialized yet - a consequence of a circular reference&#34;</span>);
</span></span><span style=display:flex><span>         }
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>            logger.<span style=color:#50fa7b>trace</span>(<span style=color:#f1fa8c>&#34;Returning cached instance of singleton bean &#39;&#34;</span> <span style=color:#ff79c6>+</span> beanName <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;&#39;&#34;</span>);
</span></span><span style=display:flex><span>         }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      bean <span style=color:#ff79c6>=</span> getObjectForBeanInstance(sharedInstance, name, beanName, <span style=color:#ff79c6>null</span>);
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   <span style=color:#6272a4>// 如果Bean还没被创建会走到这个分支</span>
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#6272a4>// 如果这个Bean在正在创建的原型集合中就抛异常</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>if</span> (isPrototypeCurrentlyInCreation(beanName)) {
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> BeanCurrentlyInCreationException(beanName);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#6272a4>// 处理父子容器</span>
</span></span><span style=display:flex><span>      BeanFactory parentBeanFactory <span style=color:#ff79c6>=</span> getParentBeanFactory();
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>if</span> (parentBeanFactory <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!</span>containsBeanDefinition(beanName)) {
</span></span><span style=display:flex><span>         <span style=color:#6272a4>// Not found -&gt; check parent.</span>
</span></span><span style=display:flex><span>         String nameToLookup <span style=color:#ff79c6>=</span> originalBeanName(name);
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>if</span> (parentBeanFactory <span style=color:#ff79c6>instanceof</span> AbstractBeanFactory) {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> ((AbstractBeanFactory) parentBeanFactory).<span style=color:#50fa7b>doGetBean</span>(
</span></span><span style=display:flex><span>                  nameToLookup, requiredType, args, typeCheckOnly);
</span></span><span style=display:flex><span>         }
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (args <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// Delegation to parent with explicit args.</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> (T) parentBeanFactory.<span style=color:#50fa7b>getBean</span>(nameToLookup, args);
</span></span><span style=display:flex><span>         }
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (requiredType <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// No args -&gt; delegate to standard getBean method.</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> parentBeanFactory.<span style=color:#50fa7b>getBean</span>(nameToLookup, requiredType);
</span></span><span style=display:flex><span>         }
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> (T) parentBeanFactory.<span style=color:#50fa7b>getBean</span>(nameToLookup);
</span></span><span style=display:flex><span>         }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>typeCheckOnly) {
</span></span><span style=display:flex><span>         markBeanAsCreated(beanName);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>         RootBeanDefinition mbd <span style=color:#ff79c6>=</span> getMergedLocalBeanDefinition(beanName);
</span></span><span style=display:flex><span>         checkMergedBeanDefinition(mbd, beanName, args);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>         <span style=color:#6272a4>// Guarantee initialization of beans that the current bean depends on.</span>
</span></span><span style=display:flex><span>         <span style=color:#6272a4>// 处理@DependsOn注解</span>
</span></span><span style=display:flex><span>         String<span style=color:#ff79c6>[]</span> dependsOn <span style=color:#ff79c6>=</span> mbd.<span style=color:#50fa7b>getDependsOn</span>();
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>if</span> (dependsOn <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>for</span> (String dep : dependsOn) {
</span></span><span style=display:flex><span>               <span style=color:#ff79c6>if</span> (isDependent(beanName, dep)) {
</span></span><span style=display:flex><span>                  <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> BeanCreationException(mbd.<span style=color:#50fa7b>getResourceDescription</span>(), beanName,
</span></span><span style=display:flex><span>                        <span style=color:#f1fa8c>&#34;Circular depends-on relationship between &#39;&#34;</span> <span style=color:#ff79c6>+</span> beanName <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;&#39; and &#39;&#34;</span> <span style=color:#ff79c6>+</span> dep <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;&#39;&#34;</span>);
</span></span><span style=display:flex><span>               }
</span></span><span style=display:flex><span>               <span style=color:#6272a4>//先去处理@DependsOn注解里的类</span>
</span></span><span style=display:flex><span>               registerDependentBean(dep, beanName);
</span></span><span style=display:flex><span>               <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>                  getBean(dep);
</span></span><span style=display:flex><span>               }
</span></span><span style=display:flex><span>               <span style=color:#ff79c6>catch</span> (NoSuchBeanDefinitionException ex) {
</span></span><span style=display:flex><span>                  <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> BeanCreationException(mbd.<span style=color:#50fa7b>getResourceDescription</span>(), beanName,
</span></span><span style=display:flex><span>                        <span style=color:#f1fa8c>&#34;&#39;&#34;</span> <span style=color:#ff79c6>+</span> beanName <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;&#39; depends on missing bean &#39;&#34;</span> <span style=color:#ff79c6>+</span> dep <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;&#39;&#34;</span>, ex);
</span></span><span style=display:flex><span>               }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>         }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>         <span style=color:#6272a4>// Create bean instance.</span>
</span></span><span style=display:flex><span>         <span style=color:#6272a4>// 如果是单例的就创建Bean</span>
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>if</span> (mbd.<span style=color:#50fa7b>isSingleton</span>()) {
</span></span><span style=display:flex><span>            sharedInstance <span style=color:#ff79c6>=</span> getSingleton(beanName, () <span style=color:#ff79c6>-&gt;</span> {
</span></span><span style=display:flex><span>               <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>                  <span style=color:#6272a4>// 开始创建</span>
</span></span><span style=display:flex><span>                  <span style=color:#ff79c6>return</span> createBean(beanName, mbd, args);
</span></span><span style=display:flex><span>               }
</span></span><span style=display:flex><span>               <span style=color:#ff79c6>catch</span> (BeansException ex) {
</span></span><span style=display:flex><span>                  <span style=color:#6272a4>// Explicitly remove instance from singleton cache: It might have been put there</span>
</span></span><span style=display:flex><span>                  <span style=color:#6272a4>// eagerly by the creation process, to allow for circular reference resolution.</span>
</span></span><span style=display:flex><span>                  <span style=color:#6272a4>// Also remove any beans that received a temporary reference to the bean.</span>
</span></span><span style=display:flex><span>                  destroySingleton(beanName);
</span></span><span style=display:flex><span>                  <span style=color:#ff79c6>throw</span> ex;
</span></span><span style=display:flex><span>               }
</span></span><span style=display:flex><span>            });
</span></span><span style=display:flex><span>            bean <span style=color:#ff79c6>=</span> getObjectForBeanInstance(sharedInstance, name, beanName, mbd);
</span></span><span style=display:flex><span>         }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (mbd.<span style=color:#50fa7b>isPrototype</span>()) {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// It&#39;s a prototype -&gt; create a new instance.</span>
</span></span><span style=display:flex><span>            Object prototypeInstance <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>               beforePrototypeCreation(beanName);
</span></span><span style=display:flex><span>               prototypeInstance <span style=color:#ff79c6>=</span> createBean(beanName, mbd, args);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>finally</span> {
</span></span><span style=display:flex><span>               afterPrototypeCreation(beanName);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            bean <span style=color:#ff79c6>=</span> getObjectForBeanInstance(prototypeInstance, name, beanName, mbd);
</span></span><span style=display:flex><span>         }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>            String scopeName <span style=color:#ff79c6>=</span> mbd.<span style=color:#50fa7b>getScope</span>();
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>StringUtils.<span style=color:#50fa7b>hasLength</span>(scopeName)) {
</span></span><span style=display:flex><span>               <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> IllegalStateException(<span style=color:#f1fa8c>&#34;No scope name defined for bean &#39;&#34;</span> <span style=color:#ff79c6>+</span> beanName <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;&#39;&#34;</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            Scope scope <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>scopes</span>.<span style=color:#50fa7b>get</span>(scopeName);
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (scope <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>               <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> IllegalStateException(<span style=color:#f1fa8c>&#34;No Scope registered for scope name &#39;&#34;</span> <span style=color:#ff79c6>+</span> scopeName <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;&#39;&#34;</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>               Object scopedInstance <span style=color:#ff79c6>=</span> scope.<span style=color:#50fa7b>get</span>(beanName, () <span style=color:#ff79c6>-&gt;</span> {
</span></span><span style=display:flex><span>                  beforePrototypeCreation(beanName);
</span></span><span style=display:flex><span>                  <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>                     <span style=color:#ff79c6>return</span> createBean(beanName, mbd, args);
</span></span><span style=display:flex><span>                  }
</span></span><span style=display:flex><span>                  <span style=color:#ff79c6>finally</span> {
</span></span><span style=display:flex><span>                     afterPrototypeCreation(beanName);
</span></span><span style=display:flex><span>                  }
</span></span><span style=display:flex><span>               });
</span></span><span style=display:flex><span>               bean <span style=color:#ff79c6>=</span> getObjectForBeanInstance(scopedInstance, name, beanName, mbd);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>catch</span> (IllegalStateException ex) {
</span></span><span style=display:flex><span>               <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> BeanCreationException(beanName,
</span></span><span style=display:flex><span>                     <span style=color:#f1fa8c>&#34;Scope &#39;&#34;</span> <span style=color:#ff79c6>+</span> scopeName <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;&#39; is not active for the current thread; consider &#34;</span> <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>                     <span style=color:#f1fa8c>&#34;defining a scoped proxy for this bean if you intend to refer to it from a singleton&#34;</span>,
</span></span><span style=display:flex><span>                     ex);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>         }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>catch</span> (BeansException ex) {
</span></span><span style=display:flex><span>         cleanupAfterBeanCreationFailure(beanName);
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>throw</span> ex;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#6272a4>// Check if required type matches the type of the actual bean instance.</span>
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>if</span> (requiredType <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!</span>requiredType.<span style=color:#50fa7b>isInstance</span>(bean)) {
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>         T convertedBean <span style=color:#ff79c6>=</span> getTypeConverter().<span style=color:#50fa7b>convertIfNecessary</span>(bean, requiredType);
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>if</span> (convertedBean <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> BeanNotOfRequiredTypeException(name, requiredType, bean.<span style=color:#50fa7b>getClass</span>());
</span></span><span style=display:flex><span>         }
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>return</span> convertedBean;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>catch</span> (TypeMismatchException ex) {
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>if</span> (logger.<span style=color:#50fa7b>isTraceEnabled</span>()) {
</span></span><span style=display:flex><span>            logger.<span style=color:#50fa7b>trace</span>(<span style=color:#f1fa8c>&#34;Failed to convert bean &#39;&#34;</span> <span style=color:#ff79c6>+</span> name <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;&#39; to required type &#39;&#34;</span> <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>                  ClassUtils.<span style=color:#50fa7b>getQualifiedName</span>(requiredType) <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;&#39;&#34;</span>, ex);
</span></span><span style=display:flex><span>         }
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> BeanNotOfRequiredTypeException(name, requiredType, bean.<span style=color:#50fa7b>getClass</span>());
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>return</span> (T) bean;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>真正创建Bean的代码在**createBean(beanName, mbd, args);<strong>里，但是这个方法显示通过</strong>resolveBeforeInstantiation(beanName, mbdToUse);<strong>处理了一下AOP的@Before，然后通过</strong>doCreateBean(beanName, mbdToUse, args);**创建Bean：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>protected</span> Object <span style=color:#50fa7b>doCreateBean</span>(String beanName, RootBeanDefinition mbd, @Nullable Object<span style=color:#ff79c6>[]</span> args)
</span></span><span style=display:flex><span>      <span style=color:#8be9fd;font-style:italic>throws</span> BeanCreationException {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#6272a4>// Instantiate the bean.</span>
</span></span><span style=display:flex><span>   <span style=color:#6272a4>// 这个BeanWrapper属于对Bean的一层包裹</span>
</span></span><span style=display:flex><span>   BeanWrapper instanceWrapper <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>if</span> (mbd.<span style=color:#50fa7b>isSingleton</span>()) {
</span></span><span style=display:flex><span>      <span style=color:#6272a4>// 移除单例的缓存</span>
</span></span><span style=display:flex><span>      instanceWrapper <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>factoryBeanInstanceCache</span>.<span style=color:#50fa7b>remove</span>(beanName);
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>if</span> (instanceWrapper <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>      <span style=color:#6272a4>// 推断supplier、推断构造方法，创建对象</span>
</span></span><span style=display:flex><span>      instanceWrapper <span style=color:#ff79c6>=</span> createBeanInstance(beanName, mbd, args);
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   Object bean <span style=color:#ff79c6>=</span> instanceWrapper.<span style=color:#50fa7b>getWrappedInstance</span>();
</span></span><span style=display:flex><span>   Class<span style=color:#ff79c6>&lt;?&gt;</span> beanType <span style=color:#ff79c6>=</span> instanceWrapper.<span style=color:#50fa7b>getWrappedClass</span>();
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>if</span> (beanType <span style=color:#ff79c6>!=</span> NullBean.<span style=color:#50fa7b>class</span>) {
</span></span><span style=display:flex><span>      mbd.<span style=color:#50fa7b>resolvedTargetType</span> <span style=color:#ff79c6>=</span> beanType;
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#6272a4>// Allow post-processors to modify the merged bean definition.</span>
</span></span><span style=display:flex><span>   <span style=color:#8be9fd;font-style:italic>synchronized</span> (mbd.<span style=color:#50fa7b>postProcessingLock</span>) {
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>mbd.<span style=color:#50fa7b>postProcessed</span>) {
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 这里就会执行所有MergedBeanDefinitionPostProcessor的实现类</span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 比如AutowiredAnnotationBeanPostProcessor就会在这个时候找到所有@Autowired注解的属性或者方法缓存起来</span>
</span></span><span style=display:flex><span>            applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName);
</span></span><span style=display:flex><span>         }
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>catch</span> (Throwable ex) {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> BeanCreationException(mbd.<span style=color:#50fa7b>getResourceDescription</span>(), beanName,
</span></span><span style=display:flex><span>                  <span style=color:#f1fa8c>&#34;Post-processing of merged bean definition failed&#34;</span>, ex);
</span></span><span style=display:flex><span>         }
</span></span><span style=display:flex><span>         mbd.<span style=color:#50fa7b>postProcessed</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>true</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#6272a4>// Eagerly cache singletons to be able to resolve circular references</span>
</span></span><span style=display:flex><span>   <span style=color:#6272a4>// even when triggered by lifecycle interfaces like BeanFactoryAware.</span>
</span></span><span style=display:flex><span>   <span style=color:#8be9fd>boolean</span> earlySingletonExposure <span style=color:#ff79c6>=</span> (mbd.<span style=color:#50fa7b>isSingleton</span>() <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>allowCircularReferences</span> <span style=color:#ff79c6>&amp;&amp;</span>
</span></span><span style=display:flex><span>         isSingletonCurrentlyInCreation(beanName));
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>if</span> (earlySingletonExposure) {
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>if</span> (logger.<span style=color:#50fa7b>isTraceEnabled</span>()) {
</span></span><span style=display:flex><span>         logger.<span style=color:#50fa7b>trace</span>(<span style=color:#f1fa8c>&#34;Eagerly caching bean &#39;&#34;</span> <span style=color:#ff79c6>+</span> beanName <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>               <span style=color:#f1fa8c>&#34;&#39; to allow for resolving potential circular references&#34;</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#6272a4>// 把Bean封装成BeanFactory缓存到singletonFactories中</span>
</span></span><span style=display:flex><span>      <span style=color:#6272a4>// 这个是为了做循环依赖的支撑</span>
</span></span><span style=display:flex><span>      addSingletonFactory(beanName, () <span style=color:#ff79c6>-&gt;</span> getEarlyBeanReference(beanName, mbd, bean));
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#6272a4>// Initialize the bean instance.</span>
</span></span><span style=display:flex><span>   Object exposedObject <span style=color:#ff79c6>=</span> bean;
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#6272a4>// 完成属性填充</span>
</span></span><span style=display:flex><span>      populateBean(beanName, mbd, instanceWrapper);
</span></span><span style=display:flex><span>      <span style=color:#6272a4>// 初始化Bean</span>
</span></span><span style=display:flex><span>      exposedObject <span style=color:#ff79c6>=</span> initializeBean(beanName, exposedObject, mbd);
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>catch</span> (Throwable ex) {
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>if</span> (ex <span style=color:#ff79c6>instanceof</span> BeanCreationException <span style=color:#ff79c6>&amp;&amp;</span> beanName.<span style=color:#50fa7b>equals</span>(((BeanCreationException) ex).<span style=color:#50fa7b>getBeanName</span>())) {
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>throw</span> (BeanCreationException) ex;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> BeanCreationException(
</span></span><span style=display:flex><span>               mbd.<span style=color:#50fa7b>getResourceDescription</span>(), beanName, <span style=color:#f1fa8c>&#34;Initialization of bean failed&#34;</span>, ex);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>if</span> (earlySingletonExposure) {
</span></span><span style=display:flex><span>      Object earlySingletonReference <span style=color:#ff79c6>=</span> getSingleton(beanName, <span style=color:#ff79c6>false</span>);
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>if</span> (earlySingletonReference <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>if</span> (exposedObject <span style=color:#ff79c6>==</span> bean) {
</span></span><span style=display:flex><span>            exposedObject <span style=color:#ff79c6>=</span> earlySingletonReference;
</span></span><span style=display:flex><span>         }
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span><span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>allowRawInjectionDespiteWrapping</span> <span style=color:#ff79c6>&amp;&amp;</span> hasDependentBean(beanName)) {
</span></span><span style=display:flex><span>            String<span style=color:#ff79c6>[]</span> dependentBeans <span style=color:#ff79c6>=</span> getDependentBeans(beanName);
</span></span><span style=display:flex><span>            Set<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span> actualDependentBeans <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> LinkedHashSet<span style=color:#ff79c6>&lt;&gt;</span>(dependentBeans.<span style=color:#50fa7b>length</span>);
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>for</span> (String dependentBean : dependentBeans) {
</span></span><span style=display:flex><span>               <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>removeSingletonIfCreatedForTypeCheckOnly(dependentBean)) {
</span></span><span style=display:flex><span>                  actualDependentBeans.<span style=color:#50fa7b>add</span>(dependentBean);
</span></span><span style=display:flex><span>               }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>actualDependentBeans.<span style=color:#50fa7b>isEmpty</span>()) {
</span></span><span style=display:flex><span>               <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> BeanCurrentlyInCreationException(beanName,
</span></span><span style=display:flex><span>                     <span style=color:#f1fa8c>&#34;Bean with name &#39;&#34;</span> <span style=color:#ff79c6>+</span> beanName <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;&#39; has been injected into other beans [&#34;</span> <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>                     StringUtils.<span style=color:#50fa7b>collectionToCommaDelimitedString</span>(actualDependentBeans) <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>                     <span style=color:#f1fa8c>&#34;] in its raw version as part of a circular reference, but has eventually been &#34;</span> <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>                     <span style=color:#f1fa8c>&#34;wrapped. This means that said other beans do not use the final version of the &#34;</span> <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>                     <span style=color:#f1fa8c>&#34;bean. This is often the result of over-eager type matching - consider using &#34;</span> <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>                     <span style=color:#f1fa8c>&#34;&#39;getBeanNamesForType&#39; with the &#39;allowEagerInit&#39; flag turned off, for example.&#34;</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>         }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#6272a4>// Register bean as disposable.</span>
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>      registerDisposableBeanIfNecessary(beanName, bean, mbd);
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>catch</span> (BeanDefinitionValidationException ex) {
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> BeanCreationException(
</span></span><span style=display:flex><span>            mbd.<span style=color:#50fa7b>getResourceDescription</span>(), beanName, <span style=color:#f1fa8c>&#34;Invalid destruction signatrue&#34;</span>, ex);
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>return</span> exposedObject;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>属性填充会先去判断我们有没有重写过InstantiationAwareBeanPostProcessor的postProcessAfterInstantiation()方法，这个方法可以控制是否进行属性填充，然后对@Autowired和@Resource进行注入，最后在实现自动注入：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">83
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>protected</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>populateBean</span>(String beanName, RootBeanDefinition mbd, @Nullable BeanWrapper bw) {
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>if</span> (bw <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>if</span> (mbd.<span style=color:#50fa7b>hasPropertyValues</span>()) {
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> BeanCreationException(
</span></span><span style=display:flex><span>               mbd.<span style=color:#50fa7b>getResourceDescription</span>(), beanName, <span style=color:#f1fa8c>&#34;Cannot apply property values to null instance&#34;</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>         <span style=color:#6272a4>// Skip property population phase for null instance.</span>
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#6272a4>// Give any InstantiationAwareBeanPostProcessors the opportunity to modify the</span>
</span></span><span style=display:flex><span>   <span style=color:#6272a4>// state of the bean before properties are set. This can be used, for example,</span>
</span></span><span style=display:flex><span>   <span style=color:#6272a4>// to support styles of field injection.</span>
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>mbd.<span style=color:#50fa7b>isSynthetic</span>() <span style=color:#ff79c6>&amp;&amp;</span> hasInstantiationAwareBeanPostProcessors()) {
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>for</span> (BeanPostProcessor bp : getBeanPostProcessors()) {
</span></span><span style=display:flex><span>         <span style=color:#6272a4>// 这里会执行InstantiationAwareBeanPostProcessor的所有实现类</span>
</span></span><span style=display:flex><span>         <span style=color:#6272a4>// 如果postProcessAfterInstantiation()方法返回的是false，是不会继续填充属性的</span>
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>if</span> (bp <span style=color:#ff79c6>instanceof</span> InstantiationAwareBeanPostProcessor) {
</span></span><span style=display:flex><span>            InstantiationAwareBeanPostProcessor ibp <span style=color:#ff79c6>=</span> (InstantiationAwareBeanPostProcessor) bp;
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>ibp.<span style=color:#50fa7b>postProcessAfterInstantiation</span>(bw.<span style=color:#50fa7b>getWrappedInstance</span>(), beanName)) {
</span></span><span style=display:flex><span>               <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>         }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   PropertyValues pvs <span style=color:#ff79c6>=</span> (mbd.<span style=color:#50fa7b>hasPropertyValues</span>() <span style=color:#ff79c6>?</span> mbd.<span style=color:#50fa7b>getPropertyValues</span>() : <span style=color:#ff79c6>null</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#8be9fd>int</span> resolvedAutowireMode <span style=color:#ff79c6>=</span> mbd.<span style=color:#50fa7b>getResolvedAutowireMode</span>();
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>if</span> (resolvedAutowireMode <span style=color:#ff79c6>==</span> AUTOWIRE_BY_NAME <span style=color:#ff79c6>||</span> resolvedAutowireMode <span style=color:#ff79c6>==</span> AUTOWIRE_BY_TYPE) {
</span></span><span style=display:flex><span>      MutablePropertyValues newPvs <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> MutablePropertyValues(pvs);
</span></span><span style=display:flex><span>      <span style=color:#6272a4>// Add property values based on autowire by name if applicable.</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>if</span> (resolvedAutowireMode <span style=color:#ff79c6>==</span> AUTOWIRE_BY_NAME) {
</span></span><span style=display:flex><span>         autowireByName(beanName, mbd, bw, newPvs);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#6272a4>// Add property values based on autowire by type if applicable.</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>if</span> (resolvedAutowireMode <span style=color:#ff79c6>==</span> AUTOWIRE_BY_TYPE) {
</span></span><span style=display:flex><span>         autowireByType(beanName, mbd, bw, newPvs);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      pvs <span style=color:#ff79c6>=</span> newPvs;
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#8be9fd>boolean</span> hasInstAwareBpps <span style=color:#ff79c6>=</span> hasInstantiationAwareBeanPostProcessors();
</span></span><span style=display:flex><span>   <span style=color:#8be9fd>boolean</span> needsDepCheck <span style=color:#ff79c6>=</span> (mbd.<span style=color:#50fa7b>getDependencyCheck</span>() <span style=color:#ff79c6>!=</span> AbstractBeanDefinition.<span style=color:#50fa7b>DEPENDENCY_CHECK_NONE</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   PropertyDescriptor<span style=color:#ff79c6>[]</span> filteredPds <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>if</span> (hasInstAwareBpps) {
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>if</span> (pvs <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>         pvs <span style=color:#ff79c6>=</span> mbd.<span style=color:#50fa7b>getPropertyValues</span>();
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>for</span> (BeanPostProcessor bp : getBeanPostProcessors()) {
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>if</span> (bp <span style=color:#ff79c6>instanceof</span> InstantiationAwareBeanPostProcessor) {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 执行InstantiationAwareBeanPostProcessor的postProcessProperties()方法</span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// @Autowired和@Resource就是在这里处理的</span>
</span></span><span style=display:flex><span>            InstantiationAwareBeanPostProcessor ibp <span style=color:#ff79c6>=</span> (InstantiationAwareBeanPostProcessor) bp;
</span></span><span style=display:flex><span>            PropertyValues pvsToUse <span style=color:#ff79c6>=</span> ibp.<span style=color:#50fa7b>postProcessProperties</span>(pvs, bw.<span style=color:#50fa7b>getWrappedInstance</span>(), beanName);
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (pvsToUse <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>               <span style=color:#ff79c6>if</span> (filteredPds <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>                  filteredPds <span style=color:#ff79c6>=</span> filterPropertyDescriptorsForDependencyCheck(bw, mbd.<span style=color:#50fa7b>allowCaching</span>);
</span></span><span style=display:flex><span>               }
</span></span><span style=display:flex><span>               pvsToUse <span style=color:#ff79c6>=</span> ibp.<span style=color:#50fa7b>postProcessPropertyValues</span>(pvs, filteredPds, bw.<span style=color:#50fa7b>getWrappedInstance</span>(), beanName);
</span></span><span style=display:flex><span>               <span style=color:#ff79c6>if</span> (pvsToUse <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>                  <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span>               }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            pvs <span style=color:#ff79c6>=</span> pvsToUse;
</span></span><span style=display:flex><span>         }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>if</span> (needsDepCheck) {
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>if</span> (filteredPds <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>         filteredPds <span style=color:#ff79c6>=</span> filterPropertyDescriptorsForDependencyCheck(bw, mbd.<span style=color:#50fa7b>allowCaching</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      checkDependencies(beanName, mbd, filteredPds, pvs);
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>if</span> (pvs <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>      <span style=color:#6272a4>// 实现自动注入</span>
</span></span><span style=display:flex><span>      applyPropertyValues(beanName, mbd, bw, pvs);
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>回过头看初始化Bean的代码，这里主要是处理一些Aware接口、@PostConstruct注解或者方法，最后执行BeanPostProcessor的postProcessAfterInitialization()方法，AOP通过这个方法生成的代理：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>protected</span> Object <span style=color:#50fa7b>initializeBean</span>(String beanName, Object bean, @Nullable RootBeanDefinition mbd) {
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>if</span> (System.<span style=color:#50fa7b>getSecurityManager</span>() <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>      AccessController.<span style=color:#50fa7b>doPrivileged</span>((PrivilegedAction<span style=color:#ff79c6>&lt;</span>Object<span style=color:#ff79c6>&gt;</span>) () <span style=color:#ff79c6>-&gt;</span> {
</span></span><span style=display:flex><span>         invokeAwareMethods(beanName, bean);
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span>      }, getAccessControlContext());
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#6272a4>// 这里会判断这个Bean是否实现了Aware接口，然后执行里面的方法</span>
</span></span><span style=display:flex><span>      <span style=color:#6272a4>// 判断是否继承BeanNameAware、BeanClassLoaderAware、BeanFactoryAware</span>
</span></span><span style=display:flex><span>      invokeAwareMethods(beanName, bean);
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   Object wrappedBean <span style=color:#ff79c6>=</span> bean;
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>if</span> (mbd <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>||</span> <span style=color:#ff79c6>!</span>mbd.<span style=color:#50fa7b>isSynthetic</span>()) {
</span></span><span style=display:flex><span>      <span style=color:#6272a4>// 这里主要是处理一些生命周期的注解，比如@PostConstruct</span>
</span></span><span style=display:flex><span>      wrappedBean <span style=color:#ff79c6>=</span> applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName);
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#6272a4>// 这个和上面对应，他是处理方法的</span>
</span></span><span style=display:flex><span>      invokeInitMethods(beanName, wrappedBean, mbd);
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>catch</span> (Throwable ex) {
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> BeanCreationException(
</span></span><span style=display:flex><span>            (mbd <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>?</span> mbd.<span style=color:#50fa7b>getResourceDescription</span>() : <span style=color:#ff79c6>null</span>),
</span></span><span style=display:flex><span>            beanName, <span style=color:#f1fa8c>&#34;Invocation of init method failed&#34;</span>, ex);
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>if</span> (mbd <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>||</span> <span style=color:#ff79c6>!</span>mbd.<span style=color:#50fa7b>isSynthetic</span>()) {
</span></span><span style=display:flex><span>      <span style=color:#6272a4>// 这里执行postProcessAfterInitialization()方法</span>
</span></span><span style=display:flex><span>      <span style=color:#6272a4>// 大部分的BeanPostProcessors都没有实现这个方法</span>
</span></span><span style=display:flex><span>      wrappedBean <span style=color:#ff79c6>=</span> applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName);
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>return</span> wrappedBean;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>这里一个半成品的Bean就创建完了，但是还没有放进单例池中。</p><p>很少对Bean生命周期的前半部分扩展，很少在干扰Bean的初始化和干扰Bean的注入。大部分都是对BeanPostProcessor的postProcessorafterInitialization()方法进行扩展，比如AOP。</p><h5 id=3循环依赖>3.循环依赖<a hidden class=anchor aria-hidden=true href=#3循环依赖>#</a></h5><p>循环依赖就是A依赖B，B依赖A。<strong>Spring是不支持非单例Bean或者通过构造方法注入的循环依赖的</strong>。</p><p>当扫描完Bean开始实例化的时候，会去调用BeanFactory的getBean()方法然后再调用到doGetBean()方法，这个方法里会先尝试从第3级缓存获取Bean：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Object sharedInstance <span style=color:#ff79c6>=</span> getSingleton(beanName);
</span></span></code></pre></td></tr></table></div></div><p>假设现在是第一次获取Bean A，此时拿到的一定是null，然后回往下走到创建Bean A的分支，真正创建Bean A的代码是下面这段：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>sharedInstance <span style=color:#ff79c6>=</span> getSingleton(beanName, () <span style=color:#ff79c6>-&gt;</span> {
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#6272a4>// 开始创建</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>return</span> createBean(beanName, mbd, args);
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>catch</span> (BeansException ex) {
</span></span><span style=display:flex><span>      <span style=color:#6272a4>// Explicitly remove instance from singleton cache: It might have been put there</span>
</span></span><span style=display:flex><span>      <span style=color:#6272a4>// eagerly by the creation process, to allow for circular reference resolution.</span>
</span></span><span style=display:flex><span>      <span style=color:#6272a4>// Also remove any beans that received a temporary reference to the bean.</span>
</span></span><span style=display:flex><span>      destroySingleton(beanName);
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>throw</span> ex;
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>});
</span></span></code></pre></td></tr></table></div></div><p><strong>注意</strong>这里先调用的是getSingleton()方法，getSingleton()方法需要两个参数，bean名字和ObjectFactory对象，上面创建了一个新的ObjectFactory对象，然后重写了getObject()方法，在getObject()方法里调用的createBean()方法。</p><p>getSingleton()方法关键代码：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * DefaultSingletonBeanRegistry类
</span></span></span><span style=display:flex><span><span style=color:#6272a4> */</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> Object <span style=color:#50fa7b>getSingleton</span>(String beanName, ObjectFactory<span style=color:#ff79c6>&lt;?&gt;</span> singletonFactory) {
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>synchronized</span> (<span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>singletonObjects</span>) {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// this.singletonObjects就是单例池，我也把他叫做1级缓存</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 尝试从1级缓存中拿</span>
</span></span><span style=display:flex><span>        Object singletonObject <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>singletonObjects</span>.<span style=color:#50fa7b>get</span>(beanName);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (singletonObject <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>singletonsCurrentlyInDestruction</span>) {
</span></span><span style=display:flex><span>                <span style=color:#6272a4>// 正在被销毁就抛出异常</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 把这个Bean加到singletonsCurrentlyInCreation集合中</span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 标记为正在被创建的Bean</span>
</span></span><span style=display:flex><span>            beforeSingletonCreation(beanName);
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>                <span style=color:#6272a4>// 因为上面重写了getObject()方法，所以这里调用了上面的是createBean()方法</span>
</span></span><span style=display:flex><span>                singletonObject <span style=color:#ff79c6>=</span> singletonFactory.<span style=color:#50fa7b>getObject</span>();
</span></span><span style=display:flex><span>                newSingleton <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>true</span>;
</span></span><span style=display:flex><span>            } <span style=color:#ff79c6>finally</span> {
</span></span><span style=display:flex><span>                <span style=color:#6272a4>// 把Bean名字从singletonsCurrentlyInCreation集合里移出</span>
</span></span><span style=display:flex><span>                <span style=color:#6272a4>// 意思就是取消标记为正在被创建的Bean</span>
</span></span><span style=display:flex><span>                afterSingletonCreation(beanName);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (newSingleton) {
</span></span><span style=display:flex><span>                <span style=color:#6272a4>// 把实例化好的Bean放到单例池中</span>
</span></span><span style=display:flex><span>                <span style=color:#6272a4>// 就是删掉2、3级缓存，添加到1级缓存</span>
</span></span><span style=display:flex><span>                addSingleton(beanName, singletonObject);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> singletonObject;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>通过singletonFactory.getObject()一定会走到createBean()方法，然后再走到doCreateBean()方法，doCreateBean()方法的关键代码：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>protected</span> Object <span style=color:#50fa7b>doCreateBean</span>(String beanName, RootBeanDefinition mbd, @Nullable Object<span style=color:#ff79c6>[]</span> args)
</span></span><span style=display:flex><span>			<span style=color:#8be9fd;font-style:italic>throws</span> BeanCreationException {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (instanceWrapper <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 推断supplier、推断构造方法，创建对象</span>
</span></span><span style=display:flex><span>        instanceWrapper <span style=color:#ff79c6>=</span> createBeanInstance(beanName, mbd, args);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>synchronized</span> (mbd.<span style=color:#50fa7b>postProcessingLock</span>) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>mbd.<span style=color:#50fa7b>postProcessed</span>) {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 这里就会执行所有MergedBeanDefinitionPostProcessor的实现类</span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 比如AutowiredAnnotationBeanPostProcessor就会在这个时候找到所有@Autowired注解的属性或者方法缓存起来</span>
</span></span><span style=display:flex><span>            applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 单例并且正在创建</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>boolean</span> earlySingletonExposure <span style=color:#ff79c6>=</span> (mbd.<span style=color:#50fa7b>isSingleton</span>() <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>allowCircularReferences</span> <span style=color:#ff79c6>&amp;&amp;</span>
</span></span><span style=display:flex><span>                                      isSingletonCurrentlyInCreation(beanName));
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (earlySingletonExposure) {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 把Bean封装成ObjectFactory(BeanFactory)</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 添加到singletonFactories和registeredSingletons，从earlySingletonObjects移出</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 	Map&lt;String, ObjectFactory&lt;?&gt;&gt; singletonFactories</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 	Map&lt;String, Object&gt; earlySingletonObjects</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 	Set&lt;String&gt; registeredSingletons</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 这个是为了做循环依赖的支撑</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// getEarlyBeanReference()方法也会在循环依赖时，拿到ObjectFactory对象后调用</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// todo 为什么要缓存一个半成品的Bean？</span>
</span></span><span style=display:flex><span>        addSingletonFactory(beanName, () <span style=color:#ff79c6>-&gt;</span> getEarlyBeanReference(beanName, mbd, bean));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// Initialize the bean instance.</span>
</span></span><span style=display:flex><span>    Object exposedObject <span style=color:#ff79c6>=</span> bean;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 完成属性填充</span>
</span></span><span style=display:flex><span>        populateBean(beanName, mbd, instanceWrapper);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>	……
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>这里首先扫描需要注入的属性存起来，然后把A放到3级缓存里，接走到属性注入的代码，当发现需要注入Bean B时又会从getBean(B)开始走一样的步骤，当注入B的属性时，发现B又依赖了A，此时又走到了getBean(A)方法。
这个时候A的状态是正在被创建，并且A和B都在3级缓存里，这个时候getSingleton()方法的处理就不一样了：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>protected</span> Object <span style=color:#50fa7b>getSingleton</span>(String beanName, <span style=color:#8be9fd>boolean</span> allowEarlyReference) {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 从单例池里拿</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 这个map首先用到，暂且叫他1级缓存</span>
</span></span><span style=display:flex><span>    Object singletonObject <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>singletonObjects</span>.<span style=color:#50fa7b>get</span>(beanName);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 如果是空并且这个Bean正在创建</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (singletonObject <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> isSingletonCurrentlyInCreation(beanName)) {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 这个map第2个被用到，暂且叫他2级缓存</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 这里第一次也获取不到</span>
</span></span><span style=display:flex><span>        singletonObject <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>earlySingletonObjects</span>.<span style=color:#50fa7b>get</span>(beanName);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (singletonObject <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> allowEarlyReference) {
</span></span><span style=display:flex><span>            <span style=color:#8be9fd;font-style:italic>synchronized</span> (<span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>singletonObjects</span>) {
</span></span><span style=display:flex><span>                <span style=color:#6272a4>// Consistent creation of early reference within full singleton lock</span>
</span></span><span style=display:flex><span>                singletonObject <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>singletonObjects</span>.<span style=color:#50fa7b>get</span>(beanName);
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>if</span> (singletonObject <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>                    singletonObject <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>earlySingletonObjects</span>.<span style=color:#50fa7b>get</span>(beanName);
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>if</span> (singletonObject <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>                        <span style=color:#6272a4>// 这个map第3个被用到，暂且叫他3级缓存</span>
</span></span><span style=display:flex><span>                        <span style=color:#6272a4>// 这个缓存里存储的是ObjectFactory，为什么是ObjectFactory，而不是一个Bean，哪怕是半成品的Bean</span>
</span></span><span style=display:flex><span>                        <span style=color:#6272a4>// 如果我们对一个Bean进行了代理，同时这个Bean a和其他Bean b发生了循环依赖</span>
</span></span><span style=display:flex><span>                        <span style=color:#6272a4>// 创建Bean的时候肯定是创建a，创建到一半属性注入的时候发现需要b，创建b的时候又回过头去创建a</span>
</span></span><span style=display:flex><span>                        <span style=color:#6272a4>// 这个时候返回的就应该是a的代理了，因为此时虽然a还是个半成品，但是b马上就创建好了</span>
</span></span><span style=display:flex><span>                        <span style=color:#6272a4>// Spring并不知道b创建好了之后会不会马上去调用a</span>
</span></span><span style=display:flex><span>                        <span style=color:#6272a4>// 所以一些扩展的动作就比如AOP的代理需要在ObjectFactory的getObject()方法中实现</span>
</span></span><span style=display:flex><span>                        ObjectFactory<span style=color:#ff79c6>&lt;?&gt;</span> singletonFactory <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>singletonFactories</span>.<span style=color:#50fa7b>get</span>(beanName);
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>if</span> (singletonFactory <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>                            <span style=color:#6272a4>// 如果是循环依赖这里调用getObject()方法就会调用创建ObjectFactory的时候传进来的lambda表达式</span>
</span></span><span style=display:flex><span>                            singletonObject <span style=color:#ff79c6>=</span> singletonFactory.<span style=color:#50fa7b>getObject</span>();
</span></span><span style=display:flex><span>                            <span style=color:#6272a4>// 把这个Bean放到2级缓存</span>
</span></span><span style=display:flex><span>                            <span style=color:#6272a4>// todo 为什么要放到2级缓存</span>
</span></span><span style=display:flex><span>                            <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>earlySingletonObjects</span>.<span style=color:#50fa7b>put</span>(beanName, singletonObject);
</span></span><span style=display:flex><span>                            <span style=color:#6272a4>// 从3级缓存中删除</span>
</span></span><span style=display:flex><span>                            <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>singletonFactories</span>.<span style=color:#50fa7b>remove</span>(beanName);
</span></span><span style=display:flex><span>                        }
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> singletonObject;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>当从3级缓存中拿到A的ObjectFactory对象后还是会调用重写的getObject()方法，这个getObject()对应的是<strong>getEarlyBeanReference(beanName, mbd, bean)</strong>，这个方法非常关键，这个可以保证注入的A哪怕被AOP代理也不会出现问题，处理完A之后就会把A从3级缓存拿到2级缓存，然后B会从属性注入继续执行，B走完之后A也会继续属性注入。</p><p>可以调用**context.setAllowCircularReferences(false);**关闭循环依赖，但是需要在容器refresh()方法之前调用。</p><h5 id=4问题>4.问题<a hidden class=anchor aria-hidden=true href=#4问题>#</a></h5><h6 id=1怎么理解aop>1）怎么理解AOP<a hidden class=anchor aria-hidden=true href=#1怎么理解aop>#</a></h6><p>AOP是面向切面编程，在面向对象的过程中可能会衍生出一些横切性的问题，比如日志记录、事务的提交，面向切面就是把这些问题统一处理。Spring AOP通过扩展BeanPostProcessor的postProcessorafterInitialization()方法+cgLib/jdk代理实现了AOP。</p><h6 id=2怎么回答bean的生命周期>2）怎么回答Bean的生命周期<a hidden class=anchor aria-hidden=true href=#2怎么回答bean的生命周期>#</a></h6><p>Bean的生命周期我理解的是分成6个阶段：</p><ol><li>容器启动阶段：扫描、实例化BeanDefinition对象，然后把他存到beanDefinitionMap变量中，注册BeanPostProcessor以及验证BeanDefinition的合法性(因为有的对象是prototype的)；</li><li>Bean的实例化：推断实例化方式(supplier方式、静态工厂方法、构造方法等等)，利用这个推断出来的方式实例化对象；</li><li>属性注入：提前暴露半成品的Bean用来做循环依赖的支持，查找注入信息(找到@Autowired和@Resource)，判断是否关闭属性注入，如果没关闭就解析刚才查找的注解进行注入；</li><li>Bean的初始化：aware接口的回调比如BeanNameAware，各种初始化方法的回调，执行BeanPostProcessor的postProcessorafterInitialization()方法，这个也是对Bean生命周期扩展使用最多的一个方法，比如AOP；</li><li>Bean的缓存：删掉创建Bean产生的临时变量，把Bean放到单例池中；</li><li>Bean的销毁：回调销毁方法，移出单例池；</li></ol><h6 id=3循环依赖-1>3）循环依赖<a hidden class=anchor aria-hidden=true href=#3循环依赖-1>#</a></h6><p>先大概说一下Bean的生命周期，然后描述一下什么是循环依赖，然后再提到3级缓存怎么解决，以及为什么要有3级缓存。</p><h6 id=43级缓存>4）3级缓存<a hidden class=anchor aria-hidden=true href=#43级缓存>#</a></h6><p>3级缓存就是DefaultSingletonBeanRegistry里的3个map：</p><ol><li>Map&lt;String, Object> singletonObjects，这个也叫单例池，里面放的是完整的Bean，他是在getSingle()方法中最先被查找的，所以先叫他第1级缓存。</li><li>Map&lt;String, Object> earlySingletonObjects，这里面放的是半成品的Bean，他是在getSingle()方法中第2个被查找的，所以先叫他第2级缓存。</li><li>Map&lt;String, ObjectFactory> singletonFactories，这里放的是封装了半成品Bean的ObjectFactory对象，她最后被查找，所以先叫他第3级缓存，也是为了解决循环依赖。</li></ol><p>只有第3级缓存里放的是ObjectFactory对象，这是为了解决AOP对Bean进行了代理，此时发生循环依赖被注入时就应该是代理产生的类。</p><h6 id=5后置处理器操作bean的问题>5）后置处理器操作Bean的问题<a hidden class=anchor aria-hidden=true href=#5后置处理器操作bean的问题>#</a></h6><p>假设程序中有一个MyBean，然后我们创建了两个BeanPostProcessor，一个BeanPostProcessor中注入了MyBean：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>@Autowired
</span></span><span style=display:flex><span>MyBean myBean;
</span></span></code></pre></td></tr></table></div></div><p>另一个BeanPostProcessor中执行以下代码：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>@Override
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> Object <span style=color:#50fa7b>postProcessAfterInitialization</span>(Object bean, String beanName) <span style=color:#8be9fd;font-style:italic>throws</span> BeansException {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span>(beanName.<span style=color:#50fa7b>equals</span>(<span style=color:#f1fa8c>&#34;myBean&#34;</span>)) {
</span></span><span style=display:flex><span>        Class<span style=color:#ff79c6>&lt;?&gt;</span> aClass <span style=color:#ff79c6>=</span> bean.<span style=color:#50fa7b>getClass</span>();
</span></span><span style=display:flex><span>        Field<span style=color:#ff79c6>[]</span> fs <span style=color:#ff79c6>=</span> aClass.<span style=color:#50fa7b>getDeclaredFields</span>();
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>for</span> (Field f : fs) {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span>(f.<span style=color:#50fa7b>getName</span>().<span style=color:#50fa7b>equals</span>(<span style=color:#f1fa8c>&#34;str&#34;</span>)){
</span></span><span style=display:flex><span>                f.<span style=color:#50fa7b>setAccessible</span>(<span style=color:#ff79c6>true</span>);
</span></span><span style=display:flex><span>                f.<span style=color:#50fa7b>set</span>(bean,<span style=color:#f1fa8c>&#34;spring&#34;</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> bean;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 返回null停止执行其他后置处理器</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ul><li><p>在上面的代码中修改了MyBean里的str属性值，当我们在代码里打印MyBean的两个属性是全都是null，但是第一个BeanPostProcessor中注入的MyBean是有值的：</p><p>正常注入时没问题的，当Bean创建完成之后会遍历BeanFactory里的List&lt;BeanPostProcessor> beanPostProcessors变量，而我们上面声明的BeanPostProcessor还没有放到list里，当遍历第一个BeanPostProcessor时，发现需要注入MyBean，这个时候会先创建MyBean对象，MyBean创建完之后又会执行Bean的后置处理器，但是问题就来了，此时我们还有两个BeanPostProcessor没有创建完，所以创建MyBean的时候不会走我们自己创建的这两个BeanPostProcessor，所以第二个BeanPostProcessor中修改MyBean的属性会不生效。</p></li><li><p>如果把第一个BeanPostProcessor的注入去掉，第二个BeanPostProcessor中修改MyBean里的str属性值会生效，这个时候创建MyBean的时机变晚了，BeanPostProcessor已经全部被注册到了BeanFactory中的list里，这个时候就正常了。</p></li><li><p>如果第一个BeanPostProcessor实现了Ordered接口对注入没有影响，但是如果改成实现PriorityOrdered就注入不进去：</p><p>处理@Autowired和@Resource注解的BeanPostProcessor实现了PriorityOrdered接口，正常情况下我们自己BeanPostProcessor实例化的时候处理@Autowired和@Resource注解的BeanPostProcessor已经创建好了，所以可以正常注入，但是如果我们自己的BeanPostProcessor也实现了PriorityOrdered，那就保证不了实例化自己的BeanPostProcessor的时候处理@Autowired和@Resource注解的BeanPostProcessor是否已经创建好了。</p></li><li><p>还是第一个BeanPostProcessor实现了Ordered接口但是注入了一个需要被AOP的Bean，因为他返回了null，会导致停止执行其他的后置处理器，此时AOP的后置处理器在Order之后还没有执行，所以会导致AOP失效；如果第一个BeanPostProcessor实现了PriorityOrdered接口，就算他不返回null，AOP也会失效，AOP实现了Ordered接口，所以注入MyBean的时候处理AOP的BeanPostProcessor还没创建好。</p></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://wangxiaohong123.github.io/tags/spring-framework/>Spring-Framework</a></li></ul><nav class=paginav><a class=prev href=https://wangxiaohong123.github.io/posts/%E6%A1%86%E6%9E%B6/mq/rocketmq/4.%E6%B6%88%E6%81%AF%E8%8E%B7%E5%8F%96/><span class=title>« Prev</span><br><span>4.消息消费</span>
</a><a class=next href=https://wangxiaohong123.github.io/posts/%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/%E5%AE%89%E5%85%A8%E8%AE%A4%E8%AF%81/shiro/5.session%E5%8E%9F%E7%90%86/><span class=title>Next »</span><br><span>5.shiro-session原理</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share 5.Bean的实例化 on x" href="https://x.com/intent/tweet/?text=5.Bean%e7%9a%84%e5%ae%9e%e4%be%8b%e5%8c%96&amp;url=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fspring%2fframework%2f5.bean%25E7%259A%2584%25E5%25AE%259E%25E4%25BE%258B%25E5%258C%2596%2f&amp;hashtags=spring-framework"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 5.Bean的实例化 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fspring%2fframework%2f5.bean%25E7%259A%2584%25E5%25AE%259E%25E4%25BE%258B%25E5%258C%2596%2f&amp;title=5.Bean%e7%9a%84%e5%ae%9e%e4%be%8b%e5%8c%96&amp;summary=5.Bean%e7%9a%84%e5%ae%9e%e4%be%8b%e5%8c%96&amp;source=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fspring%2fframework%2f5.bean%25E7%259A%2584%25E5%25AE%259E%25E4%25BE%258B%25E5%258C%2596%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 5.Bean的实例化 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fspring%2fframework%2f5.bean%25E7%259A%2584%25E5%25AE%259E%25E4%25BE%258B%25E5%258C%2596%2f&title=5.Bean%e7%9a%84%e5%ae%9e%e4%be%8b%e5%8c%96"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 5.Bean的实例化 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fspring%2fframework%2f5.bean%25E7%259A%2584%25E5%25AE%259E%25E4%25BE%258B%25E5%258C%2596%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 5.Bean的实例化 on whatsapp" href="https://api.whatsapp.com/send?text=5.Bean%e7%9a%84%e5%ae%9e%e4%be%8b%e5%8c%96%20-%20https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fspring%2fframework%2f5.bean%25E7%259A%2584%25E5%25AE%259E%25E4%25BE%258B%25E5%258C%2596%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 5.Bean的实例化 on telegram" href="https://telegram.me/share/url?text=5.Bean%e7%9a%84%e5%ae%9e%e4%be%8b%e5%8c%96&amp;url=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fspring%2fframework%2f5.bean%25E7%259A%2584%25E5%25AE%259E%25E4%25BE%258B%25E5%258C%2596%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 5.Bean的实例化 on ycombinator" href="https://news.ycombinator.com/submitlink?t=5.Bean%e7%9a%84%e5%ae%9e%e4%be%8b%e5%8c%96&u=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fspring%2fframework%2f5.bean%25E7%259A%2584%25E5%25AE%259E%25E4%25BE%258B%25E5%258C%2596%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://wangxiaohong123.github.io/>王小红的笔记</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>