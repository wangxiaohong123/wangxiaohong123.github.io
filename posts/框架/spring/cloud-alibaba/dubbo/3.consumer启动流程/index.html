<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>3.dubbo-consumer启动源码 | 王小红的笔记</title><meta name=keywords content="源码"><meta name=description content='进到consumer的api的启动demo，首先创建的是一个ReferenceConfig。provider创建的是ServiceConfig。


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16


private static void runWithRefer() {
    // reference是要调用的实例
    // 为每个实例创建一个reference
    ReferenceConfig<DemoService> reference = new ReferenceConfig<>();
    // 配置注册地址、元数据地址和引用的服务接口
    reference.setApplication(new ApplicationConfig("dubbo-demo-api-consumer"));
    reference.setRegistry(new RegistryConfig("zookeeper://127.0.0.1:2181"));
    reference.setMetadataReportConfig(new MetadataReportConfig("zookeeper://127.0.0.1:2181"));
    reference.setInterface(DemoService.class);
    // 通过reference的get，拿到的推断是DemoService的动态代理
    // get结束后，consumer应该就启动完成了
    DemoService service = reference.get();
    // 调用代理的方法，就会实现和目标接口的建立连接、序列化、发送请求等等
    String message = service.sayHello("dubbo");
    System.out.println(message);
}


直接进到get()方法里：'><meta name=author content><link rel=canonical href=https://wangxiaohong123.github.io/posts/%E6%A1%86%E6%9E%B6/spring/cloud-alibaba/dubbo/3.consumer%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/><link crossorigin=anonymous href=/assets/css/stylesheet.08f7d74f0ada0f975d29ae436285b61ed7a719d05f350cb888d00341642995a2.css integrity="sha256-CPfXTwraD5ddKa5DYoW2HtenGdBfNQy4iNADQWQplaI=" rel="preload stylesheet" as=style><link rel=icon href=https://wangxiaohong123.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://wangxiaohong123.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://wangxiaohong123.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://wangxiaohong123.github.io/apple-touch-icon.png><link rel=mask-icon href=https://wangxiaohong123.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://wangxiaohong123.github.io/posts/%E6%A1%86%E6%9E%B6/spring/cloud-alibaba/dubbo/3.consumer%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://wangxiaohong123.github.io/posts/%E6%A1%86%E6%9E%B6/spring/cloud-alibaba/dubbo/3.consumer%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/"><meta property="og:site_name" content="王小红的笔记"><meta property="og:title" content="3.dubbo-consumer启动源码"><meta property="og:description" content='进到consumer的api的启动demo，首先创建的是一个ReferenceConfig。provider创建的是ServiceConfig。
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 private static void runWithRefer() { // reference是要调用的实例 // 为每个实例创建一个reference ReferenceConfig<DemoService> reference = new ReferenceConfig<>(); // 配置注册地址、元数据地址和引用的服务接口 reference.setApplication(new ApplicationConfig("dubbo-demo-api-consumer")); reference.setRegistry(new RegistryConfig("zookeeper://127.0.0.1:2181")); reference.setMetadataReportConfig(new MetadataReportConfig("zookeeper://127.0.0.1:2181")); reference.setInterface(DemoService.class); // 通过reference的get，拿到的推断是DemoService的动态代理 // get结束后，consumer应该就启动完成了 DemoService service = reference.get(); // 调用代理的方法，就会实现和目标接口的建立连接、序列化、发送请求等等 String message = service.sayHello("dubbo"); System.out.println(message); } 直接进到get()方法里：'><meta property="og:locale" content="zh-CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:tag" content="源码"><meta name=twitter:card content="summary"><meta name=twitter:title content="3.dubbo-consumer启动源码"><meta name=twitter:description content='进到consumer的api的启动demo，首先创建的是一个ReferenceConfig。provider创建的是ServiceConfig。


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16


private static void runWithRefer() {
    // reference是要调用的实例
    // 为每个实例创建一个reference
    ReferenceConfig<DemoService> reference = new ReferenceConfig<>();
    // 配置注册地址、元数据地址和引用的服务接口
    reference.setApplication(new ApplicationConfig("dubbo-demo-api-consumer"));
    reference.setRegistry(new RegistryConfig("zookeeper://127.0.0.1:2181"));
    reference.setMetadataReportConfig(new MetadataReportConfig("zookeeper://127.0.0.1:2181"));
    reference.setInterface(DemoService.class);
    // 通过reference的get，拿到的推断是DemoService的动态代理
    // get结束后，consumer应该就启动完成了
    DemoService service = reference.get();
    // 调用代理的方法，就会实现和目标接口的建立连接、序列化、发送请求等等
    String message = service.sayHello("dubbo");
    System.out.println(message);
}


直接进到get()方法里：'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://wangxiaohong123.github.io/posts/"},{"@type":"ListItem","position":2,"name":"3.dubbo-consumer启动源码","item":"https://wangxiaohong123.github.io/posts/%E6%A1%86%E6%9E%B6/spring/cloud-alibaba/dubbo/3.consumer%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"3.dubbo-consumer启动源码","name":"3.dubbo-consumer启动源码","description":"进到consumer的api的启动demo，首先创建的是一个ReferenceConfig。provider创建的是ServiceConfig。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 private static void runWithRefer() { // reference是要调用的实例 // 为每个实例创建一个reference ReferenceConfig\u0026lt;DemoService\u0026gt; reference = new ReferenceConfig\u0026lt;\u0026gt;(); // 配置注册地址、元数据地址和引用的服务接口 reference.setApplication(new ApplicationConfig(\u0026#34;dubbo-demo-api-consumer\u0026#34;)); reference.setRegistry(new RegistryConfig(\u0026#34;zookeeper://127.0.0.1:2181\u0026#34;)); reference.setMetadataReportConfig(new MetadataReportConfig(\u0026#34;zookeeper://127.0.0.1:2181\u0026#34;)); reference.setInterface(DemoService.class); // 通过reference的get，拿到的推断是DemoService的动态代理 // get结束后，consumer应该就启动完成了 DemoService service = reference.get(); // 调用代理的方法，就会实现和目标接口的建立连接、序列化、发送请求等等 String message = service.sayHello(\u0026#34;dubbo\u0026#34;); System.out.println(message); } 直接进到get()方法里：\n","keywords":["源码"],"articleBody":"进到consumer的api的启动demo，首先创建的是一个ReferenceConfig。provider创建的是ServiceConfig。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 private static void runWithRefer() { // reference是要调用的实例 // 为每个实例创建一个reference ReferenceConfig\u003cDemoService\u003e reference = new ReferenceConfig\u003c\u003e(); // 配置注册地址、元数据地址和引用的服务接口 reference.setApplication(new ApplicationConfig(\"dubbo-demo-api-consumer\")); reference.setRegistry(new RegistryConfig(\"zookeeper://127.0.0.1:2181\")); reference.setMetadataReportConfig(new MetadataReportConfig(\"zookeeper://127.0.0.1:2181\")); reference.setInterface(DemoService.class); // 通过reference的get，拿到的推断是DemoService的动态代理 // get结束后，consumer应该就启动完成了 DemoService service = reference.get(); // 调用代理的方法，就会实现和目标接口的建立连接、序列化、发送请求等等 String message = service.sayHello(\"dubbo\"); System.out.println(message); } 直接进到get()方法里：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 public T get() { if (destroyed) { throw new IllegalStateException(\"The invoker of ReferenceConfig(\"+url+\") has already destroyed!\"); } // 这个ref是一个全局对象，类型就是之前声明ReferenceConfig传进来的泛型 // 也就是要访问的五福 if (ref == null) { // 初始化ScopeModel，这个和之前provider的代码是一样的 getScopeModel().getDeployer().start(); synchronized (this) { if (ref == null) { init(); } } } return ref; } 继续走到init()方法：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 protected synchronized void init() { if (initialized) { return; } initialized = true; // 这里的refresh()包括下面的元数据中心、加载配置、注册repository的处理都和我们之前看的一样 if (!this.isRefreshed()) { this.refresh(); } initServiceMetadata(consumer); serviceMetadata.setServiceType(getServiceInterfaceClass()); serviceMetadata.setServiceKey(URL.buildKey(interfaceName, group, version)); Map\u003cString, String\u003e referenceParameters = appendConfig(); ModuleServiceRepository repository = getScopeModel().getServiceRepository(); ServiceDescriptor serviceDescriptor = repository.registerService(interfaceClass); consumerModel = new ConsumerModel(serviceMetadata.getServiceKey(), proxy, serviceDescriptor, this, getScopeModel(), serviceMetadata, createAsyncMethodInfo()); repository.registerConsumer(consumerModel); serviceMetadata.getAttachments().putAll(referenceParameters); // 这里就不一样了，也是核心，创建代理 ref = createProxy(referenceParameters); serviceMetadata.setTarget(ref); serviceMetadata.addAttribute(PROXY_CLASS_REF, ref); consumerModel.setProxyObject(ref); consumerModel.initMethodModels(); checkInvokerAvailable(); } createProxy()：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 private T createProxy(Map\u003cString, String\u003e referenceParameters) { // 是否是本地的服务 if (shouldJvmRefer(referenceParameters)) { createInvokerForLocal(referenceParameters); } else { urls.clear(); if (url != null \u0026\u0026 url.length() \u003e 0) { // user specified URL, could be peer-to-peer address, or register center's address. parseUrl(referenceParameters); } else { // if protocols not in jvm checkRegistry // 协议不在jvm的注册表 if (!LOCAL_PROTOCOL.equalsIgnoreCase(getProtocol())) { // 这个里就设置一些属性 aggregateUrlFromRegistry(referenceParameters); } } // 关键：为远程服务创建invoker createInvokerForRemote(); } URL consumerUrl = new ServiceConfigURL(CONSUMER_PROTOCOL, referenceParameters.get(REGISTER_IP_KEY), 0, referenceParameters.get(INTERFACE_KEY), referenceParameters); consumerUrl = consumerUrl.setScopeModel(getScopeModel()); consumerUrl = consumerUrl.setServiceModel(consumerModel); MetadataUtils.publishServiceDefinition(consumerUrl); // 关键：创建代理 return (T) proxyFactory.getProxy(invoker, ProtocolUtils.isGeneric(generic)); } 这个方法最开始就是一些判断处理什么的，如果是远程的话一定会走这个方法createInvokerForRemote();这里创建了一个invoker，是全局的，然后下面就是一些设置属性什么的先不管，最下面是根据刚才创建的invoker创建代理，这两步是最关键的，先看创建invoker的代码:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 private void createInvokerForRemote() { if (urls.size() == 1) { URL curUrl = urls.get(0); // 又使用了protocolSPI，但是这里调用的是refer方法 // 拿到的involer的类型是MigrationInvoker // 内部有很多组件，其中有一个就是ClusterInvoker类型的invoker // 只能把protocol的实现类都看一遍，推测还是使用RegistryProtocol创建的invoker invoker = protocolSPI.refer(interfaceClass,curUrl); if (!UrlUtils.isRegistry(curUrl)){ List\u003cInvoker\u003c?\u003e\u003e invokers = new ArrayList\u003c\u003e(); invokers.add(invoker); invoker = Cluster.getCluster(scopeModel, Cluster.DEFAULT).join(new StaticDirectory(curUrl, invokers), true); } } else { List\u003cInvoker\u003c?\u003e\u003e invokers = new ArrayList\u003c\u003e(); URL registryUrl = null; for (URL url : urls) { // For multi-registry scenarios, it is not checked whether each referInvoker is available. // Because this invoker may become available later. invokers.add(protocolSPI.refer(interfaceClass, url)); if (UrlUtils.isRegistry(url)) { // use last registry url registryUrl = url; } } if (registryUrl != null) { // registry url is available // for multi-subscription scenario, use 'zone-aware' policy by default String cluster = registryUrl.getParameter(CLUSTER_KEY, ZoneAwareCluster.NAME); // The invoker wrap sequence would be: ZoneAwareClusterInvoker(StaticDirectory) -\u003e FailoverClusterInvoker // (RegistryDirectory, routing happens here) -\u003e Invoker invoker = Cluster.getCluster(registryUrl.getScopeModel(), cluster, false).join(new StaticDirectory(registryUrl, invokers), false); } else { // not a registry url, must be direct invoke. if (CollectionUtils.isEmpty(invokers)) { throw new IllegalArgumentException(\"invokers == null\"); } URL curUrl = invokers.get(0).getUrl(); String cluster = curUrl.getParameter(CLUSTER_KEY, Cluster.DEFAULT); invoker = Cluster.getCluster(scopeModel, cluster).join(new StaticDirectory(curUrl, invokers), true); } } } 断点进来走的是第一个if分支，也就是urls的size是1，先按照1看，这里生成的invoker是MigrationInvoker，里面有一个很重要的成员是MockClusterInvoker，通过RegistryProtocol生成的invoker：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 public \u003cT\u003e Invoker\u003cT\u003e refer(Class\u003cT\u003e type, URL url) throws RpcException { url = getRegistryUrl(url); // 推测是注册zk组件 Registry registry = getRegistry(url); if (RegistryService.class.equals(type)) { return proxyFactory.getInvoker((T) registry, type, url); } // group=\"a,b\" or group=\"*\" Map\u003cString, String\u003e qs = (Map\u003cString, String\u003e) url.getAttribute(REFER_KEY); String group = qs.get(GROUP_KEY); if (group != null \u0026\u0026 group.length() \u003e 0) { if ((COMMA_SPLIT_PATTERN.split(group)).length \u003e 1 || \"*\".equals(group)) { return doRefer(Cluster.getCluster(url.getScopeModel(), MergeableCluster.NAME), registry, type, url, qs); } } // 拿到的是failoverCLuster，集群故障转移组件 Cluster cluster = Cluster.getCluster(url.getScopeModel(), qs.get(CLUSTER_KEY)); return doRefer(cluster, registry, type, url, qs); } doRefer()方法：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 protected \u003cT\u003e Invoker\u003cT\u003e doRefer(Cluster cluster, Registry registry, Class\u003cT\u003e type, URL url, Map\u003cString, String\u003e parameters) { Map\u003cString, Object\u003e consumerAttribute = new HashMap\u003c\u003e(url.getAttributes()); consumerAttribute.remove(REFER_KEY); URL consumerUrl = new ServiceConfigURL(parameters.get(PROTOCOL_KEY) == null ? DUBBO : parameters.get(PROTOCOL_KEY), null, null, parameters.get(REGISTER_IP_KEY), 0, getPath(parameters, type), parameters, consumerAttribute); url = url.putAttribute(CONSUMER_URL_KEY, consumerUrl); // getMigrationInvoker()方法就在下面 // 用刚才创建的failoverCLuster实例化一个ServiceDiscoveryMigrationInvoker ClusterInvoker\u003cT\u003e migrationInvoker = getMigrationInvoker(this, cluster, registry, type, url, consumerUrl); return interceptInvoker(migrationInvoker, url, consumerUrl, url); } protected \u003cT\u003e ClusterInvoker\u003cT\u003e getMigrationInvoker(RegistryProtocol registryProtocol, Cluster cluster, Registry registry, Class\u003cT\u003e type, URL url, URL consumerUrl) { return new ServiceDiscoveryMigrationInvoker\u003cT\u003e(registryProtocol, cluster, registry, type, url, consumerUrl); } interceptInvoker()方法里拿到了监听器，然后调用监听器的onRefer()方法，这里拿到的监听器就是MigrationRuleListener，MigrationRuleListener里的onRefer()方法先根据传进来的invoker拿到MigrationRuleHandler实例，然后调用实例的doMigrate()方法，这个方法里有一行代码很关键：\n1 2 3 4 if (refreshInvoker(step, threshold, rule)) { // 刷新成功之后更新规则 setMigrationRule(rule); } 进到refreshInvoker()方法中里面是一个switch case分支，根据传进来的step（MigrationStep）直接走到APPLICATION_FIRST分支，这个分支执行migrationInvoker.migrateToApplicationFirstInvoker(newRule)方法，而migrationInvoker是我们在上面的getMigrationInvoker中直接实例化的ServiceDiscoveryMigrationInvoker：\n1 2 3 4 5 6 7 8 9 10 public void migrateToApplicationFirstInvoker(MigrationRule newRule) { CountDownLatch latch = new CountDownLatch(0); // 这个方法生成MockClusterInvoker refreshInterfaceInvoker(latch); refreshServiceDiscoveryInvoker(latch); // 上面创建了两个invoker，这里就是判断那个invoker是最优的，然后就会把另一个放到备用里 // 根据什么判断的呢，以后再看 calcPreferredInvoker(newRule); } 先看refreshInterfaceInvoker()方法，这个方法里又调回了RegistryProtocol的getInvoker()方法：\n1 invoker = registryProtocol.getInvoker(cluster, registry, type, url); 在getInvoker()方法中先是用url创建一个DynamicDirectory实例（RegistryDirectory类型），然后调用doCreateInvoker()方法：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 protected \u003cT\u003e ClusterInvoker\u003cT\u003e doCreateInvoker(DynamicDirectory\u003cT\u003e directory, Cluster cluster, Registry registry, Class\u003cT\u003e type) { // 设置注册中心、protocol directory.setRegistry(registry); directory.setProtocol(protocol); // 这个parameters里面是ip、端口、协议之类的 Map\u003cString, String\u003e parameters = new HashMap\u003c\u003e(directory.getConsumerUrl().getParameters()); // 构造一个新的URL URL urlToRegistry = new ServiceConfigURL( parameters.get(PROTOCOL_KEY) == null ? DUBBO : parameters.get(PROTOCOL_KEY), parameters.remove(REGISTER_IP_KEY), 0, getPath(parameters, type), parameters); urlToRegistry = urlToRegistry.setScopeModel(directory.getConsumerUrl().getScopeModel()); urlToRegistry = urlToRegistry.setServiceModel(directory.getConsumerUrl().getServiceModel()); if (directory.isShouldRegister()) { directory.setRegisteredConsumerUrl(urlToRegistry); // 这里就是往zk上注册 registry.register(directory.getRegisteredConsumerUrl()); } directory.buildRouterChain(urlToRegistry); // 这里非常重要，这里面有获取服务实例信息的代码 directory.subscribe(toSubscribeUrl(urlToRegistry)); // 这里会调用MockClusterWrapper的join方法，把directory封装到MockClusterInvoker里返回 return (ClusterInvoker\u003cT\u003e) cluster.join(directory, true); } registry.subscribe(url, this);方法经过ListenerRegistryWrapper-\u003eFailbackRegistry-\u003eZookeeperRegistry，最终走到了注册zk的方法ZookeeperRegistry的doSubscribe()：\n1 2 3 4 5 6 7 8 9 // 创建节点 zkClient.create(path, false); // 对子节点监听 List\u003cString\u003e children = zkClient.addChildListener(path, zkListener); if (children != null) { urls.addAll(toUrlsWithEmpty(url, path, children)); } // 这里应该就是对每个实例的客户端建立netty连接 notify(url, listener, urls); 跟着notify走到了RegistryDirectory的notify()方法，然后最后一行有一个refreshOverrideAndInvoker()方法，refreshOverrideAndInvoker()方法里又调用了refreshInvoker()方法，refreshInvoker()方法里有一行很关键：\n1 2 // Translate url list to Invoker map Map\u003cURL, Invoker\u003cT\u003e\u003e newUrlInvokerMap = toInvokers(oldUrlInvokerMap, invokerUrls); 在toInvokers中调用了**protocol.refer(serviceType, url);**方法，进到DubboProtocol的refer()方法里，方法里又调用了protocolBindingRefer()方法，在这个方法里构造了一个invoker：\n1 DubboInvoker\u003cT\u003e invoker = new DubboInvoker\u003cT\u003e(serviceType, url, getClients(url), invokers); 构造DubboInvoker之前先调用了getClient()方法，断点进到DubboInvoker的构造方法里发现连接已经建立完了，所以建立连接的代码就应该在getClients(url)方法里，这个方法里创建了一个关键的元素：List shareClients，他是通过getSharedClient(url, connections)方法创建的，然后一直跟，跟到了buildReferenceCountExchangeClientList()方法，又跟到了buildReferenceCountExchangeClient()方法，在这个方法里看到了像核心代码的东西：initClient(url)\n1 2 // 发起请求 client = Exchangers.connect(url, requestHandler); 代码里的核心就是这个，Exchangers一看就是网络通信的组件，然后继续往下跟，跟到了HeaderExchanger，又跟到了Transporters又跟到了netty4的NettyTransporter，找到了一行代码：\n1 return new NettyClient(url, handler); 点击去又跟到了父类AbstractClient中，在父类的构造方法里主要就是干了两件事，doOpen();和connect();doOpen和connect都是在NettyClient中实现的，先看doOpen：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 protected void doOpen() throws Throwable { // 处理网络请求的handler final NettyClientHandler nettyClientHandler = new NettyClientHandler(getUrl(), this); bootstrap = new Bootstrap(); // 设置group以及一些参数 bootstrap.group(EVENT_LOOP_GROUP.get()) .option(ChannelOption.SO_KEEPALIVE, true) .option(ChannelOption.TCP_NODELAY, true) .option(ChannelOption.ALLOCATOR, PooledByteBufAllocator.DEFAULT) //.option(ChannelOption.CONNECT_TIMEOUT_MILLIS, getTimeout()) .channel(socketChannelClass()); bootstrap.option(ChannelOption.CONNECT_TIMEOUT_MILLIS, Math.max(DEFAULT_CONNECT_TIMEOUT, getConnectTimeout())); // 处理逻辑、编解码啥的 bootstrap.handler(new ChannelInitializer\u003cSocketChannel\u003e() { @Override protected void initChannel(SocketChannel ch) throws Exception { int heartbeatInterval = UrlUtils.getHeartbeat(getUrl()); if (getUrl().getParameter(SSL_ENABLED_KEY, false)) { ch.pipeline().addLast(\"negotiation\", new SslClientTlsHandler(getUrl())); } NettyCodecAdapter adapter = new NettyCodecAdapter(getCodec(), getUrl(), NettyClient.this); ch.pipeline()//.addLast(\"logging\",new LoggingHandler(LogLevel.INFO))//for debug .addLast(\"decoder\", adapter.getDecoder()) .addLast(\"encoder\", adapter.getEncoder()) .addLast(\"client-idle-handler\", new IdleStateHandler(heartbeatInterval, 0, 0, MILLISECONDS)) .addLast(\"handler\", nettyClientHandler); String socksProxyHost = ConfigurationUtils.getProperty(getUrl().getOrDefaultApplicationModel(), SOCKS_PROXY_HOST); if(socksProxyHost != null \u0026\u0026 !isFilteredAddress(getUrl().getHost())) { int socksProxyPort = Integer.parseInt(ConfigurationUtils.getProperty(getUrl().getOrDefaultApplicationModel(), SOCKS_PROXY_PORT, DEFAULT_SOCKS_PROXY_PORT)); Socks5ProxyHandler socks5ProxyHandler = new Socks5ProxyHandler(new InetSocketAddress(socksProxyHost, socksProxyPort)); ch.pipeline().addFirst(socks5ProxyHandler); } } }); } connect()走的是子类的doConnect()方法：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 protected void doConnect() throws Throwable { long start = System.currentTimeMillis(); // 发起了连接，但是连接并不是同步建立的 // 需要拿到一个futrue // 在下面需要判断连接建立的状态 ChannelFutrue futrue = bootstrap.connect(getConnectAddress()); try { boolean ret = futrue.awaitUninterruptibly(getConnectTimeout(), MILLISECONDS); if (ret \u0026\u0026 futrue.isSuccess()) { Channel newChannel = futrue.channel(); try { // Close old channel // copy reference Channel oldChannel = NettyClient.this.channel; if (oldChannel != null) { try { oldChannel.close(); } finally { NettyChannel.removeChannelIfDisconnected(oldChannel); } } } finally { if (NettyClient.this.isClosed()) { try { newChannel.close(); } finally { NettyClient.this.channel = null; NettyChannel.removeChannelIfDisconnected(newChannel); } } else { NettyClient.this.channel = newChannel; } } } else if (futrue.cause() != null) { throw new RemotingException(this, \"client(url: \" + getUrl() + \") failed to connect to server \" + getRemoteAddress() + \", error message is:\" + futrue.cause().getMessage(), futrue.cause()); } else { throw new RemotingException(this, \"client(url: \" + getUrl() + \") failed to connect to server \" + getRemoteAddress() + \" client-side timeout \" + getConnectTimeout() + \"ms (elapsed: \" + (System.currentTimeMillis() - start) + \"ms) from netty client \" + NetUtils.getLocalHost() + \" using dubbo version \" + Version.getVersion()); } } finally { // just add new valid channel to NettyChannel's cache if (!isConnected()) { //futrue.cancel(true); } } } 然后netty就建立完了。\ncluster.join(directory, true)调用的是\n1 new MockClusterInvoker\u003cT\u003e(directory, this.cluster.join(directory, buildFilterChain)) 除了directory还需要一个invoker，使用cluster.join()根据directory成成invoker，cluster.join()走到了AbstractCluster里，接着又调用了dojoin()方法生成FailoverClusterInvoker实例，所以这个时候MockClusterInvoker实例中有两个属性，一个是DynamicDirectory，一个是FailoverClusterInvoker。\n回到migrateToApplicationFirstInvoker()方法，继续走到refreshServiceDiscoveryInvoker(latch);方法，和上面一样，只不过创建的DynamicDirectory是ServiceDiscoveryRegistryDirectory类型，然后也没有走注册分支。\n到这里ReferenceConfig的createProxy()方法中的createInvokerForRemote()就执行完了，继续往下看根据invoker创建动态代理的代码：\n1 proxyFactory.getProxy(invoker, ProtocolUtils.isGeneric(generic)); 这个代码走到了StubProxyFactoryWrapper方法中，进到这个方法里的第一行又是一个proxyFactory.getProxy()，这里的proxyFactory变成了AbstractProxyFactory：\n1 2 3 4 5 6 7 8 /** * StubProxyFactoryWrapper */ public \u003cT\u003e T getProxy(Invoker\u003cT\u003e invoker, boolean generic) throws RpcException { // 这里的proxyFactory是AbstractProxyFactory T proxy = proxyFactory.getProxy(invoker, generic); // 剩下的是对GenericService的处理，先不看 } AbstractProxyFactory的getProxy首先拿到了url里的所有接口对应的class，然后调用子类的getProxy()方法生成代理:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 public \u003cT\u003e T getProxy(Invoker\u003cT\u003e invoker, boolean generic) throws RpcException { // when compiling with native image, ensure that the order of the interfaces remains unchanged LinkedHashSet\u003cClass\u003c?\u003e\u003e interfaces = new LinkedHashSet\u003c\u003e(); String config = invoker.getUrl().getParameter(INTERFACES); if (StringUtils.isNotEmpty(config)) { // 逗号分割 String[] types = COMMA_SPLIT_PATTERN.split(config); for (String type : types) { try { ClassLoader classLoader = getClassLoader(invoker); // 这个就是对基础类/包装类的处理 interfaces.add(ReflectUtils.forName(classLoader, type)); } catch (Throwable e) { // ignore } } } if (generic) { try { // 通过反射拿到真正要代理的class String realInterface = invoker.getUrl().getParameter(Constants.INTERFACE); ClassLoader classLoader = getClassLoader(invoker); interfaces.add(ReflectUtils.forName(classLoader, realInterface)); } catch (Throwable e) { // ignore } if (GenericService.class.equals(invoker.getInterface()) || !GenericService.class.isAssignableFrom(invoker.getInterface())) { interfaces.add(com.alibaba.dubbo.rpc.service.GenericService.class); } } interfaces.add(invoker.getInterface()); interfaces.addAll(Arrays.asList(INTERNAL_INTERFACES)); // 这个就很关键了 // 走到了JavassistProxyFactory return getProxy(invoker, interfaces.toArray(new Class\u003c?\u003e[0])); } JavassistProxyFactory里面就一句话：\n1 2 3 4 public \u003cT\u003e T getProxy(Invoker\u003cT\u003e invoker, Class\u003c?\u003e[] interfaces) { // Proxy是dubbo自己实现的 return (T) Proxy.getProxy(interfaces).newInstance(new InvokerInvocationHandler(invoker)); } 到这里动态代理就创建完了，然后回到ReferenceConfig的init()方法，继续往下走，走到了checkInvokerAvailable()方法，这个方法是检查刚才创建的代理有没有效，就是调用involer的isAvailable方法，不写了，到这里创建动态代理的方法就结束了，回到demo里，这时候调用了一下provider的demo的方法，一定会走到invokerInvocationHandler的invoker里去\n","wordCount":"1602","inLanguage":"en","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://wangxiaohong123.github.io/posts/%E6%A1%86%E6%9E%B6/spring/cloud-alibaba/dubbo/3.consumer%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/"},"publisher":{"@type":"Organization","name":"王小红的笔记","logo":{"@type":"ImageObject","url":"https://wangxiaohong123.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wangxiaohong123.github.io/ accesskey=h title="王小红的笔记 (Alt + H)">王小红的笔记</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://wangxiaohong123.github.io/posts/ title=笔记><span>笔记</span></a></li><li><a href=https://wangxiaohong123.github.io/categories/ title=分类><span>分类</span></a></li><li><a href=https://wangxiaohong123.github.io/tags/ title=标签><span>标签</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">3.dubbo-consumer启动源码</h1><div class=post-meta>8 min</div></header><div class=post-content><p>进到consumer的api的启动demo，首先创建的是一个ReferenceConfig。provider创建的是ServiceConfig。</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>runWithRefer</span>() {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// reference是要调用的实例</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 为每个实例创建一个reference</span>
</span></span><span style=display:flex><span>    ReferenceConfig<span style=color:#ff79c6>&lt;</span>DemoService<span style=color:#ff79c6>&gt;</span> reference <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ReferenceConfig<span style=color:#ff79c6>&lt;&gt;</span>();
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 配置注册地址、元数据地址和引用的服务接口</span>
</span></span><span style=display:flex><span>    reference.<span style=color:#50fa7b>setApplication</span>(<span style=color:#ff79c6>new</span> ApplicationConfig(<span style=color:#f1fa8c>&#34;dubbo-demo-api-consumer&#34;</span>));
</span></span><span style=display:flex><span>    reference.<span style=color:#50fa7b>setRegistry</span>(<span style=color:#ff79c6>new</span> RegistryConfig(<span style=color:#f1fa8c>&#34;zookeeper://127.0.0.1:2181&#34;</span>));
</span></span><span style=display:flex><span>    reference.<span style=color:#50fa7b>setMetadataReportConfig</span>(<span style=color:#ff79c6>new</span> MetadataReportConfig(<span style=color:#f1fa8c>&#34;zookeeper://127.0.0.1:2181&#34;</span>));
</span></span><span style=display:flex><span>    reference.<span style=color:#50fa7b>setInterface</span>(DemoService.<span style=color:#50fa7b>class</span>);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 通过reference的get，拿到的推断是DemoService的动态代理</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// get结束后，consumer应该就启动完成了</span>
</span></span><span style=display:flex><span>    DemoService service <span style=color:#ff79c6>=</span> reference.<span style=color:#50fa7b>get</span>();
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 调用代理的方法，就会实现和目标接口的建立连接、序列化、发送请求等等</span>
</span></span><span style=display:flex><span>    String message <span style=color:#ff79c6>=</span> service.<span style=color:#50fa7b>sayHello</span>(<span style=color:#f1fa8c>&#34;dubbo&#34;</span>);
</span></span><span style=display:flex><span>    System.<span style=color:#50fa7b>out</span>.<span style=color:#50fa7b>println</span>(message);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>直接进到get()方法里：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> T <span style=color:#50fa7b>get</span>() {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (destroyed) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> IllegalStateException(<span style=color:#f1fa8c>&#34;The invoker of ReferenceConfig(&#34;</span><span style=color:#ff79c6>+</span>url<span style=color:#ff79c6>+</span><span style=color:#f1fa8c>&#34;) has already destroyed!&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// 这个ref是一个全局对象，类型就是之前声明ReferenceConfig&lt;DemoService&gt;传进来的泛型</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 也就是要访问的五福</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (ref <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 初始化ScopeModel，这个和之前provider的代码是一样的</span>
</span></span><span style=display:flex><span>        getScopeModel().<span style=color:#50fa7b>getDeployer</span>().<span style=color:#50fa7b>start</span>();
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>synchronized</span> (<span style=color:#ff79c6>this</span>) {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (ref <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>                init();
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> ref;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>继续走到init()方法：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>protected</span> <span style=color:#8be9fd;font-style:italic>synchronized</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>init</span>() {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (initialized) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    initialized <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>true</span>;
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// 这里的refresh()包括下面的元数据中心、加载配置、注册repository的处理都和我们之前看的一样</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span><span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>isRefreshed</span>()) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>refresh</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    initServiceMetadata(consumer);
</span></span><span style=display:flex><span>    serviceMetadata.<span style=color:#50fa7b>setServiceType</span>(getServiceInterfaceClass());
</span></span><span style=display:flex><span>    serviceMetadata.<span style=color:#50fa7b>setServiceKey</span>(URL.<span style=color:#50fa7b>buildKey</span>(interfaceName, group, version));
</span></span><span style=display:flex><span>    Map<span style=color:#ff79c6>&lt;</span>String, String<span style=color:#ff79c6>&gt;</span> referenceParameters <span style=color:#ff79c6>=</span> appendConfig();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ModuleServiceRepository repository <span style=color:#ff79c6>=</span> getScopeModel().<span style=color:#50fa7b>getServiceRepository</span>();
</span></span><span style=display:flex><span>    ServiceDescriptor serviceDescriptor <span style=color:#ff79c6>=</span> repository.<span style=color:#50fa7b>registerService</span>(interfaceClass);
</span></span><span style=display:flex><span>    consumerModel <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ConsumerModel(serviceMetadata.<span style=color:#50fa7b>getServiceKey</span>(), proxy, serviceDescriptor, <span style=color:#ff79c6>this</span>,
</span></span><span style=display:flex><span>                                      getScopeModel(), serviceMetadata, createAsyncMethodInfo());
</span></span><span style=display:flex><span>    repository.<span style=color:#50fa7b>registerConsumer</span>(consumerModel);
</span></span><span style=display:flex><span>    serviceMetadata.<span style=color:#50fa7b>getAttachments</span>().<span style=color:#50fa7b>putAll</span>(referenceParameters);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 这里就不一样了，也是核心，创建代理</span>
</span></span><span style=display:flex><span>    ref <span style=color:#ff79c6>=</span> createProxy(referenceParameters);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    serviceMetadata.<span style=color:#50fa7b>setTarget</span>(ref);
</span></span><span style=display:flex><span>    serviceMetadata.<span style=color:#50fa7b>addAttribute</span>(PROXY_CLASS_REF, ref);
</span></span><span style=display:flex><span>    consumerModel.<span style=color:#50fa7b>setProxyObject</span>(ref);
</span></span><span style=display:flex><span>    consumerModel.<span style=color:#50fa7b>initMethodModels</span>();
</span></span><span style=display:flex><span>    checkInvokerAvailable();
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>createProxy()：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>private</span> T <span style=color:#50fa7b>createProxy</span>(Map<span style=color:#ff79c6>&lt;</span>String, String<span style=color:#ff79c6>&gt;</span> referenceParameters) {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 是否是本地的服务</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (shouldJvmRefer(referenceParameters)) {
</span></span><span style=display:flex><span>        createInvokerForLocal(referenceParameters);
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>        urls.<span style=color:#50fa7b>clear</span>();
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (url <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> url.<span style=color:#50fa7b>length</span>() <span style=color:#ff79c6>&gt;</span> 0) {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// user specified URL, could be peer-to-peer address, or register center&#39;s address.</span>
</span></span><span style=display:flex><span>            parseUrl(referenceParameters);
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// if protocols not in jvm checkRegistry</span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 协议不在jvm的注册表</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>LOCAL_PROTOCOL.<span style=color:#50fa7b>equalsIgnoreCase</span>(getProtocol())) {
</span></span><span style=display:flex><span>                <span style=color:#6272a4>// 这个里就设置一些属性</span>
</span></span><span style=display:flex><span>                aggregateUrlFromRegistry(referenceParameters);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 关键：为远程服务创建invoker</span>
</span></span><span style=display:flex><span>        createInvokerForRemote();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    URL consumerUrl <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ServiceConfigURL(CONSUMER_PROTOCOL, referenceParameters.<span style=color:#50fa7b>get</span>(REGISTER_IP_KEY), 0,
</span></span><span style=display:flex><span>                                           referenceParameters.<span style=color:#50fa7b>get</span>(INTERFACE_KEY), referenceParameters);
</span></span><span style=display:flex><span>    consumerUrl <span style=color:#ff79c6>=</span> consumerUrl.<span style=color:#50fa7b>setScopeModel</span>(getScopeModel());
</span></span><span style=display:flex><span>    consumerUrl <span style=color:#ff79c6>=</span> consumerUrl.<span style=color:#50fa7b>setServiceModel</span>(consumerModel);
</span></span><span style=display:flex><span>    MetadataUtils.<span style=color:#50fa7b>publishServiceDefinition</span>(consumerUrl);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 关键：创建代理</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> (T) proxyFactory.<span style=color:#50fa7b>getProxy</span>(invoker, ProtocolUtils.<span style=color:#50fa7b>isGeneric</span>(generic));
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>这个方法最开始就是一些判断处理什么的，如果是远程的话一定会走这个方法createInvokerForRemote();这里创建了一个invoker，是全局的，然后下面就是一些设置属性什么的先不管，最下面是根据刚才创建的invoker创建代理，这两步是最关键的，先看创建invoker的代码:</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>createInvokerForRemote</span>() {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (urls.<span style=color:#50fa7b>size</span>() <span style=color:#ff79c6>==</span> 1) {
</span></span><span style=display:flex><span>        URL curUrl <span style=color:#ff79c6>=</span> urls.<span style=color:#50fa7b>get</span>(0);
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 又使用了protocolSPI，但是这里调用的是refer方法</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 拿到的involer的类型是MigrationInvoker</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 内部有很多组件，其中有一个就是ClusterInvoker类型的invoker</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 只能把protocol的实现类都看一遍，推测还是使用RegistryProtocol创建的invoker</span>
</span></span><span style=display:flex><span>        invoker <span style=color:#ff79c6>=</span> protocolSPI.<span style=color:#50fa7b>refer</span>(interfaceClass,curUrl);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>UrlUtils.<span style=color:#50fa7b>isRegistry</span>(curUrl)){
</span></span><span style=display:flex><span>            List<span style=color:#ff79c6>&lt;</span>Invoker<span style=color:#ff79c6>&lt;?&gt;&gt;</span> invokers <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ArrayList<span style=color:#ff79c6>&lt;&gt;</span>();
</span></span><span style=display:flex><span>            invokers.<span style=color:#50fa7b>add</span>(invoker);
</span></span><span style=display:flex><span>            invoker <span style=color:#ff79c6>=</span> Cluster.<span style=color:#50fa7b>getCluster</span>(scopeModel, Cluster.<span style=color:#50fa7b>DEFAULT</span>).<span style=color:#50fa7b>join</span>(<span style=color:#ff79c6>new</span> StaticDirectory(curUrl, invokers), <span style=color:#ff79c6>true</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>        List<span style=color:#ff79c6>&lt;</span>Invoker<span style=color:#ff79c6>&lt;?&gt;&gt;</span> invokers <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ArrayList<span style=color:#ff79c6>&lt;&gt;</span>();
</span></span><span style=display:flex><span>        URL registryUrl <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>for</span> (URL url : urls) {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// For multi-registry scenarios, it is not checked whether each referInvoker is available.</span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// Because this invoker may become available later.</span>
</span></span><span style=display:flex><span>            invokers.<span style=color:#50fa7b>add</span>(protocolSPI.<span style=color:#50fa7b>refer</span>(interfaceClass, url));
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (UrlUtils.<span style=color:#50fa7b>isRegistry</span>(url)) {
</span></span><span style=display:flex><span>                <span style=color:#6272a4>// use last registry url</span>
</span></span><span style=display:flex><span>                registryUrl <span style=color:#ff79c6>=</span> url;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (registryUrl <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// registry url is available</span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// for multi-subscription scenario, use &#39;zone-aware&#39; policy by default</span>
</span></span><span style=display:flex><span>            String cluster <span style=color:#ff79c6>=</span> registryUrl.<span style=color:#50fa7b>getParameter</span>(CLUSTER_KEY, ZoneAwareCluster.<span style=color:#50fa7b>NAME</span>);
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// The invoker wrap sequence would be: ZoneAwareClusterInvoker(StaticDirectory) -&gt; FailoverClusterInvoker</span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// (RegistryDirectory, routing happens here) -&gt; Invoker</span>
</span></span><span style=display:flex><span>            invoker <span style=color:#ff79c6>=</span> Cluster.<span style=color:#50fa7b>getCluster</span>(registryUrl.<span style=color:#50fa7b>getScopeModel</span>(), cluster, <span style=color:#ff79c6>false</span>).<span style=color:#50fa7b>join</span>(<span style=color:#ff79c6>new</span> StaticDirectory(registryUrl, invokers), <span style=color:#ff79c6>false</span>);
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// not a registry url, must be direct invoke.</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (CollectionUtils.<span style=color:#50fa7b>isEmpty</span>(invokers)) {
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> IllegalArgumentException(<span style=color:#f1fa8c>&#34;invokers == null&#34;</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            URL curUrl <span style=color:#ff79c6>=</span> invokers.<span style=color:#50fa7b>get</span>(0).<span style=color:#50fa7b>getUrl</span>();
</span></span><span style=display:flex><span>            String cluster <span style=color:#ff79c6>=</span> curUrl.<span style=color:#50fa7b>getParameter</span>(CLUSTER_KEY, Cluster.<span style=color:#50fa7b>DEFAULT</span>);
</span></span><span style=display:flex><span>            invoker <span style=color:#ff79c6>=</span> Cluster.<span style=color:#50fa7b>getCluster</span>(scopeModel, cluster).<span style=color:#50fa7b>join</span>(<span style=color:#ff79c6>new</span> StaticDirectory(curUrl, invokers), <span style=color:#ff79c6>true</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>断点进来走的是第一个if分支，也就是urls的size是1，先按照1看，这里生成的invoker是MigrationInvoker，里面有一个很重要的成员是MockClusterInvoker，通过RegistryProtocol生成的invoker：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> <span style=color:#50fa7b>refer</span>(Class<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> type, URL url) <span style=color:#8be9fd;font-style:italic>throws</span> RpcException {
</span></span><span style=display:flex><span>    url <span style=color:#ff79c6>=</span> getRegistryUrl(url);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 推测是注册zk组件</span>
</span></span><span style=display:flex><span>    Registry registry <span style=color:#ff79c6>=</span> getRegistry(url);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (RegistryService.<span style=color:#50fa7b>class</span>.<span style=color:#50fa7b>equals</span>(type)) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> proxyFactory.<span style=color:#50fa7b>getInvoker</span>((T) registry, type, url);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// group=&#34;a,b&#34; or group=&#34;*&#34;</span>
</span></span><span style=display:flex><span>    Map<span style=color:#ff79c6>&lt;</span>String, String<span style=color:#ff79c6>&gt;</span> qs <span style=color:#ff79c6>=</span> (Map<span style=color:#ff79c6>&lt;</span>String, String<span style=color:#ff79c6>&gt;</span>) url.<span style=color:#50fa7b>getAttribute</span>(REFER_KEY);
</span></span><span style=display:flex><span>    String group <span style=color:#ff79c6>=</span> qs.<span style=color:#50fa7b>get</span>(GROUP_KEY);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (group <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> group.<span style=color:#50fa7b>length</span>() <span style=color:#ff79c6>&gt;</span> 0) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> ((COMMA_SPLIT_PATTERN.<span style=color:#50fa7b>split</span>(group)).<span style=color:#50fa7b>length</span> <span style=color:#ff79c6>&gt;</span> 1 <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#34;*&#34;</span>.<span style=color:#50fa7b>equals</span>(group)) {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> doRefer(Cluster.<span style=color:#50fa7b>getCluster</span>(url.<span style=color:#50fa7b>getScopeModel</span>(), MergeableCluster.<span style=color:#50fa7b>NAME</span>), registry, type, url, qs);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 拿到的是failoverCLuster，集群故障转移组件</span>
</span></span><span style=display:flex><span>    Cluster cluster <span style=color:#ff79c6>=</span> Cluster.<span style=color:#50fa7b>getCluster</span>(url.<span style=color:#50fa7b>getScopeModel</span>(), qs.<span style=color:#50fa7b>get</span>(CLUSTER_KEY));
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> doRefer(cluster, registry, type, url, qs);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>doRefer()方法：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>protected</span> <span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> <span style=color:#50fa7b>doRefer</span>(Cluster cluster, Registry registry, Class<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> type, URL url, Map<span style=color:#ff79c6>&lt;</span>String, String<span style=color:#ff79c6>&gt;</span> parameters) {
</span></span><span style=display:flex><span>    Map<span style=color:#ff79c6>&lt;</span>String, Object<span style=color:#ff79c6>&gt;</span> consumerAttribute <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> HashMap<span style=color:#ff79c6>&lt;&gt;</span>(url.<span style=color:#50fa7b>getAttributes</span>());
</span></span><span style=display:flex><span>    consumerAttribute.<span style=color:#50fa7b>remove</span>(REFER_KEY);
</span></span><span style=display:flex><span>    URL consumerUrl <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ServiceConfigURL(parameters.<span style=color:#50fa7b>get</span>(PROTOCOL_KEY) <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>?</span> DUBBO : parameters.<span style=color:#50fa7b>get</span>(PROTOCOL_KEY),
</span></span><span style=display:flex><span>                                           <span style=color:#ff79c6>null</span>,
</span></span><span style=display:flex><span>                                           <span style=color:#ff79c6>null</span>,
</span></span><span style=display:flex><span>                                           parameters.<span style=color:#50fa7b>get</span>(REGISTER_IP_KEY),
</span></span><span style=display:flex><span>                                           0, getPath(parameters, type),
</span></span><span style=display:flex><span>                                           parameters,
</span></span><span style=display:flex><span>                                           consumerAttribute);
</span></span><span style=display:flex><span>    url <span style=color:#ff79c6>=</span> url.<span style=color:#50fa7b>putAttribute</span>(CONSUMER_URL_KEY, consumerUrl);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// getMigrationInvoker()方法就在下面</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 用刚才创建的failoverCLuster实例化一个ServiceDiscoveryMigrationInvoker</span>
</span></span><span style=display:flex><span>    ClusterInvoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> migrationInvoker <span style=color:#ff79c6>=</span> getMigrationInvoker(<span style=color:#ff79c6>this</span>, cluster, registry, type, url, consumerUrl);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> interceptInvoker(migrationInvoker, url, consumerUrl, url);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>protected</span> <span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> ClusterInvoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> <span style=color:#50fa7b>getMigrationInvoker</span>(RegistryProtocol registryProtocol, Cluster cluster, Registry registry, Class<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> type, URL url, URL consumerUrl) {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>new</span> ServiceDiscoveryMigrationInvoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span>(registryProtocol, cluster, registry, type, url, consumerUrl);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>interceptInvoker()方法里拿到了监听器，然后调用监听器的onRefer()方法，这里拿到的监听器就是MigrationRuleListener，MigrationRuleListener里的onRefer()方法先根据传进来的invoker拿到MigrationRuleHandler实例，然后调用实例的doMigrate()方法，这个方法里有一行代码很关键：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff79c6>if</span> (refreshInvoker(step, threshold, rule)) {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 刷新成功之后更新规则</span>
</span></span><span style=display:flex><span>    setMigrationRule(rule);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>进到refreshInvoker()方法中里面是一个switch case分支，根据传进来的step（MigrationStep）直接走到APPLICATION_FIRST分支，这个分支执行migrationInvoker.migrateToApplicationFirstInvoker(newRule)方法，而migrationInvoker是我们在上面的getMigrationInvoker中直接实例化的ServiceDiscoveryMigrationInvoker：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>migrateToApplicationFirstInvoker</span>(MigrationRule newRule) {
</span></span><span style=display:flex><span>    CountDownLatch latch <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> CountDownLatch(0);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 这个方法生成MockClusterInvoker</span>
</span></span><span style=display:flex><span>    refreshInterfaceInvoker(latch);
</span></span><span style=display:flex><span>    refreshServiceDiscoveryInvoker(latch);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 上面创建了两个invoker，这里就是判断那个invoker是最优的，然后就会把另一个放到备用里</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 根据什么判断的呢，以后再看</span>
</span></span><span style=display:flex><span>    calcPreferredInvoker(newRule);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>先看refreshInterfaceInvoker()方法，这个方法里又调回了RegistryProtocol的getInvoker()方法：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>invoker <span style=color:#ff79c6>=</span> registryProtocol.<span style=color:#50fa7b>getInvoker</span>(cluster, registry, type, url);
</span></span></code></pre></td></tr></table></div></div><p>在getInvoker()方法中先是用url创建一个DynamicDirectory实例（RegistryDirectory类型），然后调用doCreateInvoker()方法：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>protected</span> <span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> ClusterInvoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> <span style=color:#50fa7b>doCreateInvoker</span>(DynamicDirectory<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> directory, Cluster cluster, Registry registry, Class<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> type) {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 设置注册中心、protocol</span>
</span></span><span style=display:flex><span>    directory.<span style=color:#50fa7b>setRegistry</span>(registry);
</span></span><span style=display:flex><span>    directory.<span style=color:#50fa7b>setProtocol</span>(protocol);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 这个parameters里面是ip、端口、协议之类的</span>
</span></span><span style=display:flex><span>    Map<span style=color:#ff79c6>&lt;</span>String, String<span style=color:#ff79c6>&gt;</span> parameters <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> HashMap<span style=color:#ff79c6>&lt;&gt;</span>(directory.<span style=color:#50fa7b>getConsumerUrl</span>().<span style=color:#50fa7b>getParameters</span>());
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 构造一个新的URL</span>
</span></span><span style=display:flex><span>    URL urlToRegistry <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ServiceConfigURL(
</span></span><span style=display:flex><span>        parameters.<span style=color:#50fa7b>get</span>(PROTOCOL_KEY) <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>?</span> DUBBO : parameters.<span style=color:#50fa7b>get</span>(PROTOCOL_KEY),
</span></span><span style=display:flex><span>        parameters.<span style=color:#50fa7b>remove</span>(REGISTER_IP_KEY), 0, getPath(parameters, type), parameters);
</span></span><span style=display:flex><span>    urlToRegistry <span style=color:#ff79c6>=</span> urlToRegistry.<span style=color:#50fa7b>setScopeModel</span>(directory.<span style=color:#50fa7b>getConsumerUrl</span>().<span style=color:#50fa7b>getScopeModel</span>());
</span></span><span style=display:flex><span>    urlToRegistry <span style=color:#ff79c6>=</span> urlToRegistry.<span style=color:#50fa7b>setServiceModel</span>(directory.<span style=color:#50fa7b>getConsumerUrl</span>().<span style=color:#50fa7b>getServiceModel</span>());
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (directory.<span style=color:#50fa7b>isShouldRegister</span>()) {
</span></span><span style=display:flex><span>        directory.<span style=color:#50fa7b>setRegisteredConsumerUrl</span>(urlToRegistry);
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 这里就是往zk上注册</span>
</span></span><span style=display:flex><span>        registry.<span style=color:#50fa7b>register</span>(directory.<span style=color:#50fa7b>getRegisteredConsumerUrl</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    directory.<span style=color:#50fa7b>buildRouterChain</span>(urlToRegistry);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 这里非常重要，这里面有获取服务实例信息的代码</span>
</span></span><span style=display:flex><span>    directory.<span style=color:#50fa7b>subscribe</span>(toSubscribeUrl(urlToRegistry));
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// 这里会调用MockClusterWrapper的join方法，把directory封装到MockClusterInvoker里返回</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> (ClusterInvoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span>) cluster.<span style=color:#50fa7b>join</span>(directory, <span style=color:#ff79c6>true</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>registry.subscribe(url, this);方法经过ListenerRegistryWrapper->FailbackRegistry->ZookeeperRegistry，最终走到了注册zk的方法ZookeeperRegistry的doSubscribe()：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#6272a4>// 创建节点</span>
</span></span><span style=display:flex><span>zkClient.<span style=color:#50fa7b>create</span>(path, <span style=color:#ff79c6>false</span>);
</span></span><span style=display:flex><span><span style=color:#6272a4>// 对子节点监听</span>
</span></span><span style=display:flex><span>List<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span> children <span style=color:#ff79c6>=</span> zkClient.<span style=color:#50fa7b>addChildListener</span>(path, zkListener);
</span></span><span style=display:flex><span><span style=color:#ff79c6>if</span> (children <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>    urls.<span style=color:#50fa7b>addAll</span>(toUrlsWithEmpty(url, path, children));
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#6272a4>// 这里应该就是对每个实例的客户端建立netty连接</span>
</span></span><span style=display:flex><span>notify(url, listener, urls);
</span></span></code></pre></td></tr></table></div></div><p>跟着notify走到了RegistryDirectory的notify()方法，然后最后一行有一个refreshOverrideAndInvoker()方法，refreshOverrideAndInvoker()方法里又调用了refreshInvoker()方法，refreshInvoker()方法里有一行很关键：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#6272a4>// Translate url list to Invoker map</span>
</span></span><span style=display:flex><span>Map<span style=color:#ff79c6>&lt;</span>URL, Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> newUrlInvokerMap <span style=color:#ff79c6>=</span> toInvokers(oldUrlInvokerMap, invokerUrls);
</span></span></code></pre></td></tr></table></div></div><p>在toInvokers中调用了**protocol.refer(serviceType, url);**方法，进到DubboProtocol的refer()方法里，方法里又调用了protocolBindingRefer()方法，在这个方法里构造了一个invoker：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>DubboInvoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> invoker <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> DubboInvoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span>(serviceType, url, getClients(url), invokers);
</span></span></code></pre></td></tr></table></div></div><p>构造DubboInvoker之前先调用了getClient()方法，断点进到DubboInvoker的构造方法里发现连接已经建立完了，所以建立连接的代码就应该在getClients(url)方法里，这个方法里创建了一个关键的元素：List&lt;ReferenceCountExchangeClient> shareClients，他是通过getSharedClient(url, connections)方法创建的，然后一直跟，跟到了buildReferenceCountExchangeClientList()方法，又跟到了buildReferenceCountExchangeClient()方法，在这个方法里看到了像核心代码的东西：initClient(url)</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#6272a4>// 发起请求</span>
</span></span><span style=display:flex><span>client <span style=color:#ff79c6>=</span> Exchangers.<span style=color:#50fa7b>connect</span>(url, requestHandler);
</span></span></code></pre></td></tr></table></div></div><p>代码里的核心就是这个，Exchangers一看就是网络通信的组件，然后继续往下跟，跟到了HeaderExchanger，又跟到了Transporters又跟到了netty4的NettyTransporter，找到了一行代码：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff79c6>return</span> <span style=color:#ff79c6>new</span> NettyClient(url, handler);
</span></span></code></pre></td></tr></table></div></div><p>点击去又跟到了父类AbstractClient中，在父类的构造方法里主要就是干了两件事，doOpen();和connect();doOpen和connect都是在NettyClient中实现的，先看doOpen：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>protected</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>doOpen</span>() <span style=color:#8be9fd;font-style:italic>throws</span> Throwable {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 处理网络请求的handler</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>final</span> NettyClientHandler nettyClientHandler <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> NettyClientHandler(getUrl(), <span style=color:#ff79c6>this</span>);
</span></span><span style=display:flex><span>    bootstrap <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> Bootstrap();
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 设置group以及一些参数</span>
</span></span><span style=display:flex><span>    bootstrap.<span style=color:#50fa7b>group</span>(EVENT_LOOP_GROUP.<span style=color:#50fa7b>get</span>())
</span></span><span style=display:flex><span>        .<span style=color:#50fa7b>option</span>(ChannelOption.<span style=color:#50fa7b>SO_KEEPALIVE</span>, <span style=color:#ff79c6>true</span>)
</span></span><span style=display:flex><span>        .<span style=color:#50fa7b>option</span>(ChannelOption.<span style=color:#50fa7b>TCP_NODELAY</span>, <span style=color:#ff79c6>true</span>)
</span></span><span style=display:flex><span>        .<span style=color:#50fa7b>option</span>(ChannelOption.<span style=color:#50fa7b>ALLOCATOR</span>, PooledByteBufAllocator.<span style=color:#50fa7b>DEFAULT</span>)
</span></span><span style=display:flex><span>        <span style=color:#6272a4>//.option(ChannelOption.CONNECT_TIMEOUT_MILLIS, getTimeout())</span>
</span></span><span style=display:flex><span>        .<span style=color:#50fa7b>channel</span>(socketChannelClass());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    bootstrap.<span style=color:#50fa7b>option</span>(ChannelOption.<span style=color:#50fa7b>CONNECT_TIMEOUT_MILLIS</span>, Math.<span style=color:#50fa7b>max</span>(DEFAULT_CONNECT_TIMEOUT, getConnectTimeout()));
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 处理逻辑、编解码啥的</span>
</span></span><span style=display:flex><span>    bootstrap.<span style=color:#50fa7b>handler</span>(<span style=color:#ff79c6>new</span> ChannelInitializer<span style=color:#ff79c6>&lt;</span>SocketChannel<span style=color:#ff79c6>&gt;</span>() {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        @Override
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>protected</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>initChannel</span>(SocketChannel ch) <span style=color:#8be9fd;font-style:italic>throws</span> Exception {
</span></span><span style=display:flex><span>            <span style=color:#8be9fd>int</span> heartbeatInterval <span style=color:#ff79c6>=</span> UrlUtils.<span style=color:#50fa7b>getHeartbeat</span>(getUrl());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (getUrl().<span style=color:#50fa7b>getParameter</span>(SSL_ENABLED_KEY, <span style=color:#ff79c6>false</span>)) {
</span></span><span style=display:flex><span>                ch.<span style=color:#50fa7b>pipeline</span>().<span style=color:#50fa7b>addLast</span>(<span style=color:#f1fa8c>&#34;negotiation&#34;</span>, <span style=color:#ff79c6>new</span> SslClientTlsHandler(getUrl()));
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            NettyCodecAdapter adapter <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> NettyCodecAdapter(getCodec(), getUrl(), NettyClient.<span style=color:#50fa7b>this</span>);
</span></span><span style=display:flex><span>            ch.<span style=color:#50fa7b>pipeline</span>()<span style=color:#6272a4>//.addLast(&#34;logging&#34;,new LoggingHandler(LogLevel.INFO))//for debug</span>
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>addLast</span>(<span style=color:#f1fa8c>&#34;decoder&#34;</span>, adapter.<span style=color:#50fa7b>getDecoder</span>())
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>addLast</span>(<span style=color:#f1fa8c>&#34;encoder&#34;</span>, adapter.<span style=color:#50fa7b>getEncoder</span>())
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>addLast</span>(<span style=color:#f1fa8c>&#34;client-idle-handler&#34;</span>, <span style=color:#ff79c6>new</span> IdleStateHandler(heartbeatInterval, 0, 0, MILLISECONDS))
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>addLast</span>(<span style=color:#f1fa8c>&#34;handler&#34;</span>, nettyClientHandler);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            String socksProxyHost <span style=color:#ff79c6>=</span> ConfigurationUtils.<span style=color:#50fa7b>getProperty</span>(getUrl().<span style=color:#50fa7b>getOrDefaultApplicationModel</span>(), SOCKS_PROXY_HOST);
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span>(socksProxyHost <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!</span>isFilteredAddress(getUrl().<span style=color:#50fa7b>getHost</span>())) {
</span></span><span style=display:flex><span>                <span style=color:#8be9fd>int</span> socksProxyPort <span style=color:#ff79c6>=</span> Integer.<span style=color:#50fa7b>parseInt</span>(ConfigurationUtils.<span style=color:#50fa7b>getProperty</span>(getUrl().<span style=color:#50fa7b>getOrDefaultApplicationModel</span>(), SOCKS_PROXY_PORT, DEFAULT_SOCKS_PROXY_PORT));
</span></span><span style=display:flex><span>                Socks5ProxyHandler socks5ProxyHandler <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> Socks5ProxyHandler(<span style=color:#ff79c6>new</span> InetSocketAddress(socksProxyHost, socksProxyPort));
</span></span><span style=display:flex><span>                ch.<span style=color:#50fa7b>pipeline</span>().<span style=color:#50fa7b>addFirst</span>(socks5ProxyHandler);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>connect()走的是子类的doConnect()方法：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>protected</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>doConnect</span>() <span style=color:#8be9fd;font-style:italic>throws</span> Throwable {
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>long</span> start <span style=color:#ff79c6>=</span> System.<span style=color:#50fa7b>currentTimeMillis</span>();
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 发起了连接，但是连接并不是同步建立的</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 需要拿到一个futrue</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 在下面需要判断连接建立的状态</span>
</span></span><span style=display:flex><span>    ChannelFutrue futrue <span style=color:#ff79c6>=</span> bootstrap.<span style=color:#50fa7b>connect</span>(getConnectAddress());
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#8be9fd>boolean</span> ret <span style=color:#ff79c6>=</span> futrue.<span style=color:#50fa7b>awaitUninterruptibly</span>(getConnectTimeout(), MILLISECONDS);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (ret <span style=color:#ff79c6>&amp;&amp;</span> futrue.<span style=color:#50fa7b>isSuccess</span>()) {
</span></span><span style=display:flex><span>            Channel newChannel <span style=color:#ff79c6>=</span> futrue.<span style=color:#50fa7b>channel</span>();
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>                <span style=color:#6272a4>// Close old channel</span>
</span></span><span style=display:flex><span>                <span style=color:#6272a4>// copy reference</span>
</span></span><span style=display:flex><span>                Channel oldChannel <span style=color:#ff79c6>=</span> NettyClient.<span style=color:#50fa7b>this</span>.<span style=color:#50fa7b>channel</span>;
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>if</span> (oldChannel <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>                        oldChannel.<span style=color:#50fa7b>close</span>();
</span></span><span style=display:flex><span>                    } <span style=color:#ff79c6>finally</span> {
</span></span><span style=display:flex><span>                        NettyChannel.<span style=color:#50fa7b>removeChannelIfDisconnected</span>(oldChannel);
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            } <span style=color:#ff79c6>finally</span> {
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>if</span> (NettyClient.<span style=color:#50fa7b>this</span>.<span style=color:#50fa7b>isClosed</span>()) {
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>                        newChannel.<span style=color:#50fa7b>close</span>();
</span></span><span style=display:flex><span>                    } <span style=color:#ff79c6>finally</span> {
</span></span><span style=display:flex><span>                        NettyClient.<span style=color:#50fa7b>this</span>.<span style=color:#50fa7b>channel</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span>                        NettyChannel.<span style=color:#50fa7b>removeChannelIfDisconnected</span>(newChannel);
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>                    NettyClient.<span style=color:#50fa7b>this</span>.<span style=color:#50fa7b>channel</span> <span style=color:#ff79c6>=</span> newChannel;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (futrue.<span style=color:#50fa7b>cause</span>() <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> RemotingException(<span style=color:#ff79c6>this</span>, <span style=color:#f1fa8c>&#34;client(url: &#34;</span> <span style=color:#ff79c6>+</span> getUrl() <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;) failed to connect to server &#34;</span>
</span></span><span style=display:flex><span>                                        <span style=color:#ff79c6>+</span> getRemoteAddress() <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;, error message is:&#34;</span> <span style=color:#ff79c6>+</span> futrue.<span style=color:#50fa7b>cause</span>().<span style=color:#50fa7b>getMessage</span>(), futrue.<span style=color:#50fa7b>cause</span>());
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> RemotingException(<span style=color:#ff79c6>this</span>, <span style=color:#f1fa8c>&#34;client(url: &#34;</span> <span style=color:#ff79c6>+</span> getUrl() <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;) failed to connect to server &#34;</span>
</span></span><span style=display:flex><span>                                        <span style=color:#ff79c6>+</span> getRemoteAddress() <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; client-side timeout &#34;</span>
</span></span><span style=display:flex><span>                                        <span style=color:#ff79c6>+</span> getConnectTimeout() <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;ms (elapsed: &#34;</span> <span style=color:#ff79c6>+</span> (System.<span style=color:#50fa7b>currentTimeMillis</span>() <span style=color:#ff79c6>-</span> start) <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;ms) from netty client &#34;</span>
</span></span><span style=display:flex><span>                                        <span style=color:#ff79c6>+</span> NetUtils.<span style=color:#50fa7b>getLocalHost</span>() <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; using dubbo version &#34;</span> <span style=color:#ff79c6>+</span> Version.<span style=color:#50fa7b>getVersion</span>());
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>finally</span> {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// just add new valid channel to NettyChannel&#39;s cache</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>isConnected()) {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>//futrue.cancel(true);</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>然后netty就建立完了。</p><p>cluster.join(directory, true)调用的是</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff79c6>new</span> MockClusterInvoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span>(directory, <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>cluster</span>.<span style=color:#50fa7b>join</span>(directory, buildFilterChain))
</span></span></code></pre></td></tr></table></div></div><p>除了directory还需要一个invoker，使用cluster.join()根据directory成成invoker，cluster.join()走到了AbstractCluster里，接着又调用了dojoin()方法生成FailoverClusterInvoker实例，所以这个时候MockClusterInvoker实例中有两个属性，一个是DynamicDirectory，一个是FailoverClusterInvoker。</p><p>回到migrateToApplicationFirstInvoker()方法，继续走到refreshServiceDiscoveryInvoker(latch);方法，和上面一样，只不过创建的DynamicDirectory是ServiceDiscoveryRegistryDirectory类型，然后也没有走注册分支。</p><p>到这里ReferenceConfig的createProxy()方法中的createInvokerForRemote()就执行完了，继续往下看根据invoker创建动态代理的代码：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>proxyFactory.<span style=color:#50fa7b>getProxy</span>(invoker, ProtocolUtils.<span style=color:#50fa7b>isGeneric</span>(generic));
</span></span></code></pre></td></tr></table></div></div><p>这个代码走到了StubProxyFactoryWrapper方法中，进到这个方法里的第一行又是一个proxyFactory.getProxy()，这里的proxyFactory变成了AbstractProxyFactory：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * StubProxyFactoryWrapper
</span></span></span><span style=display:flex><span><span style=color:#6272a4> */</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> T <span style=color:#50fa7b>getProxy</span>(Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> invoker, <span style=color:#8be9fd>boolean</span> generic) <span style=color:#8be9fd;font-style:italic>throws</span> RpcException {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 这里的proxyFactory是AbstractProxyFactory</span>
</span></span><span style=display:flex><span>    T proxy <span style=color:#ff79c6>=</span> proxyFactory.<span style=color:#50fa7b>getProxy</span>(invoker, generic);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 剩下的是对GenericService的处理，先不看</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>AbstractProxyFactory的getProxy首先拿到了url里的所有接口对应的class，然后调用子类的getProxy()方法生成代理:</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> T <span style=color:#50fa7b>getProxy</span>(Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> invoker, <span style=color:#8be9fd>boolean</span> generic) <span style=color:#8be9fd;font-style:italic>throws</span> RpcException {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// when compiling with native image, ensure that the order of the interfaces remains unchanged</span>
</span></span><span style=display:flex><span>    LinkedHashSet<span style=color:#ff79c6>&lt;</span>Class<span style=color:#ff79c6>&lt;?&gt;&gt;</span> interfaces <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> LinkedHashSet<span style=color:#ff79c6>&lt;&gt;</span>();
</span></span><span style=display:flex><span>    String config <span style=color:#ff79c6>=</span> invoker.<span style=color:#50fa7b>getUrl</span>().<span style=color:#50fa7b>getParameter</span>(INTERFACES);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (StringUtils.<span style=color:#50fa7b>isNotEmpty</span>(config)) {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 逗号分割</span>
</span></span><span style=display:flex><span>        String<span style=color:#ff79c6>[]</span> types <span style=color:#ff79c6>=</span> COMMA_SPLIT_PATTERN.<span style=color:#50fa7b>split</span>(config);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>for</span> (String type : types) {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>                ClassLoader classLoader <span style=color:#ff79c6>=</span> getClassLoader(invoker);
</span></span><span style=display:flex><span>                <span style=color:#6272a4>// 这个就是对基础类/包装类的处理</span>
</span></span><span style=display:flex><span>                interfaces.<span style=color:#50fa7b>add</span>(ReflectUtils.<span style=color:#50fa7b>forName</span>(classLoader, type));
</span></span><span style=display:flex><span>            } <span style=color:#ff79c6>catch</span> (Throwable e) {
</span></span><span style=display:flex><span>                <span style=color:#6272a4>// ignore</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (generic) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 通过反射拿到真正要代理的class</span>
</span></span><span style=display:flex><span>            String realInterface <span style=color:#ff79c6>=</span> invoker.<span style=color:#50fa7b>getUrl</span>().<span style=color:#50fa7b>getParameter</span>(Constants.<span style=color:#50fa7b>INTERFACE</span>);
</span></span><span style=display:flex><span>            ClassLoader classLoader <span style=color:#ff79c6>=</span> getClassLoader(invoker);
</span></span><span style=display:flex><span>            interfaces.<span style=color:#50fa7b>add</span>(ReflectUtils.<span style=color:#50fa7b>forName</span>(classLoader, realInterface));
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>catch</span> (Throwable e) {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// ignore</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (GenericService.<span style=color:#50fa7b>class</span>.<span style=color:#50fa7b>equals</span>(invoker.<span style=color:#50fa7b>getInterface</span>()) <span style=color:#ff79c6>||</span> <span style=color:#ff79c6>!</span>GenericService.<span style=color:#50fa7b>class</span>.<span style=color:#50fa7b>isAssignableFrom</span>(invoker.<span style=color:#50fa7b>getInterface</span>())) {
</span></span><span style=display:flex><span>            interfaces.<span style=color:#50fa7b>add</span>(com.<span style=color:#50fa7b>alibaba</span>.<span style=color:#50fa7b>dubbo</span>.<span style=color:#50fa7b>rpc</span>.<span style=color:#50fa7b>service</span>.<span style=color:#50fa7b>GenericService</span>.<span style=color:#50fa7b>class</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    interfaces.<span style=color:#50fa7b>add</span>(invoker.<span style=color:#50fa7b>getInterface</span>());
</span></span><span style=display:flex><span>    interfaces.<span style=color:#50fa7b>addAll</span>(Arrays.<span style=color:#50fa7b>asList</span>(INTERNAL_INTERFACES));
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 这个就很关键了</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 走到了JavassistProxyFactory</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> getProxy(invoker, interfaces.<span style=color:#50fa7b>toArray</span>(<span style=color:#ff79c6>new</span> Class<span style=color:#ff79c6>&lt;?&gt;[</span>0<span style=color:#ff79c6>]</span>));
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>JavassistProxyFactory里面就一句话：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> T <span style=color:#50fa7b>getProxy</span>(Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> invoker, Class<span style=color:#ff79c6>&lt;?&gt;[]</span> interfaces) {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// Proxy是dubbo自己实现的</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> (T) Proxy.<span style=color:#50fa7b>getProxy</span>(interfaces).<span style=color:#50fa7b>newInstance</span>(<span style=color:#ff79c6>new</span> InvokerInvocationHandler(invoker));
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>到这里动态代理就创建完了，然后回到ReferenceConfig的init()方法，继续往下走，走到了checkInvokerAvailable()方法，这个方法是检查刚才创建的代理有没有效，就是调用involer的isAvailable方法，不写了，到这里创建动态代理的方法就结束了，回到demo里，这时候调用了一下provider的demo的方法，一定会走到invokerInvocationHandler的invoker里去</p><p><img loading=lazy src=https://tva1.sinaimg.cn/large/008vxvgGly1h7ucja9iryj324a0u00xz.jpg></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://wangxiaohong123.github.io/tags/%E6%BA%90%E7%A0%81/>源码</a></li></ul><nav class=paginav><a class=prev href=https://wangxiaohong123.github.io/posts/%E5%9F%BA%E7%A1%80/%E7%AE%97%E6%B3%95/leecode/28.%E5%AF%B9%E7%A7%B0%E4%BA%8C%E5%8F%89%E6%A0%91/><span class=title>« Prev</span><br><span>28.对称二叉树</span>
</a><a class=next href=https://wangxiaohong123.github.io/posts/%E5%9F%BA%E7%A1%80/%E6%95%B0%E6%8D%AE%E5%BA%93/es/3.%E5%85%A5%E9%97%A8/><span class=title>Next »</span><br><span>3.es-入门</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share 3.dubbo-consumer启动源码 on x" href="https://x.com/intent/tweet/?text=3.dubbo-consumer%e5%90%af%e5%8a%a8%e6%ba%90%e7%a0%81&amp;url=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fspring%2fcloud-alibaba%2fdubbo%2f3.consumer%25E5%2590%25AF%25E5%258A%25A8%25E6%25B5%2581%25E7%25A8%258B%2f&amp;hashtags=%e6%ba%90%e7%a0%81"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 3.dubbo-consumer启动源码 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fspring%2fcloud-alibaba%2fdubbo%2f3.consumer%25E5%2590%25AF%25E5%258A%25A8%25E6%25B5%2581%25E7%25A8%258B%2f&amp;title=3.dubbo-consumer%e5%90%af%e5%8a%a8%e6%ba%90%e7%a0%81&amp;summary=3.dubbo-consumer%e5%90%af%e5%8a%a8%e6%ba%90%e7%a0%81&amp;source=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fspring%2fcloud-alibaba%2fdubbo%2f3.consumer%25E5%2590%25AF%25E5%258A%25A8%25E6%25B5%2581%25E7%25A8%258B%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 3.dubbo-consumer启动源码 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fspring%2fcloud-alibaba%2fdubbo%2f3.consumer%25E5%2590%25AF%25E5%258A%25A8%25E6%25B5%2581%25E7%25A8%258B%2f&title=3.dubbo-consumer%e5%90%af%e5%8a%a8%e6%ba%90%e7%a0%81"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 3.dubbo-consumer启动源码 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fspring%2fcloud-alibaba%2fdubbo%2f3.consumer%25E5%2590%25AF%25E5%258A%25A8%25E6%25B5%2581%25E7%25A8%258B%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 3.dubbo-consumer启动源码 on whatsapp" href="https://api.whatsapp.com/send?text=3.dubbo-consumer%e5%90%af%e5%8a%a8%e6%ba%90%e7%a0%81%20-%20https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fspring%2fcloud-alibaba%2fdubbo%2f3.consumer%25E5%2590%25AF%25E5%258A%25A8%25E6%25B5%2581%25E7%25A8%258B%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 3.dubbo-consumer启动源码 on telegram" href="https://telegram.me/share/url?text=3.dubbo-consumer%e5%90%af%e5%8a%a8%e6%ba%90%e7%a0%81&amp;url=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fspring%2fcloud-alibaba%2fdubbo%2f3.consumer%25E5%2590%25AF%25E5%258A%25A8%25E6%25B5%2581%25E7%25A8%258B%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 3.dubbo-consumer启动源码 on ycombinator" href="https://news.ycombinator.com/submitlink?t=3.dubbo-consumer%e5%90%af%e5%8a%a8%e6%ba%90%e7%a0%81&u=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fspring%2fcloud-alibaba%2fdubbo%2f3.consumer%25E5%2590%25AF%25E5%258A%25A8%25E6%25B5%2581%25E7%25A8%258B%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://wangxiaohong123.github.io/>王小红的笔记</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>