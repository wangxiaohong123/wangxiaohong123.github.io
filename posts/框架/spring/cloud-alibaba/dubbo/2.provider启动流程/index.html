<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>2.dubbo-provider启动源码 | 王小红的笔记</title><meta name=keywords content="源码"><meta name=description content="启动
进到ServiceConfig的export()方法中，看到3.0的代码把服务启动的代码都放到了ModuleDeployer中，猜测是在start方法中做的启动准备工作，有的版本调用的不是start()方法，而是prepare()方法。
然后在下面加了一个锁再去判断服务的export状态，首先不明白这里为什么要加锁，然后下面有初始化也有发布，但是还有个刷新，这里在刷新什么？


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34


/**
 *ServiceConfig的export()
 */
public void export() {
    // 如果这个服务已经启动了，就直接返回
    // exported被volatile修饰
    if (this.exported) {
        return;
    }
    // 3.0新引入的ScopeModel，管理各种组件的，这里的getScopeModel()拿到的是ScopeModel的子类ModuleModel
    // getDeployer()拿到的是DefaultModuleDeployer
    // 判断DefaultModuleDeployer就是对服务启动做初始化的组件
    getScopeModel().getDeployer().start();

    synchronized (this) {
        if (this.exported) {
            return;
        }
        // 执行刷新
        if (!this.isRefreshed()) {
            this.refresh();
        }
        // 服务实例的初始化
        if (this.shouldExport()) {
            this.init();
            // 延迟发布
            if (shouldDelay()) {
                doDelayExport();
            } else {
                doExport();
            }
        }
    }
}


DefaultModuleDeployer的start()方法："><meta name=author content><link rel=canonical href=https://wangxiaohong123.github.io/posts/%E6%A1%86%E6%9E%B6/spring/cloud-alibaba/dubbo/2.provider%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/><link crossorigin=anonymous href=/assets/css/stylesheet.08f7d74f0ada0f975d29ae436285b61ed7a719d05f350cb888d00341642995a2.css integrity="sha256-CPfXTwraD5ddKa5DYoW2HtenGdBfNQy4iNADQWQplaI=" rel="preload stylesheet" as=style><link rel=icon href=https://wangxiaohong123.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://wangxiaohong123.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://wangxiaohong123.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://wangxiaohong123.github.io/apple-touch-icon.png><link rel=mask-icon href=https://wangxiaohong123.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://wangxiaohong123.github.io/posts/%E6%A1%86%E6%9E%B6/spring/cloud-alibaba/dubbo/2.provider%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://wangxiaohong123.github.io/posts/%E6%A1%86%E6%9E%B6/spring/cloud-alibaba/dubbo/2.provider%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/"><meta property="og:site_name" content="王小红的笔记"><meta property="og:title" content="2.dubbo-provider启动源码"><meta property="og:description" content="启动 进到ServiceConfig的export()方法中，看到3.0的代码把服务启动的代码都放到了ModuleDeployer中，猜测是在start方法中做的启动准备工作，有的版本调用的不是start()方法，而是prepare()方法。
然后在下面加了一个锁再去判断服务的export状态，首先不明白这里为什么要加锁，然后下面有初始化也有发布，但是还有个刷新，这里在刷新什么？
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 /** *ServiceConfig的export() */ public void export() { // 如果这个服务已经启动了，就直接返回 // exported被volatile修饰 if (this.exported) { return; } // 3.0新引入的ScopeModel，管理各种组件的，这里的getScopeModel()拿到的是ScopeModel的子类ModuleModel // getDeployer()拿到的是DefaultModuleDeployer // 判断DefaultModuleDeployer就是对服务启动做初始化的组件 getScopeModel().getDeployer().start(); synchronized (this) { if (this.exported) { return; } // 执行刷新 if (!this.isRefreshed()) { this.refresh(); } // 服务实例的初始化 if (this.shouldExport()) { this.init(); // 延迟发布 if (shouldDelay()) { doDelayExport(); } else { doExport(); } } } } DefaultModuleDeployer的start()方法："><meta property="og:locale" content="zh-CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:tag" content="源码"><meta name=twitter:card content="summary"><meta name=twitter:title content="2.dubbo-provider启动源码"><meta name=twitter:description content="启动
进到ServiceConfig的export()方法中，看到3.0的代码把服务启动的代码都放到了ModuleDeployer中，猜测是在start方法中做的启动准备工作，有的版本调用的不是start()方法，而是prepare()方法。
然后在下面加了一个锁再去判断服务的export状态，首先不明白这里为什么要加锁，然后下面有初始化也有发布，但是还有个刷新，这里在刷新什么？


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34


/**
 *ServiceConfig的export()
 */
public void export() {
    // 如果这个服务已经启动了，就直接返回
    // exported被volatile修饰
    if (this.exported) {
        return;
    }
    // 3.0新引入的ScopeModel，管理各种组件的，这里的getScopeModel()拿到的是ScopeModel的子类ModuleModel
    // getDeployer()拿到的是DefaultModuleDeployer
    // 判断DefaultModuleDeployer就是对服务启动做初始化的组件
    getScopeModel().getDeployer().start();

    synchronized (this) {
        if (this.exported) {
            return;
        }
        // 执行刷新
        if (!this.isRefreshed()) {
            this.refresh();
        }
        // 服务实例的初始化
        if (this.shouldExport()) {
            this.init();
            // 延迟发布
            if (shouldDelay()) {
                doDelayExport();
            } else {
                doExport();
            }
        }
    }
}


DefaultModuleDeployer的start()方法："><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://wangxiaohong123.github.io/posts/"},{"@type":"ListItem","position":2,"name":"2.dubbo-provider启动源码","item":"https://wangxiaohong123.github.io/posts/%E6%A1%86%E6%9E%B6/spring/cloud-alibaba/dubbo/2.provider%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"2.dubbo-provider启动源码","name":"2.dubbo-provider启动源码","description":"启动 进到ServiceConfig的export()方法中，看到3.0的代码把服务启动的代码都放到了ModuleDeployer中，猜测是在start方法中做的启动准备工作，有的版本调用的不是start()方法，而是prepare()方法。\n然后在下面加了一个锁再去判断服务的export状态，首先不明白这里为什么要加锁，然后下面有初始化也有发布，但是还有个刷新，这里在刷新什么？\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 /** *ServiceConfig的export() */ public void export() { // 如果这个服务已经启动了，就直接返回 // exported被volatile修饰 if (this.exported) { return; } // 3.0新引入的ScopeModel，管理各种组件的，这里的getScopeModel()拿到的是ScopeModel的子类ModuleModel // getDeployer()拿到的是DefaultModuleDeployer // 判断DefaultModuleDeployer就是对服务启动做初始化的组件 getScopeModel().getDeployer().start(); synchronized (this) { if (this.exported) { return; } // 执行刷新 if (!this.isRefreshed()) { this.refresh(); } // 服务实例的初始化 if (this.shouldExport()) { this.init(); // 延迟发布 if (shouldDelay()) { doDelayExport(); } else { doExport(); } } } } DefaultModuleDeployer的start()方法：\n","keywords":["源码"],"articleBody":"启动 进到ServiceConfig的export()方法中，看到3.0的代码把服务启动的代码都放到了ModuleDeployer中，猜测是在start方法中做的启动准备工作，有的版本调用的不是start()方法，而是prepare()方法。\n然后在下面加了一个锁再去判断服务的export状态，首先不明白这里为什么要加锁，然后下面有初始化也有发布，但是还有个刷新，这里在刷新什么？\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 /** *ServiceConfig的export() */ public void export() { // 如果这个服务已经启动了，就直接返回 // exported被volatile修饰 if (this.exported) { return; } // 3.0新引入的ScopeModel，管理各种组件的，这里的getScopeModel()拿到的是ScopeModel的子类ModuleModel // getDeployer()拿到的是DefaultModuleDeployer // 判断DefaultModuleDeployer就是对服务启动做初始化的组件 getScopeModel().getDeployer().start(); synchronized (this) { if (this.exported) { return; } // 执行刷新 if (!this.isRefreshed()) { this.refresh(); } // 服务实例的初始化 if (this.shouldExport()) { this.init(); // 延迟发布 if (shouldDelay()) { doDelayExport(); } else { doExport(); } } } } DefaultModuleDeployer的start()方法：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 public synchronized Futrue start() throws IllegalStateException { // 检查state变量的状态 if (isStopping() || isStopped() || isFailed()) { throw new IllegalStateException(getIdentifier() + \" is stopping or stopped, can not start again\"); } // 也是state变量 if (isStarting() || isStarted()) { // 这个startFutrue是一个全局的CompletableFutrue类型变量 return startFutrue; } // 这里就是把状态设置成starting // 然后出发starting状态的监听 // 然后把全局变量startFutrue赋初始值CompletableFutrue onModuleStarting(); // 服务初始化 applicationDeployer.initialize(); // 这里只是设置了一个initialized状态 // 他是全局的AtomicBoolean类型变量 initialize(); // refresh服务 exportServices(); // prepare application instance // exclude internal module to avoid wait itself // 如果不是内部模块就准备实例，防止自我等待 if (moduleModel != moduleModel.getApplicationModel().getInternalModule()) { applicationDeployer.prepareApplicationInstance(); } // 描述服务，大概看了一眼，没看懂是干什么的 referServices(); executorRepository.getSharedExecutor().submit(() -\u003e { // 这里调用featrue.get()等待拿到结果 try { // wait for export finish waitExportFinish(); // wait for refer finish waitReferFinish(); } catch (Throwable e) { logger.warn(\"wait for export/refer services occurred an exception\", e); } finally { // 设置启动完成，applicationDeployer也需要修改一下状态 onModuleStarted(); } }); return startFutrue; } 整体的启动就是这些，看完了start方法又多了几个疑问，refresh服务有做了什么操作，为什么这么多刷新，有什么用，描述服务是干什么的\n继续点进applicationDeployer.initialize();里看一下，可以看到DefaultApplicationDeployer是ApplicationDeployer的实现类：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 /** * DefaultApplicationDeployer */ public void initialize() { if (initialized.get()) { return; } // 这个startLock只是一个全局的对象 // 我觉得这里加锁不是因为启动的时候有多线程并发访问dubbo服务的启动 // 是有多个线程访问不同的方法 synchronized (startLock) { if (initialized.get()) { return; } // 注册jvm销毁钩子 // 销毁一些资源 // 1.先创建一个DubboShutdownHook，他是个线程 // 2.然后通过调用Runtime.getRuntime().addShutdownHook(this);注册销毁钩子 registerShutdownHook(); // 启动配置中心 // 要先判断有没有必要把注册中心当成配置中心，然后在创建一个配置中心（ConfigCenterConfig） startConfigCenter(); // 通过ConfigManager加载配置,比如ProtocolConfig，MetadataReportConfig等等 // ProtocolConfig就是dubbo.protocols.xxx // 如果没配置就是空，此时还没有默认值 loadApplicationConfigs(); // 初始化moduleModel // 拿到所有的ModuleModel // 遍历ModuleModel，执行ModuleModel的Deployer的initialize()方法 initModuleDeployers(); // 2.7.8之后引入的启动元数据中心 // 创建一个MetadataReportInstance，调用他的的init方法。 startMetadataCenter(); // 初始化一些类 initMetadataService(); // 设置initialized状态 initialized.set(true); } } 初始化moduleModel，初始化之前已经拿到了moduleModels，生么时候设置的moduleModels没看到：\n1 2 3 4 5 6 7 8 9 10 11 private void initModuleDeployers() { // 这个是把models放到全局变量defaultModule中 applicationModel.getDefaultModule(); // 把moduleModels复制一份在操作，避免遍历的时候其他线程插入ModuleModel导致ConcurrentModificationException List\u003cModuleModel\u003e moduleModels = new ArrayList\u003c\u003e(applicationModel.getModuleModels()); for (ModuleModel moduleModel : moduleModels) { // 初始化moduleModel，ModuleModel只有DefaultModuleDeployer一个实现类 // 这里只会走到DefaultModuleDeployer的initialize()方法 moduleModel.getDeployer().initialize(); } } 初始化结束后回到ModuleDeployer的start方法，继续走initialize()方法，因为这个方法在DefaultApplicationDeployer的initialize()方法中初始化初始化moduleModel使已经被调用过了，所以initialized已经被设置成了true，这个时候会直接返回：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 public void initialize() throws IllegalStateException { if (initialized.get()) { return; } // Ensure that the initialization is completed when concurrent calls synchronized (this) { if (initialized.get()) { return; } // 这里又加载了一次配置，和DefaultApplicationDeployer加载的不一样 // 这里加载了dubbo.providers.xxx、load dubbo.consumers.xxx和load dubbo.modules.xxx loadConfigs(); // 设置exportAsync、referAsync和background ModuleConfig moduleConfig = moduleModel.getConfigManager().getModule().orElseThrow(() -\u003e new IllegalStateException(\"Default module config is not initialized\")); exportAsync = Boolean.TRUE.equals(moduleConfig.getExportAsync()); referAsync = Boolean.TRUE.equals(moduleConfig.getReferAsync()); // start in background background = moduleConfig.getBackground(); if (background == null) { // compatible with old usages background = isExportBackground() || isReferBackground(); } initialized.set(true); } } 到exportServices()进行刷新服务：\n1 2 3 4 5 6 7 8 9 10 private void exportServices() { // 拿到所有服务 for (ServiceConfigBase sc : configManager.getServices()) { // 可以把每个ServiceConfig看成一个服务 // exportServiceInternal的代码就是调用了sc.refresh();这个方法在父类AbstractConfig中 // 如果是异步export还会执行sc.export()方法，但是我们就是从这个方法进来的啊 // 断点发现这个代码根本就不会走，configManager.getServices()拿到的size是0 exportServiceInternal(sc); } } 然后回到ServiceConfig的export()，在调用完DefaultApplicationDeployer的start()方法后继续走到refresh()方法：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 public void refresh() { // 设置一下状态 refreshed.set(true); try { // 这个就是一个检查，检查什么没看 preProcessRefresh(); // 拿到环境 Environment environment = getScopeModel().getModelEnvironment(); List\u003cMap\u003cString, String\u003e\u003e configurationMaps = environment.getConfigurationMaps(); // 下面是获取前缀的 String preferredPrefix = null; for (String prefix : getPrefixes()) { if (ConfigurationUtils.hasSubProperties(configurationMaps, prefix)) { preferredPrefix = prefix; break; } } // 如果没有配置前缀，调用getPrefixes()，这个是子类实现的自定义前缀方法 if (preferredPrefix == null) { preferredPrefix = getPrefixes().get(0); } // 到此为止就拿到了一个preferredPrefix，这个路径现在是dubbo.service.org.apache.dubbo.demo.DemoService // dubbo.service是他自己拼的前缀，中间一部分是服务接口的包名，最后跟上接口的名称 // Extract sub props (which key was starts with preferredPrefix) Collection\u003cMap\u003cString, String\u003e\u003e instanceConfigMaps = environment.getConfigurationMaps(this, preferredPrefix); Map\u003cString, String\u003e subProperties = ConfigurationUtils.getSubProperties(instanceConfigMaps, preferredPrefix); InmemoryConfiguration subPropsConfiguration = new InmemoryConfiguration(subProperties); // 这就是日志处理了 if (logger.isDebugEnabled()) { String idOrName = \"\"; if (StringUtils.hasText(this.getId())) { idOrName = \"[id=\" + this.getId() + \"]\"; } else { String name = ReflectUtils.getProperty(this, \"getName\"); if (StringUtils.hasText(name)) { idOrName = \"[name=\" + name + \"]\"; } } } assignProperties(this, environment, subProperties, subPropsConfiguration); // 这里处理服务接口里提供方法 processExtraRefresh(preferredPrefix, subPropsConfiguration); } catch (Exception e) { logger.error(\"Failed to override field value of config bean: \" + this, e); throw new IllegalStateException(\"Failed to override field value of config bean: \" + this, e); } // 刷新之后的一些检查 postProcessRefresh(); } 处理服务接口里提供方法就是通过反射，拿到接口和里面对应的方法：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 /** * AbstractInterfaceConfig */ protected void processExtraRefresh(String preferredPrefix, InmemoryConfiguration subPropsConfiguration) { if (StringUtils.hasText(interfaceName)) { Class\u003c?\u003e interfaceClass = null; try { // 反射拿到类，这个interfaceName是用set方法设置的，在哪设置还没看 interfaceClass = ClassUtils.forName(interfaceName); } catch (ClassNotFoundException e) { return; } // 获取到配置 Map\u003cString, String\u003e configProperties = subPropsConfiguration.getProperties(); // 拿到所有方法，遍历 Method[] methods = interfaceClass.getMethods(); for (Method method : methods) { // 判断方法名是configProperties的元素，什么时候设置成map的key也没看到 if (ConfigurationUtils.hasSubProperties(configProperties, method.getName())) { // 每个方法就是一个MethodConfig，把方法名和参数设置进去 MethodConfig methodConfig = getMethodByName(method.getName()); if (methodConfig == null) { methodConfig = new MethodConfig(); methodConfig.setName(method.getName()); this.addMethod(methodConfig); } java.lang.reflect.Parameter[] arguments = method.getParameters(); for (int i = 0; i \u003c arguments.length; i++) { if (getArgumentByIndex(methodConfig, i) == null \u0026\u0026 hasArgumentConfigProps(configProperties, methodConfig.getName(), i)) { ArgumentConfig argumentConfig = new ArgumentConfig(); argumentConfig.setIndex(i); methodConfig.addArgument(argumentConfig); } } } } // 有把方法刷新了 List\u003cMethodConfig\u003e methodConfigs = this.getMethods(); if (methodConfigs != null \u0026\u0026 methodConfigs.size() \u003e 0) { // whether ignore invalid method config Object ignoreInvalidMethodConfigVal = getEnvironment().getConfiguration() .getProperty(ConfigKeys.DUBBO_CONFIG_IGNORE_INVALID_METHOD_CONFIG, \"false\"); boolean ignoreInvalidMethodConfig = Boolean.parseBoolean(ignoreInvalidMethodConfigVal.toString()); Class\u003c?\u003e finalInterfaceClass = interfaceClass; List\u003cMethodConfig\u003e validMethodConfigs = methodConfigs.stream().filter(methodConfig -\u003e { methodConfig.setParentPrefix(preferredPrefix); methodConfig.setScopeModel(getScopeModel()); // 猜测这个刷新就是生成了代理，因为我看到里面先把方法名拼到了刚才得到的接口名后面 // 然后调用了invoke方法 methodConfig.refresh(); // 又验证了一下配置 return verifyMethodConfig(methodConfig, finalInterfaceClass, ignoreInvalidMethodConfig); }).collect(Collectors.toList()); this.setMethods(validMethodConfigs); } } } 回到ServiceConfig的export()里继续走到init()方法：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 public void init() { // 这里是乐观锁设置initialized属性为true if (this.initialized.compareAndSet(false, true)) { // load ServiceListeners from extension ExtensionLoader\u003cServiceListener\u003e extensionLoader = this.getExtensionLoader(ServiceListener.class); this.serviceListeners.addAll(extensionLoader.getSupportedExtensionInstances()); } // 这里很关键，初始化service的元数据 // 应该是和元数据中心配合使用的 initServiceMetadata(provider); // 接口类型 serviceMetadata.setServiceType(getInterfaceClass()); // target是实现的类 serviceMetadata.setTarget(getRef()); // 这个就是接口的路径 serviceMetadata.generateServiceKey(); } initServiceMetadata里设置了版本、group、接口名等等，但是设置完了除了接口名，其他还是null。\n1 2 3 4 5 6 protected void initServiceMetadata(AbstractInterfaceConfig interfaceConfig) { serviceMetadata.setVersion(getVersion(interfaceConfig)); serviceMetadata.setGroup(getGroup(interfaceConfig)); serviceMetadata.setDefaultGroup(getGroup(interfaceConfig)); serviceMetadata.setServiceInterfaceName(getInterface()); } 到这为止，启动的准备工作就完事儿了，接下来就要执行发布的代码，继续往下看doExport()方法，doExport方法中就是调用了两个方法：\n1 2 doExportUrls(); exported(); exported()一看就是发布结束后的收尾工作，核心应该都在doExportUrls()里面，在这个方法中又出现了getScopeModel()，之前的deployer就是用这个方法获取的，所以我先进去看了下这个方法的返回值是干什么的。进去之后就是一堆组件，各种model，model中还有model，他通过这个model组件体系保存了所有插件，在别的地方需要使用的时候直接获取。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 private void doExportUrls() { // 这个getScopeModel()已经出现不止一次了，他的返回值是ScopeModel的子类ModuleModel // 通过ModuleModel可以拿到ModuleServiceRepository // 之前还获取过其他的组件，这里就猜测dubbo把各个组件都集中在了ModuleModel中 // ModuleModel相当于门面模式，需要那个组件就去获取 // ModuleServiceRepository他的本质是dubbo服务数据的存储组件,里面有服务对应的map、consumer的map、provider的map等 ModuleServiceRepository repository = getScopeModel().getServiceRepository(); // 把要发布的服务注册到repository中，就是把这个服务的数据存到repository的services里面 ServiceDescriptor serviceDescriptor = repository.registerService(getInterfaceClass()); // 创建一个服务的提供者，有接口名、具体的类、还有ModuleModel，必须有这个，要不然获取不到其他组件了 // 还有刚才初始化的元数据 providerModel = new ProviderModel(getUniqueServiceName(), ref, serviceDescriptor, this, getScopeModel(), serviceMetadata); // 在把封装好的providerModel放到repository的providers里 repository.registerProvider(providerModel); // 生成注册的url，registry://127.0.0.1:2181/……和service-discovery-registry://127.0.0.1:2181/…… List\u003cURL\u003e registryURLs = ConfigValidationUtils.loadRegistries(this, true); // protocols是通信的协议，默认是dubbo for (ProtocolConfig protocolConfig : protocols) { // 在protocolConfig中如果配置了contextPath就会把在path前面拼接contextPath/ // 但是我们没配置，所以治理拿到的pathKey还是org.apache.dubbo.demo.DemoService String pathKey = URL.buildKey(getContextPath(protocolConfig) .map(p -\u003e p + \"/\" + path) .orElse(path), group, version); // 又保存了一遍服务信息，这次把path和接口关联 // 因为path没变，所以这不不会有什么操作 repository.registerService(pathKey, interfaceClass); // 核心发布的流程 doExportUrlsFor1Protocol(protocolConfig, registryURLs); } } 然后进到关键的发布流程的代码里：\n1 2 3 4 5 6 7 8 9 10 11 12 13 private void doExportUrlsFor1Protocol(ProtocolConfig protocolConfig, List\u003cURL\u003e registryURLs) { // 先把配置转成map然后删掉空值 Map\u003cString, String\u003e map = buildAttributes(protocolConfig); map.keySet().removeIf(key -\u003e key == null || map.get(key) == null); // 设置元数据 serviceMetadata.getAttachments().putAll(map); // 在这里构建了一个url // 里面有协议、地址、接口的path、还有一些元数据 // 类似这样：dubbo://102.168.31.153:21880/org.apache.dubbo.demo.DemoService?anyhost=true…… // 也是在这步设置了默认值 URL url = buildUrl(protocolConfig, registryURLs, map); exportUrl(url, registryURLs); } 上面创建了一个URL对象，然后走到了exportUrl方法，在这个方法里有本地发布和非本地发布，根据url里的scope参数判断是本地还是非本地，我觉得正常的服务启动之后会本地和远程都需要发布，也就说这个方法会走两次，一次本地，一次远程。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 private void exportUrl(URL url, List\u003cURL\u003e registryURLs) { String scope = url.getParameter(SCOPE_KEY); // 如果scope不是none就发布 if (!SCOPE_NONE.equalsIgnoreCase(scope)) { // 不是远程就发本地 if (!SCOPE_REMOTE.equalsIgnoreCase(scope)) { exportLocal(url); } // 不是本地就发远程 if (!SCOPE_LOCAL.equalsIgnoreCase(scope)) { url = exportRemote(url, registryURLs); MetadataUtils.publishServiceDefinition(url); } } this.urls.add(url); } **为什么他的判断条件是!远程，就本地发布和!本地就远程发布？**因为这里的scope传进来的是null，这样判断本地和远程都可以发布。\n先进到到本地发布exportLocal(url)里去：\n1 2 3 4 5 6 7 8 9 10 11 private void exportLocal(URL url) { // 这里在原来的URL基础上覆盖了几个属性 URL local = URLBuilder.from(url) .setProtocol(LOCAL_PROTOCOL) .setHost(LOCALHOST_VALUE) .setPort(0) .build(); local = local.setScopeModel(getScopeModel()).setServiceModel(providerModel); // 注意这里的false，表示是否带元数据 doExportUrl(local, false); } 这个时候url变成了injvm://102.168.31.153……，injvm表示的是本地发布替换了原来的dubbo协议头dubbo://，进到doExportUrl中：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 private void doExportUrl(URL url, boolean withMetaData) { // ref是实现类DemoServiceImpl，interfaceClass是接口DemoService，url是暴露出去的信息 // 通过proxyFactory生成一个invoker，这个invoker就是基于DemoService接口生成的动态代理 // 当netty server收到请求的时候，肯定会根据url调用这个invoker，底层肯定会回调自己的实现类 // ProxyFactory$Adaptive // proxyFactory instanceof JavassistProxyFactory Invoker\u003c?\u003e invoker = proxyFactory.getInvoker(ref, (Class) interfaceClass, url); // 本地创建的withMetaData是false if (withMetaData) { invoker = new DelegateProviderMetaDataInvoker(invoker, this); } // protocolSPI是Protocol类型 // 通过protocol把invoker封装成Exporter发布出去 Exporter\u003c?\u003e exporter = protocolSPI.export(invoker); exporters.add(exporter); } Protocol$Adaptive是一个native类，断点进不去，大概的意思就是构建一个org.apache.dubbo.rpc.Protocol类型的protocol。\n虽然方法里不能打断点，但是这步走完后的返回值可以看到，返回值是一个ListenerExporterWrapper，里面有过一个Exporter exporter对象，这个对象在本地发布的时候返回的是InjvmExporter，所以Protocol$Adaptive的export方法里调用的应该是InjvmProtocol，看一下InjvmProtocol的expoer：\n1 2 3 4 5 @Override public \u003cT\u003e Exporter\u003cT\u003e export(Invoker\u003cT\u003e invoker) throws RpcException { // 只有一句话，就是实例化InjvmExporter return new InjvmExporter\u003cT\u003e(invoker, invoker.getUrl().getServiceKey(), exporterMap); } 到这里本地发布就完事了，回到之前的exportRul()方法里，往下走到了exportRemote()远程发布的代码，这个方法有两个参数，一个url，一个是个数组，数组里有两个元素：\nservice-discovery-registry://127.0.0.1:2181/org.apache.dubbo.registry.RegistryService?application=dubbo-demo-api-provider\u0026dubbo=2.0.2\u0026pid=44489\u0026registry=zookeeper\u0026timestamp=1637053498954 registry://127.0.0.1:2181/org.apache.dubbo.registry.RegistryService?application=dubbo-demo-api-provider\u0026dubbo=2.0.2\u0026pid=44489\u0026registry=zookeeper\u0026timestamp=1637053498954。 这两个元素除了头，其他的都一样，每个元素都会调用一遍doExportUrl()方法，但是protocolSPI已经变成了RegistryProtocol，RegistryProtocol类里有个内置对象protected Protocol protocol;这个protocol的类型是DubboProtocol，先看RegistryProtocol的export方法：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 public \u003cT\u003e Exporter\u003cT\u003e export(final Invoker\u003cT\u003e originInvoker) throws RpcException { // 拿到对应的url，设置一些属性 URL registryUrl = getRegistryUrl(originInvoker); URL providerUrl = getProviderUrl(originInvoker); final URL overrideSubscribeUrl = getSubscribedOverrideUrl(providerUrl); final OverrideListener overrideSubscribeListener = new OverrideListener(overrideSubscribeUrl, originInvoker); Map\u003cURL, NotifyListener\u003e overrideListeners = getProviderConfigurationListener(providerUrl).getOverrideListeners(); overrideListeners.put(registryUrl, overrideSubscribeListener); providerUrl = overrideUrlWithConfig(providerUrl, overrideSubscribeListener); // 虽然叫doLocalExport，但是他是远程发布核心代码 final ExporterChangeableWrapper\u003cT\u003e exporter = doLocalExport(originInvoker, providerUrl); …… return new DestroyableExporter\u003c\u003e(exporter); } 在doLocalExport()方法中调用了DubboProtocol的export方法，只要是远程发布，不管那个url都会调用DubboProtocol，dubboProtocol的export()方法中也没啥代码，就是又调用了一个openServer(url);方法，所以直接进到openServer方法里看：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 private void openServer(URL url) { checkDestroyed(); String key = url.getAddress(); boolean isServer = url.getParameter(IS_SERVER_KEY, true); if (isServer) { ProtocolServer server = serverMap.get(key); // 第一次发布server是null if (server == null) { synchronized (this) { server = serverMap.get(key); if (server == null) { // 双重检查server还是null，所有又走到了createServer() serverMap.put(key, createServer(url)); }else { server.reset(url); } } } else { // server supports reset, use together with override server.reset(url); } } } 这里又调用了createServer()，这个代码就会非常非常关键了：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 private ProtocolServer createServer(URL url) { // 又是一顿处理url url = URLBuilder.from(url) // send readonly event when server closes, it's enabled by default .addParameterIfAbsent(CHANNEL_READONLYEVENT_SENT_KEY, Boolean.TRUE.toString()) // enable heartbeat by default .addParameterIfAbsent(HEARTBEAT_KEY, String.valueOf(DEFAULT_HEARTBEAT)) .addParameter(CODEC_KEY, DubboCodec.NAME) .build(); String str = url.getParameter(SERVER_KEY, DEFAULT_REMOTING_SERVER); if (StringUtils.isNotEmpty(str) \u0026\u0026 !url.getOrDefaultFrameworkModel().getExtensionLoader(Transporter.class).hasExtension(str)) { throw new RpcException(\"Unsupported server type: \" + str + \", url: \" + url); } ExchangeServer server; try { // 应该是核心了 server = Exchangers.bind(url, requestHandler); } catch (RemotingException e) { throw new RpcException(\"Fail to start server(url: \" + url + \") \" + e.getMessage(), e); } str = url.getParameter(CLIENT_KEY); if (StringUtils.isNotEmpty(str)) { Set\u003cString\u003e supportedTypes = url.getOrDefaultFrameworkModel().getExtensionLoader(Transporter.class).getSupportedExtensions(); if (!supportedTypes.contains(str)) { throw new RpcException(\"Unsupported client type: \" + str); } } DubboProtocolServer protocolServer = new DubboProtocolServer(server); loadServerProperties(protocolServer); return protocolServer; } 刚开始以为上面的bind方法应该很关键，但是进去之后又没啥东西：\n1 2 3 4 5 6 7 8 9 10 public static ExchangeServer bind(URL url, ExchangeHandler handler) throws RemotingException { if (url == null) { throw new IllegalArgumentException(\"url == null\"); } if (handler == null) { throw new IllegalArgumentException(\"handler == null\"); } url = url.addParameterIfAbsent(Constants.CODEC_KEY, \"exchange\"); return getExchanger(url).bind(url, handler); } 继续往下跟getExchanger(url).bind(url, handler)，getExchanger返回了HeaderExchanger，继续：\n1 2 3 4 @Override public ExchangeServer bind(URL url, ExchangeHandler handler) throws RemotingException { return new HeaderExchangeServer(Transporters.bind(url, new DecodeHandler(new HeaderExchangeHandler(handler)))); } 这里就是一直封装成ExchangeServer，调用了Transporters.bind：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 public static RemotingServer bind(URL url, ChannelHandler... handlers) throws RemotingException { if (url == null) { throw new IllegalArgumentException(\"url == null\"); } if (handlers == null || handlers.length == 0) { throw new IllegalArgumentException(\"handlers == null\"); } ChannelHandler handler; if (handlers.length == 1) { handler = handlers[0]; } else { handler = new ChannelHandlerDispatcher(handlers); } // 这个getTransporter是Transporter$Adaptive类型，又不能进断点了 // 但是Transporter$Adaptive对我们有用的实现类只有一个：NettyTransporter，netty4包下的 // 在这里构造一个NettyServer return getTransporter(url).bind(url, handler); } bind里就是return new NettyServer(……)，点进去看也是调用父类的构造函数，所以直接进到父类AbstractServer中看构造方法：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 public AbstractServer(URL url, ChannelHandler handler) throws RemotingException { // 这个super就是一个赋值操作，没啥东西 super(url, handler); // 下面也是一些简单赋值 executorRepository = url.getOrDefaultApplicationModel().getExtensionLoader(ExecutorRepository.class).getDefaultExtension(); localAddress = getUrl().toInetSocketAddress(); String bindIp = getUrl().getParameter(Constants.BIND_IP_KEY, getUrl().getHost()); int bindPort = getUrl().getParameter(Constants.BIND_PORT_KEY, getUrl().getPort()); if (url.getParameter(ANYHOST_KEY, false) || NetUtils.isInvalidLocalHost(bindIp)) { bindIp = ANYHOST_VALUE; } bindAddress = new InetSocketAddress(bindIp, bindPort); this.accepts = url.getParameter(ACCEPTS_KEY, DEFAULT_ACCEPTS); try { // 关键就是这个 doOpen(); if (logger.isInfoEnabled()) { logger.info(\"Start \" + getClass().getSimpleName() + \" bind \" + getBindAddress() + \", export \" + getLocalAddress()); } } catch (Throwable t) { throw new RemotingException(url.toInetSocketAddress(), null, \"Failed to bind \" + getClass().getSimpleName() + \" on \" + getLocalAddress() + \", cause: \" + t.getMessage(), t); } executor = executorRepository.createExecutorIfAbsent(url); } 找到了启动netty的代码doOpen()，这是个抽象方法，要回到netty4的NettyServer看实现：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 protected void doOpen() throws Throwable { // ServerBootstrap相当于一个server服务器 bootstrap = new ServerBootstrap(); // 轮询监听端口连接事件的线程池 // 使用netty的成熟框架都会根据操作系统来选择是EpollEventLoopGroup还是NioEventLoopGroup来提高性能 bossGroup = NettyEventLoopFactory.eventLoopGroup(1, EVENT_LOOP_BOSS_POOL_NAME); // 处理监听到的事件的线程池 workerGroup = NettyEventLoopFactory.eventLoopGroup( getUrl().getPositiveParameter(IO_THREADS_KEY, Constants.DEFAULT_IO_THREADS), EVENT_LOOP_WORKER_POOL_NAME); // 创建handler final NettyServerHandler nettyServerHandler = new NettyServerHandler(getUrl(), this); channels = nettyServerHandler.getChannels(); // 获取keepalive配置 boolean keepalive = getUrl().getParameter(KEEP_ALIVE_KEY, Boolean.FALSE); bootstrap.group(bossGroup, workerGroup) // 这里也是根据操作系统判断使用EpollServerSocketChannel还是NioServerSocketChannel .channel(NettyEventLoopFactory.serverSocketChannelClass()) // reuseAddr是true // 这个是防止重启时四次挥手出错导致的重启报错Address already in use .option(ChannelOption.SO_REUSEADDR, Boolean.TRUE) // tcp no delay整合多个请求一起发送虽然吞吐量会变高，但是延迟也会变高 // 所以tcp no delay的意思是不把多个请求合并发送 .childOption(ChannelOption.TCP_NODELAY, Boolean.TRUE) .childOption(ChannelOption.SO_KEEPALIVE, keepalive) .childOption(ChannelOption.ALLOCATOR, PooledByteBufAllocator.DEFAULT) .childHandler(new ChannelInitializer\u003cSocketChannel\u003e() { @Override // 建立连接的操作 protected void initChannel(SocketChannel ch) throws Exception { // FIXME: should we use getTimeout()? int idleTimeout = UrlUtils.getIdleTimeout(getUrl()); NettyCodecAdapter adapter = new NettyCodecAdapter(getCodec(), getUrl(), NettyServer.this); if (getUrl().getParameter(SSL_ENABLED_KEY, false)) { // 加密通信 ch.pipeline().addLast(\"negotiation\", new SslServerTlsHandler(getUrl())); } ch.pipeline() // 编解码 .addLast(\"decoder\", adapter.getDecoder()) .addLast(\"encoder\", adapter.getEncoder()) // 这个应该是机器空闲的处理 .addLast(\"server-idle-handler\", new IdleStateHandler(0, 0, idleTimeout, MILLISECONDS)) // 业务处理代码，这里用的是NettyServerHandler .addLast(\"handler\", nettyServerHandler); } }); // bind之后就可以监听网络了 ChannelFutrue channelFutrue = bootstrap.bind(getBindAddress()); channelFutrue.syncUninterruptibly(); channel = channelFutrue.channel(); } 启动了nettyServer之后就可以把他注册到zk上去了，需要回到RegistryProtocol的export()方法中，执行完了doLocalExport(originInvoker, providerUrl)要继续往下走\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 // 这里拿到的是ListenerRegistryWrapper final Registry registry = getRegistry(registryUrl); final URL registeredProviderUrl = getUrlToRegistry(providerUrl, registryUrl); // decide if we need to delay publish boolean register = providerUrl.getParameter(REGISTER_KEY, true); if (register) { // 注册的逻辑 register(registry, registeredProviderUrl); } // 把url添加到ProviderModel registerStatedUrl(registryUrl, registeredProviderUrl, register); // 设置两个url // registerUrl exporter.setRegisterUrl(registeredProviderUrl); // subscribeUrl exporter.setSubscribeUrl(overrideSubscribeUrl); if (!registry.isServiceDiscovery()) { // Deprecated! Subscribe to override rules in 2.6.x or before. // 这个弃用了，为了兼容2.6或之前版本？ registry.subscribe(overrideSubscribeUrl, overrideSubscribeListener); } // 这个是执行监听的 notifyExport(exporter); //Ensure that a new exporter instance is returned every time export return new DestroyableExporter\u003c\u003e(exporter); 注册的逻辑就是registry.register(registeredProviderUrl);这个registry是之前生成的ListenerRegistryWrapper，ListenerRegistryWrapper的register()又调用了registry.register(url)，这个registry是Registry类型的全局对象，拿到的是ServiceDiscoveryRegistry类型，ServiceDiscoveryRegistry的register()又调用了同类的doRegister()方法：\n1 2 3 4 5 6 7 8 9 10 11 12 13 public void doRegister(URL url) { url = addRegistryClusterKey(url); // 这句很关键，核心了 if (writableMetadataService.exportURL(url)) { if (logger.isInfoEnabled()) { logger.info(format(\"The URL[%s] registered successfully.\", url.toString())); } } else { if (logger.isWarnEnabled()) { logger.warn(format(\"The URL[%s] has been registered.\", url.toString())); } } } writableMetadataService是WritableMetadataService类型的接口，他的实现类是InMemoryWritableMetadataService，看这名就知道是本地发布，直接跳过，看远程发布，回到ListenerRegistryWrapper，远程发布的时候registry变成了ZookeeperRegistry，但是ZookeeperRegistry并不是Registry的实现类，直接断点跟进去发现调用的是FailbackRegistry的register()方法，FailbackRegistry是Registry的实现类，FailbackRegistry还是一个抽象类，在register()方法中调用了抽象方法doRegister()，由子类实现，而ZookeeperRegistry就是他的子类，这样就回到了ZookeeperRegistry的doRegister方法：\n1 2 3 4 5 6 7 8 9 10 public void doRegister(URL url) { try { // 这个就是检查zkClient有没有被初始化 checkDestroyed(); // 自己封装的zkClient创建节点、添加监听什么的 zkClient.create(toUrlPath(url), url.getParameter(DYNAMIC_KEY, true)); } catch (Throwable e) { throw new RpcException(\"Failed to register \" + url + \" to zookeeper \" + getUrl() + \", cause: \" + e.getMessage(), e); } } 注册成功，启动结束。\n","wordCount":"2481","inLanguage":"en","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://wangxiaohong123.github.io/posts/%E6%A1%86%E6%9E%B6/spring/cloud-alibaba/dubbo/2.provider%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/"},"publisher":{"@type":"Organization","name":"王小红的笔记","logo":{"@type":"ImageObject","url":"https://wangxiaohong123.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wangxiaohong123.github.io/ accesskey=h title="王小红的笔记 (Alt + H)">王小红的笔记</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://wangxiaohong123.github.io/posts/ title=笔记><span>笔记</span></a></li><li><a href=https://wangxiaohong123.github.io/categories/ title=分类><span>分类</span></a></li><li><a href=https://wangxiaohong123.github.io/tags/ title=标签><span>标签</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">2.dubbo-provider启动源码</h1><div class=post-meta>12 min</div></header><div class=post-content><h4 id=启动>启动<a hidden class=anchor aria-hidden=true href=#启动>#</a></h4><p>进到ServiceConfig的export()方法中，看到3.0的代码把服务启动的代码都放到了ModuleDeployer中，猜测是在start方法中做的启动准备工作，有的版本调用的不是start()方法，而是prepare()方法。</p><p>然后在下面加了一个锁再去判断服务的export状态，<strong>首先不明白这里为什么要加锁，然后下面有初始化也有发布，但是还有个刷新，这里在刷新什么？</strong></p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span><span style=color:#6272a4> *ServiceConfig的export()
</span></span></span><span style=display:flex><span><span style=color:#6272a4> */</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>export</span>() {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 如果这个服务已经启动了，就直接返回</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// exported被volatile修饰</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>exported</span>) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 3.0新引入的ScopeModel，管理各种组件的，这里的getScopeModel()拿到的是ScopeModel的子类ModuleModel</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// getDeployer()拿到的是DefaultModuleDeployer</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 判断DefaultModuleDeployer就是对服务启动做初始化的组件</span>
</span></span><span style=display:flex><span>    getScopeModel().<span style=color:#50fa7b>getDeployer</span>().<span style=color:#50fa7b>start</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>synchronized</span> (<span style=color:#ff79c6>this</span>) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>exported</span>) {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 执行刷新</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span><span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>isRefreshed</span>()) {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>refresh</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 服务实例的初始化</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>shouldExport</span>()) {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>init</span>();
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 延迟发布</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (shouldDelay()) {
</span></span><span style=display:flex><span>                doDelayExport();
</span></span><span style=display:flex><span>            } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>                doExport();
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>DefaultModuleDeployer的start()方法：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>synchronized</span> Futrue <span style=color:#50fa7b>start</span>() <span style=color:#8be9fd;font-style:italic>throws</span> IllegalStateException {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 检查state变量的状态</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (isStopping() <span style=color:#ff79c6>||</span> isStopped() <span style=color:#ff79c6>||</span> isFailed()) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> IllegalStateException(getIdentifier() <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; is stopping or stopped, can not start again&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// 也是state变量</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (isStarting() <span style=color:#ff79c6>||</span> isStarted()) {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 这个startFutrue是一个全局的CompletableFutrue类型变量</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> startFutrue;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 这里就是把状态设置成starting</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 然后出发starting状态的监听</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 然后把全局变量startFutrue赋初始值CompletableFutrue</span>
</span></span><span style=display:flex><span>    onModuleStarting();
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 服务初始化</span>
</span></span><span style=display:flex><span>    applicationDeployer.<span style=color:#50fa7b>initialize</span>();
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 这里只是设置了一个initialized状态</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 他是全局的AtomicBoolean类型变量</span>
</span></span><span style=display:flex><span>    initialize();
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// refresh服务</span>
</span></span><span style=display:flex><span>    exportServices();
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// prepare application instance</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// exclude internal module to avoid wait itself</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 如果不是内部模块就准备实例，防止自我等待</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (moduleModel <span style=color:#ff79c6>!=</span> moduleModel.<span style=color:#50fa7b>getApplicationModel</span>().<span style=color:#50fa7b>getInternalModule</span>()) {
</span></span><span style=display:flex><span>        applicationDeployer.<span style=color:#50fa7b>prepareApplicationInstance</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 描述服务，大概看了一眼，没看懂是干什么的</span>
</span></span><span style=display:flex><span>    referServices();
</span></span><span style=display:flex><span>    executorRepository.<span style=color:#50fa7b>getSharedExecutor</span>().<span style=color:#50fa7b>submit</span>(() <span style=color:#ff79c6>-&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 这里调用featrue.get()等待拿到结果</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// wait for export finish</span>
</span></span><span style=display:flex><span>            waitExportFinish();
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// wait for refer finish</span>
</span></span><span style=display:flex><span>            waitReferFinish();
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>catch</span> (Throwable e) {
</span></span><span style=display:flex><span>            logger.<span style=color:#50fa7b>warn</span>(<span style=color:#f1fa8c>&#34;wait for export/refer services occurred an exception&#34;</span>, e);
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>finally</span> {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 设置启动完成，applicationDeployer也需要修改一下状态</span>
</span></span><span style=display:flex><span>            onModuleStarted();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> startFutrue;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>整体的启动就是这些，看完了start方法又多了几个疑问，<strong>refresh服务有做了什么操作，为什么这么多刷新，有什么用，描述服务是干什么的</strong></p><p>继续点进applicationDeployer.initialize();里看一下，可以看到DefaultApplicationDeployer是ApplicationDeployer的实现类：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * DefaultApplicationDeployer
</span></span></span><span style=display:flex><span><span style=color:#6272a4> */</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>initialize</span>() {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (initialized.<span style=color:#50fa7b>get</span>()) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 这个startLock只是一个全局的对象</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 我觉得这里加锁不是因为启动的时候有多线程并发访问dubbo服务的启动</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 是有多个线程访问不同的方法</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>synchronized</span> (startLock) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (initialized.<span style=color:#50fa7b>get</span>()) {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 注册jvm销毁钩子</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 销毁一些资源</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 1.先创建一个DubboShutdownHook，他是个线程</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 2.然后通过调用Runtime.getRuntime().addShutdownHook(this);注册销毁钩子</span>
</span></span><span style=display:flex><span>        registerShutdownHook();
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 启动配置中心</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 要先判断有没有必要把注册中心当成配置中心，然后在创建一个配置中心（ConfigCenterConfig）</span>
</span></span><span style=display:flex><span>        startConfigCenter();
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 通过ConfigManager加载配置,比如ProtocolConfig，MetadataReportConfig等等</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// ProtocolConfig就是dubbo.protocols.xxx</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 如果没配置就是空，此时还没有默认值</span>
</span></span><span style=display:flex><span>        loadApplicationConfigs();
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 初始化moduleModel</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 拿到所有的ModuleModel</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 遍历ModuleModel，执行ModuleModel的Deployer的initialize()方法</span>
</span></span><span style=display:flex><span>        initModuleDeployers();
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 2.7.8之后引入的启动元数据中心</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 创建一个MetadataReportInstance，调用他的的init方法。</span>
</span></span><span style=display:flex><span>        startMetadataCenter();
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 初始化一些类</span>
</span></span><span style=display:flex><span>        initMetadataService();
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 设置initialized状态</span>
</span></span><span style=display:flex><span>        initialized.<span style=color:#50fa7b>set</span>(<span style=color:#ff79c6>true</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>初始化moduleModel，初始化之前已经拿到了moduleModels，<strong>生么时候设置的moduleModels没看到</strong>：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>initModuleDeployers</span>() {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 这个是把models放到全局变量defaultModule中</span>
</span></span><span style=display:flex><span>    applicationModel.<span style=color:#50fa7b>getDefaultModule</span>();
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 把moduleModels复制一份在操作，避免遍历的时候其他线程插入ModuleModel导致ConcurrentModificationException</span>
</span></span><span style=display:flex><span>    List<span style=color:#ff79c6>&lt;</span>ModuleModel<span style=color:#ff79c6>&gt;</span> moduleModels <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ArrayList<span style=color:#ff79c6>&lt;&gt;</span>(applicationModel.<span style=color:#50fa7b>getModuleModels</span>());
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> (ModuleModel moduleModel : moduleModels) {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 初始化moduleModel，ModuleModel只有DefaultModuleDeployer一个实现类</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 这里只会走到DefaultModuleDeployer的initialize()方法</span>
</span></span><span style=display:flex><span>        moduleModel.<span style=color:#50fa7b>getDeployer</span>().<span style=color:#50fa7b>initialize</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>初始化结束后回到ModuleDeployer的start方法，继续走initialize()方法，因为这个方法在DefaultApplicationDeployer的initialize()方法中初始化初始化moduleModel使已经被调用过了，所以initialized已经被设置成了true，这个时候会直接返回：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>initialize</span>() <span style=color:#8be9fd;font-style:italic>throws</span> IllegalStateException {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (initialized.<span style=color:#50fa7b>get</span>()) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// Ensure that the initialization is completed when concurrent calls</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>synchronized</span> (<span style=color:#ff79c6>this</span>) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (initialized.<span style=color:#50fa7b>get</span>()) {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 这里又加载了一次配置，和DefaultApplicationDeployer加载的不一样</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 这里加载了dubbo.providers.xxx、load dubbo.consumers.xxx和load dubbo.modules.xxx</span>
</span></span><span style=display:flex><span>        loadConfigs();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 设置exportAsync、referAsync和background</span>
</span></span><span style=display:flex><span>        ModuleConfig moduleConfig <span style=color:#ff79c6>=</span> moduleModel.<span style=color:#50fa7b>getConfigManager</span>().<span style=color:#50fa7b>getModule</span>().<span style=color:#50fa7b>orElseThrow</span>(() <span style=color:#ff79c6>-&gt;</span> <span style=color:#ff79c6>new</span> IllegalStateException(<span style=color:#f1fa8c>&#34;Default module config is not initialized&#34;</span>));
</span></span><span style=display:flex><span>        exportAsync <span style=color:#ff79c6>=</span> Boolean.<span style=color:#50fa7b>TRUE</span>.<span style=color:#50fa7b>equals</span>(moduleConfig.<span style=color:#50fa7b>getExportAsync</span>());
</span></span><span style=display:flex><span>        referAsync <span style=color:#ff79c6>=</span> Boolean.<span style=color:#50fa7b>TRUE</span>.<span style=color:#50fa7b>equals</span>(moduleConfig.<span style=color:#50fa7b>getReferAsync</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// start in background</span>
</span></span><span style=display:flex><span>        background <span style=color:#ff79c6>=</span> moduleConfig.<span style=color:#50fa7b>getBackground</span>();
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (background <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// compatible with old usages</span>
</span></span><span style=display:flex><span>            background <span style=color:#ff79c6>=</span> isExportBackground() <span style=color:#ff79c6>||</span> isReferBackground();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        initialized.<span style=color:#50fa7b>set</span>(<span style=color:#ff79c6>true</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>到exportServices()进行刷新服务：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>exportServices</span>() {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 拿到所有服务</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> (ServiceConfigBase sc : configManager.<span style=color:#50fa7b>getServices</span>()) {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 可以把每个ServiceConfig看成一个服务</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// exportServiceInternal的代码就是调用了sc.refresh();这个方法在父类AbstractConfig中</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 如果是异步export还会执行sc.export()方法，但是我们就是从这个方法进来的啊</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 断点发现这个代码根本就不会走，configManager.getServices()拿到的size是0</span>
</span></span><span style=display:flex><span>        exportServiceInternal(sc);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>然后回到ServiceConfig的export()，在调用完DefaultApplicationDeployer的start()方法后继续走到refresh()方法：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>refresh</span>() {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 设置一下状态</span>
</span></span><span style=display:flex><span>    refreshed.<span style=color:#50fa7b>set</span>(<span style=color:#ff79c6>true</span>);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 这个就是一个检查，检查什么没看</span>
</span></span><span style=display:flex><span>        preProcessRefresh();
</span></span><span style=display:flex><span>		<span style=color:#6272a4>// 拿到环境</span>
</span></span><span style=display:flex><span>        Environment environment <span style=color:#ff79c6>=</span> getScopeModel().<span style=color:#50fa7b>getModelEnvironment</span>();
</span></span><span style=display:flex><span>        List<span style=color:#ff79c6>&lt;</span>Map<span style=color:#ff79c6>&lt;</span>String, String<span style=color:#ff79c6>&gt;&gt;</span> configurationMaps <span style=color:#ff79c6>=</span> environment.<span style=color:#50fa7b>getConfigurationMaps</span>();
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 下面是获取前缀的</span>
</span></span><span style=display:flex><span>        String preferredPrefix <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>for</span> (String prefix : getPrefixes()) {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (ConfigurationUtils.<span style=color:#50fa7b>hasSubProperties</span>(configurationMaps, prefix)) {
</span></span><span style=display:flex><span>                preferredPrefix <span style=color:#ff79c6>=</span> prefix;
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 如果没有配置前缀，调用getPrefixes()，这个是子类实现的自定义前缀方法</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (preferredPrefix <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>            preferredPrefix <span style=color:#ff79c6>=</span> getPrefixes().<span style=color:#50fa7b>get</span>(0);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 到此为止就拿到了一个preferredPrefix，这个路径现在是dubbo.service.org.apache.dubbo.demo.DemoService</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// dubbo.service是他自己拼的前缀，中间一部分是服务接口的包名，最后跟上接口的名称</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// Extract sub props (which key was starts with preferredPrefix)</span>
</span></span><span style=display:flex><span>        Collection<span style=color:#ff79c6>&lt;</span>Map<span style=color:#ff79c6>&lt;</span>String, String<span style=color:#ff79c6>&gt;&gt;</span> instanceConfigMaps <span style=color:#ff79c6>=</span> environment.<span style=color:#50fa7b>getConfigurationMaps</span>(<span style=color:#ff79c6>this</span>, preferredPrefix);
</span></span><span style=display:flex><span>        Map<span style=color:#ff79c6>&lt;</span>String, String<span style=color:#ff79c6>&gt;</span> subProperties <span style=color:#ff79c6>=</span> ConfigurationUtils.<span style=color:#50fa7b>getSubProperties</span>(instanceConfigMaps, preferredPrefix);
</span></span><span style=display:flex><span>        InmemoryConfiguration subPropsConfiguration <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> InmemoryConfiguration(subProperties);
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 这就是日志处理了</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (logger.<span style=color:#50fa7b>isDebugEnabled</span>()) {
</span></span><span style=display:flex><span>            String idOrName <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;&#34;</span>;
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (StringUtils.<span style=color:#50fa7b>hasText</span>(<span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>getId</span>())) {
</span></span><span style=display:flex><span>                idOrName <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;[id=&#34;</span> <span style=color:#ff79c6>+</span> <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>getId</span>() <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;]&#34;</span>;
</span></span><span style=display:flex><span>            } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>                String name <span style=color:#ff79c6>=</span> ReflectUtils.<span style=color:#50fa7b>getProperty</span>(<span style=color:#ff79c6>this</span>, <span style=color:#f1fa8c>&#34;getName&#34;</span>);
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>if</span> (StringUtils.<span style=color:#50fa7b>hasText</span>(name)) {
</span></span><span style=display:flex><span>                    idOrName <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;[name=&#34;</span> <span style=color:#ff79c6>+</span> name <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;]&#34;</span>;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        assignProperties(<span style=color:#ff79c6>this</span>, environment, subProperties, subPropsConfiguration);
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 这里处理服务接口里提供方法</span>
</span></span><span style=display:flex><span>        processExtraRefresh(preferredPrefix, subPropsConfiguration);
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>catch</span> (Exception e) {
</span></span><span style=display:flex><span>        logger.<span style=color:#50fa7b>error</span>(<span style=color:#f1fa8c>&#34;Failed to override field value of config bean: &#34;</span> <span style=color:#ff79c6>+</span> <span style=color:#ff79c6>this</span>, e);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> IllegalStateException(<span style=color:#f1fa8c>&#34;Failed to override field value of config bean: &#34;</span> <span style=color:#ff79c6>+</span> <span style=color:#ff79c6>this</span>, e);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 刷新之后的一些检查</span>
</span></span><span style=display:flex><span>    postProcessRefresh();
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>处理服务接口里提供方法就是通过反射，拿到接口和里面对应的方法：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * AbstractInterfaceConfig
</span></span></span><span style=display:flex><span><span style=color:#6272a4> */</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>protected</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>processExtraRefresh</span>(String preferredPrefix, InmemoryConfiguration subPropsConfiguration) {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (StringUtils.<span style=color:#50fa7b>hasText</span>(interfaceName)) {
</span></span><span style=display:flex><span>        Class<span style=color:#ff79c6>&lt;?&gt;</span> interfaceClass <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 反射拿到类，这个interfaceName是用set方法设置的，在哪设置还没看</span>
</span></span><span style=display:flex><span>            interfaceClass <span style=color:#ff79c6>=</span> ClassUtils.<span style=color:#50fa7b>forName</span>(interfaceName);
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>catch</span> (ClassNotFoundException e) {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 获取到配置</span>
</span></span><span style=display:flex><span>        Map<span style=color:#ff79c6>&lt;</span>String, String<span style=color:#ff79c6>&gt;</span> configProperties <span style=color:#ff79c6>=</span> subPropsConfiguration.<span style=color:#50fa7b>getProperties</span>();
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 拿到所有方法，遍历</span>
</span></span><span style=display:flex><span>        Method<span style=color:#ff79c6>[]</span> methods <span style=color:#ff79c6>=</span> interfaceClass.<span style=color:#50fa7b>getMethods</span>();
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>for</span> (Method method : methods) {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 判断方法名是configProperties的元素，什么时候设置成map的key也没看到</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (ConfigurationUtils.<span style=color:#50fa7b>hasSubProperties</span>(configProperties, method.<span style=color:#50fa7b>getName</span>())) {
</span></span><span style=display:flex><span>                <span style=color:#6272a4>// 每个方法就是一个MethodConfig，把方法名和参数设置进去</span>
</span></span><span style=display:flex><span>                MethodConfig methodConfig <span style=color:#ff79c6>=</span> getMethodByName(method.<span style=color:#50fa7b>getName</span>());
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>if</span> (methodConfig <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>                    methodConfig <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> MethodConfig();
</span></span><span style=display:flex><span>                    methodConfig.<span style=color:#50fa7b>setName</span>(method.<span style=color:#50fa7b>getName</span>());
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>addMethod</span>(methodConfig);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                java.<span style=color:#50fa7b>lang</span>.<span style=color:#50fa7b>reflect</span>.<span style=color:#50fa7b>Parameter</span><span style=color:#ff79c6>[]</span> arguments <span style=color:#ff79c6>=</span> method.<span style=color:#50fa7b>getParameters</span>();
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> 0; i <span style=color:#ff79c6>&lt;</span> arguments.<span style=color:#50fa7b>length</span>; i<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>if</span> (getArgumentByIndex(methodConfig, i) <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span>
</span></span><span style=display:flex><span>                        hasArgumentConfigProps(configProperties, methodConfig.<span style=color:#50fa7b>getName</span>(), i)) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                        ArgumentConfig argumentConfig <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ArgumentConfig();
</span></span><span style=display:flex><span>                        argumentConfig.<span style=color:#50fa7b>setIndex</span>(i);
</span></span><span style=display:flex><span>                        methodConfig.<span style=color:#50fa7b>addArgument</span>(argumentConfig);
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 有把方法刷新了</span>
</span></span><span style=display:flex><span>        List<span style=color:#ff79c6>&lt;</span>MethodConfig<span style=color:#ff79c6>&gt;</span> methodConfigs <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>getMethods</span>();
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (methodConfigs <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> methodConfigs.<span style=color:#50fa7b>size</span>() <span style=color:#ff79c6>&gt;</span> 0) {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// whether ignore invalid method config</span>
</span></span><span style=display:flex><span>            Object ignoreInvalidMethodConfigVal <span style=color:#ff79c6>=</span> getEnvironment().<span style=color:#50fa7b>getConfiguration</span>()
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>getProperty</span>(ConfigKeys.<span style=color:#50fa7b>DUBBO_CONFIG_IGNORE_INVALID_METHOD_CONFIG</span>, <span style=color:#f1fa8c>&#34;false&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#8be9fd>boolean</span> ignoreInvalidMethodConfig <span style=color:#ff79c6>=</span> Boolean.<span style=color:#50fa7b>parseBoolean</span>(ignoreInvalidMethodConfigVal.<span style=color:#50fa7b>toString</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            Class<span style=color:#ff79c6>&lt;?&gt;</span> finalInterfaceClass <span style=color:#ff79c6>=</span> interfaceClass;
</span></span><span style=display:flex><span>            List<span style=color:#ff79c6>&lt;</span>MethodConfig<span style=color:#ff79c6>&gt;</span> validMethodConfigs <span style=color:#ff79c6>=</span> methodConfigs.<span style=color:#50fa7b>stream</span>().<span style=color:#50fa7b>filter</span>(methodConfig <span style=color:#ff79c6>-&gt;</span> {
</span></span><span style=display:flex><span>                methodConfig.<span style=color:#50fa7b>setParentPrefix</span>(preferredPrefix);
</span></span><span style=display:flex><span>                methodConfig.<span style=color:#50fa7b>setScopeModel</span>(getScopeModel());
</span></span><span style=display:flex><span>                <span style=color:#6272a4>// 猜测这个刷新就是生成了代理，因为我看到里面先把方法名拼到了刚才得到的接口名后面</span>
</span></span><span style=display:flex><span>                <span style=color:#6272a4>// 然后调用了invoke方法</span>
</span></span><span style=display:flex><span>                methodConfig.<span style=color:#50fa7b>refresh</span>();
</span></span><span style=display:flex><span>                <span style=color:#6272a4>// 又验证了一下配置</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>return</span> verifyMethodConfig(methodConfig, finalInterfaceClass, ignoreInvalidMethodConfig);
</span></span><span style=display:flex><span>            }).<span style=color:#50fa7b>collect</span>(Collectors.<span style=color:#50fa7b>toList</span>());
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>setMethods</span>(validMethodConfigs);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>回到ServiceConfig的export()里继续走到init()方法：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>init</span>() {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 这里是乐观锁设置initialized属性为true</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>initialized</span>.<span style=color:#50fa7b>compareAndSet</span>(<span style=color:#ff79c6>false</span>, <span style=color:#ff79c6>true</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// load ServiceListeners from extension</span>
</span></span><span style=display:flex><span>        ExtensionLoader<span style=color:#ff79c6>&lt;</span>ServiceListener<span style=color:#ff79c6>&gt;</span> extensionLoader <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>getExtensionLoader</span>(ServiceListener.<span style=color:#50fa7b>class</span>);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>serviceListeners</span>.<span style=color:#50fa7b>addAll</span>(extensionLoader.<span style=color:#50fa7b>getSupportedExtensionInstances</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 这里很关键，初始化service的元数据</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 应该是和元数据中心配合使用的</span>
</span></span><span style=display:flex><span>    initServiceMetadata(provider);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 接口类型</span>
</span></span><span style=display:flex><span>    serviceMetadata.<span style=color:#50fa7b>setServiceType</span>(getInterfaceClass());
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// target是实现的类</span>
</span></span><span style=display:flex><span>    serviceMetadata.<span style=color:#50fa7b>setTarget</span>(getRef());
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 这个就是接口的路径</span>
</span></span><span style=display:flex><span>    serviceMetadata.<span style=color:#50fa7b>generateServiceKey</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>initServiceMetadata里设置了版本、group、接口名等等，但是设置完了除了接口名，其他还是null。</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>protected</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>initServiceMetadata</span>(AbstractInterfaceConfig interfaceConfig) {
</span></span><span style=display:flex><span>    serviceMetadata.<span style=color:#50fa7b>setVersion</span>(getVersion(interfaceConfig));
</span></span><span style=display:flex><span>    serviceMetadata.<span style=color:#50fa7b>setGroup</span>(getGroup(interfaceConfig));
</span></span><span style=display:flex><span>    serviceMetadata.<span style=color:#50fa7b>setDefaultGroup</span>(getGroup(interfaceConfig));
</span></span><span style=display:flex><span>    serviceMetadata.<span style=color:#50fa7b>setServiceInterfaceName</span>(getInterface());
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>到这为止，启动的准备工作就完事儿了，接下来就要执行发布的代码，继续往下看doExport()方法，doExport方法中就是调用了两个方法：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>doExportUrls();
</span></span><span style=display:flex><span>exported();
</span></span></code></pre></td></tr></table></div></div><p>exported()一看就是发布结束后的收尾工作，核心应该都在doExportUrls()里面，在这个方法中又出现了getScopeModel()，之前的deployer就是用这个方法获取的，所以我先进去看了下这个方法的返回值是干什么的。进去之后就是一堆组件，各种model，model中还有model，他通过这个model组件体系保存了所有插件，在别的地方需要使用的时候直接获取。</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>doExportUrls</span>() {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 这个getScopeModel()已经出现不止一次了，他的返回值是ScopeModel的子类ModuleModel</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 通过ModuleModel可以拿到ModuleServiceRepository</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 之前还获取过其他的组件，这里就猜测dubbo把各个组件都集中在了ModuleModel中</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// ModuleModel相当于门面模式，需要那个组件就去获取</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// ModuleServiceRepository他的本质是dubbo服务数据的存储组件,里面有服务对应的map、consumer的map、provider的map等</span>
</span></span><span style=display:flex><span>    ModuleServiceRepository repository <span style=color:#ff79c6>=</span> getScopeModel().<span style=color:#50fa7b>getServiceRepository</span>();
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 把要发布的服务注册到repository中，就是把这个服务的数据存到repository的services里面</span>
</span></span><span style=display:flex><span>    ServiceDescriptor serviceDescriptor <span style=color:#ff79c6>=</span> repository.<span style=color:#50fa7b>registerService</span>(getInterfaceClass());
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 创建一个服务的提供者，有接口名、具体的类、还有ModuleModel，必须有这个，要不然获取不到其他组件了</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 还有刚才初始化的元数据</span>
</span></span><span style=display:flex><span>    providerModel <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ProviderModel(getUniqueServiceName(), ref, serviceDescriptor, <span style=color:#ff79c6>this</span>,
</span></span><span style=display:flex><span>                                      getScopeModel(), serviceMetadata);
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// 在把封装好的providerModel放到repository的providers里</span>
</span></span><span style=display:flex><span>    repository.<span style=color:#50fa7b>registerProvider</span>(providerModel);
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// 生成注册的url，registry://127.0.0.1:2181/……和service-discovery-registry://127.0.0.1:2181/……</span>
</span></span><span style=display:flex><span>    List<span style=color:#ff79c6>&lt;</span>URL<span style=color:#ff79c6>&gt;</span> registryURLs <span style=color:#ff79c6>=</span> ConfigValidationUtils.<span style=color:#50fa7b>loadRegistries</span>(<span style=color:#ff79c6>this</span>, <span style=color:#ff79c6>true</span>);
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// protocols是通信的协议，默认是dubbo</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> (ProtocolConfig protocolConfig : protocols) {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 在protocolConfig中如果配置了contextPath就会把在path前面拼接contextPath/</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 但是我们没配置，所以治理拿到的pathKey还是org.apache.dubbo.demo.DemoService</span>
</span></span><span style=display:flex><span>        String pathKey <span style=color:#ff79c6>=</span> URL.<span style=color:#50fa7b>buildKey</span>(getContextPath(protocolConfig)
</span></span><span style=display:flex><span>                                      .<span style=color:#50fa7b>map</span>(p <span style=color:#ff79c6>-&gt;</span> p <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;/&#34;</span> <span style=color:#ff79c6>+</span> path)
</span></span><span style=display:flex><span>                                      .<span style=color:#50fa7b>orElse</span>(path), group, version);
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 又保存了一遍服务信息，这次把path和接口关联</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 因为path没变，所以这不不会有什么操作</span>
</span></span><span style=display:flex><span>        repository.<span style=color:#50fa7b>registerService</span>(pathKey, interfaceClass);
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 核心发布的流程</span>
</span></span><span style=display:flex><span>        doExportUrlsFor1Protocol(protocolConfig, registryURLs);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>然后进到关键的发布流程的代码里：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>doExportUrlsFor1Protocol</span>(ProtocolConfig protocolConfig, List<span style=color:#ff79c6>&lt;</span>URL<span style=color:#ff79c6>&gt;</span> registryURLs) {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 先把配置转成map然后删掉空值</span>
</span></span><span style=display:flex><span>    Map<span style=color:#ff79c6>&lt;</span>String, String<span style=color:#ff79c6>&gt;</span> map <span style=color:#ff79c6>=</span> buildAttributes(protocolConfig);
</span></span><span style=display:flex><span>    map.<span style=color:#50fa7b>keySet</span>().<span style=color:#50fa7b>removeIf</span>(key <span style=color:#ff79c6>-&gt;</span> key <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>||</span> map.<span style=color:#50fa7b>get</span>(key) <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 设置元数据</span>
</span></span><span style=display:flex><span>    serviceMetadata.<span style=color:#50fa7b>getAttachments</span>().<span style=color:#50fa7b>putAll</span>(map);
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// 在这里构建了一个url</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 里面有协议、地址、接口的path、还有一些元数据</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 类似这样：dubbo://102.168.31.153:21880/org.apache.dubbo.demo.DemoService?anyhost=true……</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 也是在这步设置了默认值</span>
</span></span><span style=display:flex><span>    URL url <span style=color:#ff79c6>=</span> buildUrl(protocolConfig, registryURLs, map);
</span></span><span style=display:flex><span>    exportUrl(url, registryURLs);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>上面创建了一个URL对象，然后走到了exportUrl方法，在这个方法里有本地发布和非本地发布，根据url里的scope参数判断是本地还是非本地，我觉得正常的服务启动之后会本地和远程都需要发布，也就说这个方法会走两次，一次本地，一次远程。</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>exportUrl</span>(URL url, List<span style=color:#ff79c6>&lt;</span>URL<span style=color:#ff79c6>&gt;</span> registryURLs) {
</span></span><span style=display:flex><span>    String scope <span style=color:#ff79c6>=</span> url.<span style=color:#50fa7b>getParameter</span>(SCOPE_KEY);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 如果scope不是none就发布</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>SCOPE_NONE.<span style=color:#50fa7b>equalsIgnoreCase</span>(scope)) {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 不是远程就发本地</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>SCOPE_REMOTE.<span style=color:#50fa7b>equalsIgnoreCase</span>(scope)) {
</span></span><span style=display:flex><span>            exportLocal(url);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 不是本地就发远程</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>SCOPE_LOCAL.<span style=color:#50fa7b>equalsIgnoreCase</span>(scope)) {
</span></span><span style=display:flex><span>            url <span style=color:#ff79c6>=</span> exportRemote(url, registryURLs);
</span></span><span style=display:flex><span>            MetadataUtils.<span style=color:#50fa7b>publishServiceDefinition</span>(url);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>urls</span>.<span style=color:#50fa7b>add</span>(url);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>**为什么他的判断条件是!远程，就本地发布和!本地就远程发布？**因为这里的scope传进来的是null，这样判断本地和远程都可以发布。</p><p>先进到到本地发布exportLocal(url)里去：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>exportLocal</span>(URL url) {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 这里在原来的URL基础上覆盖了几个属性</span>
</span></span><span style=display:flex><span>    URL local <span style=color:#ff79c6>=</span> URLBuilder.<span style=color:#50fa7b>from</span>(url)
</span></span><span style=display:flex><span>        .<span style=color:#50fa7b>setProtocol</span>(LOCAL_PROTOCOL)
</span></span><span style=display:flex><span>        .<span style=color:#50fa7b>setHost</span>(LOCALHOST_VALUE)
</span></span><span style=display:flex><span>        .<span style=color:#50fa7b>setPort</span>(0)
</span></span><span style=display:flex><span>        .<span style=color:#50fa7b>build</span>();
</span></span><span style=display:flex><span>    local <span style=color:#ff79c6>=</span> local.<span style=color:#50fa7b>setScopeModel</span>(getScopeModel()).<span style=color:#50fa7b>setServiceModel</span>(providerModel);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 注意这里的false，表示是否带元数据</span>
</span></span><span style=display:flex><span>    doExportUrl(local, <span style=color:#ff79c6>false</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>这个时候url变成了injvm://102.168.31.153……，injvm表示的是本地发布替换了原来的dubbo协议头dubbo://，进到doExportUrl中：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>doExportUrl</span>(URL url, <span style=color:#8be9fd>boolean</span> withMetaData) {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// ref是实现类DemoServiceImpl，interfaceClass是接口DemoService，url是暴露出去的信息</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 通过proxyFactory生成一个invoker，这个invoker就是基于DemoService接口生成的动态代理</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 当netty server收到请求的时候，肯定会根据url调用这个invoker，底层肯定会回调自己的实现类</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// ProxyFactory$Adaptive</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// proxyFactory instanceof JavassistProxyFactory</span>
</span></span><span style=display:flex><span>    Invoker<span style=color:#ff79c6>&lt;?&gt;</span> invoker <span style=color:#ff79c6>=</span> proxyFactory.<span style=color:#50fa7b>getInvoker</span>(ref, (Class) interfaceClass, url);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 本地创建的withMetaData是false</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (withMetaData) {
</span></span><span style=display:flex><span>        invoker <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> DelegateProviderMetaDataInvoker(invoker, <span style=color:#ff79c6>this</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// protocolSPI是Protocol类型</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 通过protocol把invoker封装成Exporter发布出去</span>
</span></span><span style=display:flex><span>    Exporter<span style=color:#ff79c6>&lt;?&gt;</span> exporter <span style=color:#ff79c6>=</span> protocolSPI.<span style=color:#50fa7b>export</span>(invoker);
</span></span><span style=display:flex><span>    exporters.<span style=color:#50fa7b>add</span>(exporter);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>Protocol$Adaptive是一个native类，断点进不去，大概的意思就是构建一个org.apache.dubbo.rpc.Protocol类型的protocol。</p><p>虽然方法里不能打断点，但是这步走完后的返回值可以看到，返回值是一个ListenerExporterWrapper，里面有过一个Exporter exporter对象，这个对象在本地发布的时候返回的是InjvmExporter，所以Protocol$Adaptive的export方法里调用的应该是InjvmProtocol，看一下InjvmProtocol的expoer：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>@Override
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> Exporter<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> <span style=color:#50fa7b>export</span>(Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> invoker) <span style=color:#8be9fd;font-style:italic>throws</span> RpcException {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 只有一句话，就是实例化InjvmExporter</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>new</span> InjvmExporter<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span>(invoker, invoker.<span style=color:#50fa7b>getUrl</span>().<span style=color:#50fa7b>getServiceKey</span>(), exporterMap);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>到这里本地发布就完事了，回到之前的exportRul()方法里，往下走到了exportRemote()远程发布的代码，这个方法有两个参数，一个url，一个是个数组，数组里有两个元素：</p><ol><li>service-discovery-registry://127.0.0.1:2181/org.apache.dubbo.registry.RegistryService?application=dubbo-demo-api-provider&amp;dubbo=2.0.2&amp;pid=44489&amp;registry=zookeeper&amp;timestamp=1637053498954</li><li>registry://127.0.0.1:2181/org.apache.dubbo.registry.RegistryService?application=dubbo-demo-api-provider&amp;dubbo=2.0.2&amp;pid=44489&amp;registry=zookeeper&amp;timestamp=1637053498954。</li></ol><p>这两个元素除了头，其他的都一样，每个元素都会调用一遍doExportUrl()方法，但是protocolSPI已经变成了RegistryProtocol，RegistryProtocol类里有个内置对象protected Protocol protocol;这个protocol的类型是DubboProtocol，先看RegistryProtocol的export方法：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> Exporter<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> <span style=color:#50fa7b>export</span>(<span style=color:#8be9fd;font-style:italic>final</span> Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> originInvoker) <span style=color:#8be9fd;font-style:italic>throws</span> RpcException {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 拿到对应的url，设置一些属性</span>
</span></span><span style=display:flex><span>    URL registryUrl <span style=color:#ff79c6>=</span> getRegistryUrl(originInvoker);
</span></span><span style=display:flex><span>    URL providerUrl <span style=color:#ff79c6>=</span> getProviderUrl(originInvoker);
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>final</span> URL overrideSubscribeUrl <span style=color:#ff79c6>=</span> getSubscribedOverrideUrl(providerUrl);
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>final</span> OverrideListener overrideSubscribeListener <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> OverrideListener(overrideSubscribeUrl, originInvoker);
</span></span><span style=display:flex><span>    Map<span style=color:#ff79c6>&lt;</span>URL, NotifyListener<span style=color:#ff79c6>&gt;</span> overrideListeners <span style=color:#ff79c6>=</span> getProviderConfigurationListener(providerUrl).<span style=color:#50fa7b>getOverrideListeners</span>();
</span></span><span style=display:flex><span>    overrideListeners.<span style=color:#50fa7b>put</span>(registryUrl, overrideSubscribeListener);
</span></span><span style=display:flex><span>    providerUrl <span style=color:#ff79c6>=</span> overrideUrlWithConfig(providerUrl, overrideSubscribeListener);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 虽然叫doLocalExport，但是他是远程发布核心代码</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>final</span> ExporterChangeableWrapper<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> exporter <span style=color:#ff79c6>=</span> doLocalExport(originInvoker, providerUrl);
</span></span><span style=display:flex><span>    ……
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>new</span> DestroyableExporter<span style=color:#ff79c6>&lt;&gt;</span>(exporter);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>在doLocalExport()方法中调用了DubboProtocol的export方法，只要是远程发布，不管那个url都会调用DubboProtocol，dubboProtocol的export()方法中也没啥代码，就是又调用了一个openServer(url);方法，所以直接进到openServer方法里看：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>openServer</span>(URL url) {
</span></span><span style=display:flex><span>    checkDestroyed();
</span></span><span style=display:flex><span>    String key <span style=color:#ff79c6>=</span> url.<span style=color:#50fa7b>getAddress</span>();
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>boolean</span> isServer <span style=color:#ff79c6>=</span> url.<span style=color:#50fa7b>getParameter</span>(IS_SERVER_KEY, <span style=color:#ff79c6>true</span>);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (isServer) {
</span></span><span style=display:flex><span>        ProtocolServer server <span style=color:#ff79c6>=</span> serverMap.<span style=color:#50fa7b>get</span>(key);
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 第一次发布server是null</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (server <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#8be9fd;font-style:italic>synchronized</span> (<span style=color:#ff79c6>this</span>) {
</span></span><span style=display:flex><span>                server <span style=color:#ff79c6>=</span> serverMap.<span style=color:#50fa7b>get</span>(key);
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>if</span> (server <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>                    <span style=color:#6272a4>// 双重检查server还是null，所有又走到了createServer()</span>
</span></span><span style=display:flex><span>                    serverMap.<span style=color:#50fa7b>put</span>(key, createServer(url));
</span></span><span style=display:flex><span>                }<span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>                    server.<span style=color:#50fa7b>reset</span>(url);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// server supports reset, use together with override</span>
</span></span><span style=display:flex><span>            server.<span style=color:#50fa7b>reset</span>(url);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>这里又调用了createServer()，这个代码就会非常非常关键了：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>private</span> ProtocolServer <span style=color:#50fa7b>createServer</span>(URL url) {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 又是一顿处理url</span>
</span></span><span style=display:flex><span>    url <span style=color:#ff79c6>=</span> URLBuilder.<span style=color:#50fa7b>from</span>(url)
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// send readonly event when server closes, it&#39;s enabled by default</span>
</span></span><span style=display:flex><span>        .<span style=color:#50fa7b>addParameterIfAbsent</span>(CHANNEL_READONLYEVENT_SENT_KEY, Boolean.<span style=color:#50fa7b>TRUE</span>.<span style=color:#50fa7b>toString</span>())
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// enable heartbeat by default</span>
</span></span><span style=display:flex><span>        .<span style=color:#50fa7b>addParameterIfAbsent</span>(HEARTBEAT_KEY, String.<span style=color:#50fa7b>valueOf</span>(DEFAULT_HEARTBEAT))
</span></span><span style=display:flex><span>        .<span style=color:#50fa7b>addParameter</span>(CODEC_KEY, DubboCodec.<span style=color:#50fa7b>NAME</span>)
</span></span><span style=display:flex><span>        .<span style=color:#50fa7b>build</span>();
</span></span><span style=display:flex><span>    String str <span style=color:#ff79c6>=</span> url.<span style=color:#50fa7b>getParameter</span>(SERVER_KEY, DEFAULT_REMOTING_SERVER);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (StringUtils.<span style=color:#50fa7b>isNotEmpty</span>(str) <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!</span>url.<span style=color:#50fa7b>getOrDefaultFrameworkModel</span>().<span style=color:#50fa7b>getExtensionLoader</span>(Transporter.<span style=color:#50fa7b>class</span>).<span style=color:#50fa7b>hasExtension</span>(str)) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> RpcException(<span style=color:#f1fa8c>&#34;Unsupported server type: &#34;</span> <span style=color:#ff79c6>+</span> str <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;, url: &#34;</span> <span style=color:#ff79c6>+</span> url);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ExchangeServer server;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 应该是核心了</span>
</span></span><span style=display:flex><span>        server <span style=color:#ff79c6>=</span> Exchangers.<span style=color:#50fa7b>bind</span>(url, requestHandler);
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>catch</span> (RemotingException e) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> RpcException(<span style=color:#f1fa8c>&#34;Fail to start server(url: &#34;</span> <span style=color:#ff79c6>+</span> url <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;) &#34;</span> <span style=color:#ff79c6>+</span> e.<span style=color:#50fa7b>getMessage</span>(), e);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    str <span style=color:#ff79c6>=</span> url.<span style=color:#50fa7b>getParameter</span>(CLIENT_KEY);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (StringUtils.<span style=color:#50fa7b>isNotEmpty</span>(str)) {
</span></span><span style=display:flex><span>        Set<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span> supportedTypes <span style=color:#ff79c6>=</span> url.<span style=color:#50fa7b>getOrDefaultFrameworkModel</span>().<span style=color:#50fa7b>getExtensionLoader</span>(Transporter.<span style=color:#50fa7b>class</span>).<span style=color:#50fa7b>getSupportedExtensions</span>();
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>supportedTypes.<span style=color:#50fa7b>contains</span>(str)) {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> RpcException(<span style=color:#f1fa8c>&#34;Unsupported client type: &#34;</span> <span style=color:#ff79c6>+</span> str);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    DubboProtocolServer protocolServer <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> DubboProtocolServer(server);
</span></span><span style=display:flex><span>    loadServerProperties(protocolServer);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> protocolServer;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>刚开始以为上面的bind方法应该很关键，但是进去之后又没啥东西：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> ExchangeServer <span style=color:#50fa7b>bind</span>(URL url, ExchangeHandler handler) <span style=color:#8be9fd;font-style:italic>throws</span> RemotingException {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (url <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> IllegalArgumentException(<span style=color:#f1fa8c>&#34;url == null&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (handler <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> IllegalArgumentException(<span style=color:#f1fa8c>&#34;handler == null&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    url <span style=color:#ff79c6>=</span> url.<span style=color:#50fa7b>addParameterIfAbsent</span>(Constants.<span style=color:#50fa7b>CODEC_KEY</span>, <span style=color:#f1fa8c>&#34;exchange&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> getExchanger(url).<span style=color:#50fa7b>bind</span>(url, handler);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>继续往下跟getExchanger(url).bind(url, handler)，getExchanger返回了HeaderExchanger，继续：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>@Override
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> ExchangeServer <span style=color:#50fa7b>bind</span>(URL url, ExchangeHandler handler) <span style=color:#8be9fd;font-style:italic>throws</span> RemotingException {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>new</span> HeaderExchangeServer(Transporters.<span style=color:#50fa7b>bind</span>(url, <span style=color:#ff79c6>new</span> DecodeHandler(<span style=color:#ff79c6>new</span> HeaderExchangeHandler(handler))));
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>这里就是一直封装成ExchangeServer，调用了Transporters.bind：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> RemotingServer <span style=color:#50fa7b>bind</span>(URL url, ChannelHandler... handlers) <span style=color:#8be9fd;font-style:italic>throws</span> RemotingException {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (url <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> IllegalArgumentException(<span style=color:#f1fa8c>&#34;url == null&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (handlers <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>||</span> handlers.<span style=color:#50fa7b>length</span> <span style=color:#ff79c6>==</span> 0) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> IllegalArgumentException(<span style=color:#f1fa8c>&#34;handlers == null&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    ChannelHandler handler;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (handlers.<span style=color:#50fa7b>length</span> <span style=color:#ff79c6>==</span> 1) {
</span></span><span style=display:flex><span>        handler <span style=color:#ff79c6>=</span> handlers<span style=color:#ff79c6>[</span>0<span style=color:#ff79c6>]</span>;
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>        handler <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ChannelHandlerDispatcher(handlers);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 这个getTransporter是Transporter$Adaptive类型，又不能进断点了</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 但是Transporter$Adaptive对我们有用的实现类只有一个：NettyTransporter，netty4包下的</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 在这里构造一个NettyServer</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> getTransporter(url).<span style=color:#50fa7b>bind</span>(url, handler);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>bind里就是return new NettyServer(……)，点进去看也是调用父类的构造函数，所以直接进到父类AbstractServer中看构造方法：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#50fa7b>AbstractServer</span>(URL url, ChannelHandler handler) <span style=color:#8be9fd;font-style:italic>throws</span> RemotingException {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 这个super就是一个赋值操作，没啥东西</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>super</span>(url, handler);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 下面也是一些简单赋值</span>
</span></span><span style=display:flex><span>    executorRepository <span style=color:#ff79c6>=</span> url.<span style=color:#50fa7b>getOrDefaultApplicationModel</span>().<span style=color:#50fa7b>getExtensionLoader</span>(ExecutorRepository.<span style=color:#50fa7b>class</span>).<span style=color:#50fa7b>getDefaultExtension</span>();
</span></span><span style=display:flex><span>    localAddress <span style=color:#ff79c6>=</span> getUrl().<span style=color:#50fa7b>toInetSocketAddress</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    String bindIp <span style=color:#ff79c6>=</span> getUrl().<span style=color:#50fa7b>getParameter</span>(Constants.<span style=color:#50fa7b>BIND_IP_KEY</span>, getUrl().<span style=color:#50fa7b>getHost</span>());
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>int</span> bindPort <span style=color:#ff79c6>=</span> getUrl().<span style=color:#50fa7b>getParameter</span>(Constants.<span style=color:#50fa7b>BIND_PORT_KEY</span>, getUrl().<span style=color:#50fa7b>getPort</span>());
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (url.<span style=color:#50fa7b>getParameter</span>(ANYHOST_KEY, <span style=color:#ff79c6>false</span>) <span style=color:#ff79c6>||</span> NetUtils.<span style=color:#50fa7b>isInvalidLocalHost</span>(bindIp)) {
</span></span><span style=display:flex><span>        bindIp <span style=color:#ff79c6>=</span> ANYHOST_VALUE;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    bindAddress <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> InetSocketAddress(bindIp, bindPort);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>accepts</span> <span style=color:#ff79c6>=</span> url.<span style=color:#50fa7b>getParameter</span>(ACCEPTS_KEY, DEFAULT_ACCEPTS);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 关键就是这个</span>
</span></span><span style=display:flex><span>        doOpen();
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (logger.<span style=color:#50fa7b>isInfoEnabled</span>()) {
</span></span><span style=display:flex><span>            logger.<span style=color:#50fa7b>info</span>(<span style=color:#f1fa8c>&#34;Start &#34;</span> <span style=color:#ff79c6>+</span> getClass().<span style=color:#50fa7b>getSimpleName</span>() <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; bind &#34;</span> <span style=color:#ff79c6>+</span> getBindAddress() <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;, export &#34;</span> <span style=color:#ff79c6>+</span> getLocalAddress());
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>catch</span> (Throwable t) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> RemotingException(url.<span style=color:#50fa7b>toInetSocketAddress</span>(), <span style=color:#ff79c6>null</span>, <span style=color:#f1fa8c>&#34;Failed to bind &#34;</span> <span style=color:#ff79c6>+</span> getClass().<span style=color:#50fa7b>getSimpleName</span>()
</span></span><span style=display:flex><span>                                    <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; on &#34;</span> <span style=color:#ff79c6>+</span> getLocalAddress() <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;, cause: &#34;</span> <span style=color:#ff79c6>+</span> t.<span style=color:#50fa7b>getMessage</span>(), t);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    executor <span style=color:#ff79c6>=</span> executorRepository.<span style=color:#50fa7b>createExecutorIfAbsent</span>(url);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>找到了启动netty的代码doOpen()，这是个抽象方法，要回到netty4的NettyServer看实现：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>protected</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>doOpen</span>() <span style=color:#8be9fd;font-style:italic>throws</span> Throwable {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// ServerBootstrap相当于一个server服务器</span>
</span></span><span style=display:flex><span>    bootstrap <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ServerBootstrap();
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 轮询监听端口连接事件的线程池</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 使用netty的成熟框架都会根据操作系统来选择是EpollEventLoopGroup还是NioEventLoopGroup来提高性能</span>
</span></span><span style=display:flex><span>    bossGroup <span style=color:#ff79c6>=</span> NettyEventLoopFactory.<span style=color:#50fa7b>eventLoopGroup</span>(1, EVENT_LOOP_BOSS_POOL_NAME);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 处理监听到的事件的线程池</span>
</span></span><span style=display:flex><span>    workerGroup <span style=color:#ff79c6>=</span> NettyEventLoopFactory.<span style=color:#50fa7b>eventLoopGroup</span>(
</span></span><span style=display:flex><span>        getUrl().<span style=color:#50fa7b>getPositiveParameter</span>(IO_THREADS_KEY, Constants.<span style=color:#50fa7b>DEFAULT_IO_THREADS</span>),
</span></span><span style=display:flex><span>        EVENT_LOOP_WORKER_POOL_NAME);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 创建handler</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>final</span> NettyServerHandler nettyServerHandler <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> NettyServerHandler(getUrl(), <span style=color:#ff79c6>this</span>);
</span></span><span style=display:flex><span>    channels <span style=color:#ff79c6>=</span> nettyServerHandler.<span style=color:#50fa7b>getChannels</span>();
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 获取keepalive配置</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>boolean</span> keepalive <span style=color:#ff79c6>=</span> getUrl().<span style=color:#50fa7b>getParameter</span>(KEEP_ALIVE_KEY, Boolean.<span style=color:#50fa7b>FALSE</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    bootstrap.<span style=color:#50fa7b>group</span>(bossGroup, workerGroup)
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 这里也是根据操作系统判断使用EpollServerSocketChannel还是NioServerSocketChannel</span>
</span></span><span style=display:flex><span>        .<span style=color:#50fa7b>channel</span>(NettyEventLoopFactory.<span style=color:#50fa7b>serverSocketChannelClass</span>())
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// reuseAddr是true</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 这个是防止重启时四次挥手出错导致的重启报错Address already in use</span>
</span></span><span style=display:flex><span>        .<span style=color:#50fa7b>option</span>(ChannelOption.<span style=color:#50fa7b>SO_REUSEADDR</span>, Boolean.<span style=color:#50fa7b>TRUE</span>)
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// tcp no delay整合多个请求一起发送虽然吞吐量会变高，但是延迟也会变高</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 所以tcp no delay的意思是不把多个请求合并发送</span>
</span></span><span style=display:flex><span>        .<span style=color:#50fa7b>childOption</span>(ChannelOption.<span style=color:#50fa7b>TCP_NODELAY</span>, Boolean.<span style=color:#50fa7b>TRUE</span>)
</span></span><span style=display:flex><span>        .<span style=color:#50fa7b>childOption</span>(ChannelOption.<span style=color:#50fa7b>SO_KEEPALIVE</span>, keepalive)
</span></span><span style=display:flex><span>        .<span style=color:#50fa7b>childOption</span>(ChannelOption.<span style=color:#50fa7b>ALLOCATOR</span>, PooledByteBufAllocator.<span style=color:#50fa7b>DEFAULT</span>)
</span></span><span style=display:flex><span>        .<span style=color:#50fa7b>childHandler</span>(<span style=color:#ff79c6>new</span> ChannelInitializer<span style=color:#ff79c6>&lt;</span>SocketChannel<span style=color:#ff79c6>&gt;</span>() {
</span></span><span style=display:flex><span>            @Override
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 建立连接的操作</span>
</span></span><span style=display:flex><span>            <span style=color:#8be9fd;font-style:italic>protected</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>initChannel</span>(SocketChannel ch) <span style=color:#8be9fd;font-style:italic>throws</span> Exception {
</span></span><span style=display:flex><span>                <span style=color:#6272a4>// FIXME: should we use getTimeout()?</span>
</span></span><span style=display:flex><span>                <span style=color:#8be9fd>int</span> idleTimeout <span style=color:#ff79c6>=</span> UrlUtils.<span style=color:#50fa7b>getIdleTimeout</span>(getUrl());
</span></span><span style=display:flex><span>                NettyCodecAdapter adapter <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> NettyCodecAdapter(getCodec(), getUrl(), NettyServer.<span style=color:#50fa7b>this</span>);
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>if</span> (getUrl().<span style=color:#50fa7b>getParameter</span>(SSL_ENABLED_KEY, <span style=color:#ff79c6>false</span>)) {
</span></span><span style=display:flex><span>                    <span style=color:#6272a4>// 加密通信</span>
</span></span><span style=display:flex><span>                    ch.<span style=color:#50fa7b>pipeline</span>().<span style=color:#50fa7b>addLast</span>(<span style=color:#f1fa8c>&#34;negotiation&#34;</span>, <span style=color:#ff79c6>new</span> SslServerTlsHandler(getUrl()));
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                ch.<span style=color:#50fa7b>pipeline</span>()
</span></span><span style=display:flex><span>                    <span style=color:#6272a4>// 编解码</span>
</span></span><span style=display:flex><span>                    .<span style=color:#50fa7b>addLast</span>(<span style=color:#f1fa8c>&#34;decoder&#34;</span>, adapter.<span style=color:#50fa7b>getDecoder</span>())
</span></span><span style=display:flex><span>                    .<span style=color:#50fa7b>addLast</span>(<span style=color:#f1fa8c>&#34;encoder&#34;</span>, adapter.<span style=color:#50fa7b>getEncoder</span>())
</span></span><span style=display:flex><span>                    <span style=color:#6272a4>// 这个应该是机器空闲的处理</span>
</span></span><span style=display:flex><span>                    .<span style=color:#50fa7b>addLast</span>(<span style=color:#f1fa8c>&#34;server-idle-handler&#34;</span>, <span style=color:#ff79c6>new</span> IdleStateHandler(0, 0, idleTimeout, MILLISECONDS))
</span></span><span style=display:flex><span>                    <span style=color:#6272a4>// 业务处理代码，这里用的是NettyServerHandler</span>
</span></span><span style=display:flex><span>                    .<span style=color:#50fa7b>addLast</span>(<span style=color:#f1fa8c>&#34;handler&#34;</span>, nettyServerHandler);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// bind之后就可以监听网络了</span>
</span></span><span style=display:flex><span>    ChannelFutrue channelFutrue <span style=color:#ff79c6>=</span> bootstrap.<span style=color:#50fa7b>bind</span>(getBindAddress());
</span></span><span style=display:flex><span>    channelFutrue.<span style=color:#50fa7b>syncUninterruptibly</span>();
</span></span><span style=display:flex><span>    channel <span style=color:#ff79c6>=</span> channelFutrue.<span style=color:#50fa7b>channel</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>启动了nettyServer之后就可以把他注册到zk上去了，需要回到RegistryProtocol的export()方法中，执行完了doLocalExport(originInvoker, providerUrl)要继续往下走</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#6272a4>// 这里拿到的是ListenerRegistryWrapper</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>final</span> Registry registry <span style=color:#ff79c6>=</span> getRegistry(registryUrl);
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>final</span> URL registeredProviderUrl <span style=color:#ff79c6>=</span> getUrlToRegistry(providerUrl, registryUrl);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// decide if we need to delay publish</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>boolean</span> register <span style=color:#ff79c6>=</span> providerUrl.<span style=color:#50fa7b>getParameter</span>(REGISTER_KEY, <span style=color:#ff79c6>true</span>);
</span></span><span style=display:flex><span><span style=color:#ff79c6>if</span> (register) {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 注册的逻辑</span>
</span></span><span style=display:flex><span>    register(registry, registeredProviderUrl);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// 把url添加到ProviderModel</span>
</span></span><span style=display:flex><span>registerStatedUrl(registryUrl, registeredProviderUrl, register);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// 设置两个url</span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// registerUrl</span>
</span></span><span style=display:flex><span>exporter.<span style=color:#50fa7b>setRegisterUrl</span>(registeredProviderUrl);
</span></span><span style=display:flex><span><span style=color:#6272a4>// subscribeUrl</span>
</span></span><span style=display:flex><span>exporter.<span style=color:#50fa7b>setSubscribeUrl</span>(overrideSubscribeUrl);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>registry.<span style=color:#50fa7b>isServiceDiscovery</span>()) {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// Deprecated! Subscribe to override rules in 2.6.x or before.</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 这个弃用了，为了兼容2.6或之前版本？</span>
</span></span><span style=display:flex><span>    registry.<span style=color:#50fa7b>subscribe</span>(overrideSubscribeUrl, overrideSubscribeListener);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#6272a4>// 这个是执行监听的</span>
</span></span><span style=display:flex><span>notifyExport(exporter);
</span></span><span style=display:flex><span><span style=color:#6272a4>//Ensure that a new exporter instance is returned every time export</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>return</span> <span style=color:#ff79c6>new</span> DestroyableExporter<span style=color:#ff79c6>&lt;&gt;</span>(exporter);
</span></span></code></pre></td></tr></table></div></div><p>注册的逻辑就是registry.register(registeredProviderUrl);这个registry是之前生成的ListenerRegistryWrapper，ListenerRegistryWrapper的register()又调用了registry.register(url)，这个registry是Registry类型的全局对象，拿到的是ServiceDiscoveryRegistry类型，ServiceDiscoveryRegistry的register()又调用了同类的doRegister()方法：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>doRegister</span>(URL url) {
</span></span><span style=display:flex><span>    url <span style=color:#ff79c6>=</span> addRegistryClusterKey(url);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 这句很关键，核心了</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (writableMetadataService.<span style=color:#50fa7b>exportURL</span>(url)) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (logger.<span style=color:#50fa7b>isInfoEnabled</span>()) {
</span></span><span style=display:flex><span>            logger.<span style=color:#50fa7b>info</span>(format(<span style=color:#f1fa8c>&#34;The URL[%s] registered successfully.&#34;</span>, url.<span style=color:#50fa7b>toString</span>()));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (logger.<span style=color:#50fa7b>isWarnEnabled</span>()) {
</span></span><span style=display:flex><span>            logger.<span style=color:#50fa7b>warn</span>(format(<span style=color:#f1fa8c>&#34;The URL[%s] has been registered.&#34;</span>, url.<span style=color:#50fa7b>toString</span>()));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>writableMetadataService是WritableMetadataService类型的接口，他的实现类是InMemoryWritableMetadataService，看这名就知道是本地发布，直接跳过，看远程发布，回到ListenerRegistryWrapper，远程发布的时候registry变成了ZookeeperRegistry，但是ZookeeperRegistry并不是Registry的实现类，直接断点跟进去发现调用的是FailbackRegistry的register()方法，FailbackRegistry是Registry的实现类，FailbackRegistry还是一个抽象类，在register()方法中调用了抽象方法doRegister()，由子类实现，而ZookeeperRegistry就是他的子类，这样就回到了ZookeeperRegistry的doRegister方法：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>doRegister</span>(URL url) {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 这个就是检查zkClient有没有被初始化</span>
</span></span><span style=display:flex><span>        checkDestroyed();
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 自己封装的zkClient创建节点、添加监听什么的</span>
</span></span><span style=display:flex><span>        zkClient.<span style=color:#50fa7b>create</span>(toUrlPath(url), url.<span style=color:#50fa7b>getParameter</span>(DYNAMIC_KEY, <span style=color:#ff79c6>true</span>));
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>catch</span> (Throwable e) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> RpcException(<span style=color:#f1fa8c>&#34;Failed to register &#34;</span> <span style=color:#ff79c6>+</span> url <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; to zookeeper &#34;</span> <span style=color:#ff79c6>+</span> getUrl() <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;, cause: &#34;</span> <span style=color:#ff79c6>+</span> e.<span style=color:#50fa7b>getMessage</span>(), e);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>注册成功，启动结束。</p><p><img loading=lazy src=https://tva1.sinaimg.cn/large/008vxvgGly1h7tz463yp2j31lf0u0dkl.jpg></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://wangxiaohong123.github.io/tags/%E6%BA%90%E7%A0%81/>源码</a></li></ul><nav class=paginav><a class=prev href=https://wangxiaohong123.github.io/posts/flutter/2.dart%E5%9F%BA%E7%A1%80/><span class=title>« Prev</span><br><span>2.Dart基础</span>
</a><a class=next href=https://wangxiaohong123.github.io/posts/%E6%A1%86%E6%9E%B6/mq/rocketmq/2.nameserver%E7%9B%B8%E5%85%B3%E5%8E%9F%E7%90%86/><span class=title>Next »</span><br><span>2.nameServer相关原理</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share 2.dubbo-provider启动源码 on x" href="https://x.com/intent/tweet/?text=2.dubbo-provider%e5%90%af%e5%8a%a8%e6%ba%90%e7%a0%81&amp;url=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fspring%2fcloud-alibaba%2fdubbo%2f2.provider%25E5%2590%25AF%25E5%258A%25A8%25E6%25B5%2581%25E7%25A8%258B%2f&amp;hashtags=%e6%ba%90%e7%a0%81"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 2.dubbo-provider启动源码 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fspring%2fcloud-alibaba%2fdubbo%2f2.provider%25E5%2590%25AF%25E5%258A%25A8%25E6%25B5%2581%25E7%25A8%258B%2f&amp;title=2.dubbo-provider%e5%90%af%e5%8a%a8%e6%ba%90%e7%a0%81&amp;summary=2.dubbo-provider%e5%90%af%e5%8a%a8%e6%ba%90%e7%a0%81&amp;source=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fspring%2fcloud-alibaba%2fdubbo%2f2.provider%25E5%2590%25AF%25E5%258A%25A8%25E6%25B5%2581%25E7%25A8%258B%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 2.dubbo-provider启动源码 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fspring%2fcloud-alibaba%2fdubbo%2f2.provider%25E5%2590%25AF%25E5%258A%25A8%25E6%25B5%2581%25E7%25A8%258B%2f&title=2.dubbo-provider%e5%90%af%e5%8a%a8%e6%ba%90%e7%a0%81"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 2.dubbo-provider启动源码 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fspring%2fcloud-alibaba%2fdubbo%2f2.provider%25E5%2590%25AF%25E5%258A%25A8%25E6%25B5%2581%25E7%25A8%258B%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 2.dubbo-provider启动源码 on whatsapp" href="https://api.whatsapp.com/send?text=2.dubbo-provider%e5%90%af%e5%8a%a8%e6%ba%90%e7%a0%81%20-%20https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fspring%2fcloud-alibaba%2fdubbo%2f2.provider%25E5%2590%25AF%25E5%258A%25A8%25E6%25B5%2581%25E7%25A8%258B%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 2.dubbo-provider启动源码 on telegram" href="https://telegram.me/share/url?text=2.dubbo-provider%e5%90%af%e5%8a%a8%e6%ba%90%e7%a0%81&amp;url=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fspring%2fcloud-alibaba%2fdubbo%2f2.provider%25E5%2590%25AF%25E5%258A%25A8%25E6%25B5%2581%25E7%25A8%258B%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 2.dubbo-provider启动源码 on ycombinator" href="https://news.ycombinator.com/submitlink?t=2.dubbo-provider%e5%90%af%e5%8a%a8%e6%ba%90%e7%a0%81&u=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fspring%2fcloud-alibaba%2fdubbo%2f2.provider%25E5%2590%25AF%25E5%258A%25A8%25E6%25B5%2581%25E7%25A8%258B%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://wangxiaohong123.github.io/>王小红的笔记</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>