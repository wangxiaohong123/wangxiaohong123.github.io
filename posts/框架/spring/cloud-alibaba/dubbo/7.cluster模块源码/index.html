<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>7.cluster模块源码 | 王小红的笔记</title><meta name=keywords content="源码"><meta name=description content='cluster模块里主要的组件有Directory(管理集群信息)、Cluster+ClusterInvoker(集群容错)、LoadBalance(负载均衡)、Router(筛选可以访问的invokers)。
1.Directory
在源码中关于这个接口主要用到的实现类就是RegistryDirectory，RegistryDirectory是DynamicDirectory的子类，这两个实现类都是在dubbo_registry模块里的。先看DynamicDirectory的代码。
DynamicDirectory的类注释上写的RegistryDirectory，因为在2.6.x、2.7.x的版本这个类就是叫RegistryDirectory，3.0之后改名为DynamicDirectory，他是用来做目标服务发现和集群信息维护的最核心的组件，Dynamic的意思是维护目标实例集群地址不光要主动拉取，一般第一次的时候会主动拉取，还需要在注册中心注册监听，动态维护目标实例集群。注意这里只是目标实例，每个目标实例都有自己的DynamicDirectory，看构造方法，没啥东西，都是一些变量的初始化，url设置什么的，之前看到在实例化这个类之后调用了subscribe()方法，在进到这个方法里：
subscribe()源码


1
2
3
4
5
6
7


public void subscribe(URL url) {
    // 这个就是设置了一下url，set方法，没啥看的
    setSubscribeUrl(url);
    // 这个方法就很关键，用来在最开始的时候拿到目标服务实例集群地址
    // 订阅！用zk相关的registry进行订阅
    registry.subscribe(url, this);
}


这个时候的registry是ListenerRegistryWrapper，这个ListenerRegistryWrapper不是重点，因为他里面就是一个try finally，继续调用registry.subscribe(url, listener);这个时候的registry是ServiceDiscoveryRegistry……，最后会走到ZookeeperRegistry的doSubscribe()方法里。这个方法里会为节点添加监听：


1


zkClient.addChildListener(path, zkListener);


zk节点监听器中重写了childChanged()方法：


1
2
3
4
5
6
7
8
9


public void childChanged(String path, List<String> children) {
    try {
        latch.await();
    } catch (InterruptedException e) {
        logger.warn("Zookeeper children listener thread was interrupted unexpectedly, may cause race condition with the main thread.");
    }
    // notifier是在构造方法里创建的RegistryNotifier
    notifier.notify(children);
}


最后会一层一层调用到RegistryDirectory的refreshInvoker()方法，在这里会建立netty连接，构建DubboInvoker。'><meta name=author content><link rel=canonical href=https://wangxiaohong123.github.io/posts/%E6%A1%86%E6%9E%B6/spring/cloud-alibaba/dubbo/7.cluster%E6%A8%A1%E5%9D%97%E6%BA%90%E7%A0%81/><link crossorigin=anonymous href=/assets/css/stylesheet.08f7d74f0ada0f975d29ae436285b61ed7a719d05f350cb888d00341642995a2.css integrity="sha256-CPfXTwraD5ddKa5DYoW2HtenGdBfNQy4iNADQWQplaI=" rel="preload stylesheet" as=style><link rel=icon href=https://wangxiaohong123.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://wangxiaohong123.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://wangxiaohong123.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://wangxiaohong123.github.io/apple-touch-icon.png><link rel=mask-icon href=https://wangxiaohong123.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://wangxiaohong123.github.io/posts/%E6%A1%86%E6%9E%B6/spring/cloud-alibaba/dubbo/7.cluster%E6%A8%A1%E5%9D%97%E6%BA%90%E7%A0%81/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=/katex/katex.min.css><script defer src=/katex/katex.min.js></script><script defer src=/katex/auto-render.min.js onload=renderMathInElement(document.body)></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script><meta property="og:url" content="https://wangxiaohong123.github.io/posts/%E6%A1%86%E6%9E%B6/spring/cloud-alibaba/dubbo/7.cluster%E6%A8%A1%E5%9D%97%E6%BA%90%E7%A0%81/"><meta property="og:site_name" content="王小红的笔记"><meta property="og:title" content="7.cluster模块源码"><meta property="og:description" content='cluster模块里主要的组件有Directory(管理集群信息)、Cluster+ClusterInvoker(集群容错)、LoadBalance(负载均衡)、Router(筛选可以访问的invokers)。
1.Directory 在源码中关于这个接口主要用到的实现类就是RegistryDirectory，RegistryDirectory是DynamicDirectory的子类，这两个实现类都是在dubbo_registry模块里的。先看DynamicDirectory的代码。
DynamicDirectory的类注释上写的RegistryDirectory，因为在2.6.x、2.7.x的版本这个类就是叫RegistryDirectory，3.0之后改名为DynamicDirectory，他是用来做目标服务发现和集群信息维护的最核心的组件，Dynamic的意思是维护目标实例集群地址不光要主动拉取，一般第一次的时候会主动拉取，还需要在注册中心注册监听，动态维护目标实例集群。注意这里只是目标实例，每个目标实例都有自己的DynamicDirectory，看构造方法，没啥东西，都是一些变量的初始化，url设置什么的，之前看到在实例化这个类之后调用了subscribe()方法，在进到这个方法里：
subscribe()源码 1 2 3 4 5 6 7 public void subscribe(URL url) { // 这个就是设置了一下url，set方法，没啥看的 setSubscribeUrl(url); // 这个方法就很关键，用来在最开始的时候拿到目标服务实例集群地址 // 订阅！用zk相关的registry进行订阅 registry.subscribe(url, this); } 这个时候的registry是ListenerRegistryWrapper，这个ListenerRegistryWrapper不是重点，因为他里面就是一个try finally，继续调用registry.subscribe(url, listener);这个时候的registry是ServiceDiscoveryRegistry……，最后会走到ZookeeperRegistry的doSubscribe()方法里。这个方法里会为节点添加监听：
1 zkClient.addChildListener(path, zkListener); zk节点监听器中重写了childChanged()方法：
1 2 3 4 5 6 7 8 9 public void childChanged(String path, List<String> children) { try { latch.await(); } catch (InterruptedException e) { logger.warn("Zookeeper children listener thread was interrupted unexpectedly, may cause race condition with the main thread."); } // notifier是在构造方法里创建的RegistryNotifier notifier.notify(children); } 最后会一层一层调用到RegistryDirectory的refreshInvoker()方法，在这里会建立netty连接，构建DubboInvoker。'><meta property="og:locale" content="zh-CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:tag" content="源码"><meta name=twitter:card content="summary"><meta name=twitter:title content="7.cluster模块源码"><meta name=twitter:description content='cluster模块里主要的组件有Directory(管理集群信息)、Cluster+ClusterInvoker(集群容错)、LoadBalance(负载均衡)、Router(筛选可以访问的invokers)。
1.Directory
在源码中关于这个接口主要用到的实现类就是RegistryDirectory，RegistryDirectory是DynamicDirectory的子类，这两个实现类都是在dubbo_registry模块里的。先看DynamicDirectory的代码。
DynamicDirectory的类注释上写的RegistryDirectory，因为在2.6.x、2.7.x的版本这个类就是叫RegistryDirectory，3.0之后改名为DynamicDirectory，他是用来做目标服务发现和集群信息维护的最核心的组件，Dynamic的意思是维护目标实例集群地址不光要主动拉取，一般第一次的时候会主动拉取，还需要在注册中心注册监听，动态维护目标实例集群。注意这里只是目标实例，每个目标实例都有自己的DynamicDirectory，看构造方法，没啥东西，都是一些变量的初始化，url设置什么的，之前看到在实例化这个类之后调用了subscribe()方法，在进到这个方法里：
subscribe()源码


1
2
3
4
5
6
7


public void subscribe(URL url) {
    // 这个就是设置了一下url，set方法，没啥看的
    setSubscribeUrl(url);
    // 这个方法就很关键，用来在最开始的时候拿到目标服务实例集群地址
    // 订阅！用zk相关的registry进行订阅
    registry.subscribe(url, this);
}


这个时候的registry是ListenerRegistryWrapper，这个ListenerRegistryWrapper不是重点，因为他里面就是一个try finally，继续调用registry.subscribe(url, listener);这个时候的registry是ServiceDiscoveryRegistry……，最后会走到ZookeeperRegistry的doSubscribe()方法里。这个方法里会为节点添加监听：


1


zkClient.addChildListener(path, zkListener);


zk节点监听器中重写了childChanged()方法：


1
2
3
4
5
6
7
8
9


public void childChanged(String path, List<String> children) {
    try {
        latch.await();
    } catch (InterruptedException e) {
        logger.warn("Zookeeper children listener thread was interrupted unexpectedly, may cause race condition with the main thread.");
    }
    // notifier是在构造方法里创建的RegistryNotifier
    notifier.notify(children);
}


最后会一层一层调用到RegistryDirectory的refreshInvoker()方法，在这里会建立netty连接，构建DubboInvoker。'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://wangxiaohong123.github.io/posts/"},{"@type":"ListItem","position":2,"name":"7.cluster模块源码","item":"https://wangxiaohong123.github.io/posts/%E6%A1%86%E6%9E%B6/spring/cloud-alibaba/dubbo/7.cluster%E6%A8%A1%E5%9D%97%E6%BA%90%E7%A0%81/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"7.cluster模块源码","name":"7.cluster模块源码","description":"cluster模块里主要的组件有Directory(管理集群信息)、Cluster+ClusterInvoker(集群容错)、LoadBalance(负载均衡)、Router(筛选可以访问的invokers)。\n1.Directory 在源码中关于这个接口主要用到的实现类就是RegistryDirectory，RegistryDirectory是DynamicDirectory的子类，这两个实现类都是在dubbo_registry模块里的。先看DynamicDirectory的代码。\nDynamicDirectory的类注释上写的RegistryDirectory，因为在2.6.x、2.7.x的版本这个类就是叫RegistryDirectory，3.0之后改名为DynamicDirectory，他是用来做目标服务发现和集群信息维护的最核心的组件，Dynamic的意思是维护目标实例集群地址不光要主动拉取，一般第一次的时候会主动拉取，还需要在注册中心注册监听，动态维护目标实例集群。注意这里只是目标实例，每个目标实例都有自己的DynamicDirectory，看构造方法，没啥东西，都是一些变量的初始化，url设置什么的，之前看到在实例化这个类之后调用了subscribe()方法，在进到这个方法里：\nsubscribe()源码 1 2 3 4 5 6 7 public void subscribe(URL url) { // 这个就是设置了一下url，set方法，没啥看的 setSubscribeUrl(url); // 这个方法就很关键，用来在最开始的时候拿到目标服务实例集群地址 // 订阅！用zk相关的registry进行订阅 registry.subscribe(url, this); } 这个时候的registry是ListenerRegistryWrapper，这个ListenerRegistryWrapper不是重点，因为他里面就是一个try finally，继续调用registry.subscribe(url, listener);这个时候的registry是ServiceDiscoveryRegistry……，最后会走到ZookeeperRegistry的doSubscribe()方法里。这个方法里会为节点添加监听：\n1 zkClient.addChildListener(path, zkListener); zk节点监听器中重写了childChanged()方法：\n1 2 3 4 5 6 7 8 9 public void childChanged(String path, List\u0026lt;String\u0026gt; children) { try { latch.await(); } catch (InterruptedException e) { logger.warn(\u0026#34;Zookeeper children listener thread was interrupted unexpectedly, may cause race condition with the main thread.\u0026#34;); } // notifier是在构造方法里创建的RegistryNotifier notifier.notify(children); } 最后会一层一层调用到RegistryDirectory的refreshInvoker()方法，在这里会建立netty连接，构建DubboInvoker。\n","keywords":["源码"],"articleBody":"cluster模块里主要的组件有Directory(管理集群信息)、Cluster+ClusterInvoker(集群容错)、LoadBalance(负载均衡)、Router(筛选可以访问的invokers)。\n1.Directory 在源码中关于这个接口主要用到的实现类就是RegistryDirectory，RegistryDirectory是DynamicDirectory的子类，这两个实现类都是在dubbo_registry模块里的。先看DynamicDirectory的代码。\nDynamicDirectory的类注释上写的RegistryDirectory，因为在2.6.x、2.7.x的版本这个类就是叫RegistryDirectory，3.0之后改名为DynamicDirectory，他是用来做目标服务发现和集群信息维护的最核心的组件，Dynamic的意思是维护目标实例集群地址不光要主动拉取，一般第一次的时候会主动拉取，还需要在注册中心注册监听，动态维护目标实例集群。注意这里只是目标实例，每个目标实例都有自己的DynamicDirectory，看构造方法，没啥东西，都是一些变量的初始化，url设置什么的，之前看到在实例化这个类之后调用了subscribe()方法，在进到这个方法里：\nsubscribe()源码 1 2 3 4 5 6 7 public void subscribe(URL url) { // 这个就是设置了一下url，set方法，没啥看的 setSubscribeUrl(url); // 这个方法就很关键，用来在最开始的时候拿到目标服务实例集群地址 // 订阅！用zk相关的registry进行订阅 registry.subscribe(url, this); } 这个时候的registry是ListenerRegistryWrapper，这个ListenerRegistryWrapper不是重点，因为他里面就是一个try finally，继续调用registry.subscribe(url, listener);这个时候的registry是ServiceDiscoveryRegistry……，最后会走到ZookeeperRegistry的doSubscribe()方法里。这个方法里会为节点添加监听：\n1 zkClient.addChildListener(path, zkListener); zk节点监听器中重写了childChanged()方法：\n1 2 3 4 5 6 7 8 9 public void childChanged(String path, List\u003cString\u003e children) { try { latch.await(); } catch (InterruptedException e) { logger.warn(\"Zookeeper children listener thread was interrupted unexpectedly, may cause race condition with the main thread.\"); } // notifier是在构造方法里创建的RegistryNotifier notifier.notify(children); } 最后会一层一层调用到RegistryDirectory的refreshInvoker()方法，在这里会建立netty连接，构建DubboInvoker。\ndoList()源码 doList()方法就会获取可用的目标实例集群信息：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 public List\u003cInvoker\u003cT\u003e\u003e doList(Invocation invocation) { if (forbidden) { // 1. No service provider 2. Service providers are disabled throw new RpcException(RpcException.FORBIDDEN_EXCEPTION, \"No provider available from registry \" + getUrl().getAddress() + \" for service \" + getConsumerUrl().getServiceKey() + \" on consumer \" + NetUtils.getLocalHost() + \" use dubbo version \" + Version.getVersion() + \", please check status of providers(disabled, not registered or in blacklist).\"); } if (multiGroup) { return this.invokers == null ? Collections.emptyList() : this.invokers; } List\u003cInvoker\u003cT\u003e\u003e invokers = null; try { // 这里可以筛选出来可以访问的特定的provider实例 // 比如灰度发布，按照版本 invokers = routerChain.route(getConsumerUrl(), invocation); } catch (Throwable t) { logger.error(\"Failed to execute router: \" + getUrl() + \", cause: \" + t.getMessage(), t); } return invokers == null ? Collections.emptyList() : invokers; } 2.Cluster+ClusterInvoker 有6种集群容错策略：\n故障转移集群模式(failover)：呼叫失败的时候将自动切换到其他节点，也叫重试机制，如果接口支持幂等，允许重复调用可以使用这个模式。 快速失败模式(failfast)：只调用一次，如果失败就抛出异常，如果接口不支持幂等，就要用这个模式保证只掉1次，比如下单，如果失败就失败，让用户重新下单。 失败安全模式(failsafe)：如果调用失败，不抛出异常，只打印日志，如果接口的数据可有可无，使用这个模式。 失败自动恢复(failback)：调用失败会记录，然后定时重试。 并行多路调用模式(forking)：并行调用多个provider，返回第一个结果，他是并行调用，比较消耗CPU。 广播模式(broadcast)：广播所有provider，有一个失败就算失败。 除了并行模式和广播模式，其他的模式选择节点的代码都在AbstractClusterInvoker中，这个是他们的父类，选择节点的方法是select():\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 protected Invoker\u003cT\u003e select(LoadBalance loadbalance, Invocation invocation, List\u003cInvoker\u003cT\u003e\u003e invokers, List\u003cInvoker\u003cT\u003e\u003e selected) throws RpcException { if (CollectionUtils.isEmpty(invokers)) { return null; } // invocation差不多就表示一次调用，如果invocation是空，方法名会被定义成空字符串，否则就是invocation里的方法名 String methodName = invocation == null ? StringUtils.EMPTY_STRING : invocation.getMethodName(); // sticky默认是false // 这个是dubbo的粘滞链接 // 粘滞链接是尽可能保证多次调用到同一个provider // 什么时候会用到粘滞链接？比如调用一个provider，provider可能把结果缓存到jvm，我们就可以使用粘滞链接，避免其他provider再次缓存 boolean sticky = invokers.get(0).getUrl() .getMethodParameter(methodName, CLUSTER_STICKY_KEY, DEFAULT_CLUSTER_STICKY); // 经过一系列条件 // 如果!invokers.contains(stickyInvoker)说明provider挂了 // 此时应该重新选择一个粘滞链接 if (stickyInvoker != null \u0026\u0026 !invokers.contains(stickyInvoker)) { stickyInvoker = null; } //ignore concurrency problem if (sticky \u0026\u0026 stickyInvoker != null \u0026\u0026 (selected == null || !selected.contains(stickyInvoker))) { if (availablecheck \u0026\u0026 stickyInvoker.isAvailable()) { return stickyInvoker; } } // 走到这说明尽管设置了粘滞链接，但是没有生效 // 可能是因为第一次调用，也可能是provider挂了 // 此时需要根据负载均衡策略选择一个invoker Invoker\u003cT\u003e invoker = doSelect(loadbalance, invocation, invokers, selected); // 如果是粘滞链接就把stickyInvoker赋值 if (sticky) { stickyInvoker = invoker; } return invoker; } 这个方法只是进行校验和处理粘滞链接，真正的选择节点方法在doSelect()里：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 /** * 大概思路就是优先选择没有调用过的 * 如果没有满足条件的，在调用过的并且可用的节点中选择 * 如果调用过的节点中没有满足条件就使用下一个invoker，反正也是失败 */ private Invoker\u003cT\u003e doSelect(LoadBalance loadbalance, Invocation invocation, List\u003cInvoker\u003cT\u003e\u003e invokers, List\u003cInvoker\u003cT\u003e\u003e selected) throws RpcException { if (CollectionUtils.isEmpty(invokers)) { return null; } // 如果只有1个invoker，不需要复杂均衡直接返回这个invoker if (invokers.size() == 1) { return invokers.get(0); } // 负载均衡策略选择一个invoker Invoker\u003cT\u003e invoker = loadbalance.select(invokers, getUrl(), invocation); // 如果选择的invoker是已经选择过了，或者选择的invoker是不可用的就要重新选择一个invoker if ((selected != null \u0026\u0026 selected.contains(invoker)) || (!invoker.isAvailable() \u0026\u0026 getUrl() != null \u0026\u0026 availablecheck)) { try { // 重新选择 Invoker\u003cT\u003e rInvoker = reselect(loadbalance, invocation, invokers, selected, availablecheck); if (rInvoker != null) { invoker = rInvoker; } else { // 如果选来选去都是空直接拿到下一个invoker // 需要看一下什么时候会返回空 // invokers里的invoker都不可用会返回空 // loadbalance.select()也可能会返回空 int index = invokers.indexOf(invoker); try { //Avoid collision invoker = invokers.get((index + 1) % invokers.size()); } catch (Exception e) { logger.warn(e.getMessage() + \" may because invokers list dynamic change, ignore.\", e); } } } catch (Throwable t) { logger.error(\"cluster reselect fail reason is :\" + t.getMessage() + \" if can not solve, you can set cluster.availablecheck=false in url\", t); } } return invoker; } /** * 重新选择节点 */ private Invoker\u003cT\u003e reselect(LoadBalance loadbalance, Invocation invocation, List\u003cInvoker\u003cT\u003e\u003e invokers, List\u003cInvoker\u003cT\u003e\u003e selected, boolean availablecheck) throws RpcException { //Allocating one in advance, this list is certain to be used. List\u003cInvoker\u003cT\u003e\u003e reselectInvokers = new ArrayList\u003c\u003e( invokers.size() \u003e 1 ? (invokers.size() - 1) : invokers.size()); // 把可用的invoker和没选择过的invoker挑出来 for (Invoker\u003cT\u003e invoker : invokers) { if (availablecheck \u0026\u0026 !invoker.isAvailable()) { continue; } if (selected == null || !selected.contains(invoker)) { reselectInvokers.add(invoker); } } // 如果有没选择过的可用的invoker，重新根据负载均衡策略选择一次invoker if (!reselectInvokers.isEmpty()) { return loadbalance.select(reselectInvokers, getUrl(), invocation); } // 如果invokers里都是不可用的或者选择过的，就在可用的invoker里重新根据负载均衡策略选择一次invoker if (selected != null) { for (Invoker\u003cT\u003e invoker : selected) { if ((invoker.isAvailable()) // available first \u0026\u0026 !reselectInvokers.contains(invoker)) { reselectInvokers.add(invoker); } } } if (!reselectInvokers.isEmpty()) { return loadbalance.select(reselectInvokers, getUrl(), invocation); } return null; } 1)重试模式 重试模式对应FailoverClusterInvoker，发起rpc调用时会走到这个类的doInvoke()方法：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 public Result doInvoke(Invocation invocation, final List\u003cInvoker\u003cT\u003e\u003e invokers, LoadBalance loadbalance) throws RpcException { List\u003cInvoker\u003cT\u003e\u003e copyInvokers = invokers; // 检查invokers是否是空 checkInvokers(copyInvokers, invocation); String methodName = RpcUtils.getMethodName(invocation); // 计算invoke的次数，猜测这个跟重试相关的 // 根据的配置是retries + 1，但是默认值，一写用到相同配置的地方的默认值可能不一样 int len = calculateInvokeTimes(methodName); // retry loop. RpcException le = null; // last exception. List\u003cInvoker\u003cT\u003e\u003e invoked = new ArrayList\u003cInvoker\u003cT\u003e\u003e(copyInvokers.size()); // invoked invokers. // 这里放的是invoker的address，size还是len // 但是这个不是控制调用次数的，这个就是为了输出日志的 Set\u003cString\u003e providers = new HashSet\u003cString\u003e(len); for (int i = 0; i \u003c len; i++) { //Reselect before retry to avoid a change of candidate `invokers`. //NOTE: if `invokers` changed, then `invoked` also lose accuracy. if (i \u003e 0) { // 检查invoker是否被销毁 checkWhetherDestroyed(); // 重新拿到invokers copyInvokers = list(invocation); // 在检查一下目标肌群中是否有节点 checkInvokers(copyInvokers, invocation); } // 选择一个invoker Invoker\u003cT\u003e invoker = select(loadbalance, invocation, copyInvokers, invoked); // 尽量不重试已经请求过的invoker invoked.add(invoker); RpcContext.getServiceContext().setInvokers((List) invoked); try { // 这里就是执行rpc的代码了 Result result = invokeWithContext(invoker, invocation); if (le != null \u0026\u0026 logger.isWarnEnabled()) { // 虽然这次成功了，但是之前调用存在失败的情况 // 把失败的信息打印出来 logger.warn(\"Although retry the method \" + methodName + \" in the service \" + getInterface().getName() + \" was successful by the provider \" + invoker.getUrl().getAddress() + \", but there have been failed providers \" + providers + \" (\" + providers.size() + \"/\" + copyInvokers.size() + \") from the registry \" + directory.getUrl().getAddress() + \" on the consumer \" + NetUtils.getLocalHost() + \" using the dubbo version \" + Version.getVersion() + \". Last error is: \" + le.getMessage(), le); } return result; } catch (RpcException e) { if (e.isBiz()) { // biz exception. throw e; } le = e; } catch (Throwable e) { le = new RpcException(e.getMessage(), e); } finally { providers.add(invoker.getUrl().getAddress()); } } // 超过最大调用次数还是失败就抛出异常 throw new RpcException(le.getCode(), \"Failed to invoke the method \" + methodName + \" in the service \" + getInterface().getName() + \". Tried \" + len + \" times of the providers \" + providers + \" (\" + providers.size() + \"/\" + copyInvokers.size() + \") from the registry \" + directory.getUrl().getAddress() + \" on the consumer \" + NetUtils.getLocalHost() + \" using the dubbo version \" + Version.getVersion() + \". Last error is: \" + le.getMessage(), le.getCause() != null ? le.getCause() : le); } 2)快速失败模式 快速失败对应FailfastClusterInvoker，他和\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 public Result doInvoke(Invocation invocation, List\u003cInvoker\u003cT\u003e\u003e invokers, LoadBalance loadbalance) throws RpcException { // 检查节点是否为空 checkInvokers(invokers, invocation); Invoker\u003cT\u003e invoker = select(loadbalance, invocation, invokers, null); try { return invokeWithContext(invoker, invocation); } catch (Throwable e) { if (e instanceof RpcException \u0026\u0026 ((RpcException) e).isBiz()) { // biz exception. throw (RpcException) e; } throw new RpcException(e instanceof RpcException ? ((RpcException) e).getCode() : 0, \"Failfast invoke providers \" + invoker.getUrl() + \" \" + loadbalance.getClass().getSimpleName() + \" for service \" + getInterface().getName() + \" method \" + invocation.getMethodName() + \" on consumer \" + NetUtils.getLocalHost() + \" use dubbo version \" + Version.getVersion() + \", but no luck to perform the invocation. Last error is: \" + e.getMessage(), e.getCause() != null ? e.getCause() : e); } } 3)安全失败模式 failsafe模式对应FailsafeClusterInvoker\n1 2 3 4 5 6 7 8 9 10 public Result doInvoke(Invocation invocation, List\u003cInvoker\u003cT\u003e\u003e invokers, LoadBalance loadbalance) throws RpcException { try { checkInvokers(invokers, invocation); Invoker\u003cT\u003e invoker = select(loadbalance, invocation, invokers, null); return invokeWithContext(invoker, invocation); } catch (Throwable e) { logger.error(\"Failsafe ignore exception: \" + e.getMessage(), e); return AsyncRpcResult.newDefaultAsyncResult(null, null, invocation); // ignore } } 4)失败自动恢复模式 这个模式基于自己的时间轮实现的重试，对应FailbackClusterInvoker\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 protected Result doInvoke(Invocation invocation, List\u003cInvoker\u003cT\u003e\u003e invokers, LoadBalance loadbalance) throws RpcException { Invoker\u003cT\u003e invoker = null; URL consumerUrl = RpcContext.getServiceContext().getConsumerUrl(); try { checkInvokers(invokers, invocation); invoker = select(loadbalance, invocation, invokers, null); // Asynchronous call method must be used here, because failback will retry in the background. // Then the serviceContext will be cleared after the call is completed. // 这个是异步调用，但是方法体和invokeWithContext()一样 return invokeWithContextAsync(invoker, invocation, consumerUrl); } catch (Throwable e) { logger.error(\"Failback to invoke method \" + invocation.getMethodName() + \", wait for retry in background. Ignored exception: \" + e.getMessage() + \", \", e); if (retries \u003e 0) { // 如果配置了重试，提交到TimerTask addFailed(loadbalance, invocation, invokers, invoker, consumerUrl); } return AsyncRpcResult.newDefaultAsyncResult(null, null, invocation); // ignore } } 提交重试任务就是先初始化时间轮，然后通过时间轮定时重试任务：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 private void addFailed(LoadBalance loadbalance, Invocation invocation, List\u003cInvoker\u003cT\u003e\u003e invokers, Invoker\u003cT\u003e lastInvoker, URL consumerUrl) { // double check，保证多线程并发安全问题 // 初始化Hash时间轮 if (failTimer == null) { synchronized (this) { if (failTimer == null) { failTimer = new HashedWheelTimer( new NamedThreadFactory(\"failback-cluster-timer\", true), 1, TimeUnit.SECONDS, 32, failbackTasks); } } } // 创建重试任务 RetryTimerTask retryTimerTask = new RetryTimerTask(loadbalance, invocation, invokers, lastInvoker, retries, RETRY_FAILED_PERIOD, consumerUrl); try { failTimer.newTimeout(retryTimerTask, RETRY_FAILED_PERIOD, TimeUnit.SECONDS); } catch (Throwable e) { logger.error(\"Failback background works error, invocation-\u003e\" + invocation + \", exception: \" + e.getMessage()); } } TODO 时间轮源码：\n5)广播模式 广播模式对应BroadcastClusterInvoker\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 public Result doInvoke(final Invocation invocation, List\u003cInvoker\u003cT\u003e\u003e invokers, LoadBalance loadbalance) throws RpcException { checkInvokers(invokers, invocation); // 把所有目标节点放到RPC上下文里 RpcContext.getServiceContext().setInvokers((List) invokers); RpcException exception = null; Result result = null; URL url = getUrl(); // 这个是广播失败的比例容忍度，最小0，最大100，默认是100 // 这个参数不能决定调用结果，而是控制什么时候调用结束的，只要有一个失败，还是会返回异常 // 比如配置了30，意思是当调用失败比例达到30%将不再继续调用 int broadcastFailPercent = url.getParameter(BROADCAST_FAIL_PERCENT_KEY, MAX_BROADCAST_FAIL_PERCENT); if (broadcastFailPercent \u003c MIN_BROADCAST_FAIL_PERCENT || broadcastFailPercent \u003e MAX_BROADCAST_FAIL_PERCENT) { logger.info(String.format(\"The value corresponding to the broadcast.fail.percent parameter must be between 0 and 100. \" + \"The current setting is %s, which is reset to 100.\", broadcastFailPercent)); broadcastFailPercent = MAX_BROADCAST_FAIL_PERCENT; } // 根据比例计算允许失败的机器数 int failThresholdIndex = invokers.size() * broadcastFailPercent / MAX_BROADCAST_FAIL_PERCENT; int failIndex = 0; // 开始顺序遍历 // 只要失败的节点数没达到failThresholdIndex就一直遍历 for (Invoker\u003cT\u003e invoker : invokers) { try { result = invokeWithContext(invoker, invocation); if (null != result \u0026\u0026 result.hasException()) { Throwable resultException = result.getException(); if (null != resultException) { exception = getRpcException(result.getException()); logger.warn(exception.getMessage(), exception); failIndex++; if (failIndex == failThresholdIndex) { break; } } } } catch (Throwable e) { exception = getRpcException(e); logger.warn(exception.getMessage(), exception); failIndex++; if (failIndex == failThresholdIndex) { break; } } } // 有一个调用失败就是失败 if (exception != null) { if (failIndex == failThresholdIndex) { logger.debug( String.format(\"The number of BroadcastCluster call failures has reached the threshold %s\", failThresholdIndex)); } else { logger.debug(String.format(\"The number of BroadcastCluster call failures has not reached the threshold %s, fail size is %s\", failThresholdIndex, failIndex)); } throw exception; } return result; } 6)并行调用模式 forking模式对应ForkingClusterInvoker\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 public Result doInvoke(final Invocation invocation, List\u003cInvoker\u003cT\u003e\u003e invokers, LoadBalance loadbalance) throws RpcException { try { checkInvokers(invokers, invocation); final List\u003cInvoker\u003cT\u003e\u003e selected; // 默认并行度是2 final int forks = getUrl().getParameter(FORKS_KEY, DEFAULT_FORKS); // 默认超时时间是1s final int timeout = getUrl().getParameter(TIMEOUT_KEY, DEFAULT_TIMEOUT); if (forks \u003c= 0 || forks \u003e= invokers.size()) { // 如果配置的并行度小于0或者大于目标集群节点数量就把目标节点赋值成所有集群节点 selected = invokers; } else { // 否则就使用负载均衡一直选择节点，直到满足并行度 selected = new ArrayList\u003c\u003e(forks); while (selected.size() \u003c forks) { Invoker\u003cT\u003e invoker = select(loadbalance, invocation, invokers, selected); if (!selected.contains(invoker)) { //Avoid add the same invoker several times. selected.add(invoker); } } } RpcContext.getServiceContext().setInvokers((List) selected); final AtomicInteger count = new AtomicInteger(); final BlockingQueue\u003cObject\u003e ref = new LinkedBlockingQueue\u003c\u003e(); // 遍历invoker，把结果放到队列里 for (final Invoker\u003cT\u003e invoker : selected) { URL consumerUrl = RpcContext.getServiceContext().getConsumerUrl(); executor.execute(() -\u003e { try { Result result = invokeWithContextAsync(invoker, invocation, consumerUrl); ref.offer(result); } catch (Throwable e) { // 只要失败计数加1，如果计数==selected.size，就把这个结果放到队里里 // 这个是尽可能保证有成功的结果进到队列里 // 如果都失败也会有一个失败的结果进到队列里 int value = count.incrementAndGet(); if (value \u003e= selected.size()) { ref.offer(e); } } }); } try { // 拿到第一个结果，有结果就返回结果，是异常就抛出异常 Object ret = ref.poll(timeout, TimeUnit.MILLISECONDS); if (ret instanceof Throwable) { Throwable e = (Throwable) ret; throw new RpcException(e instanceof RpcException ? ((RpcException) e).getCode() : RpcException.UNKNOWN_EXCEPTION, \"Failed to forking invoke provider \" + selected + \", but no luck to perform the invocation. \" + \"Last error is: \" + e.getMessage(), e.getCause() != null ? e.getCause() : e); } return (Result) ret; } catch (InterruptedException e) { throw new RpcException(\"Failed to forking invoke provider \" + selected + \", \" + \"but no luck to perform the invocation. Last error is: \" + e.getMessage(), e); } } finally { // clear attachments which is binding to current thread. RpcContext.getClientAttachment().clearAttachments(); } } 3.LoadBalance dubbo自己实现了5中负载均衡算法：\n带权重的随机 带权重的轮询 最小活跃 一致性哈希 最短响应时间 负载均衡的父类是AbstractLoadBalance，这个里面有一个计算权重的方法：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 protected int getWeight(Invoker\u003c?\u003e invoker, Invocation invocation) { int weight; URL url = invoker.getUrl(); // 处理多注册中心场景 if (REGISTRY_SERVICE_REFERENCE_PATH.equals(url.getServiceInterface())) { weight = url.getParameter(REGISTRY_KEY + \".\" + WEIGHT_KEY, DEFAULT_WEIGHT); } else { // 获取方法的weight属性，默认是100 weight = url.getMethodParameter(invocation.getMethodName(), WEIGHT_KEY, DEFAULT_WEIGHT); if (weight \u003e 0) { // 获取timestamp配置 long timestamp = invoker.getUrl().getParameter(TIMESTAMP_KEY, 0L); if (timestamp \u003e 0L) { long uptime = System.currentTimeMillis() - timestamp; if (uptime \u003c 0) { return 1; } // 获取warmup配置，默认10 * 60 * 1000 int warmup = invoker.getUrl().getParameter(WARMUP_KEY, DEFAULT_WARMUP); if (uptime \u003e 0 \u0026\u0026 uptime \u003c warmup) { // 计算权重 weight = calculateWarmupWeight((int)uptime, warmup, weight); } } } } return Math.max(weight, 0); } 1）随机负载均衡 带权重的随机对应RandomLoadBalance，他在选择的时候回先判断是否需要权重：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 private \u003cT\u003e boolean needWeightLoadBalance(List\u003cInvoker\u003cT\u003e\u003e invokers, Invocation invocation) { Invoker invoker = invokers.get(0); URL invokerUrl = invoker.getUrl(); // 这个是处理RegistryService接口的 // 这个是多注册中心场景的负载均衡 if (REGISTRY_SERVICE_REFERENCE_PATH.equals(invokerUrl.getServiceInterface())) { String weight = invokerUrl.getParameter(REGISTRY_KEY + \".\" + WEIGHT_KEY); if (StringUtils.isNotEmpty(weight)) { return true; } } else { // 从方法的配置里获取weight的值，如果没有就从全局配置中获取 String weight = invokerUrl.getMethodParameter(invocation.getMethodName(), WEIGHT_KEY); if (StringUtils.isNotEmpty(weight)) { return true; }else { // 获取timestamp配置 String timeStamp = invoker.getUrl().getParameter(TIMESTAMP_KEY); if (StringUtils.isNotEmpty(timeStamp)) { return true; } } } return false; } 然后进行选择：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 protected \u003cT\u003e Invoker\u003cT\u003e doSelect(List\u003cInvoker\u003cT\u003e\u003e invokers, URL url, Invocation invocation) { // 拿到invokers的数量 int length = invokers.size(); // 判断是否使用权重 if (!needWeightLoadBalance(invokers,invocation)){ // 如果不需要权重，直接生成一个随机数 return invokers.get(ThreadLocalRandom.current().nextInt(length)); } // Every invoker has the same weight? boolean sameWeight = true; // the maxWeight of every invokers, the minWeight = 0 or the maxWeight of the last invoker int[] weights = new int[length]; // The sum of weights int totalWeight = 0; // 计算每个invoker的权重，他存的累加值。判断是否哦权重都相同 for (int i = 0; i \u003c length; i++) { // 获取权重 int weight = getWeight(invokers.get(i), invocation); // Sum totalWeight += weight; // save for later use weights[i] = totalWeight; if (sameWeight \u0026\u0026 totalWeight != weight * (i + 1)) { sameWeight = false; } } if (totalWeight \u003e 0 \u0026\u0026 !sameWeight) { // If (not every invoker has the same weight \u0026 at least one invoker's weight\u003e0), select randomly based on totalWeight. // 根据总权重生成一个随机值，然后根据这个随机值拿到一个invoker int offset = ThreadLocalRandom.current().nextInt(totalWeight); // Return a invoker based on the random value. for (int i = 0; i \u003c length; i++) { if (offset \u003c weights[i]) { return invokers.get(i); } } } // 如果权重相同或者权重都是0就随机选一个 return invokers.get(ThreadLocalRandom.current().nextInt(length)); } 2）轮询负载均衡 轮询对应RoundRobinLoadBalance：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 protected \u003cT\u003e Invoker\u003cT\u003e doSelect(List\u003cInvoker\u003cT\u003e\u003e invokers, URL url, Invocation invocation) { String key = invokers.get(0).getUrl().getServiceKey() + \".\" + invocation.getMethodName(); ConcurrentMap\u003cString, WeightedRoundRobin\u003e map = methodWeightMap.computeIfAbsent(key, k -\u003e new ConcurrentHashMap\u003c\u003e()); int totalWeight = 0; long maxCurrent = Long.MIN_VALUE; long now = System.currentTimeMillis(); Invoker\u003cT\u003e selectedInvoker = null; WeightedRoundRobin selectedWRR = null; for (Invoker\u003cT\u003e invoker : invokers) { String identifyString = invoker.getUrl().toIdentityString(); int weight = getWeight(invoker, invocation); WeightedRoundRobin weightedRoundRobin = map.computeIfAbsent(identifyString, k -\u003e { WeightedRoundRobin wrr = new WeightedRoundRobin(); wrr.setWeight(weight); return wrr; }); // 权重发生改变 if (weight != weightedRoundRobin.getWeight()) { //weight changed weightedRoundRobin.setWeight(weight); } long cur = weightedRoundRobin.increaseCurrent(); weightedRoundRobin.setLastUpdate(now); if (cur \u003e maxCurrent) { maxCurrent = cur; selectedInvoker = invoker; selectedWRR = weightedRoundRobin; } totalWeight += weight; } if (invokers.size() != map.size()) { map.entrySet().removeIf(item -\u003e now - item.getValue().getLastUpdate() \u003e RECYCLE_PERIOD); } if (selectedInvoker != null) { // 选中的invoker的权重要减去总权重 // 这样就能保证下次选择其他的invoker selectedWRR.sel(totalWeight); return selectedInvoker; } // should not happen here return invokers.get(0); } WeightedRoundRobin是他的内部类：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 protected static class WeightedRoundRobin { private int weight; private AtomicLong current = new AtomicLong(0); private long lastUpdate; public int getWeight() { return weight; } public void setWeight(int weight) { this.weight = weight; current.set(0); } public long increaseCurrent() { return current.addAndGet(weight); } public void sel(int total) { current.addAndGet(-1 * total); } public long getLastUpdate() { return lastUpdate; } public void setLastUpdate(long lastUpdate) { this.lastUpdate = lastUpdate; } } 3）最小活跃负载均衡 最小活跃对应LeastActiveLoadBalance\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 protected \u003cT\u003e Invoker\u003cT\u003e doSelect(List\u003cInvoker\u003cT\u003e\u003e invokers, URL url, Invocation invocation) { // Number of invokers int length = invokers.size(); // The least active value of all invokers int leastActive = -1; // The number of invokers having the same least active value (leastActive) int leastCount = 0; // The index of invokers having the same least active value (leastActive) int[] leastIndexes = new int[length]; // the weight of every invokers int[] weights = new int[length]; // The sum of the warmup weights of all the least active invokers int totalWeight = 0; // The weight of the first least active invoker int firstWeight = 0; // Every least active invoker has the same weight value? boolean sameWeight = true; // Filter out all the least active invokers for (int i = 0; i \u003c length; i++) { Invoker\u003cT\u003e invoker = invokers.get(i); // 获取invoker的调用次数 int active = RpcStatus.getStatus(invoker.getUrl(), invocation.getMethodName()).getActive(); // Get the weight of the invoker's configuration. The default value is 100. int afterWarmup = getWeight(invoker, invocation); // save for later use weights[i] = afterWarmup; // 如果是第一个invoker或者当前invoker的调用次数比上一个小 if (leastActive == -1 || active \u003c leastActive) { // Reset the active number of the current invoker to the least active number leastActive = active; // Reset the number of least active invokers leastCount = 1; // Put the first least active invoker first in leastIndexes leastIndexes[0] = i; // Reset totalWeight totalWeight = afterWarmup; // Record the weight the first least active invoker firstWeight = afterWarmup; // Each invoke has the same weight (only one invoker here) sameWeight = true; // If current invoker's active value equals with leaseActive, then accumulating. } else if (active == leastActive) { // Record the index of the least active invoker in leastIndexes order leastIndexes[leastCount++] = i; // Accumulate the total weight of the least active invoker totalWeight += afterWarmup; // If every invoker has the same weight? if (sameWeight \u0026\u0026 afterWarmup != firstWeight) { sameWeight = false; } } } // Choose an invoker from all the least active invokers if (leastCount == 1) { // If we got exactly one invoker having the least active value, return this invoker directly. return invokers.get(leastIndexes[0]); } if (!sameWeight \u0026\u0026 totalWeight \u003e 0) { // If (not every invoker has the same weight \u0026 at least one invoker's weight\u003e0), select randomly based on // totalWeight. int offsetWeight = ThreadLocalRandom.current().nextInt(totalWeight); // Return a invoker based on the random value. for (int i = 0; i \u003c leastCount; i++) { int leastIndex = leastIndexes[i]; offsetWeight -= weights[leastIndex]; if (offsetWeight \u003c 0) { return invokers.get(leastIndex); } } } // If all invokers have the same weight value or totalWeight=0, return evenly. return invokers.get(leastIndexes[ThreadLocalRandom.current().nextInt(leastCount)]); } 4）一致性hash负载均衡 一致性hash对应ConsistentHashLoadBalance：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 protected \u003cT\u003e Invoker\u003cT\u003e doSelect(List\u003cInvoker\u003cT\u003e\u003e invokers, URL url, Invocation invocation) { String methodName = RpcUtils.getMethodName(invocation); String key = invokers.get(0).getUrl().getServiceKey() + \".\" + methodName; // using the hashcode of list to compute the hash only pay attention to the elements in the list // 根据invokers的list计算hash值 int invokersHashCode = getCorrespondingHashCode(invokers); ConsistentHashSelector\u003cT\u003e selector = (ConsistentHashSelector\u003cT\u003e) selectors.get(key); // 根据接口+方法名初始化一个ConsistentHashSelector if (selector == null || selector.identityHashCode != invokersHashCode) { selectors.put(key, new ConsistentHashSelector\u003cT\u003e(invokers, methodName, invokersHashCode)); selector = (ConsistentHashSelector\u003cT\u003e) selectors.get(key); } // 调用一致性hash的select方法 return selector.select(invocation); } ConsistentHashSelector是他的内部类：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 private static final class ConsistentHashSelector\u003cT\u003e { private final TreeMap\u003cLong, Invoker\u003cT\u003e\u003e virtualInvokers; private final int replicaNumber; private final int identityHashCode; private final int[] argumentIndex; /** * key: server(invoker) address * value: count of requests accept by certain server */ private Map\u003cString, AtomicLong\u003e serverRequestCountMap = new ConcurrentHashMap\u003c\u003e(); /** * count of total requests accept by all servers */ private AtomicLong totalRequestCount; /** * count of current servers(invokers) */ private int serverCount; /** * the ratio which allow count of requests accept by each server * overrate average (totalRequestCount/serverCount). * 1.5 is recommended, in the futrue we can make this param configurable */ private static final double OVERLOAD_RATIO_THREAD = 1.5F; ConsistentHashSelector(List\u003cInvoker\u003cT\u003e\u003e invokers, String methodName, int identityHashCode) { // virtualInvokers就是虚拟节点 this.virtualInvokers = new TreeMap\u003cLong, Invoker\u003cT\u003e\u003e(); this.identityHashCode = identityHashCode; URL url = invokers.get(0).getUrl(); this.replicaNumber = url.getMethodParameter(methodName, HASH_NODES, 160); String[] index = COMMA_SPLIT_PATTERN.split(url.getMethodParameter(methodName, HASH_ARGUMENTS, \"0\")); argumentIndex = new int[index.length]; for (int i = 0; i \u003c index.length; i++) { argumentIndex[i] = Integer.parseInt(index[i]); } // 每个invoker对应几个虚拟节点 for (Invoker\u003cT\u003e invoker : invokers) { String address = invoker.getUrl().getAddress(); for (int i = 0; i \u003c replicaNumber / 4; i++) { byte[] digest = Bytes.getMD5(address + i); for (int h = 0; h \u003c 4; h++) { long m = hash(digest, h); virtualInvokers.put(m, invoker); } } } totalRequestCount = new AtomicLong(0); serverCount = invokers.size(); serverRequestCountMap.clear(); } public Invoker\u003cT\u003e select(Invocation invocation) { String key = toKey(invocation.getArguments()); byte[] digest = Bytes.getMD5(key); return selectForKey(hash(digest, 0)); } private String toKey(Object[] args) { StringBuilder buf = new StringBuilder(); for (int i : argumentIndex) { if (i \u003e= 0 \u0026\u0026 i \u003c args.length) { buf.append(args[i]); } } return buf.toString(); } private Invoker\u003cT\u003e selectForKey(long hash) { Map.Entry\u003cLong, Invoker\u003cT\u003e\u003e entry = virtualInvokers.ceilingEntry(hash); if (entry == null) { entry = virtualInvokers.firstEntry(); } String serverAddress = entry.getValue().getUrl().getAddress(); /** * The following part of codes aims to select suitable invoker. * This part is not complete thread safety. * However, in the scene of consumer-side load balance, * thread race for this part of codes * (execution time cost for this part of codes without any IO or * network operation is very low) will rarely occur. And even in * extreme case, a few requests are assigned to an invoker which * is above OVERLOAD_RATIO_THREAD will not make a significant impact * on the effect of this new algorithm. * And make this part of codes synchronized will reduce efficiency of * every request. In my opinion, this is not worth. So it is not a * problem for this part is not complete thread safety. */ double overloadThread = ((double) totalRequestCount.get() / (double) serverCount) * OVERLOAD_RATIO_THREAD; /** * Find a valid server node: * 1. Not have accept request yet * or * 2. Not have overloaded (request count already accept \u003c thread (average request count * overloadRatioAllowed )) */ while (serverRequestCountMap.containsKey(serverAddress) \u0026\u0026 serverRequestCountMap.get(serverAddress).get() \u003e= overloadThread) { /** * If server node is not valid, get next node */ entry = getNextInvokerNode(virtualInvokers, entry); serverAddress = entry.getValue().getUrl().getAddress(); } if (!serverRequestCountMap.containsKey(serverAddress)) { serverRequestCountMap.put(serverAddress, new AtomicLong(1)); } else { serverRequestCountMap.get(serverAddress).incrementAndGet(); } totalRequestCount.incrementAndGet(); return entry.getValue(); } private Map.Entry\u003cLong, Invoker\u003cT\u003e\u003e getNextInvokerNode(TreeMap\u003cLong, Invoker\u003cT\u003e\u003e virtualInvokers, Map.Entry\u003cLong, Invoker\u003cT\u003e\u003e entry){ Map.Entry\u003cLong, Invoker\u003cT\u003e\u003e nextEntry = virtualInvokers.higherEntry(entry.getKey()); if(nextEntry == null){ return virtualInvokers.firstEntry(); } return nextEntry; } private long hash(byte[] digest, int number) { return (((long) (digest[3 + number * 4] \u0026 0xFF) \u003c\u003c 24) | ((long) (digest[2 + number * 4] \u0026 0xFF) \u003c\u003c 16) | ((long) (digest[1 + number * 4] \u0026 0xFF) \u003c\u003c 8) | (digest[number * 4] \u0026 0xFF)) \u0026 0xFFFFFFFFL; } } 3.自动降级机制 在调用容错策略对应的Invoker之前会经过MockCLusterInvoker，他的Invoker组成了严格的责任链模式，这个Invoker是负责处理mock配置的，有两种选择，force开头的潜质mock和普通mock，强制mock就是不发起远程调用，直接本地模拟，普通mock会在远程调用失败的时候才进行模拟调用：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 public Result invoke(Invocation invocation) throws RpcException { // 模拟调用的意思就是如果目标provider故障了，这个时候consumer可以降级调用 // 降级使用的就是mock模拟，不发起远程调用 Result result; // 获取mock配置 String value = getUrl().getMethodParameter(invocation.getMethodName(), MOCK_KEY, Boolean.FALSE.toString()).trim(); if (value.length() == 0 || \"false\".equalsIgnoreCase(value)) { // 处理no mock的情况 // 发起正常的情况 // 这个时候invoker是AbstractCluster的内部类ClusterFilterInvoker result = this.invoker.invoke(invocation); } else if (value.startsWith(FORCE_KEY)) { // 如果mock的配置是force开头就说明是强制mock // 这个时候是不会走远程调用的 if (logger.isWarnEnabled()) { logger.warn(\"force-mock: \" + invocation.getMethodName() + \" force-mock enabled , url : \" + getUrl()); } //force:direct mock result = doMockInvoke(invocation, null); } else { // 这个就是正常的mock // 先远程调用，如果失败了就走模拟调用 try { result = this.invoker.invoke(invocation); //fix:#4585 if(result.getException() != null \u0026\u0026 result.getException() instanceof RpcException){ RpcException rpcException= (RpcException)result.getException(); if(rpcException.isBiz()){ throw rpcException; }else { result = doMockInvoke(invocation, rpcException); } } } catch (RpcException e) { if (e.isBiz()) { throw e; } if (logger.isWarnEnabled()) { logger.warn(\"fail-mock: \" + invocation.getMethodName() + \" fail-mock enabled , url : \" + getUrl(), e); } result = doMockInvoke(invocation, e); } } return result; } 模拟调用的源码：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 private Result doMockInvoke(Invocation invocation, RpcException e) { Result result; Invoker\u003cT\u003e mockInvoker; // 选择模拟的invoker // 他这个里面就是给invocation设置了一个invocation.need.mock参数 // 然后把DynamicDirectory的invokers返回了 List\u003cInvoker\u003cT\u003e\u003e mockInvokers = selectMockInvoker(invocation); // 如果DynamicDirectory里的invokers不是空就拿第一个，否则新建一个MockInvoker if (CollectionUtils.isEmpty(mockInvokers)) { mockInvoker = (Invoker\u003cT\u003e) new MockInvoker(getUrl(), directory.getInterface()); } else { // TODO 这里看一下还是会走正常调用，但是invocation多了一个invocation.need.mock参数 // 估计后面会判断这个参数不执行远程调用 mockInvoker = mockInvokers.get(0); } try { result = mockInvoker.invoke(invocation); } catch (RpcException mockException) { if (mockException.isBiz()) { result = AsyncRpcResult.newDefaultAsyncResult(mockException.getCause(), invocation); } else { throw new RpcException(mockException.getCode(), getMockExceptionMessage(e, mockException), mockException.getCause()); } } catch (Throwable me) { throw new RpcException(getMockExceptionMessage(e, me), me.getCause()); } return result; } 执行远程调用的方式有两种，一种是invokers全部下线使用MockInvoker模拟，另外一种还是正常的Invoker执行，但是invocation多了一个invocation.need.mock参数。\n使用MockInvoker模拟调用： 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 public Result invoke(Invocation invocation) throws RpcException { if (invocation instanceof RpcInvocation) { ((RpcInvocation) invocation).setInvoker(this); } String mock = getUrl().getMethodParameter(invocation.getMethodName(), MOCK_KEY); if (StringUtils.isBlank(mock)) { throw new RpcException(new IllegalAccessException(\"mock can not be null. url :\" + url)); } // 根据mock参数的前缀设置mock变量 mock = normalizeMock(URL.decode(mock)); if (mock.startsWith(RETURN_PREFIX)) { mock = mock.substring(RETURN_PREFIX.length()).trim(); try { Type[] returnTypes = RpcUtils.getReturnTypes(invocation); // 根据returnType拿到返回的默认值 Object value = parseMockValue(mock, returnTypes); return AsyncRpcResult.newDefaultAsyncResult(value, invocation); } catch (Exception ew) { throw new RpcException(\"mock return invoke error. method :\" + invocation.getMethodName() + \", mock:\" + mock + \", url: \" + url, ew); } } else if (mock.startsWith(THROW_PREFIX)) { // 配置的mock是抛出异常就直接抛出异常 mock = mock.substring(THROW_PREFIX.length()).trim(); if (StringUtils.isBlank(mock)) { throw new RpcException(\"mocked exception for service degradation.\"); } else { // user customized class Throwable t = getThrowable(mock); throw new RpcException(RpcException.BIZ_EXCEPTION, t); } } else { //impl mock // 执行自己实现的mock类 try { Invoker\u003cT\u003e invoker = getInvoker(mock); return invoker.invoke(invocation); } catch (Throwable t) { throw new RpcException(\"Failed to create mock implementation class \" + mock, t); } } } 通过invocation配置invocation.need.mock参数实现mock 这种方式的视线在MockInvokersSelector的route()方法中，这种情况会根据invokers中有没有配置成mock的provider返回，没有会返回空集合。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 public \u003cT\u003e List\u003cInvoker\u003cT\u003e\u003e route(final List\u003cInvoker\u003cT\u003e\u003e invokers, URL url, final Invocation invocation) throws RpcException { if (CollectionUtils.isEmpty(invokers)) { return invokers; } if (invocation.getObjectAttachments() == null) { return getNormalInvokers(invokers); } else { String value = (String) invocation.getObjectAttachments().get(INVOCATION_NEED_MOCK); if (value == null) { return getNormalInvokers(invokers); } else if (Boolean.TRUE.toString().equalsIgnoreCase(value)) { return getMockedInvokers(invokers); } } return invokers; } private \u003cT\u003e List\u003cInvoker\u003cT\u003e\u003e getMockedInvokers(final List\u003cInvoker\u003cT\u003e\u003e invokers) { if (!hasMockProviders(invokers)) { return null; } List\u003cInvoker\u003cT\u003e\u003e sInvokers = new ArrayList\u003cInvoker\u003cT\u003e\u003e(1); for (Invoker\u003cT\u003e invoker : invokers) { if (invoker.getUrl().getProtocol().equals(MOCK_PROTOCOL)) { sInvokers.add(invoker); } } return sInvokers; } 4.Router dubbo的条件路由\nRouter的实现类在RouterChain类中使用，他是在DynamicDirectory中调用的RouterChain的构造方法构建Route链条：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 private RouterChain(URL url) { // 获取线程池组件 executorRepository = url.getOrDefaultApplicationModel().getExtensionLoader(ExecutorRepository.class) .getDefaultExtension(); // 创建一个新的线程池 loopPool = executorRepository.nextExecutorExecutor(); // 获取自动激活的RouterFactory List\u003cRouterFactory\u003e extensionFactories = url.getOrDefaultApplicationModel().getExtensionLoader(RouterFactory.class) .getActivateExtension(url, ROUTER_KEY); // 获取Router list List\u003cRouter\u003e routers = extensionFactories.stream() .map(factory -\u003e factory.getRouter(url)) .sorted(Router::compareTo) .collect(Collectors.toList()); // 这里没什么东西 initWithRouters(routers); // 这里应该能拿到3种RouterFactory // CacheableStateRouterFactory(可缓存的Router) // TagDynamicStateRouterFactory(动态标签Router) // TagStaticStateRouterFactory(静态标签Router) // 基于TagRouter可以实现灰度发布、蓝绿发布 List\u003cStateRouterFactory\u003e extensionStateRouterFactories = url.getOrDefaultApplicationModel() .getExtensionLoader(StateRouterFactory.class) .getActivateExtension(url, STATE_ROUTER_KEY); List\u003cStateRouter\u003e stateRouters = extensionStateRouterFactories.stream() .map(factory -\u003e factory.getRouter(url, this)) .sorted(StateRouter::compareTo) .collect(Collectors.toList()); // init state routers initWithStateRouters(stateRouters); } 当invoker发生改变时一定会调用RouterChain的setInvokers()方法，这个方法会遍历stateRouters更新invokers。\n随便看几个主要的Router：\n1）ConditionRouter 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 public \u003cT\u003e List\u003cInvoker\u003cT\u003e\u003e route(List\u003cInvoker\u003cT\u003e\u003e invokers, URL url, Invocation invocation) throws RpcException { if (!enabled) { return invokers; } if (CollectionUtils.isEmpty(invokers)) { return invokers; } try { // 如果invokers都不符合条件，就返回原来的 // 就是根据参数和值进行匹配 if (!matchWhen(url, invocation)) { return invokers; } List\u003cInvoker\u003cT\u003e\u003e result = new ArrayList\u003cInvoker\u003cT\u003e\u003e(); if (thenCondition == null) { logger.warn(\"The current consumer in the service blacklist. consumer: \" + NetUtils.getLocalHost() + \", service: \" + url.getServiceKey()); return result; } for (Invoker\u003cT\u003e invoker : invokers) { // 再次匹配 if (matchThen(invoker.getUrl(), url)) { result.add(invoker); } } if (!result.isEmpty()) { return result; } else if (this.isForce()) { logger.warn(\"The route result is empty and force execute. consumer: \" + NetUtils.getLocalHost() + \", service: \" + url.getServiceKey() + \", router: \" + url.getParameterAndDecoded(RULE_KEY)); return result; } } catch (Throwable t) { logger.error(\"Failed to execute condition router rule: \" + getUrl() + \", invokers: \" + invokers + \", cause: \" + t.getMessage(), t); } return invokers; } 2）AppRouter AppRouter是ListenableRouter的子类，当配置规则改变的时候会回调process()方法，这里维护了List conditionRouters列表，route()方法也是拿到所有的ConditionRouter进行过滤：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 public synchronized void process(ConfigChangedEvent event) { if (logger.isDebugEnabled()) { logger.debug(\"Notification of condition rule, change type is: \" + event.getChangeType() + \", raw rule is:\\n \" + event.getContent()); } if (event.getChangeType().equals(ConfigChangeType.DELETED)) { routerRule = null; conditionRouters = Collections.emptyList(); } else { try { // 这个routerRule就是List conditions routerRule = ConditionRuleParser.parse(event.getContent()); generateConditions(routerRule); } catch (Exception e) { logger.error(\"Failed to parse the raw condition rule and it will not take effect, please check \" + \"if the condition rule matches with the template, the raw rule is:\\n \" + event.getContent(), e); } } } 2）ScriptRouter 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 public \u003cT\u003e List\u003cInvoker\u003cT\u003e\u003e route(List\u003cInvoker\u003cT\u003e\u003e invokers, URL url, Invocation invocation) throws RpcException { if (engine == null || function == null) { return invokers; } Bindings bindings = createBindings(invokers, invocation); return getRoutedInvokers(AccessController.doPrivileged((PrivilegedAction\u003cObject\u003e) () -\u003e { try { // 动态运行脚本 return function.eval(bindings); } catch (ScriptException e) { logger.error(\"route error, rule has been ignored. rule: \" + rule + \", method:\" + invocation.getMethodName() + \", url: \" + RpcContext.getContext().getUrl(), e); return invokers; } }, accessControlContext)); } 3）TagRouter 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 public \u003cT\u003e List\u003cInvoker\u003cT\u003e\u003e route(List\u003cInvoker\u003cT\u003e\u003e invokers, URL url, Invocation invocation) throws RpcException { if (CollectionUtils.isEmpty(invokers)) { return invokers; } // since the rule can be changed by config center, we should copy one to use. final TagRouterRule tagRouterRuleCopy = tagRouterRule; if (tagRouterRuleCopy == null || !tagRouterRuleCopy.isValid() || !tagRouterRuleCopy.isEnabled()) { return filterUsingStaticTag(invokers, url, invocation); } List\u003cInvoker\u003cT\u003e\u003e result = invokers; // 主要是根据tag属性匹配 String tag = StringUtils.isEmpty(invocation.getAttachment(TAG_KEY)) ? url.getParameter(TAG_KEY) : invocation.getAttachment(TAG_KEY); // if we are requesting for a Provider with a specific tag if (StringUtils.isNotEmpty(tag)) { List\u003cString\u003e addresses = tagRouterRuleCopy.getTagnameToAddresses().get(tag); // filter by dynamic tag group first if (CollectionUtils.isNotEmpty(addresses)) { result = filterInvoker(invokers, invoker -\u003e addressMatches(invoker.getUrl(), addresses)); // if result is not null OR it's null but force=true, return result directly if (CollectionUtils.isNotEmpty(result) || tagRouterRuleCopy.isForce()) { return result; } } else { // dynamic tag group doesn't have any item about the requested app OR it's null after filtered by // dynamic tag group but force=false. check static tag result = filterInvoker(invokers, invoker -\u003e tag.equals(invoker.getUrl().getParameter(TAG_KEY))); } // If there's no tagged providers that can match the current tagged request. force.tag is set by default // to false, which means it will invoke any providers without a tag unless it's explicitly disallowed. if (CollectionUtils.isNotEmpty(result) || isForceUseTag(invocation)) { return result; } // FAILOVER: return all Providers without any tags. else { List\u003cInvoker\u003cT\u003e\u003e tmp = filterInvoker(invokers, invoker -\u003e addressNotMatches(invoker.getUrl(), tagRouterRuleCopy.getAddresses())); return filterInvoker(tmp, invoker -\u003e StringUtils.isEmpty(invoker.getUrl().getParameter(TAG_KEY))); } } else { // List addresses = tagRouterRule.filter(providerApp); // return all addresses in dynamic tag group. List\u003cString\u003e addresses = tagRouterRuleCopy.getAddresses(); if (CollectionUtils.isNotEmpty(addresses)) { result = filterInvoker(invokers, invoker -\u003e addressNotMatches(invoker.getUrl(), addresses)); // 1. all addresses are in dynamic tag group, return empty list. if (CollectionUtils.isEmpty(result)) { return result; } // 2. if there are some addresses that are not in any dynamic tag group, continue to filter using the // static tag group. } return filterInvoker(result, invoker -\u003e { String localTag = invoker.getUrl().getParameter(TAG_KEY); return StringUtils.isEmpty(localTag) || !tagRouterRuleCopy.getTagNames().contains(localTag); }); } } 4）MeshRuleRouter 流量管理路由策略，主要分为两块，VirtualService和DestinationRule。\n当consumer调用服务的时候会根据DubboRoute和DubboRouteDetail匹配到DubboDestination中对应的subset。\nVirtualService 主要处理入站流量分流的规则，支持服务级别和方法级别的分流。 DubboRoute 主要解决服务级别的分流问题。同时，还提供的重试机制、超时、故障注入、镜像流量等能力。 DubboRouteDetail 主要解决某个服务中方法级别的分流问题。支持方法名、方法参数、参数个数、参数类型、header 等各种维度的分流能力。同时也支持方法级的重试机制、超时、故障注入、镜像流量等能力。 DubboDestination 用来描述路由流量的目标地址，支持 host、port、subnet 等方式。 DestinationRule 主要处理目标地址规则，可以通过 hosts、subnet 等方式关联到 Provider 集群。同时可以通过 trafficPolicy 来实现负载均衡。 ","wordCount":"5817","inLanguage":"en","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://wangxiaohong123.github.io/posts/%E6%A1%86%E6%9E%B6/spring/cloud-alibaba/dubbo/7.cluster%E6%A8%A1%E5%9D%97%E6%BA%90%E7%A0%81/"},"publisher":{"@type":"Organization","name":"王小红的笔记","logo":{"@type":"ImageObject","url":"https://wangxiaohong123.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wangxiaohong123.github.io/ accesskey=h title="王小红的笔记 (Alt + H)">王小红的笔记</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://wangxiaohong123.github.io/posts/ title=笔记><span>笔记</span></a></li><li><a href=https://wangxiaohong123.github.io/categories/ title=分类><span>分类</span></a></li><li><a href=https://wangxiaohong123.github.io/tags/ title=标签><span>标签</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">7.cluster模块源码</h1><div class=post-meta>28 min</div></header><div class=post-content><p>cluster模块里主要的组件有Directory(管理集群信息)、Cluster+ClusterInvoker(集群容错)、LoadBalance(负载均衡)、Router(筛选可以访问的invokers)。</p><h3 id=1directory>1.Directory<a hidden class=anchor aria-hidden=true href=#1directory>#</a></h3><p>在源码中关于这个接口主要用到的实现类就是RegistryDirectory，RegistryDirectory是DynamicDirectory的子类，这两个实现类都是在dubbo_registry模块里的。先看DynamicDirectory的代码。</p><p>DynamicDirectory的类注释上写的RegistryDirectory，因为在2.6.x、2.7.x的版本这个类就是叫RegistryDirectory，3.0之后改名为DynamicDirectory，他是用来做目标服务发现和集群信息维护的最核心的组件，Dynamic的意思是维护目标实例集群地址不光要主动拉取，一般第一次的时候会主动拉取，还需要在注册中心注册监听，动态维护目标实例集群。注意这里只是目标实例，每个目标实例都有自己的DynamicDirectory，看构造方法，没啥东西，都是一些变量的初始化，url设置什么的，之前看到在实例化这个类之后调用了subscribe()方法，在进到这个方法里：</p><h5 id=subscribe源码>subscribe()源码<a hidden class=anchor aria-hidden=true href=#subscribe源码>#</a></h5><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>subscribe</span>(URL url) {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 这个就是设置了一下url，set方法，没啥看的</span>
</span></span><span style=display:flex><span>    setSubscribeUrl(url);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 这个方法就很关键，用来在最开始的时候拿到目标服务实例集群地址</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 订阅！用zk相关的registry进行订阅</span>
</span></span><span style=display:flex><span>    registry.<span style=color:#50fa7b>subscribe</span>(url, <span style=color:#ff79c6>this</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>这个时候的registry是ListenerRegistryWrapper，这个ListenerRegistryWrapper不是重点，因为他里面就是一个try finally，继续调用registry.subscribe(url, listener);这个时候的registry是ServiceDiscoveryRegistry……，最后会走到ZookeeperRegistry的doSubscribe()方法里。这个方法里会为节点添加监听：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>zkClient.<span style=color:#50fa7b>addChildListener</span>(path, zkListener);
</span></span></code></pre></td></tr></table></div></div><p>zk节点监听器中重写了childChanged()方法：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>childChanged</span>(String path, List<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span> children) {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>        latch.<span style=color:#50fa7b>await</span>();
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>catch</span> (InterruptedException e) {
</span></span><span style=display:flex><span>        logger.<span style=color:#50fa7b>warn</span>(<span style=color:#f1fa8c>&#34;Zookeeper children listener thread was interrupted unexpectedly, may cause race condition with the main thread.&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// notifier是在构造方法里创建的RegistryNotifier</span>
</span></span><span style=display:flex><span>    notifier.<span style=color:#50fa7b>notify</span>(children);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>最后会一层一层调用到RegistryDirectory的refreshInvoker()方法，在这里会建立netty连接，构建DubboInvoker。</p><h5 id=dolist源码>doList()源码<a hidden class=anchor aria-hidden=true href=#dolist源码>#</a></h5><p>doList()方法就会获取可用的目标实例集群信息：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> List<span style=color:#ff79c6>&lt;</span>Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> <span style=color:#50fa7b>doList</span>(Invocation invocation) {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (forbidden) {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 1. No service provider 2. Service providers are disabled</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> RpcException(RpcException.<span style=color:#50fa7b>FORBIDDEN_EXCEPTION</span>, <span style=color:#f1fa8c>&#34;No provider available from registry &#34;</span> <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>                               getUrl().<span style=color:#50fa7b>getAddress</span>() <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; for service &#34;</span> <span style=color:#ff79c6>+</span> getConsumerUrl().<span style=color:#50fa7b>getServiceKey</span>() <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; on consumer &#34;</span> <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>                               NetUtils.<span style=color:#50fa7b>getLocalHost</span>() <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; use dubbo version &#34;</span> <span style=color:#ff79c6>+</span> Version.<span style=color:#50fa7b>getVersion</span>() <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>                               <span style=color:#f1fa8c>&#34;, please check status of providers(disabled, not registered or in blacklist).&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (multiGroup) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>invokers</span> <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>?</span> Collections.<span style=color:#50fa7b>emptyList</span>() : <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>invokers</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    List<span style=color:#ff79c6>&lt;</span>Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> invokers <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 这里可以筛选出来可以访问的特定的provider实例</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 比如灰度发布，按照版本</span>
</span></span><span style=display:flex><span>        invokers <span style=color:#ff79c6>=</span> routerChain.<span style=color:#50fa7b>route</span>(getConsumerUrl(), invocation);
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>catch</span> (Throwable t) {
</span></span><span style=display:flex><span>        logger.<span style=color:#50fa7b>error</span>(<span style=color:#f1fa8c>&#34;Failed to execute router: &#34;</span> <span style=color:#ff79c6>+</span> getUrl() <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;, cause: &#34;</span> <span style=color:#ff79c6>+</span> t.<span style=color:#50fa7b>getMessage</span>(), t);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> invokers <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>?</span> Collections.<span style=color:#50fa7b>emptyList</span>() : invokers;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=2clusterclusterinvoker>2.Cluster+ClusterInvoker<a hidden class=anchor aria-hidden=true href=#2clusterclusterinvoker>#</a></h3><p>有6种集群容错策略：</p><ol><li>故障转移集群模式(failover)：呼叫失败的时候将自动切换到其他节点，也叫重试机制，如果接口支持幂等，允许重复调用可以使用这个模式。</li><li>快速失败模式(failfast)：只调用一次，如果失败就抛出异常，如果接口不支持幂等，就要用这个模式保证只掉1次，比如下单，如果失败就失败，让用户重新下单。</li><li>失败安全模式(failsafe)：如果调用失败，不抛出异常，只打印日志，如果接口的数据可有可无，使用这个模式。</li><li>失败自动恢复(failback)：调用失败会记录，然后定时重试。</li><li>并行多路调用模式(forking)：并行调用多个provider，返回第一个结果，他是并行调用，比较消耗CPU。</li><li>广播模式(broadcast)：广播所有provider，有一个失败就算失败。</li></ol><p>除了并行模式和广播模式，其他的模式选择节点的代码都在AbstractClusterInvoker中，这个是他们的父类，选择节点的方法是select():</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>protected</span> Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> <span style=color:#50fa7b>select</span>(LoadBalance loadbalance, Invocation invocation,
</span></span><span style=display:flex><span>                            List<span style=color:#ff79c6>&lt;</span>Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> invokers, List<span style=color:#ff79c6>&lt;</span>Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> selected) <span style=color:#8be9fd;font-style:italic>throws</span> RpcException {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (CollectionUtils.<span style=color:#50fa7b>isEmpty</span>(invokers)) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// invocation差不多就表示一次调用，如果invocation是空，方法名会被定义成空字符串，否则就是invocation里的方法名</span>
</span></span><span style=display:flex><span>    String methodName <span style=color:#ff79c6>=</span> invocation <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>?</span> StringUtils.<span style=color:#50fa7b>EMPTY_STRING</span> : invocation.<span style=color:#50fa7b>getMethodName</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// sticky默认是false</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 这个是dubbo的粘滞链接</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 粘滞链接是尽可能保证多次调用到同一个provider</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 什么时候会用到粘滞链接？比如调用一个provider，provider可能把结果缓存到jvm，我们就可以使用粘滞链接，避免其他provider再次缓存</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>boolean</span> sticky <span style=color:#ff79c6>=</span> invokers.<span style=color:#50fa7b>get</span>(0).<span style=color:#50fa7b>getUrl</span>()
</span></span><span style=display:flex><span>            .<span style=color:#50fa7b>getMethodParameter</span>(methodName, CLUSTER_STICKY_KEY, DEFAULT_CLUSTER_STICKY);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 经过一系列条件</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 如果!invokers.contains(stickyInvoker)说明provider挂了</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 此时应该重新选择一个粘滞链接</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (stickyInvoker <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!</span>invokers.<span style=color:#50fa7b>contains</span>(stickyInvoker)) {
</span></span><span style=display:flex><span>        stickyInvoker <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#6272a4>//ignore concurrency problem</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (sticky <span style=color:#ff79c6>&amp;&amp;</span> stickyInvoker <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> (selected <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>||</span> <span style=color:#ff79c6>!</span>selected.<span style=color:#50fa7b>contains</span>(stickyInvoker))) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (availablecheck <span style=color:#ff79c6>&amp;&amp;</span> stickyInvoker.<span style=color:#50fa7b>isAvailable</span>()) {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> stickyInvoker;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 走到这说明尽管设置了粘滞链接，但是没有生效</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 可能是因为第一次调用，也可能是provider挂了</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 此时需要根据负载均衡策略选择一个invoker</span>
</span></span><span style=display:flex><span>    Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> invoker <span style=color:#ff79c6>=</span> doSelect(loadbalance, invocation, invokers, selected);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 如果是粘滞链接就把stickyInvoker赋值</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (sticky) {
</span></span><span style=display:flex><span>        stickyInvoker <span style=color:#ff79c6>=</span> invoker;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> invoker;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>这个方法只是进行校验和处理粘滞链接，真正的选择节点方法在doSelect()里：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">88
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * 大概思路就是优先选择没有调用过的
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * 如果没有满足条件的，在调用过的并且可用的节点中选择
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * 如果调用过的节点中没有满足条件就使用下一个invoker，反正也是失败
</span></span></span><span style=display:flex><span><span style=color:#6272a4> */</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>private</span> Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> <span style=color:#50fa7b>doSelect</span>(LoadBalance loadbalance, Invocation invocation,
</span></span><span style=display:flex><span>                            List<span style=color:#ff79c6>&lt;</span>Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> invokers, List<span style=color:#ff79c6>&lt;</span>Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> selected) <span style=color:#8be9fd;font-style:italic>throws</span> RpcException {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (CollectionUtils.<span style=color:#50fa7b>isEmpty</span>(invokers)) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 如果只有1个invoker，不需要复杂均衡直接返回这个invoker</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (invokers.<span style=color:#50fa7b>size</span>() <span style=color:#ff79c6>==</span> 1) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> invokers.<span style=color:#50fa7b>get</span>(0);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 负载均衡策略选择一个invoker</span>
</span></span><span style=display:flex><span>    Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> invoker <span style=color:#ff79c6>=</span> loadbalance.<span style=color:#50fa7b>select</span>(invokers, getUrl(), invocation);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 如果选择的invoker是已经选择过了，或者选择的invoker是不可用的就要重新选择一个invoker</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> ((selected <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> selected.<span style=color:#50fa7b>contains</span>(invoker))
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>||</span> (<span style=color:#ff79c6>!</span>invoker.<span style=color:#50fa7b>isAvailable</span>() <span style=color:#ff79c6>&amp;&amp;</span> getUrl() <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> availablecheck)) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 重新选择</span>
</span></span><span style=display:flex><span>            Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> rInvoker <span style=color:#ff79c6>=</span> reselect(loadbalance, invocation, invokers, selected, availablecheck);
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (rInvoker <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>                invoker <span style=color:#ff79c6>=</span> rInvoker;
</span></span><span style=display:flex><span>            } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>                <span style=color:#6272a4>// 如果选来选去都是空直接拿到下一个invoker</span>
</span></span><span style=display:flex><span>                <span style=color:#6272a4>// 需要看一下什么时候会返回空</span>
</span></span><span style=display:flex><span>                <span style=color:#6272a4>// invokers里的invoker都不可用会返回空</span>
</span></span><span style=display:flex><span>                <span style=color:#6272a4>// loadbalance.select()也可能会返回空</span>
</span></span><span style=display:flex><span>                <span style=color:#8be9fd>int</span> index <span style=color:#ff79c6>=</span> invokers.<span style=color:#50fa7b>indexOf</span>(invoker);
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>                    <span style=color:#6272a4>//Avoid collision</span>
</span></span><span style=display:flex><span>                    invoker <span style=color:#ff79c6>=</span> invokers.<span style=color:#50fa7b>get</span>((index <span style=color:#ff79c6>+</span> 1) <span style=color:#ff79c6>%</span> invokers.<span style=color:#50fa7b>size</span>());
</span></span><span style=display:flex><span>                } <span style=color:#ff79c6>catch</span> (Exception e) {
</span></span><span style=display:flex><span>                    logger.<span style=color:#50fa7b>warn</span>(e.<span style=color:#50fa7b>getMessage</span>() <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; may because invokers list dynamic change, ignore.&#34;</span>, e);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>catch</span> (Throwable t) {
</span></span><span style=display:flex><span>            logger.<span style=color:#50fa7b>error</span>(<span style=color:#f1fa8c>&#34;cluster reselect fail reason is :&#34;</span> <span style=color:#ff79c6>+</span> t.<span style=color:#50fa7b>getMessage</span>() <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; if can not solve, you can set cluster.availablecheck=false in url&#34;</span>, t);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> invoker;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * 重新选择节点
</span></span></span><span style=display:flex><span><span style=color:#6272a4> */</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>private</span> Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> <span style=color:#50fa7b>reselect</span>(LoadBalance loadbalance, Invocation invocation,
</span></span><span style=display:flex><span>                            List<span style=color:#ff79c6>&lt;</span>Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> invokers, List<span style=color:#ff79c6>&lt;</span>Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> selected, <span style=color:#8be9fd>boolean</span> availablecheck) <span style=color:#8be9fd;font-style:italic>throws</span> RpcException {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>//Allocating one in advance, this list is certain to be used.</span>
</span></span><span style=display:flex><span>    List<span style=color:#ff79c6>&lt;</span>Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> reselectInvokers <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ArrayList<span style=color:#ff79c6>&lt;&gt;</span>(
</span></span><span style=display:flex><span>            invokers.<span style=color:#50fa7b>size</span>() <span style=color:#ff79c6>&gt;</span> 1 <span style=color:#ff79c6>?</span> (invokers.<span style=color:#50fa7b>size</span>() <span style=color:#ff79c6>-</span> 1) : invokers.<span style=color:#50fa7b>size</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 把可用的invoker和没选择过的invoker挑出来</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> (Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> invoker : invokers) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (availablecheck <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!</span>invoker.<span style=color:#50fa7b>isAvailable</span>()) {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>continue</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (selected <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>||</span> <span style=color:#ff79c6>!</span>selected.<span style=color:#50fa7b>contains</span>(invoker)) {
</span></span><span style=display:flex><span>            reselectInvokers.<span style=color:#50fa7b>add</span>(invoker);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 如果有没选择过的可用的invoker，重新根据负载均衡策略选择一次invoker</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>reselectInvokers.<span style=color:#50fa7b>isEmpty</span>()) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> loadbalance.<span style=color:#50fa7b>select</span>(reselectInvokers, getUrl(), invocation);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 如果invokers里都是不可用的或者选择过的，就在可用的invoker里重新根据负载均衡策略选择一次invoker</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (selected <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>for</span> (Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> invoker : selected) {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> ((invoker.<span style=color:#50fa7b>isAvailable</span>()) <span style=color:#6272a4>// available first</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!</span>reselectInvokers.<span style=color:#50fa7b>contains</span>(invoker)) {
</span></span><span style=display:flex><span>                reselectInvokers.<span style=color:#50fa7b>add</span>(invoker);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>reselectInvokers.<span style=color:#50fa7b>isEmpty</span>()) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> loadbalance.<span style=color:#50fa7b>select</span>(reselectInvokers, getUrl(), invocation);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h6 id=1重试模式>1)重试模式<a hidden class=anchor aria-hidden=true href=#1重试模式>#</a></h6><p>重试模式对应FailoverClusterInvoker，发起rpc调用时会走到这个类的doInvoke()方法：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> Result <span style=color:#50fa7b>doInvoke</span>(Invocation invocation, <span style=color:#8be9fd;font-style:italic>final</span> List<span style=color:#ff79c6>&lt;</span>Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> invokers, LoadBalance loadbalance) <span style=color:#8be9fd;font-style:italic>throws</span> RpcException {
</span></span><span style=display:flex><span>    List<span style=color:#ff79c6>&lt;</span>Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> copyInvokers <span style=color:#ff79c6>=</span> invokers;
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 检查invokers是否是空</span>
</span></span><span style=display:flex><span>    checkInvokers(copyInvokers, invocation);
</span></span><span style=display:flex><span>    String methodName <span style=color:#ff79c6>=</span> RpcUtils.<span style=color:#50fa7b>getMethodName</span>(invocation);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 计算invoke的次数，猜测这个跟重试相关的</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 根据的配置是retries + 1，但是默认值，一写用到相同配置的地方的默认值可能不一样</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>int</span> len <span style=color:#ff79c6>=</span> calculateInvokeTimes(methodName);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// retry loop.</span>
</span></span><span style=display:flex><span>    RpcException le <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span>; <span style=color:#6272a4>// last exception.</span>
</span></span><span style=display:flex><span>    List<span style=color:#ff79c6>&lt;</span>Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> invoked <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ArrayList<span style=color:#ff79c6>&lt;</span>Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span>(copyInvokers.<span style=color:#50fa7b>size</span>()); <span style=color:#6272a4>// invoked invokers.</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 这里放的是invoker的address，size还是len</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 但是这个不是控制调用次数的，这个就是为了输出日志的</span>
</span></span><span style=display:flex><span>    Set<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span> providers <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> HashSet<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span>(len);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> 0; i <span style=color:#ff79c6>&lt;</span> len; i<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>//Reselect before retry to avoid a change of candidate `invokers`.</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>//NOTE: if `invokers` changed, then `invoked` also lose accuracy.</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (i <span style=color:#ff79c6>&gt;</span> 0) {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 检查invoker是否被销毁</span>
</span></span><span style=display:flex><span>            checkWhetherDestroyed();
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 重新拿到invokers</span>
</span></span><span style=display:flex><span>            copyInvokers <span style=color:#ff79c6>=</span> list(invocation);
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 在检查一下目标肌群中是否有节点</span>
</span></span><span style=display:flex><span>            checkInvokers(copyInvokers, invocation);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 选择一个invoker</span>
</span></span><span style=display:flex><span>        Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> invoker <span style=color:#ff79c6>=</span> select(loadbalance, invocation, copyInvokers, invoked);
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 尽量不重试已经请求过的invoker</span>
</span></span><span style=display:flex><span>        invoked.<span style=color:#50fa7b>add</span>(invoker);
</span></span><span style=display:flex><span>        RpcContext.<span style=color:#50fa7b>getServiceContext</span>().<span style=color:#50fa7b>setInvokers</span>((List) invoked);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 这里就是执行rpc的代码了</span>
</span></span><span style=display:flex><span>            Result result <span style=color:#ff79c6>=</span> invokeWithContext(invoker, invocation);
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (le <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> logger.<span style=color:#50fa7b>isWarnEnabled</span>()) {
</span></span><span style=display:flex><span>                <span style=color:#6272a4>// 虽然这次成功了，但是之前调用存在失败的情况</span>
</span></span><span style=display:flex><span>                <span style=color:#6272a4>// 把失败的信息打印出来</span>
</span></span><span style=display:flex><span>                logger.<span style=color:#50fa7b>warn</span>(<span style=color:#f1fa8c>&#34;Although retry the method &#34;</span> <span style=color:#ff79c6>+</span> methodName
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; in the service &#34;</span> <span style=color:#ff79c6>+</span> getInterface().<span style=color:#50fa7b>getName</span>()
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; was successful by the provider &#34;</span> <span style=color:#ff79c6>+</span> invoker.<span style=color:#50fa7b>getUrl</span>().<span style=color:#50fa7b>getAddress</span>()
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;, but there have been failed providers &#34;</span> <span style=color:#ff79c6>+</span> providers
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; (&#34;</span> <span style=color:#ff79c6>+</span> providers.<span style=color:#50fa7b>size</span>() <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;/&#34;</span> <span style=color:#ff79c6>+</span> copyInvokers.<span style=color:#50fa7b>size</span>()
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;) from the registry &#34;</span> <span style=color:#ff79c6>+</span> directory.<span style=color:#50fa7b>getUrl</span>().<span style=color:#50fa7b>getAddress</span>()
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; on the consumer &#34;</span> <span style=color:#ff79c6>+</span> NetUtils.<span style=color:#50fa7b>getLocalHost</span>()
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; using the dubbo version &#34;</span> <span style=color:#ff79c6>+</span> Version.<span style=color:#50fa7b>getVersion</span>() <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;. Last error is: &#34;</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>+</span> le.<span style=color:#50fa7b>getMessage</span>(), le);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> result;
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>catch</span> (RpcException e) {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (e.<span style=color:#50fa7b>isBiz</span>()) { <span style=color:#6272a4>// biz exception.</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>throw</span> e;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            le <span style=color:#ff79c6>=</span> e;
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>catch</span> (Throwable e) {
</span></span><span style=display:flex><span>            le <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> RpcException(e.<span style=color:#50fa7b>getMessage</span>(), e);
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>finally</span> {
</span></span><span style=display:flex><span>            providers.<span style=color:#50fa7b>add</span>(invoker.<span style=color:#50fa7b>getUrl</span>().<span style=color:#50fa7b>getAddress</span>());
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 超过最大调用次数还是失败就抛出异常</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> RpcException(le.<span style=color:#50fa7b>getCode</span>(), <span style=color:#f1fa8c>&#34;Failed to invoke the method &#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>+</span> methodName <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; in the service &#34;</span> <span style=color:#ff79c6>+</span> getInterface().<span style=color:#50fa7b>getName</span>()
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;. Tried &#34;</span> <span style=color:#ff79c6>+</span> len <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; times of the providers &#34;</span> <span style=color:#ff79c6>+</span> providers
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; (&#34;</span> <span style=color:#ff79c6>+</span> providers.<span style=color:#50fa7b>size</span>() <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;/&#34;</span> <span style=color:#ff79c6>+</span> copyInvokers.<span style=color:#50fa7b>size</span>()
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;) from the registry &#34;</span> <span style=color:#ff79c6>+</span> directory.<span style=color:#50fa7b>getUrl</span>().<span style=color:#50fa7b>getAddress</span>()
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; on the consumer &#34;</span> <span style=color:#ff79c6>+</span> NetUtils.<span style=color:#50fa7b>getLocalHost</span>() <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; using the dubbo version &#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>+</span> Version.<span style=color:#50fa7b>getVersion</span>() <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;. Last error is: &#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>+</span> le.<span style=color:#50fa7b>getMessage</span>(), le.<span style=color:#50fa7b>getCause</span>() <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>?</span> le.<span style=color:#50fa7b>getCause</span>() : le);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h6 id=2快速失败模式>2)快速失败模式<a hidden class=anchor aria-hidden=true href=#2快速失败模式>#</a></h6><p>快速失败对应FailfastClusterInvoker，他和</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> Result <span style=color:#50fa7b>doInvoke</span>(Invocation invocation, List<span style=color:#ff79c6>&lt;</span>Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> invokers, LoadBalance loadbalance) <span style=color:#8be9fd;font-style:italic>throws</span> RpcException {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 检查节点是否为空</span>
</span></span><span style=display:flex><span>    checkInvokers(invokers, invocation);
</span></span><span style=display:flex><span>    Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> invoker <span style=color:#ff79c6>=</span> select(loadbalance, invocation, invokers, <span style=color:#ff79c6>null</span>);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> invokeWithContext(invoker, invocation);
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>catch</span> (Throwable e) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (e <span style=color:#ff79c6>instanceof</span> RpcException <span style=color:#ff79c6>&amp;&amp;</span> ((RpcException) e).<span style=color:#50fa7b>isBiz</span>()) { <span style=color:#6272a4>// biz exception.</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>throw</span> (RpcException) e;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> RpcException(e <span style=color:#ff79c6>instanceof</span> RpcException <span style=color:#ff79c6>?</span> ((RpcException) e).<span style=color:#50fa7b>getCode</span>() : 0,
</span></span><span style=display:flex><span>            <span style=color:#f1fa8c>&#34;Failfast invoke providers &#34;</span> <span style=color:#ff79c6>+</span> invoker.<span style=color:#50fa7b>getUrl</span>() <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; &#34;</span> <span style=color:#ff79c6>+</span> loadbalance.<span style=color:#50fa7b>getClass</span>().<span style=color:#50fa7b>getSimpleName</span>()
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; for service &#34;</span> <span style=color:#ff79c6>+</span> getInterface().<span style=color:#50fa7b>getName</span>()
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; method &#34;</span> <span style=color:#ff79c6>+</span> invocation.<span style=color:#50fa7b>getMethodName</span>() <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; on consumer &#34;</span> <span style=color:#ff79c6>+</span> NetUtils.<span style=color:#50fa7b>getLocalHost</span>()
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; use dubbo version &#34;</span> <span style=color:#ff79c6>+</span> Version.<span style=color:#50fa7b>getVersion</span>()
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;, but no luck to perform the invocation. Last error is: &#34;</span> <span style=color:#ff79c6>+</span> e.<span style=color:#50fa7b>getMessage</span>(),
</span></span><span style=display:flex><span>            e.<span style=color:#50fa7b>getCause</span>() <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>?</span> e.<span style=color:#50fa7b>getCause</span>() : e);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h6 id=3安全失败模式>3)安全失败模式<a hidden class=anchor aria-hidden=true href=#3安全失败模式>#</a></h6><p>failsafe模式对应FailsafeClusterInvoker</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> Result <span style=color:#50fa7b>doInvoke</span>(Invocation invocation, List<span style=color:#ff79c6>&lt;</span>Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> invokers, LoadBalance loadbalance) <span style=color:#8be9fd;font-style:italic>throws</span> RpcException {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>        checkInvokers(invokers, invocation);
</span></span><span style=display:flex><span>        Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> invoker <span style=color:#ff79c6>=</span> select(loadbalance, invocation, invokers, <span style=color:#ff79c6>null</span>);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> invokeWithContext(invoker, invocation);
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>catch</span> (Throwable e) {
</span></span><span style=display:flex><span>        logger.<span style=color:#50fa7b>error</span>(<span style=color:#f1fa8c>&#34;Failsafe ignore exception: &#34;</span> <span style=color:#ff79c6>+</span> e.<span style=color:#50fa7b>getMessage</span>(), e);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> AsyncRpcResult.<span style=color:#50fa7b>newDefaultAsyncResult</span>(<span style=color:#ff79c6>null</span>, <span style=color:#ff79c6>null</span>, invocation); <span style=color:#6272a4>// ignore</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h6 id=4失败自动恢复模式>4)失败自动恢复模式<a hidden class=anchor aria-hidden=true href=#4失败自动恢复模式>#</a></h6><p>这个模式基于自己的时间轮实现的重试，对应FailbackClusterInvoker</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>protected</span> Result <span style=color:#50fa7b>doInvoke</span>(Invocation invocation, List<span style=color:#ff79c6>&lt;</span>Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> invokers, LoadBalance loadbalance) <span style=color:#8be9fd;font-style:italic>throws</span> RpcException {
</span></span><span style=display:flex><span>    Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> invoker <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span>    URL consumerUrl <span style=color:#ff79c6>=</span> RpcContext.<span style=color:#50fa7b>getServiceContext</span>().<span style=color:#50fa7b>getConsumerUrl</span>();
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>        checkInvokers(invokers, invocation);
</span></span><span style=display:flex><span>        invoker <span style=color:#ff79c6>=</span> select(loadbalance, invocation, invokers, <span style=color:#ff79c6>null</span>);
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// Asynchronous call method must be used here, because failback will retry in the background.</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// Then the serviceContext will be cleared after the call is completed.</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 这个是异步调用，但是方法体和invokeWithContext()一样</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> invokeWithContextAsync(invoker, invocation, consumerUrl);
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>catch</span> (Throwable e) {
</span></span><span style=display:flex><span>        logger.<span style=color:#50fa7b>error</span>(<span style=color:#f1fa8c>&#34;Failback to invoke method &#34;</span> <span style=color:#ff79c6>+</span> invocation.<span style=color:#50fa7b>getMethodName</span>() <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;, wait for retry in background. Ignored exception: &#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>+</span> e.<span style=color:#50fa7b>getMessage</span>() <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;, &#34;</span>, e);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (retries <span style=color:#ff79c6>&gt;</span> 0) {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 如果配置了重试，提交到TimerTask</span>
</span></span><span style=display:flex><span>            addFailed(loadbalance, invocation, invokers, invoker, consumerUrl);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> AsyncRpcResult.<span style=color:#50fa7b>newDefaultAsyncResult</span>(<span style=color:#ff79c6>null</span>, <span style=color:#ff79c6>null</span>, invocation); <span style=color:#6272a4>// ignore</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>提交重试任务就是先初始化时间轮，然后通过时间轮定时重试任务：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>addFailed</span>(LoadBalance loadbalance, Invocation invocation, List<span style=color:#ff79c6>&lt;</span>Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> invokers, Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> lastInvoker, URL consumerUrl) {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// double check，保证多线程并发安全问题</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 初始化Hash时间轮</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (failTimer <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>synchronized</span> (<span style=color:#ff79c6>this</span>) {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (failTimer <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>                failTimer <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> HashedWheelTimer(
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>new</span> NamedThreadFactory(<span style=color:#f1fa8c>&#34;failback-cluster-timer&#34;</span>, <span style=color:#ff79c6>true</span>),
</span></span><span style=display:flex><span>                    1,
</span></span><span style=display:flex><span>                    TimeUnit.<span style=color:#50fa7b>SECONDS</span>, 32, failbackTasks);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 创建重试任务</span>
</span></span><span style=display:flex><span>    RetryTimerTask retryTimerTask <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> RetryTimerTask(loadbalance, invocation, invokers, lastInvoker, retries, RETRY_FAILED_PERIOD, consumerUrl);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>        failTimer.<span style=color:#50fa7b>newTimeout</span>(retryTimerTask, RETRY_FAILED_PERIOD, TimeUnit.<span style=color:#50fa7b>SECONDS</span>);
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>catch</span> (Throwable e) {
</span></span><span style=display:flex><span>        logger.<span style=color:#50fa7b>error</span>(<span style=color:#f1fa8c>&#34;Failback background works error, invocation-&gt;&#34;</span> <span style=color:#ff79c6>+</span> invocation <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;, exception: &#34;</span> <span style=color:#ff79c6>+</span> e.<span style=color:#50fa7b>getMessage</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p><strong>TODO 时间轮源码：</strong></p><h6 id=5广播模式>5)广播模式<a hidden class=anchor aria-hidden=true href=#5广播模式>#</a></h6><p>广播模式对应BroadcastClusterInvoker</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> Result <span style=color:#50fa7b>doInvoke</span>(<span style=color:#8be9fd;font-style:italic>final</span> Invocation invocation, List<span style=color:#ff79c6>&lt;</span>Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> invokers, LoadBalance loadbalance) <span style=color:#8be9fd;font-style:italic>throws</span> RpcException {
</span></span><span style=display:flex><span>    checkInvokers(invokers, invocation);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 把所有目标节点放到RPC上下文里</span>
</span></span><span style=display:flex><span>    RpcContext.<span style=color:#50fa7b>getServiceContext</span>().<span style=color:#50fa7b>setInvokers</span>((List) invokers);
</span></span><span style=display:flex><span>    RpcException exception <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span>    Result result <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span>    URL url <span style=color:#ff79c6>=</span> getUrl();
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 这个是广播失败的比例容忍度，最小0，最大100，默认是100</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 这个参数不能决定调用结果，而是控制什么时候调用结束的，只要有一个失败，还是会返回异常</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 比如配置了30，意思是当调用失败比例达到30%将不再继续调用</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>int</span> broadcastFailPercent <span style=color:#ff79c6>=</span> url.<span style=color:#50fa7b>getParameter</span>(BROADCAST_FAIL_PERCENT_KEY, MAX_BROADCAST_FAIL_PERCENT);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (broadcastFailPercent <span style=color:#ff79c6>&lt;</span> MIN_BROADCAST_FAIL_PERCENT <span style=color:#ff79c6>||</span> broadcastFailPercent <span style=color:#ff79c6>&gt;</span> MAX_BROADCAST_FAIL_PERCENT) {
</span></span><span style=display:flex><span>        logger.<span style=color:#50fa7b>info</span>(String.<span style=color:#50fa7b>format</span>(<span style=color:#f1fa8c>&#34;The value corresponding to the broadcast.fail.percent parameter must be between 0 and 100. &#34;</span> <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;The current setting is %s, which is reset to 100.&#34;</span>, broadcastFailPercent));
</span></span><span style=display:flex><span>        broadcastFailPercent <span style=color:#ff79c6>=</span> MAX_BROADCAST_FAIL_PERCENT;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 根据比例计算允许失败的机器数</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>int</span> failThresholdIndex <span style=color:#ff79c6>=</span> invokers.<span style=color:#50fa7b>size</span>() <span style=color:#ff79c6>*</span> broadcastFailPercent <span style=color:#ff79c6>/</span> MAX_BROADCAST_FAIL_PERCENT;
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>int</span> failIndex <span style=color:#ff79c6>=</span> 0;
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 开始顺序遍历</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 只要失败的节点数没达到failThresholdIndex就一直遍历</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> (Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> invoker : invokers) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>            result <span style=color:#ff79c6>=</span> invokeWithContext(invoker, invocation);
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>null</span> <span style=color:#ff79c6>!=</span> result <span style=color:#ff79c6>&amp;&amp;</span> result.<span style=color:#50fa7b>hasException</span>()) {
</span></span><span style=display:flex><span>                Throwable resultException <span style=color:#ff79c6>=</span> result.<span style=color:#50fa7b>getException</span>();
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>null</span> <span style=color:#ff79c6>!=</span> resultException) {
</span></span><span style=display:flex><span>                    exception <span style=color:#ff79c6>=</span> getRpcException(result.<span style=color:#50fa7b>getException</span>());
</span></span><span style=display:flex><span>                    logger.<span style=color:#50fa7b>warn</span>(exception.<span style=color:#50fa7b>getMessage</span>(), exception);
</span></span><span style=display:flex><span>                    failIndex<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>if</span> (failIndex <span style=color:#ff79c6>==</span> failThresholdIndex) {
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>catch</span> (Throwable e) {
</span></span><span style=display:flex><span>            exception <span style=color:#ff79c6>=</span> getRpcException(e);
</span></span><span style=display:flex><span>            logger.<span style=color:#50fa7b>warn</span>(exception.<span style=color:#50fa7b>getMessage</span>(), exception);
</span></span><span style=display:flex><span>            failIndex<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (failIndex <span style=color:#ff79c6>==</span> failThresholdIndex) {
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 有一个调用失败就是失败</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (exception <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (failIndex <span style=color:#ff79c6>==</span> failThresholdIndex) {
</span></span><span style=display:flex><span>            logger.<span style=color:#50fa7b>debug</span>(
</span></span><span style=display:flex><span>                    String.<span style=color:#50fa7b>format</span>(<span style=color:#f1fa8c>&#34;The number of BroadcastCluster call failures has reached the threshold %s&#34;</span>, failThresholdIndex));
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>            logger.<span style=color:#50fa7b>debug</span>(String.<span style=color:#50fa7b>format</span>(<span style=color:#f1fa8c>&#34;The number of BroadcastCluster call failures has not reached the threshold %s, fail size is %s&#34;</span>,
</span></span><span style=display:flex><span>                    failThresholdIndex, failIndex));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>throw</span> exception;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> result;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h6 id=6并行调用模式>6)并行调用模式<a hidden class=anchor aria-hidden=true href=#6并行调用模式>#</a></h6><p>forking模式对应ForkingClusterInvoker</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> Result <span style=color:#50fa7b>doInvoke</span>(<span style=color:#8be9fd;font-style:italic>final</span> Invocation invocation, List<span style=color:#ff79c6>&lt;</span>Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> invokers, LoadBalance loadbalance) <span style=color:#8be9fd;font-style:italic>throws</span> RpcException {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>        checkInvokers(invokers, invocation);
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>final</span> List<span style=color:#ff79c6>&lt;</span>Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> selected;
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 默认并行度是2</span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>final</span> <span style=color:#8be9fd>int</span> forks <span style=color:#ff79c6>=</span> getUrl().<span style=color:#50fa7b>getParameter</span>(FORKS_KEY, DEFAULT_FORKS);
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 默认超时时间是1s</span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>final</span> <span style=color:#8be9fd>int</span> timeout <span style=color:#ff79c6>=</span> getUrl().<span style=color:#50fa7b>getParameter</span>(TIMEOUT_KEY, DEFAULT_TIMEOUT);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (forks <span style=color:#ff79c6>&lt;=</span> 0 <span style=color:#ff79c6>||</span> forks <span style=color:#ff79c6>&gt;=</span> invokers.<span style=color:#50fa7b>size</span>()) {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 如果配置的并行度小于0或者大于目标集群节点数量就把目标节点赋值成所有集群节点</span>
</span></span><span style=display:flex><span>            selected <span style=color:#ff79c6>=</span> invokers;
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 否则就使用负载均衡一直选择节点，直到满足并行度</span>
</span></span><span style=display:flex><span>            selected <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ArrayList<span style=color:#ff79c6>&lt;&gt;</span>(forks);
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>while</span> (selected.<span style=color:#50fa7b>size</span>() <span style=color:#ff79c6>&lt;</span> forks) {
</span></span><span style=display:flex><span>                Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> invoker <span style=color:#ff79c6>=</span> select(loadbalance, invocation, invokers, selected);
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>selected.<span style=color:#50fa7b>contains</span>(invoker)) {
</span></span><span style=display:flex><span>                    <span style=color:#6272a4>//Avoid add the same invoker several times.</span>
</span></span><span style=display:flex><span>                    selected.<span style=color:#50fa7b>add</span>(invoker);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        RpcContext.<span style=color:#50fa7b>getServiceContext</span>().<span style=color:#50fa7b>setInvokers</span>((List) selected);
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>final</span> AtomicInteger count <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> AtomicInteger();
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>final</span> BlockingQueue<span style=color:#ff79c6>&lt;</span>Object<span style=color:#ff79c6>&gt;</span> ref <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> LinkedBlockingQueue<span style=color:#ff79c6>&lt;&gt;</span>();
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 遍历invoker，把结果放到队列里</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd;font-style:italic>final</span> Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> invoker : selected) {
</span></span><span style=display:flex><span>            URL consumerUrl <span style=color:#ff79c6>=</span> RpcContext.<span style=color:#50fa7b>getServiceContext</span>().<span style=color:#50fa7b>getConsumerUrl</span>();
</span></span><span style=display:flex><span>            executor.<span style=color:#50fa7b>execute</span>(() <span style=color:#ff79c6>-&gt;</span> {
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>                    Result result <span style=color:#ff79c6>=</span> invokeWithContextAsync(invoker, invocation, consumerUrl);
</span></span><span style=display:flex><span>                    ref.<span style=color:#50fa7b>offer</span>(result);
</span></span><span style=display:flex><span>                } <span style=color:#ff79c6>catch</span> (Throwable e) {
</span></span><span style=display:flex><span>                    <span style=color:#6272a4>// 只要失败计数加1，如果计数==selected.size，就把这个结果放到队里里</span>
</span></span><span style=display:flex><span>                    <span style=color:#6272a4>// 这个是尽可能保证有成功的结果进到队列里</span>
</span></span><span style=display:flex><span>                    <span style=color:#6272a4>// 如果都失败也会有一个失败的结果进到队列里</span>
</span></span><span style=display:flex><span>                    <span style=color:#8be9fd>int</span> value <span style=color:#ff79c6>=</span> count.<span style=color:#50fa7b>incrementAndGet</span>();
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>if</span> (value <span style=color:#ff79c6>&gt;=</span> selected.<span style=color:#50fa7b>size</span>()) {
</span></span><span style=display:flex><span>                        ref.<span style=color:#50fa7b>offer</span>(e);
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            });
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 拿到第一个结果，有结果就返回结果，是异常就抛出异常</span>
</span></span><span style=display:flex><span>            Object ret <span style=color:#ff79c6>=</span> ref.<span style=color:#50fa7b>poll</span>(timeout, TimeUnit.<span style=color:#50fa7b>MILLISECONDS</span>);
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (ret <span style=color:#ff79c6>instanceof</span> Throwable) {
</span></span><span style=display:flex><span>                Throwable e <span style=color:#ff79c6>=</span> (Throwable) ret;
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> RpcException(e <span style=color:#ff79c6>instanceof</span> RpcException <span style=color:#ff79c6>?</span> ((RpcException) e).<span style=color:#50fa7b>getCode</span>() : RpcException.<span style=color:#50fa7b>UNKNOWN_EXCEPTION</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f1fa8c>&#34;Failed to forking invoke provider &#34;</span> <span style=color:#ff79c6>+</span> selected <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;, but no luck to perform the invocation. &#34;</span> <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#f1fa8c>&#34;Last error is: &#34;</span> <span style=color:#ff79c6>+</span> e.<span style=color:#50fa7b>getMessage</span>(), e.<span style=color:#50fa7b>getCause</span>() <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>?</span> e.<span style=color:#50fa7b>getCause</span>() : e);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> (Result) ret;
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>catch</span> (InterruptedException e) {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> RpcException(<span style=color:#f1fa8c>&#34;Failed to forking invoke provider &#34;</span> <span style=color:#ff79c6>+</span> selected <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;, &#34;</span> <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;but no luck to perform the invocation. Last error is: &#34;</span> <span style=color:#ff79c6>+</span> e.<span style=color:#50fa7b>getMessage</span>(), e);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>finally</span> {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// clear attachments which is binding to current thread.</span>
</span></span><span style=display:flex><span>        RpcContext.<span style=color:#50fa7b>getClientAttachment</span>().<span style=color:#50fa7b>clearAttachments</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=3loadbalance>3.LoadBalance<a hidden class=anchor aria-hidden=true href=#3loadbalance>#</a></h3><p>dubbo自己实现了5中负载均衡算法：</p><ol><li>带权重的随机</li><li>带权重的轮询</li><li>最小活跃</li><li>一致性哈希</li><li>最短响应时间</li></ol><p>负载均衡的父类是AbstractLoadBalance，这个里面有一个计算权重的方法：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>protected</span> <span style=color:#8be9fd>int</span> <span style=color:#50fa7b>getWeight</span>(Invoker<span style=color:#ff79c6>&lt;?&gt;</span> invoker, Invocation invocation) {
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>int</span> weight;
</span></span><span style=display:flex><span>    URL url <span style=color:#ff79c6>=</span> invoker.<span style=color:#50fa7b>getUrl</span>();
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 处理多注册中心场景</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (REGISTRY_SERVICE_REFERENCE_PATH.<span style=color:#50fa7b>equals</span>(url.<span style=color:#50fa7b>getServiceInterface</span>())) {
</span></span><span style=display:flex><span>        weight <span style=color:#ff79c6>=</span> url.<span style=color:#50fa7b>getParameter</span>(REGISTRY_KEY <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;.&#34;</span> <span style=color:#ff79c6>+</span> WEIGHT_KEY, DEFAULT_WEIGHT);
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 获取方法的weight属性，默认是100</span>
</span></span><span style=display:flex><span>        weight <span style=color:#ff79c6>=</span> url.<span style=color:#50fa7b>getMethodParameter</span>(invocation.<span style=color:#50fa7b>getMethodName</span>(), WEIGHT_KEY, DEFAULT_WEIGHT);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (weight <span style=color:#ff79c6>&gt;</span> 0) {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 获取timestamp配置</span>
</span></span><span style=display:flex><span>            <span style=color:#8be9fd>long</span> timestamp <span style=color:#ff79c6>=</span> invoker.<span style=color:#50fa7b>getUrl</span>().<span style=color:#50fa7b>getParameter</span>(TIMESTAMP_KEY, 0L);
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (timestamp <span style=color:#ff79c6>&gt;</span> 0L) {
</span></span><span style=display:flex><span>                <span style=color:#8be9fd>long</span> uptime <span style=color:#ff79c6>=</span> System.<span style=color:#50fa7b>currentTimeMillis</span>() <span style=color:#ff79c6>-</span> timestamp;
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>if</span> (uptime <span style=color:#ff79c6>&lt;</span> 0) {
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>return</span> 1;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#6272a4>// 获取warmup配置，默认10 * 60 * 1000</span>
</span></span><span style=display:flex><span>                <span style=color:#8be9fd>int</span> warmup <span style=color:#ff79c6>=</span> invoker.<span style=color:#50fa7b>getUrl</span>().<span style=color:#50fa7b>getParameter</span>(WARMUP_KEY, DEFAULT_WARMUP);
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>if</span> (uptime <span style=color:#ff79c6>&gt;</span> 0 <span style=color:#ff79c6>&amp;&amp;</span> uptime <span style=color:#ff79c6>&lt;</span> warmup) {
</span></span><span style=display:flex><span>                    <span style=color:#6272a4>// 计算权重</span>
</span></span><span style=display:flex><span>                    weight <span style=color:#ff79c6>=</span> calculateWarmupWeight((<span style=color:#8be9fd>int</span>)uptime, warmup, weight);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> Math.<span style=color:#50fa7b>max</span>(weight, 0);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h6 id=1随机负载均衡>1）随机负载均衡<a hidden class=anchor aria-hidden=true href=#1随机负载均衡>#</a></h6><p>带权重的随机对应RandomLoadBalance，他在选择的时候回先判断是否需要权重：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> <span style=color:#8be9fd>boolean</span> <span style=color:#50fa7b>needWeightLoadBalance</span>(List<span style=color:#ff79c6>&lt;</span>Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> invokers, Invocation invocation) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Invoker invoker <span style=color:#ff79c6>=</span> invokers.<span style=color:#50fa7b>get</span>(0);
</span></span><span style=display:flex><span>    URL invokerUrl <span style=color:#ff79c6>=</span> invoker.<span style=color:#50fa7b>getUrl</span>();
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 这个是处理RegistryService接口的</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 这个是多注册中心场景的负载均衡</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (REGISTRY_SERVICE_REFERENCE_PATH.<span style=color:#50fa7b>equals</span>(invokerUrl.<span style=color:#50fa7b>getServiceInterface</span>())) {
</span></span><span style=display:flex><span>        String weight <span style=color:#ff79c6>=</span> invokerUrl.<span style=color:#50fa7b>getParameter</span>(REGISTRY_KEY <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;.&#34;</span> <span style=color:#ff79c6>+</span> WEIGHT_KEY);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (StringUtils.<span style=color:#50fa7b>isNotEmpty</span>(weight)) {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>true</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 从方法的配置里获取weight的值，如果没有就从全局配置中获取</span>
</span></span><span style=display:flex><span>        String weight <span style=color:#ff79c6>=</span> invokerUrl.<span style=color:#50fa7b>getMethodParameter</span>(invocation.<span style=color:#50fa7b>getMethodName</span>(), WEIGHT_KEY);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (StringUtils.<span style=color:#50fa7b>isNotEmpty</span>(weight)) {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>true</span>;
</span></span><span style=display:flex><span>        }<span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 获取timestamp配置</span>
</span></span><span style=display:flex><span>            String timeStamp <span style=color:#ff79c6>=</span> invoker.<span style=color:#50fa7b>getUrl</span>().<span style=color:#50fa7b>getParameter</span>(TIMESTAMP_KEY);
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (StringUtils.<span style=color:#50fa7b>isNotEmpty</span>(timeStamp)) {
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>true</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>false</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>然后进行选择：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>protected</span> <span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> <span style=color:#50fa7b>doSelect</span>(List<span style=color:#ff79c6>&lt;</span>Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> invokers, URL url, Invocation invocation) {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 拿到invokers的数量</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>int</span> length <span style=color:#ff79c6>=</span> invokers.<span style=color:#50fa7b>size</span>();
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 判断是否使用权重</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>needWeightLoadBalance(invokers,invocation)){
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 如果不需要权重，直接生成一个随机数</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> invokers.<span style=color:#50fa7b>get</span>(ThreadLocalRandom.<span style=color:#50fa7b>current</span>().<span style=color:#50fa7b>nextInt</span>(length));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// Every invoker has the same weight?</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>boolean</span> sameWeight <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>true</span>;
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// the maxWeight of every invokers, the minWeight = 0 or the maxWeight of the last invoker</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>int</span><span style=color:#ff79c6>[]</span> weights <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> <span style=color:#8be9fd>int</span><span style=color:#ff79c6>[</span>length<span style=color:#ff79c6>]</span>;
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// The sum of weights</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>int</span> totalWeight <span style=color:#ff79c6>=</span> 0;
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 计算每个invoker的权重，他存的累加值。判断是否哦权重都相同</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> 0; i <span style=color:#ff79c6>&lt;</span> length; i<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 获取权重</span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd>int</span> weight <span style=color:#ff79c6>=</span> getWeight(invokers.<span style=color:#50fa7b>get</span>(i), invocation);
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// Sum</span>
</span></span><span style=display:flex><span>        totalWeight <span style=color:#ff79c6>+=</span> weight;
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// save for later use</span>
</span></span><span style=display:flex><span>        weights<span style=color:#ff79c6>[</span>i<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> totalWeight;
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (sameWeight <span style=color:#ff79c6>&amp;&amp;</span> totalWeight <span style=color:#ff79c6>!=</span> weight <span style=color:#ff79c6>*</span> (i <span style=color:#ff79c6>+</span> 1)) {
</span></span><span style=display:flex><span>            sameWeight <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>false</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (totalWeight <span style=color:#ff79c6>&gt;</span> 0 <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!</span>sameWeight) {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// If (not every invoker has the same weight &amp; at least one invoker&#39;s weight&gt;0), select randomly based on totalWeight.</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 根据总权重生成一个随机值，然后根据这个随机值拿到一个invoker</span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd>int</span> offset <span style=color:#ff79c6>=</span> ThreadLocalRandom.<span style=color:#50fa7b>current</span>().<span style=color:#50fa7b>nextInt</span>(totalWeight);
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// Return a invoker based on the random value.</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> 0; i <span style=color:#ff79c6>&lt;</span> length; i<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (offset <span style=color:#ff79c6>&lt;</span> weights<span style=color:#ff79c6>[</span>i<span style=color:#ff79c6>]</span>) {
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>return</span> invokers.<span style=color:#50fa7b>get</span>(i);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 如果权重相同或者权重都是0就随机选一个</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> invokers.<span style=color:#50fa7b>get</span>(ThreadLocalRandom.<span style=color:#50fa7b>current</span>().<span style=color:#50fa7b>nextInt</span>(length));
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h6 id=2轮询负载均衡>2）轮询负载均衡<a hidden class=anchor aria-hidden=true href=#2轮询负载均衡>#</a></h6><p>轮询对应RoundRobinLoadBalance：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>protected</span> <span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> <span style=color:#50fa7b>doSelect</span>(List<span style=color:#ff79c6>&lt;</span>Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> invokers, URL url, Invocation invocation) {
</span></span><span style=display:flex><span>    String key <span style=color:#ff79c6>=</span> invokers.<span style=color:#50fa7b>get</span>(0).<span style=color:#50fa7b>getUrl</span>().<span style=color:#50fa7b>getServiceKey</span>() <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;.&#34;</span> <span style=color:#ff79c6>+</span> invocation.<span style=color:#50fa7b>getMethodName</span>();
</span></span><span style=display:flex><span>    ConcurrentMap<span style=color:#ff79c6>&lt;</span>String, WeightedRoundRobin<span style=color:#ff79c6>&gt;</span> map <span style=color:#ff79c6>=</span> methodWeightMap.<span style=color:#50fa7b>computeIfAbsent</span>(key, k <span style=color:#ff79c6>-&gt;</span> <span style=color:#ff79c6>new</span> ConcurrentHashMap<span style=color:#ff79c6>&lt;&gt;</span>());
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>int</span> totalWeight <span style=color:#ff79c6>=</span> 0;
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>long</span> maxCurrent <span style=color:#ff79c6>=</span> Long.<span style=color:#50fa7b>MIN_VALUE</span>;
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>long</span> now <span style=color:#ff79c6>=</span> System.<span style=color:#50fa7b>currentTimeMillis</span>();
</span></span><span style=display:flex><span>    Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> selectedInvoker <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span>    WeightedRoundRobin selectedWRR <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> (Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> invoker : invokers) {
</span></span><span style=display:flex><span>        String identifyString <span style=color:#ff79c6>=</span> invoker.<span style=color:#50fa7b>getUrl</span>().<span style=color:#50fa7b>toIdentityString</span>();
</span></span><span style=display:flex><span>        <span style=color:#8be9fd>int</span> weight <span style=color:#ff79c6>=</span> getWeight(invoker, invocation);
</span></span><span style=display:flex><span>        WeightedRoundRobin weightedRoundRobin <span style=color:#ff79c6>=</span> map.<span style=color:#50fa7b>computeIfAbsent</span>(identifyString, k <span style=color:#ff79c6>-&gt;</span> {
</span></span><span style=display:flex><span>            WeightedRoundRobin wrr <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> WeightedRoundRobin();
</span></span><span style=display:flex><span>            wrr.<span style=color:#50fa7b>setWeight</span>(weight);
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> wrr;
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 权重发生改变</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (weight <span style=color:#ff79c6>!=</span> weightedRoundRobin.<span style=color:#50fa7b>getWeight</span>()) {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>//weight changed</span>
</span></span><span style=display:flex><span>            weightedRoundRobin.<span style=color:#50fa7b>setWeight</span>(weight);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#8be9fd>long</span> cur <span style=color:#ff79c6>=</span> weightedRoundRobin.<span style=color:#50fa7b>increaseCurrent</span>();
</span></span><span style=display:flex><span>        weightedRoundRobin.<span style=color:#50fa7b>setLastUpdate</span>(now);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (cur <span style=color:#ff79c6>&gt;</span> maxCurrent) {
</span></span><span style=display:flex><span>            maxCurrent <span style=color:#ff79c6>=</span> cur;
</span></span><span style=display:flex><span>            selectedInvoker <span style=color:#ff79c6>=</span> invoker;
</span></span><span style=display:flex><span>            selectedWRR <span style=color:#ff79c6>=</span> weightedRoundRobin;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        totalWeight <span style=color:#ff79c6>+=</span> weight;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (invokers.<span style=color:#50fa7b>size</span>() <span style=color:#ff79c6>!=</span> map.<span style=color:#50fa7b>size</span>()) {
</span></span><span style=display:flex><span>        map.<span style=color:#50fa7b>entrySet</span>().<span style=color:#50fa7b>removeIf</span>(item <span style=color:#ff79c6>-&gt;</span> now <span style=color:#ff79c6>-</span> item.<span style=color:#50fa7b>getValue</span>().<span style=color:#50fa7b>getLastUpdate</span>() <span style=color:#ff79c6>&gt;</span> RECYCLE_PERIOD);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (selectedInvoker <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 选中的invoker的权重要减去总权重</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 这样就能保证下次选择其他的invoker</span>
</span></span><span style=display:flex><span>        selectedWRR.<span style=color:#50fa7b>sel</span>(totalWeight);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> selectedInvoker;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// should not happen here</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> invokers.<span style=color:#50fa7b>get</span>(0);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>WeightedRoundRobin是他的内部类：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>protected</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>WeightedRoundRobin</span> {
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>int</span> weight;
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> AtomicLong current <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> AtomicLong(0);
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>long</span> lastUpdate;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>int</span> <span style=color:#50fa7b>getWeight</span>() {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> weight;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>setWeight</span>(<span style=color:#8be9fd>int</span> weight) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>weight</span> <span style=color:#ff79c6>=</span> weight;
</span></span><span style=display:flex><span>        current.<span style=color:#50fa7b>set</span>(0);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>long</span> <span style=color:#50fa7b>increaseCurrent</span>() {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> current.<span style=color:#50fa7b>addAndGet</span>(weight);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>sel</span>(<span style=color:#8be9fd>int</span> total) {
</span></span><span style=display:flex><span>        current.<span style=color:#50fa7b>addAndGet</span>(<span style=color:#ff79c6>-</span>1 <span style=color:#ff79c6>*</span> total);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>long</span> <span style=color:#50fa7b>getLastUpdate</span>() {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> lastUpdate;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>setLastUpdate</span>(<span style=color:#8be9fd>long</span> lastUpdate) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>lastUpdate</span> <span style=color:#ff79c6>=</span> lastUpdate;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h6 id=3最小活跃负载均衡>3）最小活跃负载均衡<a hidden class=anchor aria-hidden=true href=#3最小活跃负载均衡>#</a></h6><p>最小活跃对应LeastActiveLoadBalance</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>protected</span> <span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> <span style=color:#50fa7b>doSelect</span>(List<span style=color:#ff79c6>&lt;</span>Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> invokers, URL url, Invocation invocation) {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// Number of invokers</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>int</span> length <span style=color:#ff79c6>=</span> invokers.<span style=color:#50fa7b>size</span>();
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// The least active value of all invokers</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>int</span> leastActive <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>-</span>1;
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// The number of invokers having the same least active value (leastActive)</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>int</span> leastCount <span style=color:#ff79c6>=</span> 0;
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// The index of invokers having the same least active value (leastActive)</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>int</span><span style=color:#ff79c6>[]</span> leastIndexes <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> <span style=color:#8be9fd>int</span><span style=color:#ff79c6>[</span>length<span style=color:#ff79c6>]</span>;
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// the weight of every invokers</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>int</span><span style=color:#ff79c6>[]</span> weights <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> <span style=color:#8be9fd>int</span><span style=color:#ff79c6>[</span>length<span style=color:#ff79c6>]</span>;
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// The sum of the warmup weights of all the least active invokers</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>int</span> totalWeight <span style=color:#ff79c6>=</span> 0;
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// The weight of the first least active invoker</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>int</span> firstWeight <span style=color:#ff79c6>=</span> 0;
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// Every least active invoker has the same weight value?</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>boolean</span> sameWeight <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>true</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// Filter out all the least active invokers</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> 0; i <span style=color:#ff79c6>&lt;</span> length; i<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span>        Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> invoker <span style=color:#ff79c6>=</span> invokers.<span style=color:#50fa7b>get</span>(i);
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 获取invoker的调用次数</span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd>int</span> active <span style=color:#ff79c6>=</span> RpcStatus.<span style=color:#50fa7b>getStatus</span>(invoker.<span style=color:#50fa7b>getUrl</span>(), invocation.<span style=color:#50fa7b>getMethodName</span>()).<span style=color:#50fa7b>getActive</span>();
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// Get the weight of the invoker&#39;s configuration. The default value is 100.</span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd>int</span> afterWarmup <span style=color:#ff79c6>=</span> getWeight(invoker, invocation);
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// save for later use</span>
</span></span><span style=display:flex><span>        weights<span style=color:#ff79c6>[</span>i<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> afterWarmup;
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 如果是第一个invoker或者当前invoker的调用次数比上一个小</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (leastActive <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>-</span>1 <span style=color:#ff79c6>||</span> active <span style=color:#ff79c6>&lt;</span> leastActive) {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// Reset the active number of the current invoker to the least active number</span>
</span></span><span style=display:flex><span>            leastActive <span style=color:#ff79c6>=</span> active;
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// Reset the number of least active invokers</span>
</span></span><span style=display:flex><span>            leastCount <span style=color:#ff79c6>=</span> 1;
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// Put the first least active invoker first in leastIndexes</span>
</span></span><span style=display:flex><span>            leastIndexes<span style=color:#ff79c6>[</span>0<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> i;
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// Reset totalWeight</span>
</span></span><span style=display:flex><span>            totalWeight <span style=color:#ff79c6>=</span> afterWarmup;
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// Record the weight the first least active invoker</span>
</span></span><span style=display:flex><span>            firstWeight <span style=color:#ff79c6>=</span> afterWarmup;
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// Each invoke has the same weight (only one invoker here)</span>
</span></span><span style=display:flex><span>            sameWeight <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>true</span>;
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// If current invoker&#39;s active value equals with leaseActive, then accumulating.</span>
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (active <span style=color:#ff79c6>==</span> leastActive) {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// Record the index of the least active invoker in leastIndexes order</span>
</span></span><span style=display:flex><span>            leastIndexes<span style=color:#ff79c6>[</span>leastCount<span style=color:#ff79c6>++]</span> <span style=color:#ff79c6>=</span> i;
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// Accumulate the total weight of the least active invoker</span>
</span></span><span style=display:flex><span>            totalWeight <span style=color:#ff79c6>+=</span> afterWarmup;
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// If every invoker has the same weight?</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (sameWeight <span style=color:#ff79c6>&amp;&amp;</span> afterWarmup <span style=color:#ff79c6>!=</span> firstWeight) {
</span></span><span style=display:flex><span>                sameWeight <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>false</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// Choose an invoker from all the least active invokers</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (leastCount <span style=color:#ff79c6>==</span> 1) {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// If we got exactly one invoker having the least active value, return this invoker directly.</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> invokers.<span style=color:#50fa7b>get</span>(leastIndexes<span style=color:#ff79c6>[</span>0<span style=color:#ff79c6>]</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>sameWeight <span style=color:#ff79c6>&amp;&amp;</span> totalWeight <span style=color:#ff79c6>&gt;</span> 0) {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// If (not every invoker has the same weight &amp; at least one invoker&#39;s weight&gt;0), select randomly based on </span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// totalWeight.</span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd>int</span> offsetWeight <span style=color:#ff79c6>=</span> ThreadLocalRandom.<span style=color:#50fa7b>current</span>().<span style=color:#50fa7b>nextInt</span>(totalWeight);
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// Return a invoker based on the random value.</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> 0; i <span style=color:#ff79c6>&lt;</span> leastCount; i<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span>            <span style=color:#8be9fd>int</span> leastIndex <span style=color:#ff79c6>=</span> leastIndexes<span style=color:#ff79c6>[</span>i<span style=color:#ff79c6>]</span>;
</span></span><span style=display:flex><span>            offsetWeight <span style=color:#ff79c6>-=</span> weights<span style=color:#ff79c6>[</span>leastIndex<span style=color:#ff79c6>]</span>;
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (offsetWeight <span style=color:#ff79c6>&lt;</span> 0) {
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>return</span> invokers.<span style=color:#50fa7b>get</span>(leastIndex);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// If all invokers have the same weight value or totalWeight=0, return evenly.</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> invokers.<span style=color:#50fa7b>get</span>(leastIndexes<span style=color:#ff79c6>[</span>ThreadLocalRandom.<span style=color:#50fa7b>current</span>().<span style=color:#50fa7b>nextInt</span>(leastCount)<span style=color:#ff79c6>]</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h6 id=4一致性hash负载均衡>4）一致性hash负载均衡<a hidden class=anchor aria-hidden=true href=#4一致性hash负载均衡>#</a></h6><p>一致性hash对应ConsistentHashLoadBalance：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>protected</span> <span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> <span style=color:#50fa7b>doSelect</span>(List<span style=color:#ff79c6>&lt;</span>Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> invokers, URL url, Invocation invocation) {
</span></span><span style=display:flex><span>    String methodName <span style=color:#ff79c6>=</span> RpcUtils.<span style=color:#50fa7b>getMethodName</span>(invocation);
</span></span><span style=display:flex><span>    String key <span style=color:#ff79c6>=</span> invokers.<span style=color:#50fa7b>get</span>(0).<span style=color:#50fa7b>getUrl</span>().<span style=color:#50fa7b>getServiceKey</span>() <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;.&#34;</span> <span style=color:#ff79c6>+</span> methodName;
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// using the hashcode of list to compute the hash only pay attention to the elements in the list</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 根据invokers的list计算hash值</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>int</span> invokersHashCode <span style=color:#ff79c6>=</span> getCorrespondingHashCode(invokers);
</span></span><span style=display:flex><span>    ConsistentHashSelector<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> selector <span style=color:#ff79c6>=</span> (ConsistentHashSelector<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span>) selectors.<span style=color:#50fa7b>get</span>(key);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 根据接口+方法名初始化一个ConsistentHashSelector</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (selector <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>||</span> selector.<span style=color:#50fa7b>identityHashCode</span> <span style=color:#ff79c6>!=</span> invokersHashCode) {
</span></span><span style=display:flex><span>        selectors.<span style=color:#50fa7b>put</span>(key, <span style=color:#ff79c6>new</span> ConsistentHashSelector<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span>(invokers, methodName, invokersHashCode));
</span></span><span style=display:flex><span>        selector <span style=color:#ff79c6>=</span> (ConsistentHashSelector<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span>) selectors.<span style=color:#50fa7b>get</span>(key);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 调用一致性hash的select方法</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> selector.<span style=color:#50fa7b>select</span>(invocation);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>ConsistentHashSelector是他的内部类：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">127
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">128
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">129
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">130
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">131
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">132
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">133
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">134
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">135
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">136
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd;font-style:italic>final</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>ConsistentHashSelector</span><span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd;font-style:italic>final</span> TreeMap<span style=color:#ff79c6>&lt;</span>Long, Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> virtualInvokers;
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd;font-style:italic>final</span> <span style=color:#8be9fd>int</span> replicaNumber;
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd;font-style:italic>final</span> <span style=color:#8be9fd>int</span> identityHashCode;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd;font-style:italic>final</span> <span style=color:#8be9fd>int</span><span style=color:#ff79c6>[]</span> argumentIndex;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     * key: server(invoker) address
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     * value: count of requests accept by certain server
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> Map<span style=color:#ff79c6>&lt;</span>String, AtomicLong<span style=color:#ff79c6>&gt;</span> serverRequestCountMap <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ConcurrentHashMap<span style=color:#ff79c6>&lt;&gt;</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     * count of total requests accept by all servers
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> AtomicLong totalRequestCount;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     * count of current servers(invokers)
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>int</span> serverCount;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     * the ratio which allow count of requests accept by each server
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     * overrate average (totalRequestCount/serverCount).
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     * 1.5 is recommended, in the futrue we can make this param configurable
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd;font-style:italic>final</span> <span style=color:#8be9fd>double</span> OVERLOAD_RATIO_THREAD <span style=color:#ff79c6>=</span> 1.<span style=color:#50fa7b>5F</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ConsistentHashSelector(List<span style=color:#ff79c6>&lt;</span>Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> invokers, String methodName, <span style=color:#8be9fd>int</span> identityHashCode) {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// virtualInvokers就是虚拟节点</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>virtualInvokers</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> TreeMap<span style=color:#ff79c6>&lt;</span>Long, Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span>();
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>identityHashCode</span> <span style=color:#ff79c6>=</span> identityHashCode;
</span></span><span style=display:flex><span>        URL url <span style=color:#ff79c6>=</span> invokers.<span style=color:#50fa7b>get</span>(0).<span style=color:#50fa7b>getUrl</span>();
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>replicaNumber</span> <span style=color:#ff79c6>=</span> url.<span style=color:#50fa7b>getMethodParameter</span>(methodName, HASH_NODES, 160);
</span></span><span style=display:flex><span>        String<span style=color:#ff79c6>[]</span> index <span style=color:#ff79c6>=</span> COMMA_SPLIT_PATTERN.<span style=color:#50fa7b>split</span>(url.<span style=color:#50fa7b>getMethodParameter</span>(methodName, HASH_ARGUMENTS, <span style=color:#f1fa8c>&#34;0&#34;</span>));
</span></span><span style=display:flex><span>        argumentIndex <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> <span style=color:#8be9fd>int</span><span style=color:#ff79c6>[</span>index.<span style=color:#50fa7b>length</span><span style=color:#ff79c6>]</span>;
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> 0; i <span style=color:#ff79c6>&lt;</span> index.<span style=color:#50fa7b>length</span>; i<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span>            argumentIndex<span style=color:#ff79c6>[</span>i<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> Integer.<span style=color:#50fa7b>parseInt</span>(index<span style=color:#ff79c6>[</span>i<span style=color:#ff79c6>]</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 每个invoker对应几个虚拟节点</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>for</span> (Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> invoker : invokers) {
</span></span><span style=display:flex><span>            String address <span style=color:#ff79c6>=</span> invoker.<span style=color:#50fa7b>getUrl</span>().<span style=color:#50fa7b>getAddress</span>();
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> 0; i <span style=color:#ff79c6>&lt;</span> replicaNumber <span style=color:#ff79c6>/</span> 4; i<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span>                <span style=color:#8be9fd>byte</span><span style=color:#ff79c6>[]</span> digest <span style=color:#ff79c6>=</span> Bytes.<span style=color:#50fa7b>getMD5</span>(address <span style=color:#ff79c6>+</span> i);
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> h <span style=color:#ff79c6>=</span> 0; h <span style=color:#ff79c6>&lt;</span> 4; h<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span>                    <span style=color:#8be9fd>long</span> m <span style=color:#ff79c6>=</span> hash(digest, h);
</span></span><span style=display:flex><span>                    virtualInvokers.<span style=color:#50fa7b>put</span>(m, invoker);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        totalRequestCount <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> AtomicLong(0);
</span></span><span style=display:flex><span>        serverCount <span style=color:#ff79c6>=</span> invokers.<span style=color:#50fa7b>size</span>();
</span></span><span style=display:flex><span>        serverRequestCountMap.<span style=color:#50fa7b>clear</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> <span style=color:#50fa7b>select</span>(Invocation invocation) {
</span></span><span style=display:flex><span>        String key <span style=color:#ff79c6>=</span> toKey(invocation.<span style=color:#50fa7b>getArguments</span>());
</span></span><span style=display:flex><span>        <span style=color:#8be9fd>byte</span><span style=color:#ff79c6>[]</span> digest <span style=color:#ff79c6>=</span> Bytes.<span style=color:#50fa7b>getMD5</span>(key);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> selectForKey(hash(digest, 0));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> String <span style=color:#50fa7b>toKey</span>(Object<span style=color:#ff79c6>[]</span> args) {
</span></span><span style=display:flex><span>        StringBuilder buf <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> StringBuilder();
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i : argumentIndex) {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (i <span style=color:#ff79c6>&gt;=</span> 0 <span style=color:#ff79c6>&amp;&amp;</span> i <span style=color:#ff79c6>&lt;</span> args.<span style=color:#50fa7b>length</span>) {
</span></span><span style=display:flex><span>                buf.<span style=color:#50fa7b>append</span>(args<span style=color:#ff79c6>[</span>i<span style=color:#ff79c6>]</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> buf.<span style=color:#50fa7b>toString</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> <span style=color:#50fa7b>selectForKey</span>(<span style=color:#8be9fd>long</span> hash) {
</span></span><span style=display:flex><span>        Map.<span style=color:#50fa7b>Entry</span><span style=color:#ff79c6>&lt;</span>Long, Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> entry <span style=color:#ff79c6>=</span> virtualInvokers.<span style=color:#50fa7b>ceilingEntry</span>(hash);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (entry <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>            entry <span style=color:#ff79c6>=</span> virtualInvokers.<span style=color:#50fa7b>firstEntry</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        String serverAddress <span style=color:#ff79c6>=</span> entry.<span style=color:#50fa7b>getValue</span>().<span style=color:#50fa7b>getUrl</span>().<span style=color:#50fa7b>getAddress</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span><span style=color:#6272a4>         * The following part of codes aims to select suitable invoker.
</span></span></span><span style=display:flex><span><span style=color:#6272a4>         * This part is not complete thread safety.
</span></span></span><span style=display:flex><span><span style=color:#6272a4>         * However, in the scene of consumer-side load balance,
</span></span></span><span style=display:flex><span><span style=color:#6272a4>         * thread race for this part of codes
</span></span></span><span style=display:flex><span><span style=color:#6272a4>         * (execution time cost for this part of codes without any IO or
</span></span></span><span style=display:flex><span><span style=color:#6272a4>         * network operation is very low) will rarely occur. And even in
</span></span></span><span style=display:flex><span><span style=color:#6272a4>         * extreme case, a few requests are assigned to an invoker which
</span></span></span><span style=display:flex><span><span style=color:#6272a4>         * is above OVERLOAD_RATIO_THREAD will not make a significant impact
</span></span></span><span style=display:flex><span><span style=color:#6272a4>         * on the effect of this new algorithm.
</span></span></span><span style=display:flex><span><span style=color:#6272a4>         * And make this part of codes synchronized will reduce efficiency of
</span></span></span><span style=display:flex><span><span style=color:#6272a4>         * every request. In my opinion, this is not worth. So it is not a
</span></span></span><span style=display:flex><span><span style=color:#6272a4>         * problem for this part is not complete thread safety.
</span></span></span><span style=display:flex><span><span style=color:#6272a4>         */</span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd>double</span> overloadThread <span style=color:#ff79c6>=</span> ((<span style=color:#8be9fd>double</span>) totalRequestCount.<span style=color:#50fa7b>get</span>() <span style=color:#ff79c6>/</span> (<span style=color:#8be9fd>double</span>) serverCount) <span style=color:#ff79c6>*</span> OVERLOAD_RATIO_THREAD;
</span></span><span style=display:flex><span>        <span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span><span style=color:#6272a4>         * Find a valid server node:
</span></span></span><span style=display:flex><span><span style=color:#6272a4>         * 1. Not have accept request yet
</span></span></span><span style=display:flex><span><span style=color:#6272a4>         * or
</span></span></span><span style=display:flex><span><span style=color:#6272a4>         * 2. Not have overloaded (request count already accept &lt; thread (average request count * overloadRatioAllowed ))
</span></span></span><span style=display:flex><span><span style=color:#6272a4>         */</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>while</span> (serverRequestCountMap.<span style=color:#50fa7b>containsKey</span>(serverAddress)
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>&amp;&amp;</span> serverRequestCountMap.<span style=color:#50fa7b>get</span>(serverAddress).<span style=color:#50fa7b>get</span>() <span style=color:#ff79c6>&gt;=</span> overloadThread) {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span><span style=color:#6272a4>             * If server node is not valid, get next node
</span></span></span><span style=display:flex><span><span style=color:#6272a4>             */</span>
</span></span><span style=display:flex><span>            entry <span style=color:#ff79c6>=</span> getNextInvokerNode(virtualInvokers, entry);
</span></span><span style=display:flex><span>            serverAddress <span style=color:#ff79c6>=</span> entry.<span style=color:#50fa7b>getValue</span>().<span style=color:#50fa7b>getUrl</span>().<span style=color:#50fa7b>getAddress</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>serverRequestCountMap.<span style=color:#50fa7b>containsKey</span>(serverAddress)) {
</span></span><span style=display:flex><span>            serverRequestCountMap.<span style=color:#50fa7b>put</span>(serverAddress, <span style=color:#ff79c6>new</span> AtomicLong(1));
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>            serverRequestCountMap.<span style=color:#50fa7b>get</span>(serverAddress).<span style=color:#50fa7b>incrementAndGet</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        totalRequestCount.<span style=color:#50fa7b>incrementAndGet</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> entry.<span style=color:#50fa7b>getValue</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> Map.<span style=color:#50fa7b>Entry</span><span style=color:#ff79c6>&lt;</span>Long, Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> <span style=color:#50fa7b>getNextInvokerNode</span>(TreeMap<span style=color:#ff79c6>&lt;</span>Long, Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> virtualInvokers, Map.<span style=color:#50fa7b>Entry</span><span style=color:#ff79c6>&lt;</span>Long, Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> entry){
</span></span><span style=display:flex><span>        Map.<span style=color:#50fa7b>Entry</span><span style=color:#ff79c6>&lt;</span>Long, Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> nextEntry <span style=color:#ff79c6>=</span> virtualInvokers.<span style=color:#50fa7b>higherEntry</span>(entry.<span style=color:#50fa7b>getKey</span>());
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span>(nextEntry <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>){
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> virtualInvokers.<span style=color:#50fa7b>firstEntry</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> nextEntry;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>long</span> <span style=color:#50fa7b>hash</span>(<span style=color:#8be9fd>byte</span><span style=color:#ff79c6>[]</span> digest, <span style=color:#8be9fd>int</span> number) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> (((<span style=color:#8be9fd>long</span>) (digest<span style=color:#ff79c6>[</span>3 <span style=color:#ff79c6>+</span> number <span style=color:#ff79c6>*</span> 4<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>&amp;</span> 0xFF) <span style=color:#ff79c6>&lt;&lt;</span> 24)
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>|</span> ((<span style=color:#8be9fd>long</span>) (digest<span style=color:#ff79c6>[</span>2 <span style=color:#ff79c6>+</span> number <span style=color:#ff79c6>*</span> 4<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>&amp;</span> 0xFF) <span style=color:#ff79c6>&lt;&lt;</span> 16)
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>|</span> ((<span style=color:#8be9fd>long</span>) (digest<span style=color:#ff79c6>[</span>1 <span style=color:#ff79c6>+</span> number <span style=color:#ff79c6>*</span> 4<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>&amp;</span> 0xFF) <span style=color:#ff79c6>&lt;&lt;</span> 8)
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>|</span> (digest<span style=color:#ff79c6>[</span>number <span style=color:#ff79c6>*</span> 4<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>&amp;</span> 0xFF))
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>&amp;</span> 0xFFFFFFFFL;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h5 id=3自动降级机制>3.自动降级机制<a hidden class=anchor aria-hidden=true href=#3自动降级机制>#</a></h5><p>在调用容错策略对应的Invoker之前会经过MockCLusterInvoker，他的Invoker组成了严格的责任链模式，这个Invoker是负责处理mock配置的，有两种选择，force开头的潜质mock和普通mock，强制mock就是不发起远程调用，直接本地模拟，普通mock会在远程调用失败的时候才进行模拟调用：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> Result <span style=color:#50fa7b>invoke</span>(Invocation invocation) <span style=color:#8be9fd;font-style:italic>throws</span> RpcException {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 模拟调用的意思就是如果目标provider故障了，这个时候consumer可以降级调用</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 降级使用的就是mock模拟，不发起远程调用</span>
</span></span><span style=display:flex><span>    Result result;
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 获取mock配置</span>
</span></span><span style=display:flex><span>    String value <span style=color:#ff79c6>=</span> getUrl().<span style=color:#50fa7b>getMethodParameter</span>(invocation.<span style=color:#50fa7b>getMethodName</span>(), MOCK_KEY, Boolean.<span style=color:#50fa7b>FALSE</span>.<span style=color:#50fa7b>toString</span>()).<span style=color:#50fa7b>trim</span>();
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (value.<span style=color:#50fa7b>length</span>() <span style=color:#ff79c6>==</span> 0 <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#34;false&#34;</span>.<span style=color:#50fa7b>equalsIgnoreCase</span>(value)) {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 处理no mock的情况</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 发起正常的情况</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 这个时候invoker是AbstractCluster的内部类ClusterFilterInvoker</span>
</span></span><span style=display:flex><span>        result <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>invoker</span>.<span style=color:#50fa7b>invoke</span>(invocation);
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (value.<span style=color:#50fa7b>startsWith</span>(FORCE_KEY)) {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 如果mock的配置是force开头就说明是强制mock</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 这个时候是不会走远程调用的</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (logger.<span style=color:#50fa7b>isWarnEnabled</span>()) {
</span></span><span style=display:flex><span>            logger.<span style=color:#50fa7b>warn</span>(<span style=color:#f1fa8c>&#34;force-mock: &#34;</span> <span style=color:#ff79c6>+</span> invocation.<span style=color:#50fa7b>getMethodName</span>() <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; force-mock enabled , url : &#34;</span> <span style=color:#ff79c6>+</span> getUrl());
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#6272a4>//force:direct mock</span>
</span></span><span style=display:flex><span>        result <span style=color:#ff79c6>=</span> doMockInvoke(invocation, <span style=color:#ff79c6>null</span>);
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 这个就是正常的mock</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 先远程调用，如果失败了就走模拟调用</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>            result <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>invoker</span>.<span style=color:#50fa7b>invoke</span>(invocation);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>//fix:#4585</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span>(result.<span style=color:#50fa7b>getException</span>() <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> result.<span style=color:#50fa7b>getException</span>() <span style=color:#ff79c6>instanceof</span> RpcException){
</span></span><span style=display:flex><span>                RpcException rpcException<span style=color:#ff79c6>=</span> (RpcException)result.<span style=color:#50fa7b>getException</span>();
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>if</span>(rpcException.<span style=color:#50fa7b>isBiz</span>()){
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>throw</span>  rpcException;
</span></span><span style=display:flex><span>                }<span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>                    result <span style=color:#ff79c6>=</span> doMockInvoke(invocation, rpcException);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>catch</span> (RpcException e) {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (e.<span style=color:#50fa7b>isBiz</span>()) {
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>throw</span> e;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (logger.<span style=color:#50fa7b>isWarnEnabled</span>()) {
</span></span><span style=display:flex><span>                logger.<span style=color:#50fa7b>warn</span>(<span style=color:#f1fa8c>&#34;fail-mock: &#34;</span> <span style=color:#ff79c6>+</span> invocation.<span style=color:#50fa7b>getMethodName</span>() <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; fail-mock enabled , url : &#34;</span> <span style=color:#ff79c6>+</span> getUrl(), e);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            result <span style=color:#ff79c6>=</span> doMockInvoke(invocation, e);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> result;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>模拟调用的源码：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>private</span> Result <span style=color:#50fa7b>doMockInvoke</span>(Invocation invocation, RpcException e) {
</span></span><span style=display:flex><span>    Result result;
</span></span><span style=display:flex><span>    Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> mockInvoker;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 选择模拟的invoker</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 他这个里面就是给invocation设置了一个invocation.need.mock参数</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 然后把DynamicDirectory的invokers返回了</span>
</span></span><span style=display:flex><span>    List<span style=color:#ff79c6>&lt;</span>Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> mockInvokers <span style=color:#ff79c6>=</span> selectMockInvoker(invocation);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 如果DynamicDirectory里的invokers不是空就拿第一个，否则新建一个MockInvoker</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (CollectionUtils.<span style=color:#50fa7b>isEmpty</span>(mockInvokers)) {
</span></span><span style=display:flex><span>        mockInvoker <span style=color:#ff79c6>=</span> (Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span>) <span style=color:#ff79c6>new</span> MockInvoker(getUrl(), directory.<span style=color:#50fa7b>getInterface</span>());
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// TODO 这里看一下还是会走正常调用，但是invocation多了一个invocation.need.mock参数</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 估计后面会判断这个参数不执行远程调用</span>
</span></span><span style=display:flex><span>        mockInvoker <span style=color:#ff79c6>=</span> mockInvokers.<span style=color:#50fa7b>get</span>(0);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>        result <span style=color:#ff79c6>=</span> mockInvoker.<span style=color:#50fa7b>invoke</span>(invocation);
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>catch</span> (RpcException mockException) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (mockException.<span style=color:#50fa7b>isBiz</span>()) {
</span></span><span style=display:flex><span>            result <span style=color:#ff79c6>=</span> AsyncRpcResult.<span style=color:#50fa7b>newDefaultAsyncResult</span>(mockException.<span style=color:#50fa7b>getCause</span>(), invocation);
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> RpcException(mockException.<span style=color:#50fa7b>getCode</span>(), getMockExceptionMessage(e, mockException), mockException.<span style=color:#50fa7b>getCause</span>());
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>catch</span> (Throwable me) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> RpcException(getMockExceptionMessage(e, me), me.<span style=color:#50fa7b>getCause</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> result;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>执行远程调用的方式有两种，一种是invokers全部下线使用MockInvoker模拟，另外一种还是正常的Invoker执行，但是invocation多了一个invocation.need.mock参数。</p><h6 id=使用mockinvoker模拟调用>使用MockInvoker模拟调用：<a hidden class=anchor aria-hidden=true href=#使用mockinvoker模拟调用>#</a></h6><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> Result <span style=color:#50fa7b>invoke</span>(Invocation invocation) <span style=color:#8be9fd;font-style:italic>throws</span> RpcException {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (invocation <span style=color:#ff79c6>instanceof</span> RpcInvocation) {
</span></span><span style=display:flex><span>        ((RpcInvocation) invocation).<span style=color:#50fa7b>setInvoker</span>(<span style=color:#ff79c6>this</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    String mock <span style=color:#ff79c6>=</span> getUrl().<span style=color:#50fa7b>getMethodParameter</span>(invocation.<span style=color:#50fa7b>getMethodName</span>(), MOCK_KEY);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (StringUtils.<span style=color:#50fa7b>isBlank</span>(mock)) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> RpcException(<span style=color:#ff79c6>new</span> IllegalAccessException(<span style=color:#f1fa8c>&#34;mock can not be null. url :&#34;</span> <span style=color:#ff79c6>+</span> url));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 根据mock参数的前缀设置mock变量</span>
</span></span><span style=display:flex><span>    mock <span style=color:#ff79c6>=</span> normalizeMock(URL.<span style=color:#50fa7b>decode</span>(mock));
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (mock.<span style=color:#50fa7b>startsWith</span>(RETURN_PREFIX)) {
</span></span><span style=display:flex><span>        mock <span style=color:#ff79c6>=</span> mock.<span style=color:#50fa7b>substring</span>(RETURN_PREFIX.<span style=color:#50fa7b>length</span>()).<span style=color:#50fa7b>trim</span>();
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>            Type<span style=color:#ff79c6>[]</span> returnTypes <span style=color:#ff79c6>=</span> RpcUtils.<span style=color:#50fa7b>getReturnTypes</span>(invocation);
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 根据returnType拿到返回的默认值</span>
</span></span><span style=display:flex><span>            Object value <span style=color:#ff79c6>=</span> parseMockValue(mock, returnTypes);
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> AsyncRpcResult.<span style=color:#50fa7b>newDefaultAsyncResult</span>(value, invocation);
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>catch</span> (Exception ew) {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> RpcException(<span style=color:#f1fa8c>&#34;mock return invoke error. method :&#34;</span> <span style=color:#ff79c6>+</span> invocation.<span style=color:#50fa7b>getMethodName</span>()
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;, mock:&#34;</span> <span style=color:#ff79c6>+</span> mock <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;, url: &#34;</span> <span style=color:#ff79c6>+</span> url, ew);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (mock.<span style=color:#50fa7b>startsWith</span>(THROW_PREFIX)) {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 配置的mock是抛出异常就直接抛出异常</span>
</span></span><span style=display:flex><span>        mock <span style=color:#ff79c6>=</span> mock.<span style=color:#50fa7b>substring</span>(THROW_PREFIX.<span style=color:#50fa7b>length</span>()).<span style=color:#50fa7b>trim</span>();
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (StringUtils.<span style=color:#50fa7b>isBlank</span>(mock)) {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> RpcException(<span style=color:#f1fa8c>&#34;mocked exception for service degradation.&#34;</span>);
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>else</span> { <span style=color:#6272a4>// user customized class</span>
</span></span><span style=display:flex><span>            Throwable t <span style=color:#ff79c6>=</span> getThrowable(mock);
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> RpcException(RpcException.<span style=color:#50fa7b>BIZ_EXCEPTION</span>, t);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>else</span> { <span style=color:#6272a4>//impl mock</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 执行自己实现的mock类</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>            Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> invoker <span style=color:#ff79c6>=</span> getInvoker(mock);
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> invoker.<span style=color:#50fa7b>invoke</span>(invocation);
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>catch</span> (Throwable t) {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> RpcException(<span style=color:#f1fa8c>&#34;Failed to create mock implementation class &#34;</span> <span style=color:#ff79c6>+</span> mock, t);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h6 id=通过invocation配置invocationneedmock参数实现mock>通过invocation配置invocation.need.mock参数实现mock<a hidden class=anchor aria-hidden=true href=#通过invocation配置invocationneedmock参数实现mock>#</a></h6><p>这种方式的视线在MockInvokersSelector的route()方法中，这种情况会根据invokers中有没有配置成mock的provider返回，没有会返回空集合。</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> List<span style=color:#ff79c6>&lt;</span>Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> <span style=color:#50fa7b>route</span>(<span style=color:#8be9fd;font-style:italic>final</span> List<span style=color:#ff79c6>&lt;</span>Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> invokers,
</span></span><span style=display:flex><span>                                  URL url, <span style=color:#8be9fd;font-style:italic>final</span> Invocation invocation) <span style=color:#8be9fd;font-style:italic>throws</span> RpcException {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (CollectionUtils.<span style=color:#50fa7b>isEmpty</span>(invokers)) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> invokers;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (invocation.<span style=color:#50fa7b>getObjectAttachments</span>() <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> getNormalInvokers(invokers);
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>        String value <span style=color:#ff79c6>=</span> (String) invocation.<span style=color:#50fa7b>getObjectAttachments</span>().<span style=color:#50fa7b>get</span>(INVOCATION_NEED_MOCK);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (value <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> getNormalInvokers(invokers);
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (Boolean.<span style=color:#50fa7b>TRUE</span>.<span style=color:#50fa7b>toString</span>().<span style=color:#50fa7b>equalsIgnoreCase</span>(value)) {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> getMockedInvokers(invokers);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> invokers;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> List<span style=color:#ff79c6>&lt;</span>Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> <span style=color:#50fa7b>getMockedInvokers</span>(<span style=color:#8be9fd;font-style:italic>final</span> List<span style=color:#ff79c6>&lt;</span>Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> invokers) {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>hasMockProviders(invokers)) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    List<span style=color:#ff79c6>&lt;</span>Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> sInvokers <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ArrayList<span style=color:#ff79c6>&lt;</span>Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span>(1);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> (Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> invoker : invokers) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (invoker.<span style=color:#50fa7b>getUrl</span>().<span style=color:#50fa7b>getProtocol</span>().<span style=color:#50fa7b>equals</span>(MOCK_PROTOCOL)) {
</span></span><span style=display:flex><span>            sInvokers.<span style=color:#50fa7b>add</span>(invoker);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> sInvokers;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=4router>4.Router<a hidden class=anchor aria-hidden=true href=#4router>#</a></h3><p>dubbo的条件路由</p><p>Router的实现类在RouterChain类中使用，他是在DynamicDirectory中调用的RouterChain的构造方法构建Route链条：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#50fa7b>RouterChain</span>(URL url) {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 获取线程池组件</span>
</span></span><span style=display:flex><span>    executorRepository <span style=color:#ff79c6>=</span> url.<span style=color:#50fa7b>getOrDefaultApplicationModel</span>().<span style=color:#50fa7b>getExtensionLoader</span>(ExecutorRepository.<span style=color:#50fa7b>class</span>)
</span></span><span style=display:flex><span>        .<span style=color:#50fa7b>getDefaultExtension</span>();
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 创建一个新的线程池</span>
</span></span><span style=display:flex><span>    loopPool <span style=color:#ff79c6>=</span> executorRepository.<span style=color:#50fa7b>nextExecutorExecutor</span>();
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 获取自动激活的RouterFactory</span>
</span></span><span style=display:flex><span>    List<span style=color:#ff79c6>&lt;</span>RouterFactory<span style=color:#ff79c6>&gt;</span> extensionFactories <span style=color:#ff79c6>=</span> url.<span style=color:#50fa7b>getOrDefaultApplicationModel</span>().<span style=color:#50fa7b>getExtensionLoader</span>(RouterFactory.<span style=color:#50fa7b>class</span>)
</span></span><span style=display:flex><span>        .<span style=color:#50fa7b>getActivateExtension</span>(url, ROUTER_KEY);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 获取Router list</span>
</span></span><span style=display:flex><span>    List<span style=color:#ff79c6>&lt;</span>Router<span style=color:#ff79c6>&gt;</span> routers <span style=color:#ff79c6>=</span> extensionFactories.<span style=color:#50fa7b>stream</span>()
</span></span><span style=display:flex><span>        .<span style=color:#50fa7b>map</span>(factory <span style=color:#ff79c6>-&gt;</span> factory.<span style=color:#50fa7b>getRouter</span>(url))
</span></span><span style=display:flex><span>        .<span style=color:#50fa7b>sorted</span>(Router::compareTo)
</span></span><span style=display:flex><span>        .<span style=color:#50fa7b>collect</span>(Collectors.<span style=color:#50fa7b>toList</span>());
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 这里没什么东西</span>
</span></span><span style=display:flex><span>    initWithRouters(routers);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 这里应该能拿到3种RouterFactory</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// CacheableStateRouterFactory(可缓存的Router)</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// TagDynamicStateRouterFactory(动态标签Router)</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// TagStaticStateRouterFactory(静态标签Router)</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 基于TagRouter可以实现灰度发布、蓝绿发布</span>
</span></span><span style=display:flex><span>    List<span style=color:#ff79c6>&lt;</span>StateRouterFactory<span style=color:#ff79c6>&gt;</span> extensionStateRouterFactories <span style=color:#ff79c6>=</span> url.<span style=color:#50fa7b>getOrDefaultApplicationModel</span>()
</span></span><span style=display:flex><span>        .<span style=color:#50fa7b>getExtensionLoader</span>(StateRouterFactory.<span style=color:#50fa7b>class</span>)
</span></span><span style=display:flex><span>        .<span style=color:#50fa7b>getActivateExtension</span>(url, STATE_ROUTER_KEY);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    List<span style=color:#ff79c6>&lt;</span>StateRouter<span style=color:#ff79c6>&gt;</span> stateRouters <span style=color:#ff79c6>=</span> extensionStateRouterFactories.<span style=color:#50fa7b>stream</span>()
</span></span><span style=display:flex><span>        .<span style=color:#50fa7b>map</span>(factory <span style=color:#ff79c6>-&gt;</span> factory.<span style=color:#50fa7b>getRouter</span>(url, <span style=color:#ff79c6>this</span>))
</span></span><span style=display:flex><span>        .<span style=color:#50fa7b>sorted</span>(StateRouter::compareTo)
</span></span><span style=display:flex><span>        .<span style=color:#50fa7b>collect</span>(Collectors.<span style=color:#50fa7b>toList</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// init state routers</span>
</span></span><span style=display:flex><span>    initWithStateRouters(stateRouters);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>当invoker发生改变时一定会调用RouterChain的setInvokers()方法，这个方法会遍历stateRouters更新invokers。</p><p>随便看几个主要的Router：</p><h5 id=1conditionrouter>1）ConditionRouter<a hidden class=anchor aria-hidden=true href=#1conditionrouter>#</a></h5><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> List<span style=color:#ff79c6>&lt;</span>Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> <span style=color:#50fa7b>route</span>(List<span style=color:#ff79c6>&lt;</span>Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> invokers, URL url, Invocation invocation)
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>throws</span> RpcException {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>enabled) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> invokers;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (CollectionUtils.<span style=color:#50fa7b>isEmpty</span>(invokers)) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> invokers;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 如果invokers都不符合条件，就返回原来的</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 就是根据参数和值进行匹配</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>matchWhen(url, invocation)) {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> invokers;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        List<span style=color:#ff79c6>&lt;</span>Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> result <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ArrayList<span style=color:#ff79c6>&lt;</span>Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span>();
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (thenCondition <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>            logger.<span style=color:#50fa7b>warn</span>(<span style=color:#f1fa8c>&#34;The current consumer in the service blacklist. consumer: &#34;</span> <span style=color:#ff79c6>+</span> NetUtils.<span style=color:#50fa7b>getLocalHost</span>() <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;, service: &#34;</span> <span style=color:#ff79c6>+</span> url.<span style=color:#50fa7b>getServiceKey</span>());
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> result;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>for</span> (Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> invoker : invokers) {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 再次匹配</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (matchThen(invoker.<span style=color:#50fa7b>getUrl</span>(), url)) {
</span></span><span style=display:flex><span>                result.<span style=color:#50fa7b>add</span>(invoker);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>result.<span style=color:#50fa7b>isEmpty</span>()) {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> result;
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>isForce</span>()) {
</span></span><span style=display:flex><span>            logger.<span style=color:#50fa7b>warn</span>(<span style=color:#f1fa8c>&#34;The route result is empty and force execute. consumer: &#34;</span> <span style=color:#ff79c6>+</span> NetUtils.<span style=color:#50fa7b>getLocalHost</span>() <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;, service: &#34;</span> <span style=color:#ff79c6>+</span> url.<span style=color:#50fa7b>getServiceKey</span>() <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;, router: &#34;</span> <span style=color:#ff79c6>+</span> url.<span style=color:#50fa7b>getParameterAndDecoded</span>(RULE_KEY));
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> result;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>catch</span> (Throwable t) {
</span></span><span style=display:flex><span>        logger.<span style=color:#50fa7b>error</span>(<span style=color:#f1fa8c>&#34;Failed to execute condition router rule: &#34;</span> <span style=color:#ff79c6>+</span> getUrl() <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;, invokers: &#34;</span> <span style=color:#ff79c6>+</span> invokers <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;, cause: &#34;</span> <span style=color:#ff79c6>+</span> t.<span style=color:#50fa7b>getMessage</span>(), t);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> invokers;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h5 id=2approuter>2）AppRouter<a hidden class=anchor aria-hidden=true href=#2approuter>#</a></h5><p>AppRouter是ListenableRouter的子类，当配置规则改变的时候会回调process()方法，这里维护了List&lt;ConditionRouter> conditionRouters列表，route()方法也是拿到所有的ConditionRouter进行过滤：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>synchronized</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>process</span>(ConfigChangedEvent event) {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (logger.<span style=color:#50fa7b>isDebugEnabled</span>()) {
</span></span><span style=display:flex><span>        logger.<span style=color:#50fa7b>debug</span>(<span style=color:#f1fa8c>&#34;Notification of condition rule, change type is: &#34;</span> <span style=color:#ff79c6>+</span> event.<span style=color:#50fa7b>getChangeType</span>() <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;, raw rule is:\n &#34;</span> <span style=color:#ff79c6>+</span> event.<span style=color:#50fa7b>getContent</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (event.<span style=color:#50fa7b>getChangeType</span>().<span style=color:#50fa7b>equals</span>(ConfigChangeType.<span style=color:#50fa7b>DELETED</span>)) {
</span></span><span style=display:flex><span>        routerRule <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span>        conditionRouters <span style=color:#ff79c6>=</span> Collections.<span style=color:#50fa7b>emptyList</span>();
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 这个routerRule就是List&lt;String&gt; conditions</span>
</span></span><span style=display:flex><span>            routerRule <span style=color:#ff79c6>=</span> ConditionRuleParser.<span style=color:#50fa7b>parse</span>(event.<span style=color:#50fa7b>getContent</span>());
</span></span><span style=display:flex><span>            generateConditions(routerRule);
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>catch</span> (Exception e) {
</span></span><span style=display:flex><span>            logger.<span style=color:#50fa7b>error</span>(<span style=color:#f1fa8c>&#34;Failed to parse the raw condition rule and it will not take effect, please check &#34;</span> <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>                    <span style=color:#f1fa8c>&#34;if the condition rule matches with the template, the raw rule is:\n &#34;</span> <span style=color:#ff79c6>+</span> event.<span style=color:#50fa7b>getContent</span>(), e);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h5 id=2scriptrouter>2）ScriptRouter<a hidden class=anchor aria-hidden=true href=#2scriptrouter>#</a></h5><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> List<span style=color:#ff79c6>&lt;</span>Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> <span style=color:#50fa7b>route</span>(List<span style=color:#ff79c6>&lt;</span>Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> invokers, URL url, Invocation invocation) <span style=color:#8be9fd;font-style:italic>throws</span> RpcException {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (engine <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>||</span> function <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> invokers;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    Bindings bindings <span style=color:#ff79c6>=</span> createBindings(invokers, invocation);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> getRoutedInvokers(AccessController.<span style=color:#50fa7b>doPrivileged</span>((PrivilegedAction<span style=color:#ff79c6>&lt;</span>Object<span style=color:#ff79c6>&gt;</span>) () <span style=color:#ff79c6>-&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 动态运行脚本</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> function.<span style=color:#50fa7b>eval</span>(bindings);
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>catch</span> (ScriptException e) {
</span></span><span style=display:flex><span>            logger.<span style=color:#50fa7b>error</span>(<span style=color:#f1fa8c>&#34;route error, rule has been ignored. rule: &#34;</span> <span style=color:#ff79c6>+</span> rule <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;, method:&#34;</span> <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>                    invocation.<span style=color:#50fa7b>getMethodName</span>() <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;, url: &#34;</span> <span style=color:#ff79c6>+</span> RpcContext.<span style=color:#50fa7b>getContext</span>().<span style=color:#50fa7b>getUrl</span>(), e);
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> invokers;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }, accessControlContext));
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h5 id=3tagrouter>3）TagRouter<a hidden class=anchor aria-hidden=true href=#3tagrouter>#</a></h5><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> List<span style=color:#ff79c6>&lt;</span>Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> <span style=color:#50fa7b>route</span>(List<span style=color:#ff79c6>&lt;</span>Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> invokers, URL url, Invocation invocation) <span style=color:#8be9fd;font-style:italic>throws</span> RpcException {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (CollectionUtils.<span style=color:#50fa7b>isEmpty</span>(invokers)) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> invokers;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// since the rule can be changed by config center, we should copy one to use.</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>final</span> TagRouterRule tagRouterRuleCopy <span style=color:#ff79c6>=</span> tagRouterRule;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (tagRouterRuleCopy <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>||</span> <span style=color:#ff79c6>!</span>tagRouterRuleCopy.<span style=color:#50fa7b>isValid</span>() <span style=color:#ff79c6>||</span> <span style=color:#ff79c6>!</span>tagRouterRuleCopy.<span style=color:#50fa7b>isEnabled</span>()) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> filterUsingStaticTag(invokers, url, invocation);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    List<span style=color:#ff79c6>&lt;</span>Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> result <span style=color:#ff79c6>=</span> invokers;
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 主要是根据tag属性匹配</span>
</span></span><span style=display:flex><span>    String tag <span style=color:#ff79c6>=</span> StringUtils.<span style=color:#50fa7b>isEmpty</span>(invocation.<span style=color:#50fa7b>getAttachment</span>(TAG_KEY)) <span style=color:#ff79c6>?</span> url.<span style=color:#50fa7b>getParameter</span>(TAG_KEY) :
</span></span><span style=display:flex><span>            invocation.<span style=color:#50fa7b>getAttachment</span>(TAG_KEY);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// if we are requesting for a Provider with a specific tag</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (StringUtils.<span style=color:#50fa7b>isNotEmpty</span>(tag)) {
</span></span><span style=display:flex><span>        List<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span> addresses <span style=color:#ff79c6>=</span> tagRouterRuleCopy.<span style=color:#50fa7b>getTagnameToAddresses</span>().<span style=color:#50fa7b>get</span>(tag);
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// filter by dynamic tag group first</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (CollectionUtils.<span style=color:#50fa7b>isNotEmpty</span>(addresses)) {
</span></span><span style=display:flex><span>            result <span style=color:#ff79c6>=</span> filterInvoker(invokers, invoker <span style=color:#ff79c6>-&gt;</span> addressMatches(invoker.<span style=color:#50fa7b>getUrl</span>(), addresses));
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// if result is not null OR it&#39;s null but force=true, return result directly</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (CollectionUtils.<span style=color:#50fa7b>isNotEmpty</span>(result) <span style=color:#ff79c6>||</span> tagRouterRuleCopy.<span style=color:#50fa7b>isForce</span>()) {
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>return</span> result;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// dynamic tag group doesn&#39;t have any item about the requested app OR it&#39;s null after filtered by</span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// dynamic tag group but force=false. check static tag</span>
</span></span><span style=display:flex><span>            result <span style=color:#ff79c6>=</span> filterInvoker(invokers, invoker <span style=color:#ff79c6>-&gt;</span> tag.<span style=color:#50fa7b>equals</span>(invoker.<span style=color:#50fa7b>getUrl</span>().<span style=color:#50fa7b>getParameter</span>(TAG_KEY)));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// If there&#39;s no tagged providers that can match the current tagged request. force.tag is set by default</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// to false, which means it will invoke any providers without a tag unless it&#39;s explicitly disallowed.</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (CollectionUtils.<span style=color:#50fa7b>isNotEmpty</span>(result) <span style=color:#ff79c6>||</span> isForceUseTag(invocation)) {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> result;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// FAILOVER: return all Providers without any tags.</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>            List<span style=color:#ff79c6>&lt;</span>Invoker<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;&gt;</span> tmp <span style=color:#ff79c6>=</span> filterInvoker(invokers, invoker <span style=color:#ff79c6>-&gt;</span> addressNotMatches(invoker.<span style=color:#50fa7b>getUrl</span>(),
</span></span><span style=display:flex><span>                    tagRouterRuleCopy.<span style=color:#50fa7b>getAddresses</span>()));
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> filterInvoker(tmp, invoker <span style=color:#ff79c6>-&gt;</span> StringUtils.<span style=color:#50fa7b>isEmpty</span>(invoker.<span style=color:#50fa7b>getUrl</span>().<span style=color:#50fa7b>getParameter</span>(TAG_KEY)));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// List&lt;String&gt; addresses = tagRouterRule.filter(providerApp);</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// return all addresses in dynamic tag group.</span>
</span></span><span style=display:flex><span>        List<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span> addresses <span style=color:#ff79c6>=</span> tagRouterRuleCopy.<span style=color:#50fa7b>getAddresses</span>();
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (CollectionUtils.<span style=color:#50fa7b>isNotEmpty</span>(addresses)) {
</span></span><span style=display:flex><span>            result <span style=color:#ff79c6>=</span> filterInvoker(invokers, invoker <span style=color:#ff79c6>-&gt;</span> addressNotMatches(invoker.<span style=color:#50fa7b>getUrl</span>(), addresses));
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 1. all addresses are in dynamic tag group, return empty list.</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (CollectionUtils.<span style=color:#50fa7b>isEmpty</span>(result)) {
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>return</span> result;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 2. if there are some addresses that are not in any dynamic tag group, continue to filter using the</span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// static tag group.</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> filterInvoker(result, invoker <span style=color:#ff79c6>-&gt;</span> {
</span></span><span style=display:flex><span>            String localTag <span style=color:#ff79c6>=</span> invoker.<span style=color:#50fa7b>getUrl</span>().<span style=color:#50fa7b>getParameter</span>(TAG_KEY);
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> StringUtils.<span style=color:#50fa7b>isEmpty</span>(localTag) <span style=color:#ff79c6>||</span> <span style=color:#ff79c6>!</span>tagRouterRuleCopy.<span style=color:#50fa7b>getTagNames</span>().<span style=color:#50fa7b>contains</span>(localTag);
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h5 id=4meshrulerouter>4）MeshRuleRouter<a hidden class=anchor aria-hidden=true href=#4meshrulerouter>#</a></h5><p>流量管理路由策略，主要分为两块，VirtualService和DestinationRule。</p><p>当consumer调用服务的时候会根据DubboRoute和DubboRouteDetail匹配到DubboDestination中对应的subset。</p><ul><li><a href=https://dubbo.apache.org/zh/docs3-v2/java-sdk/advanced-featrues-and-usage/traffic/mesh-style/virtualservice/>VirtualService</a> 主要处理入站流量分流的规则，支持服务级别和方法级别的分流。</li><li><a href=https://dubbo.apache.org/zh/docs3-v2/java-sdk/advanced-featrues-and-usage/traffic/mesh-style/virtualservice/#dubboroute>DubboRoute</a> 主要解决服务级别的分流问题。同时，还提供的重试机制、超时、故障注入、镜像流量等能力。</li><li><a href=https://dubbo.apache.org/zh/docs3-v2/java-sdk/advanced-featrues-and-usage/traffic/mesh-style/virtualservice/#dubboroutedetail>DubboRouteDetail</a> 主要解决某个服务中方法级别的分流问题。支持方法名、方法参数、参数个数、参数类型、header 等各种维度的分流能力。同时也支持方法级的重试机制、超时、故障注入、镜像流量等能力。</li><li><a href=https://dubbo.apache.org/zh/docs3-v2/java-sdk/advanced-featrues-and-usage/traffic/mesh-style/virtualservice/#dubbodestination>DubboDestination</a> 用来描述路由流量的目标地址，支持 host、port、subnet 等方式。</li><li><a href=https://dubbo.apache.org/zh/docs3-v2/java-sdk/advanced-featrues-and-usage/traffic/mesh-style/destination-rule/>DestinationRule</a> 主要处理目标地址规则，可以通过 hosts、subnet 等方式关联到 Provider 集群。同时可以通过 <a href=https://dubbo.apache.org/zh/docs3-v2/java-sdk/advanced-featrues-and-usage/traffic/mesh-style/destination-rule/#trafficpolicy>trafficPolicy</a> 来实现负载均衡。</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://wangxiaohong123.github.io/tags/%E6%BA%90%E7%A0%81/>源码</a></li></ul><nav class=paginav><a class=prev href=https://wangxiaohong123.github.io/posts/%E6%A1%86%E6%9E%B6/spring/cloud-alibaba/cloud-alibaba-demo%E4%B9%8B%E8%AE%A2%E5%8D%95/6.%E9%99%90%E6%B5%81%E7%86%94%E6%96%AD/><span class=title>« Prev</span><br><span>6.限流熔断</span>
</a><a class=next href=https://wangxiaohong123.github.io/posts/%E5%9F%BA%E7%A1%80/%E7%AE%97%E6%B3%95/leecode/7.%E5%A4%9A%E6%95%B0%E5%85%83%E7%B4%A0/><span class=title>Next »</span><br><span>7.多数元素</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share 7.cluster模块源码 on x" href="https://x.com/intent/tweet/?text=7.cluster%e6%a8%a1%e5%9d%97%e6%ba%90%e7%a0%81&amp;url=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fspring%2fcloud-alibaba%2fdubbo%2f7.cluster%25E6%25A8%25A1%25E5%259D%2597%25E6%25BA%2590%25E7%25A0%2581%2f&amp;hashtags=%e6%ba%90%e7%a0%81"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 7.cluster模块源码 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fspring%2fcloud-alibaba%2fdubbo%2f7.cluster%25E6%25A8%25A1%25E5%259D%2597%25E6%25BA%2590%25E7%25A0%2581%2f&amp;title=7.cluster%e6%a8%a1%e5%9d%97%e6%ba%90%e7%a0%81&amp;summary=7.cluster%e6%a8%a1%e5%9d%97%e6%ba%90%e7%a0%81&amp;source=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fspring%2fcloud-alibaba%2fdubbo%2f7.cluster%25E6%25A8%25A1%25E5%259D%2597%25E6%25BA%2590%25E7%25A0%2581%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 7.cluster模块源码 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fspring%2fcloud-alibaba%2fdubbo%2f7.cluster%25E6%25A8%25A1%25E5%259D%2597%25E6%25BA%2590%25E7%25A0%2581%2f&title=7.cluster%e6%a8%a1%e5%9d%97%e6%ba%90%e7%a0%81"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 7.cluster模块源码 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fspring%2fcloud-alibaba%2fdubbo%2f7.cluster%25E6%25A8%25A1%25E5%259D%2597%25E6%25BA%2590%25E7%25A0%2581%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 7.cluster模块源码 on whatsapp" href="https://api.whatsapp.com/send?text=7.cluster%e6%a8%a1%e5%9d%97%e6%ba%90%e7%a0%81%20-%20https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fspring%2fcloud-alibaba%2fdubbo%2f7.cluster%25E6%25A8%25A1%25E5%259D%2597%25E6%25BA%2590%25E7%25A0%2581%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 7.cluster模块源码 on telegram" href="https://telegram.me/share/url?text=7.cluster%e6%a8%a1%e5%9d%97%e6%ba%90%e7%a0%81&amp;url=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fspring%2fcloud-alibaba%2fdubbo%2f7.cluster%25E6%25A8%25A1%25E5%259D%2597%25E6%25BA%2590%25E7%25A0%2581%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 7.cluster模块源码 on ycombinator" href="https://news.ycombinator.com/submitlink?t=7.cluster%e6%a8%a1%e5%9d%97%e6%ba%90%e7%a0%81&u=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fspring%2fcloud-alibaba%2fdubbo%2f7.cluster%25E6%25A8%25A1%25E5%259D%2597%25E6%25BA%2590%25E7%25A0%2581%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://wangxiaohong123.github.io/>王小红的笔记</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>