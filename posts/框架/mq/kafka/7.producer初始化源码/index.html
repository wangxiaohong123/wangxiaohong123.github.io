<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>7.kafka源码-producer初始化 | 王小红的笔记</title><meta name=keywords content="大数据"><meta name=description content='producer初始化
初始化producer，直接new KafkaProducer就可以，初始化的代码都在这个类里：


1


KafkaProducer<String, String> producer = new KafkaProducer<>(Properties);


在这个构造方法里首先把我们配置的Properties转成ProducerConfig，kafka自己的配置文件，这个文件里有所有的Producer配置和默认值，还有一些属性的名字和注释在CommonClientConfigs里：


1
2


this(new ProducerConfig(ProducerConfig.addSerializerToConfig(properties, keySerializer, valueSerializer)),
     keySerializer, valueSerializer, null, null);


然后调用另一个构造方法初始化核心组件：


  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139


KafkaProducer(ProducerConfig config, Serializer<K> keySerializer, Serializer<V> valueSerializer, Metadata metadata, KafkaClient kafkaClient) {
    try {
        // 我们自己的配置
        Map<String, Object> userProvidedConfigs = config.originals();
        this.producerConfig = config;
        this.time = Time.SYSTEM;
        // 获取client.id属性，默认是空串
        String clientId = config.getString(ProducerConfig.CLIENT_ID_CONFIG);
        if (clientId.length() <= 0)
            // 空串的话会走到这里，producer-自增数字作为clientId，线程安全的
            clientId = "producer-" + PRODUCER_CLIENT_ID_SEQUENCE.getAndIncrement();
        this.clientId = clientId;
        // 核心组件，用来决定你的消息会发送到那个topic的那个分区里的
        this.partitioner = config.getConfiguredInstance(ProducerConfig.PARTITIONER_CLASS_CONFIG, Partitioner.class);
        // retry.backoff.ms，重试间隔，默认100ms
        long retryBackoffMs = config.getLong(ProducerConfig.RETRY_BACKOFF_MS_CONFIG);
        // 序列组件
        if (keySerializer == null) {
            this.keySerializer = ensureExtended(config.getConfiguredInstance(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG,
                                                                             Serializer.class));
            this.keySerializer.configure(config.originals(), true);
        } else {
            config.ignore(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG);
            this.keySerializer = ensureExtended(keySerializer);
        }
        if (valueSerializer == null) {
            this.valueSerializer = ensureExtended(config.getConfiguredInstance(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG,
                                                                               Serializer.class));
            this.valueSerializer.configure(config.originals(), false);
        } else {
            config.ignore(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG);
            this.valueSerializer = ensureExtended(valueSerializer);
        }

        // 拦截器组件
        userProvidedConfigs.put(ProducerConfig.CLIENT_ID_CONFIG, clientId);
        List<ProducerInterceptor<K, V>> interceptorList = (List) (new ProducerConfig(userProvidedConfigs, false)).getConfiguredInstances(ProducerConfig.INTERCEPTOR_CLASSES_CONFIG,
                                                                                                                                         ProducerInterceptor.class);
        this.interceptors = new ProducerInterceptors<>(interceptorList);
        ClusterResourceListeners clusterResourceListeners = configureClusterResourceListeners(keySerializer, valueSerializer, interceptorList, reporters);
        // max.request.size，每个请求的最大大小，默认1M
        this.maxRequestSize = config.getInt(ProducerConfig.MAX_REQUEST_SIZE_CONFIG);
        // buffer.memory，缓冲池大小，默认32M
        this.totalMemorySize = config.getLong(ProducerConfig.BUFFER_MEMORY_CONFIG);
        this.compressionType = CompressionType.forName(config.getString(ProducerConfig.COMPRESSION_TYPE_CONFIG));

        // max.block.ms缓冲区满了的阻塞时间，默认一分钟，超过1分钟会抛出异常
        this.maxBlockTimeMs = config.getLong(ProducerConfig.MAX_BLOCK_MS_CONFIG);
        // request.timeout.ms，请求超时时间，默认30s
        this.requestTimeoutMs = config.getInt(ProducerConfig.REQUEST_TIMEOUT_MS_CONFIG);
        this.transactionManager = configureTransactionState(config, logContext, log);
        // 这个应该是重试次数
        int retries = configureRetries(config, transactionManager != null, log);
        int maxInflightRequests = configureInflightRequests(config, transactionManager != null);
        short acks = configureAcks(config, transactionManager != null, log);

        this.apiVersions = new ApiVersions();
        // 核心组件，缓冲池
        this.accumulator = new RecordAccumulator(logContext,
                                                 config.getInt(ProducerConfig.BATCH_SIZE_CONFIG),
                                                 this.totalMemorySize,
                                                 this.compressionType,
                                                 config.getLong(ProducerConfig.LINGER_MS_CONFIG),
                                                 retryBackoffMs,
                                                 metrics,
                                                 time,
                                                 apiVersions,
                                                 transactionManager);
        // broker地址
        List<InetSocketAddress> addresses = ClientUtils.parseAndValidateAddresses(config.getList(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG));
        // 核心组件，维护broker的元数据信息
        if (metadata != null) {
            this.metadata = metadata;
        } else {
            this.metadata = new Metadata(retryBackoffMs, 
                                         // metadata.max.age.ms，默认5分钟强制刷新一次
                                         config.getLong(ProducerConfig.METADATA_MAX_AGE_CONFIG),
                                         true, true, clusterResourceListeners);
            // 如果metadata是空需要拉取一下元数据
            this.metadata.update(Cluster.bootstrap(addresses), Collections.<String>emptySet(), time.milliseconds());
        }
        ChannelBuilder channelBuilder = ClientUtils.createChannelBuilder(config);
        Sensor throttleTimeSensor = Sender.throttleTimeSensor(metricsRegistry.senderMetrics);
        // 核心组件，网络通信组件，这里初始化了一个selector
        KafkaClient client = kafkaClient != null ? kafkaClient : new NetworkClient(
            new Selector(config.getLong(ProducerConfig.CONNECTIONS_MAX_IDLE_MS_CONFIG),
                         this.metrics, time, "producer", channelBuilder, logContext),
            // 这个是元数据的信息，负责元数据的增改，唤醒主线程
            this.metadata,
            clientId,
            // max.in.flight.requests.per.connection，同时发送的消息数
            // 这个最大就是5
            maxInflightRequests,
            // reconnect.backoff.ms，重新建立连接的等待时长
            config.getLong(ProducerConfig.RECONNECT_BACKOFF_MS_CONFIG),
            // reconnect.backoff.max.ms，建立连接的最大时长
            // 连接失败的时候会重试，每次间隔reconnect.backoff.ms成倍增加，直到超过max.ms
            config.getLong(ProducerConfig.RECONNECT_BACKOFF_MAX_MS_CONFIG),
            // send.buffer.bytes，# 发送缓冲区的大小
            config.getInt(ProducerConfig.SEND_BUFFER_CONFIG),
            // receive.buffer.bytes，接收缓冲区的大小
            config.getInt(ProducerConfig.RECEIVE_BUFFER_CONFIG),
            // request.timeout.ms，发送的超时时间
            this.requestTimeoutMs,
            time,
            true,
            apiVersions,
            throttleTimeSensor,
            logContext);
        // 核心组件，负责把缓冲池里的消息发送到broker上
        this.sender = new Sender(logContext,
                                 client,
                                 // 这个是元数据的信息，负责元数据的增改，唤醒主线程
                                 this.metadata,
                                 this.accumulator,
                                 maxInflightRequests == 1,
                                 // max.request.size单次请求的最大字节
                                 config.getInt(ProducerConfig.MAX_REQUEST_SIZE_CONFIG),
                                 acks,
                                 // 重试次数
                                 retries,
                                 metricsRegistry.senderMetrics,
                                 Time.SYSTEM,
                                 // 发送的超时时间
                                 this.requestTimeoutMs,
                                 // retry.backoff.ms，重试的最大时间
                                 config.getLong(ProducerConfig.RETRY_BACKOFF_MS_CONFIG),
                                 this.transactionManager,
                                 apiVersions);
        // 线程名：kafka-producer-network-thread|clientId
        String ioThreadName = NETWORK_THREAD_PREFIX + " | " + clientId;
        // 把sender放到线程里，启动
        this.ioThread = new KafkaThread(ioThreadName, this.sender, true);
        this.ioThread.start();
    } catch (Throwable t) {
        close(0, TimeUnit.MILLISECONDS, true);
        throw new KafkaException("Failed to construct kafka producer", t);
    }
}


看拉取元数据的方法：'><meta name=author content><link rel=canonical href=https://wangxiaohong123.github.io/posts/%E6%A1%86%E6%9E%B6/mq/kafka/7.producer%E5%88%9D%E5%A7%8B%E5%8C%96%E6%BA%90%E7%A0%81/><link crossorigin=anonymous href=/assets/css/stylesheet.08f7d74f0ada0f975d29ae436285b61ed7a719d05f350cb888d00341642995a2.css integrity="sha256-CPfXTwraD5ddKa5DYoW2HtenGdBfNQy4iNADQWQplaI=" rel="preload stylesheet" as=style><link rel=icon href=https://wangxiaohong123.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://wangxiaohong123.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://wangxiaohong123.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://wangxiaohong123.github.io/apple-touch-icon.png><link rel=mask-icon href=https://wangxiaohong123.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://wangxiaohong123.github.io/posts/%E6%A1%86%E6%9E%B6/mq/kafka/7.producer%E5%88%9D%E5%A7%8B%E5%8C%96%E6%BA%90%E7%A0%81/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=/katex/katex.min.css><script defer src=/katex/katex.min.js></script><script defer src=/katex/auto-render.min.js onload=renderMathInElement(document.body)></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script><meta property="og:url" content="https://wangxiaohong123.github.io/posts/%E6%A1%86%E6%9E%B6/mq/kafka/7.producer%E5%88%9D%E5%A7%8B%E5%8C%96%E6%BA%90%E7%A0%81/"><meta property="og:site_name" content="王小红的笔记"><meta property="og:title" content="7.kafka源码-producer初始化"><meta property="og:description" content='producer初始化 初始化producer，直接new KafkaProducer就可以，初始化的代码都在这个类里：
1 KafkaProducer<String, String> producer = new KafkaProducer<>(Properties); 在这个构造方法里首先把我们配置的Properties转成ProducerConfig，kafka自己的配置文件，这个文件里有所有的Producer配置和默认值，还有一些属性的名字和注释在CommonClientConfigs里：
1 2 this(new ProducerConfig(ProducerConfig.addSerializerToConfig(properties, keySerializer, valueSerializer)), keySerializer, valueSerializer, null, null); 然后调用另一个构造方法初始化核心组件：
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 KafkaProducer(ProducerConfig config, Serializer<K> keySerializer, Serializer<V> valueSerializer, Metadata metadata, KafkaClient kafkaClient) { try { // 我们自己的配置 Map<String, Object> userProvidedConfigs = config.originals(); this.producerConfig = config; this.time = Time.SYSTEM; // 获取client.id属性，默认是空串 String clientId = config.getString(ProducerConfig.CLIENT_ID_CONFIG); if (clientId.length() <= 0) // 空串的话会走到这里，producer-自增数字作为clientId，线程安全的 clientId = "producer-" + PRODUCER_CLIENT_ID_SEQUENCE.getAndIncrement(); this.clientId = clientId; // 核心组件，用来决定你的消息会发送到那个topic的那个分区里的 this.partitioner = config.getConfiguredInstance(ProducerConfig.PARTITIONER_CLASS_CONFIG, Partitioner.class); // retry.backoff.ms，重试间隔，默认100ms long retryBackoffMs = config.getLong(ProducerConfig.RETRY_BACKOFF_MS_CONFIG); // 序列组件 if (keySerializer == null) { this.keySerializer = ensureExtended(config.getConfiguredInstance(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, Serializer.class)); this.keySerializer.configure(config.originals(), true); } else { config.ignore(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG); this.keySerializer = ensureExtended(keySerializer); } if (valueSerializer == null) { this.valueSerializer = ensureExtended(config.getConfiguredInstance(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, Serializer.class)); this.valueSerializer.configure(config.originals(), false); } else { config.ignore(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG); this.valueSerializer = ensureExtended(valueSerializer); } // 拦截器组件 userProvidedConfigs.put(ProducerConfig.CLIENT_ID_CONFIG, clientId); List<ProducerInterceptor<K, V>> interceptorList = (List) (new ProducerConfig(userProvidedConfigs, false)).getConfiguredInstances(ProducerConfig.INTERCEPTOR_CLASSES_CONFIG, ProducerInterceptor.class); this.interceptors = new ProducerInterceptors<>(interceptorList); ClusterResourceListeners clusterResourceListeners = configureClusterResourceListeners(keySerializer, valueSerializer, interceptorList, reporters); // max.request.size，每个请求的最大大小，默认1M this.maxRequestSize = config.getInt(ProducerConfig.MAX_REQUEST_SIZE_CONFIG); // buffer.memory，缓冲池大小，默认32M this.totalMemorySize = config.getLong(ProducerConfig.BUFFER_MEMORY_CONFIG); this.compressionType = CompressionType.forName(config.getString(ProducerConfig.COMPRESSION_TYPE_CONFIG)); // max.block.ms缓冲区满了的阻塞时间，默认一分钟，超过1分钟会抛出异常 this.maxBlockTimeMs = config.getLong(ProducerConfig.MAX_BLOCK_MS_CONFIG); // request.timeout.ms，请求超时时间，默认30s this.requestTimeoutMs = config.getInt(ProducerConfig.REQUEST_TIMEOUT_MS_CONFIG); this.transactionManager = configureTransactionState(config, logContext, log); // 这个应该是重试次数 int retries = configureRetries(config, transactionManager != null, log); int maxInflightRequests = configureInflightRequests(config, transactionManager != null); short acks = configureAcks(config, transactionManager != null, log); this.apiVersions = new ApiVersions(); // 核心组件，缓冲池 this.accumulator = new RecordAccumulator(logContext, config.getInt(ProducerConfig.BATCH_SIZE_CONFIG), this.totalMemorySize, this.compressionType, config.getLong(ProducerConfig.LINGER_MS_CONFIG), retryBackoffMs, metrics, time, apiVersions, transactionManager); // broker地址 List<InetSocketAddress> addresses = ClientUtils.parseAndValidateAddresses(config.getList(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG)); // 核心组件，维护broker的元数据信息 if (metadata != null) { this.metadata = metadata; } else { this.metadata = new Metadata(retryBackoffMs, // metadata.max.age.ms，默认5分钟强制刷新一次 config.getLong(ProducerConfig.METADATA_MAX_AGE_CONFIG), true, true, clusterResourceListeners); // 如果metadata是空需要拉取一下元数据 this.metadata.update(Cluster.bootstrap(addresses), Collections.<String>emptySet(), time.milliseconds()); } ChannelBuilder channelBuilder = ClientUtils.createChannelBuilder(config); Sensor throttleTimeSensor = Sender.throttleTimeSensor(metricsRegistry.senderMetrics); // 核心组件，网络通信组件，这里初始化了一个selector KafkaClient client = kafkaClient != null ? kafkaClient : new NetworkClient( new Selector(config.getLong(ProducerConfig.CONNECTIONS_MAX_IDLE_MS_CONFIG), this.metrics, time, "producer", channelBuilder, logContext), // 这个是元数据的信息，负责元数据的增改，唤醒主线程 this.metadata, clientId, // max.in.flight.requests.per.connection，同时发送的消息数 // 这个最大就是5 maxInflightRequests, // reconnect.backoff.ms，重新建立连接的等待时长 config.getLong(ProducerConfig.RECONNECT_BACKOFF_MS_CONFIG), // reconnect.backoff.max.ms，建立连接的最大时长 // 连接失败的时候会重试，每次间隔reconnect.backoff.ms成倍增加，直到超过max.ms config.getLong(ProducerConfig.RECONNECT_BACKOFF_MAX_MS_CONFIG), // send.buffer.bytes，# 发送缓冲区的大小 config.getInt(ProducerConfig.SEND_BUFFER_CONFIG), // receive.buffer.bytes，接收缓冲区的大小 config.getInt(ProducerConfig.RECEIVE_BUFFER_CONFIG), // request.timeout.ms，发送的超时时间 this.requestTimeoutMs, time, true, apiVersions, throttleTimeSensor, logContext); // 核心组件，负责把缓冲池里的消息发送到broker上 this.sender = new Sender(logContext, client, // 这个是元数据的信息，负责元数据的增改，唤醒主线程 this.metadata, this.accumulator, maxInflightRequests == 1, // max.request.size单次请求的最大字节 config.getInt(ProducerConfig.MAX_REQUEST_SIZE_CONFIG), acks, // 重试次数 retries, metricsRegistry.senderMetrics, Time.SYSTEM, // 发送的超时时间 this.requestTimeoutMs, // retry.backoff.ms，重试的最大时间 config.getLong(ProducerConfig.RETRY_BACKOFF_MS_CONFIG), this.transactionManager, apiVersions); // 线程名：kafka-producer-network-thread|clientId String ioThreadName = NETWORK_THREAD_PREFIX + " | " + clientId; // 把sender放到线程里，启动 this.ioThread = new KafkaThread(ioThreadName, this.sender, true); this.ioThread.start(); } catch (Throwable t) { close(0, TimeUnit.MILLISECONDS, true); throw new KafkaException("Failed to construct kafka producer", t); } } 看拉取元数据的方法：'><meta property="og:locale" content="zh-CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-08-06T06:27:35+00:00"><meta property="article:modified_time" content="2021-08-06T06:27:35+00:00"><meta property="article:tag" content="大数据"><meta name=twitter:card content="summary"><meta name=twitter:title content="7.kafka源码-producer初始化"><meta name=twitter:description content='producer初始化
初始化producer，直接new KafkaProducer就可以，初始化的代码都在这个类里：


1


KafkaProducer<String, String> producer = new KafkaProducer<>(Properties);


在这个构造方法里首先把我们配置的Properties转成ProducerConfig，kafka自己的配置文件，这个文件里有所有的Producer配置和默认值，还有一些属性的名字和注释在CommonClientConfigs里：


1
2


this(new ProducerConfig(ProducerConfig.addSerializerToConfig(properties, keySerializer, valueSerializer)),
     keySerializer, valueSerializer, null, null);


然后调用另一个构造方法初始化核心组件：


  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139


KafkaProducer(ProducerConfig config, Serializer<K> keySerializer, Serializer<V> valueSerializer, Metadata metadata, KafkaClient kafkaClient) {
    try {
        // 我们自己的配置
        Map<String, Object> userProvidedConfigs = config.originals();
        this.producerConfig = config;
        this.time = Time.SYSTEM;
        // 获取client.id属性，默认是空串
        String clientId = config.getString(ProducerConfig.CLIENT_ID_CONFIG);
        if (clientId.length() <= 0)
            // 空串的话会走到这里，producer-自增数字作为clientId，线程安全的
            clientId = "producer-" + PRODUCER_CLIENT_ID_SEQUENCE.getAndIncrement();
        this.clientId = clientId;
        // 核心组件，用来决定你的消息会发送到那个topic的那个分区里的
        this.partitioner = config.getConfiguredInstance(ProducerConfig.PARTITIONER_CLASS_CONFIG, Partitioner.class);
        // retry.backoff.ms，重试间隔，默认100ms
        long retryBackoffMs = config.getLong(ProducerConfig.RETRY_BACKOFF_MS_CONFIG);
        // 序列组件
        if (keySerializer == null) {
            this.keySerializer = ensureExtended(config.getConfiguredInstance(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG,
                                                                             Serializer.class));
            this.keySerializer.configure(config.originals(), true);
        } else {
            config.ignore(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG);
            this.keySerializer = ensureExtended(keySerializer);
        }
        if (valueSerializer == null) {
            this.valueSerializer = ensureExtended(config.getConfiguredInstance(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG,
                                                                               Serializer.class));
            this.valueSerializer.configure(config.originals(), false);
        } else {
            config.ignore(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG);
            this.valueSerializer = ensureExtended(valueSerializer);
        }

        // 拦截器组件
        userProvidedConfigs.put(ProducerConfig.CLIENT_ID_CONFIG, clientId);
        List<ProducerInterceptor<K, V>> interceptorList = (List) (new ProducerConfig(userProvidedConfigs, false)).getConfiguredInstances(ProducerConfig.INTERCEPTOR_CLASSES_CONFIG,
                                                                                                                                         ProducerInterceptor.class);
        this.interceptors = new ProducerInterceptors<>(interceptorList);
        ClusterResourceListeners clusterResourceListeners = configureClusterResourceListeners(keySerializer, valueSerializer, interceptorList, reporters);
        // max.request.size，每个请求的最大大小，默认1M
        this.maxRequestSize = config.getInt(ProducerConfig.MAX_REQUEST_SIZE_CONFIG);
        // buffer.memory，缓冲池大小，默认32M
        this.totalMemorySize = config.getLong(ProducerConfig.BUFFER_MEMORY_CONFIG);
        this.compressionType = CompressionType.forName(config.getString(ProducerConfig.COMPRESSION_TYPE_CONFIG));

        // max.block.ms缓冲区满了的阻塞时间，默认一分钟，超过1分钟会抛出异常
        this.maxBlockTimeMs = config.getLong(ProducerConfig.MAX_BLOCK_MS_CONFIG);
        // request.timeout.ms，请求超时时间，默认30s
        this.requestTimeoutMs = config.getInt(ProducerConfig.REQUEST_TIMEOUT_MS_CONFIG);
        this.transactionManager = configureTransactionState(config, logContext, log);
        // 这个应该是重试次数
        int retries = configureRetries(config, transactionManager != null, log);
        int maxInflightRequests = configureInflightRequests(config, transactionManager != null);
        short acks = configureAcks(config, transactionManager != null, log);

        this.apiVersions = new ApiVersions();
        // 核心组件，缓冲池
        this.accumulator = new RecordAccumulator(logContext,
                                                 config.getInt(ProducerConfig.BATCH_SIZE_CONFIG),
                                                 this.totalMemorySize,
                                                 this.compressionType,
                                                 config.getLong(ProducerConfig.LINGER_MS_CONFIG),
                                                 retryBackoffMs,
                                                 metrics,
                                                 time,
                                                 apiVersions,
                                                 transactionManager);
        // broker地址
        List<InetSocketAddress> addresses = ClientUtils.parseAndValidateAddresses(config.getList(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG));
        // 核心组件，维护broker的元数据信息
        if (metadata != null) {
            this.metadata = metadata;
        } else {
            this.metadata = new Metadata(retryBackoffMs, 
                                         // metadata.max.age.ms，默认5分钟强制刷新一次
                                         config.getLong(ProducerConfig.METADATA_MAX_AGE_CONFIG),
                                         true, true, clusterResourceListeners);
            // 如果metadata是空需要拉取一下元数据
            this.metadata.update(Cluster.bootstrap(addresses), Collections.<String>emptySet(), time.milliseconds());
        }
        ChannelBuilder channelBuilder = ClientUtils.createChannelBuilder(config);
        Sensor throttleTimeSensor = Sender.throttleTimeSensor(metricsRegistry.senderMetrics);
        // 核心组件，网络通信组件，这里初始化了一个selector
        KafkaClient client = kafkaClient != null ? kafkaClient : new NetworkClient(
            new Selector(config.getLong(ProducerConfig.CONNECTIONS_MAX_IDLE_MS_CONFIG),
                         this.metrics, time, "producer", channelBuilder, logContext),
            // 这个是元数据的信息，负责元数据的增改，唤醒主线程
            this.metadata,
            clientId,
            // max.in.flight.requests.per.connection，同时发送的消息数
            // 这个最大就是5
            maxInflightRequests,
            // reconnect.backoff.ms，重新建立连接的等待时长
            config.getLong(ProducerConfig.RECONNECT_BACKOFF_MS_CONFIG),
            // reconnect.backoff.max.ms，建立连接的最大时长
            // 连接失败的时候会重试，每次间隔reconnect.backoff.ms成倍增加，直到超过max.ms
            config.getLong(ProducerConfig.RECONNECT_BACKOFF_MAX_MS_CONFIG),
            // send.buffer.bytes，# 发送缓冲区的大小
            config.getInt(ProducerConfig.SEND_BUFFER_CONFIG),
            // receive.buffer.bytes，接收缓冲区的大小
            config.getInt(ProducerConfig.RECEIVE_BUFFER_CONFIG),
            // request.timeout.ms，发送的超时时间
            this.requestTimeoutMs,
            time,
            true,
            apiVersions,
            throttleTimeSensor,
            logContext);
        // 核心组件，负责把缓冲池里的消息发送到broker上
        this.sender = new Sender(logContext,
                                 client,
                                 // 这个是元数据的信息，负责元数据的增改，唤醒主线程
                                 this.metadata,
                                 this.accumulator,
                                 maxInflightRequests == 1,
                                 // max.request.size单次请求的最大字节
                                 config.getInt(ProducerConfig.MAX_REQUEST_SIZE_CONFIG),
                                 acks,
                                 // 重试次数
                                 retries,
                                 metricsRegistry.senderMetrics,
                                 Time.SYSTEM,
                                 // 发送的超时时间
                                 this.requestTimeoutMs,
                                 // retry.backoff.ms，重试的最大时间
                                 config.getLong(ProducerConfig.RETRY_BACKOFF_MS_CONFIG),
                                 this.transactionManager,
                                 apiVersions);
        // 线程名：kafka-producer-network-thread|clientId
        String ioThreadName = NETWORK_THREAD_PREFIX + " | " + clientId;
        // 把sender放到线程里，启动
        this.ioThread = new KafkaThread(ioThreadName, this.sender, true);
        this.ioThread.start();
    } catch (Throwable t) {
        close(0, TimeUnit.MILLISECONDS, true);
        throw new KafkaException("Failed to construct kafka producer", t);
    }
}


看拉取元数据的方法：'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://wangxiaohong123.github.io/posts/"},{"@type":"ListItem","position":2,"name":"7.kafka源码-producer初始化","item":"https://wangxiaohong123.github.io/posts/%E6%A1%86%E6%9E%B6/mq/kafka/7.producer%E5%88%9D%E5%A7%8B%E5%8C%96%E6%BA%90%E7%A0%81/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"7.kafka源码-producer初始化","name":"7.kafka源码-producer初始化","description":"producer初始化 初始化producer，直接new KafkaProducer就可以，初始化的代码都在这个类里：\n1 KafkaProducer\u0026lt;String, String\u0026gt; producer = new KafkaProducer\u0026lt;\u0026gt;(Properties); 在这个构造方法里首先把我们配置的Properties转成ProducerConfig，kafka自己的配置文件，这个文件里有所有的Producer配置和默认值，还有一些属性的名字和注释在CommonClientConfigs里：\n1 2 this(new ProducerConfig(ProducerConfig.addSerializerToConfig(properties, keySerializer, valueSerializer)), keySerializer, valueSerializer, null, null); 然后调用另一个构造方法初始化核心组件：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 KafkaProducer(ProducerConfig config, Serializer\u0026lt;K\u0026gt; keySerializer, Serializer\u0026lt;V\u0026gt; valueSerializer, Metadata metadata, KafkaClient kafkaClient) { try { // 我们自己的配置 Map\u0026lt;String, Object\u0026gt; userProvidedConfigs = config.originals(); this.producerConfig = config; this.time = Time.SYSTEM; // 获取client.id属性，默认是空串 String clientId = config.getString(ProducerConfig.CLIENT_ID_CONFIG); if (clientId.length() \u0026lt;= 0) // 空串的话会走到这里，producer-自增数字作为clientId，线程安全的 clientId = \u0026#34;producer-\u0026#34; + PRODUCER_CLIENT_ID_SEQUENCE.getAndIncrement(); this.clientId = clientId; // 核心组件，用来决定你的消息会发送到那个topic的那个分区里的 this.partitioner = config.getConfiguredInstance(ProducerConfig.PARTITIONER_CLASS_CONFIG, Partitioner.class); // retry.backoff.ms，重试间隔，默认100ms long retryBackoffMs = config.getLong(ProducerConfig.RETRY_BACKOFF_MS_CONFIG); // 序列组件 if (keySerializer == null) { this.keySerializer = ensureExtended(config.getConfiguredInstance(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, Serializer.class)); this.keySerializer.configure(config.originals(), true); } else { config.ignore(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG); this.keySerializer = ensureExtended(keySerializer); } if (valueSerializer == null) { this.valueSerializer = ensureExtended(config.getConfiguredInstance(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, Serializer.class)); this.valueSerializer.configure(config.originals(), false); } else { config.ignore(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG); this.valueSerializer = ensureExtended(valueSerializer); } // 拦截器组件 userProvidedConfigs.put(ProducerConfig.CLIENT_ID_CONFIG, clientId); List\u0026lt;ProducerInterceptor\u0026lt;K, V\u0026gt;\u0026gt; interceptorList = (List) (new ProducerConfig(userProvidedConfigs, false)).getConfiguredInstances(ProducerConfig.INTERCEPTOR_CLASSES_CONFIG, ProducerInterceptor.class); this.interceptors = new ProducerInterceptors\u0026lt;\u0026gt;(interceptorList); ClusterResourceListeners clusterResourceListeners = configureClusterResourceListeners(keySerializer, valueSerializer, interceptorList, reporters); // max.request.size，每个请求的最大大小，默认1M this.maxRequestSize = config.getInt(ProducerConfig.MAX_REQUEST_SIZE_CONFIG); // buffer.memory，缓冲池大小，默认32M this.totalMemorySize = config.getLong(ProducerConfig.BUFFER_MEMORY_CONFIG); this.compressionType = CompressionType.forName(config.getString(ProducerConfig.COMPRESSION_TYPE_CONFIG)); // max.block.ms缓冲区满了的阻塞时间，默认一分钟，超过1分钟会抛出异常 this.maxBlockTimeMs = config.getLong(ProducerConfig.MAX_BLOCK_MS_CONFIG); // request.timeout.ms，请求超时时间，默认30s this.requestTimeoutMs = config.getInt(ProducerConfig.REQUEST_TIMEOUT_MS_CONFIG); this.transactionManager = configureTransactionState(config, logContext, log); // 这个应该是重试次数 int retries = configureRetries(config, transactionManager != null, log); int maxInflightRequests = configureInflightRequests(config, transactionManager != null); short acks = configureAcks(config, transactionManager != null, log); this.apiVersions = new ApiVersions(); // 核心组件，缓冲池 this.accumulator = new RecordAccumulator(logContext, config.getInt(ProducerConfig.BATCH_SIZE_CONFIG), this.totalMemorySize, this.compressionType, config.getLong(ProducerConfig.LINGER_MS_CONFIG), retryBackoffMs, metrics, time, apiVersions, transactionManager); // broker地址 List\u0026lt;InetSocketAddress\u0026gt; addresses = ClientUtils.parseAndValidateAddresses(config.getList(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG)); // 核心组件，维护broker的元数据信息 if (metadata != null) { this.metadata = metadata; } else { this.metadata = new Metadata(retryBackoffMs, // metadata.max.age.ms，默认5分钟强制刷新一次 config.getLong(ProducerConfig.METADATA_MAX_AGE_CONFIG), true, true, clusterResourceListeners); // 如果metadata是空需要拉取一下元数据 this.metadata.update(Cluster.bootstrap(addresses), Collections.\u0026lt;String\u0026gt;emptySet(), time.milliseconds()); } ChannelBuilder channelBuilder = ClientUtils.createChannelBuilder(config); Sensor throttleTimeSensor = Sender.throttleTimeSensor(metricsRegistry.senderMetrics); // 核心组件，网络通信组件，这里初始化了一个selector KafkaClient client = kafkaClient != null ? kafkaClient : new NetworkClient( new Selector(config.getLong(ProducerConfig.CONNECTIONS_MAX_IDLE_MS_CONFIG), this.metrics, time, \u0026#34;producer\u0026#34;, channelBuilder, logContext), // 这个是元数据的信息，负责元数据的增改，唤醒主线程 this.metadata, clientId, // max.in.flight.requests.per.connection，同时发送的消息数 // 这个最大就是5 maxInflightRequests, // reconnect.backoff.ms，重新建立连接的等待时长 config.getLong(ProducerConfig.RECONNECT_BACKOFF_MS_CONFIG), // reconnect.backoff.max.ms，建立连接的最大时长 // 连接失败的时候会重试，每次间隔reconnect.backoff.ms成倍增加，直到超过max.ms config.getLong(ProducerConfig.RECONNECT_BACKOFF_MAX_MS_CONFIG), // send.buffer.bytes，# 发送缓冲区的大小 config.getInt(ProducerConfig.SEND_BUFFER_CONFIG), // receive.buffer.bytes，接收缓冲区的大小 config.getInt(ProducerConfig.RECEIVE_BUFFER_CONFIG), // request.timeout.ms，发送的超时时间 this.requestTimeoutMs, time, true, apiVersions, throttleTimeSensor, logContext); // 核心组件，负责把缓冲池里的消息发送到broker上 this.sender = new Sender(logContext, client, // 这个是元数据的信息，负责元数据的增改，唤醒主线程 this.metadata, this.accumulator, maxInflightRequests == 1, // max.request.size单次请求的最大字节 config.getInt(ProducerConfig.MAX_REQUEST_SIZE_CONFIG), acks, // 重试次数 retries, metricsRegistry.senderMetrics, Time.SYSTEM, // 发送的超时时间 this.requestTimeoutMs, // retry.backoff.ms，重试的最大时间 config.getLong(ProducerConfig.RETRY_BACKOFF_MS_CONFIG), this.transactionManager, apiVersions); // 线程名：kafka-producer-network-thread|clientId String ioThreadName = NETWORK_THREAD_PREFIX + \u0026#34; | \u0026#34; + clientId; // 把sender放到线程里，启动 this.ioThread = new KafkaThread(ioThreadName, this.sender, true); this.ioThread.start(); } catch (Throwable t) { close(0, TimeUnit.MILLISECONDS, true); throw new KafkaException(\u0026#34;Failed to construct kafka producer\u0026#34;, t); } } 看拉取元数据的方法：\n","keywords":["大数据"],"articleBody":"producer初始化 初始化producer，直接new KafkaProducer就可以，初始化的代码都在这个类里：\n1 KafkaProducer\u003cString, String\u003e producer = new KafkaProducer\u003c\u003e(Properties); 在这个构造方法里首先把我们配置的Properties转成ProducerConfig，kafka自己的配置文件，这个文件里有所有的Producer配置和默认值，还有一些属性的名字和注释在CommonClientConfigs里：\n1 2 this(new ProducerConfig(ProducerConfig.addSerializerToConfig(properties, keySerializer, valueSerializer)), keySerializer, valueSerializer, null, null); 然后调用另一个构造方法初始化核心组件：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 KafkaProducer(ProducerConfig config, Serializer\u003cK\u003e keySerializer, Serializer\u003cV\u003e valueSerializer, Metadata metadata, KafkaClient kafkaClient) { try { // 我们自己的配置 Map\u003cString, Object\u003e userProvidedConfigs = config.originals(); this.producerConfig = config; this.time = Time.SYSTEM; // 获取client.id属性，默认是空串 String clientId = config.getString(ProducerConfig.CLIENT_ID_CONFIG); if (clientId.length() \u003c= 0) // 空串的话会走到这里，producer-自增数字作为clientId，线程安全的 clientId = \"producer-\" + PRODUCER_CLIENT_ID_SEQUENCE.getAndIncrement(); this.clientId = clientId; // 核心组件，用来决定你的消息会发送到那个topic的那个分区里的 this.partitioner = config.getConfiguredInstance(ProducerConfig.PARTITIONER_CLASS_CONFIG, Partitioner.class); // retry.backoff.ms，重试间隔，默认100ms long retryBackoffMs = config.getLong(ProducerConfig.RETRY_BACKOFF_MS_CONFIG); // 序列组件 if (keySerializer == null) { this.keySerializer = ensureExtended(config.getConfiguredInstance(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, Serializer.class)); this.keySerializer.configure(config.originals(), true); } else { config.ignore(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG); this.keySerializer = ensureExtended(keySerializer); } if (valueSerializer == null) { this.valueSerializer = ensureExtended(config.getConfiguredInstance(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, Serializer.class)); this.valueSerializer.configure(config.originals(), false); } else { config.ignore(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG); this.valueSerializer = ensureExtended(valueSerializer); } // 拦截器组件 userProvidedConfigs.put(ProducerConfig.CLIENT_ID_CONFIG, clientId); List\u003cProducerInterceptor\u003cK, V\u003e\u003e interceptorList = (List) (new ProducerConfig(userProvidedConfigs, false)).getConfiguredInstances(ProducerConfig.INTERCEPTOR_CLASSES_CONFIG, ProducerInterceptor.class); this.interceptors = new ProducerInterceptors\u003c\u003e(interceptorList); ClusterResourceListeners clusterResourceListeners = configureClusterResourceListeners(keySerializer, valueSerializer, interceptorList, reporters); // max.request.size，每个请求的最大大小，默认1M this.maxRequestSize = config.getInt(ProducerConfig.MAX_REQUEST_SIZE_CONFIG); // buffer.memory，缓冲池大小，默认32M this.totalMemorySize = config.getLong(ProducerConfig.BUFFER_MEMORY_CONFIG); this.compressionType = CompressionType.forName(config.getString(ProducerConfig.COMPRESSION_TYPE_CONFIG)); // max.block.ms缓冲区满了的阻塞时间，默认一分钟，超过1分钟会抛出异常 this.maxBlockTimeMs = config.getLong(ProducerConfig.MAX_BLOCK_MS_CONFIG); // request.timeout.ms，请求超时时间，默认30s this.requestTimeoutMs = config.getInt(ProducerConfig.REQUEST_TIMEOUT_MS_CONFIG); this.transactionManager = configureTransactionState(config, logContext, log); // 这个应该是重试次数 int retries = configureRetries(config, transactionManager != null, log); int maxInflightRequests = configureInflightRequests(config, transactionManager != null); short acks = configureAcks(config, transactionManager != null, log); this.apiVersions = new ApiVersions(); // 核心组件，缓冲池 this.accumulator = new RecordAccumulator(logContext, config.getInt(ProducerConfig.BATCH_SIZE_CONFIG), this.totalMemorySize, this.compressionType, config.getLong(ProducerConfig.LINGER_MS_CONFIG), retryBackoffMs, metrics, time, apiVersions, transactionManager); // broker地址 List\u003cInetSocketAddress\u003e addresses = ClientUtils.parseAndValidateAddresses(config.getList(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG)); // 核心组件，维护broker的元数据信息 if (metadata != null) { this.metadata = metadata; } else { this.metadata = new Metadata(retryBackoffMs, // metadata.max.age.ms，默认5分钟强制刷新一次 config.getLong(ProducerConfig.METADATA_MAX_AGE_CONFIG), true, true, clusterResourceListeners); // 如果metadata是空需要拉取一下元数据 this.metadata.update(Cluster.bootstrap(addresses), Collections.\u003cString\u003eemptySet(), time.milliseconds()); } ChannelBuilder channelBuilder = ClientUtils.createChannelBuilder(config); Sensor throttleTimeSensor = Sender.throttleTimeSensor(metricsRegistry.senderMetrics); // 核心组件，网络通信组件，这里初始化了一个selector KafkaClient client = kafkaClient != null ? kafkaClient : new NetworkClient( new Selector(config.getLong(ProducerConfig.CONNECTIONS_MAX_IDLE_MS_CONFIG), this.metrics, time, \"producer\", channelBuilder, logContext), // 这个是元数据的信息，负责元数据的增改，唤醒主线程 this.metadata, clientId, // max.in.flight.requests.per.connection，同时发送的消息数 // 这个最大就是5 maxInflightRequests, // reconnect.backoff.ms，重新建立连接的等待时长 config.getLong(ProducerConfig.RECONNECT_BACKOFF_MS_CONFIG), // reconnect.backoff.max.ms，建立连接的最大时长 // 连接失败的时候会重试，每次间隔reconnect.backoff.ms成倍增加，直到超过max.ms config.getLong(ProducerConfig.RECONNECT_BACKOFF_MAX_MS_CONFIG), // send.buffer.bytes，# 发送缓冲区的大小 config.getInt(ProducerConfig.SEND_BUFFER_CONFIG), // receive.buffer.bytes，接收缓冲区的大小 config.getInt(ProducerConfig.RECEIVE_BUFFER_CONFIG), // request.timeout.ms，发送的超时时间 this.requestTimeoutMs, time, true, apiVersions, throttleTimeSensor, logContext); // 核心组件，负责把缓冲池里的消息发送到broker上 this.sender = new Sender(logContext, client, // 这个是元数据的信息，负责元数据的增改，唤醒主线程 this.metadata, this.accumulator, maxInflightRequests == 1, // max.request.size单次请求的最大字节 config.getInt(ProducerConfig.MAX_REQUEST_SIZE_CONFIG), acks, // 重试次数 retries, metricsRegistry.senderMetrics, Time.SYSTEM, // 发送的超时时间 this.requestTimeoutMs, // retry.backoff.ms，重试的最大时间 config.getLong(ProducerConfig.RETRY_BACKOFF_MS_CONFIG), this.transactionManager, apiVersions); // 线程名：kafka-producer-network-thread|clientId String ioThreadName = NETWORK_THREAD_PREFIX + \" | \" + clientId; // 把sender放到线程里，启动 this.ioThread = new KafkaThread(ioThreadName, this.sender, true); this.ioThread.start(); } catch (Throwable t) { close(0, TimeUnit.MILLISECONDS, true); throw new KafkaException(\"Failed to construct kafka producer\", t); } } 看拉取元数据的方法：\n1 2 3 // 首先创建一个Cluster对象，把我们配置的bootstrap.servers参数传进去封装成node // Cluster就是集群的元数据 this.metadata.update(Cluster.bootstrap(addresses), Collections.\u003cString\u003eemptySet(), time.milliseconds()); 在Metadata类中：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 /** * 这个方法被加了一个锁 * 每次更新版本号都会加1、更新刷新数据的时间戳 */ public synchronized void update(Cluster newCluster, Set\u003cString\u003e unavailableTopics, long now) { Objects.requireNonNull(newCluster, \"cluster should not be null\"); this.needUpdate = false; this.lastRefreshMs = now; this.lastSuccessfulRefreshMs = now; this.version += 1; if (topicExpiryEnabled) { // Handle expiry of topics from the metadata refresh set. for (Iterator\u003cMap.Entry\u003cString, Long\u003e\u003e it = topics.entrySet().iterator(); it.hasNext(); ) { Map.Entry\u003cString, Long\u003e entry = it.next(); long expireMs = entry.getValue(); if (expireMs == TOPIC_EXPIRY_NEEDS_UPDATE) entry.setValue(now + TOPIC_EXPIRY_MS); else if (expireMs \u003c= now) { it.remove(); log.debug(\"Removing unused topic {} from the metadata list, expiryMs {} now {}\", entry.getKey(), expireMs, now); } } } // 监听器处理 for (Listener listener: listeners) listener.onMetadataUpdate(newCluster, unavailableTopics); String previousClusterId = cluster.clusterResource().clusterId(); // 这个是false，目前来看在启动的时候是不会刷新元数据的 if (this.needMetadataForAllTopics) { // the listener may change the interested topics, which could cause another metadata refresh. // If we have already fetched all topics, however, another fetch should be unnecessary. this.needUpdate = false; this.cluster = getClusterForCurrentTopics(newCluster); } else { this.cluster = newCluster; } // The bootstrap cluster is guaranteed not to have any useful information if (!newCluster.isBootstrapConfigured()) { String newClusterId = newCluster.clusterResource().clusterId(); if (newClusterId == null ? previousClusterId != null : !newClusterId.equals(previousClusterId)) log.info(\"Cluster ID: {}\", newClusterId); clusterResourceListeners.onUpdate(newCluster.clusterResource()); } // 唤醒其他update线程 notifyAll(); log.debug(\"Updated cluster metadata version {} to {}\", this.version, this.cluster); } sender线程初始化 sender是一个runnable类，运行sender就是在线程里执行sender的run方法，线程设置了一下工作线程和线程名：\n1 2 3 4 public KafkaThread(final String name, boolean daemon) { super(name); configureThread(name, daemon); } 然后启动，sender就不断的通过KafkaClient发送请求了。\nselector初始化 初始化KafkaClient的时候有一行初始化selector的代码：\n1 2 new Selector(config.getLong(ProducerConfig.CONNECTIONS_MAX_IDLE_MS_CONFIG), this.metrics, time, \"producer\", channelBuilder, logContext) Selector的构造方法：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 public Selector(int maxReceiveSize, long connectionMaxIdleMs, Metrics metrics, Time time, String metricGrpPrefix, Map\u003cString, String\u003e metricTags, boolean metricsPerConnection, boolean recordTimePerConnection, ChannelBuilder channelBuilder, MemoryPool memoryPool, LogContext logContext) { try { // java nio的selector this.nioSelector = java.nio.channels.Selector.open(); } catch (IOException e) { throw new KafkaException(e); } // 最大可以接收数据的大小 this.maxReceiveSize = maxReceiveSize; this.time = time; // 保存的是brokerId和kafkaChannel，他是对java的Channel进行封装 this.channels = new HashMap\u003c\u003e(); // 这个应该是放无法连接的Channel this.explicitlyMutedChannels = new HashSet\u003c\u003e(); this.outOfMemory = false; // 成功发送出去的请求 this.completedSends = new ArrayList\u003c\u003e(); // 已经处理完的响应 this.completedReceives = new ArrayList\u003c\u003e(); // broker收到但是还没处理的响应 this.stagedReceives = new HashMap\u003c\u003e(); this.immediatelyConnectedKeys = new HashSet\u003c\u003e(); this.closingChannels = new HashMap\u003c\u003e(); this.keysWithBufferedRead = new HashSet\u003c\u003e(); // 建立连接的broker this.connected = new ArrayList\u003c\u003e(); // 还没建立连接的broker this.disconnected = new HashMap\u003c\u003e(); // 连接失败的broker this.failedSends = new ArrayList\u003c\u003e(); this.sensors = new SelectorMetrics(metrics, metricGrpPrefix, metricTags, metricsPerConnection); this.channelBuilder = channelBuilder; this.recordTimePerConnection = recordTimePerConnection; this.idleExpiryManager = connectionMaxIdleMs \u003c 0 ? null : new IdleExpiryManager(time, connectionMaxIdleMs); this.memoryPool = memoryPool; this.lowMemThreshold = (long) (0.1 * this.memoryPool.size()); this.log = logContext.logger(Selector.class); } 再看KafkaChannel的核心组件：\n每个broker id对应一个网络连接，一个网络连接对应一个KafkaChannel，底层对应的是SocketChannel，SocketChannel对应的是最最底层的网络通信层面的一个Socket，套接字通信。\nSend组件：要交给这个底层的Channel发送出去的请求，可能会不断的变换的，因为发送完一个请求需要发送下一个请求\nNetworkReceive组件：这个Channel最近一次读出来的响应，先暂存在这里，也是会不断的变换的，因为会不断的读取新的响应数据\nTransportLayer：封装了底层的Java NIO的SocketChannel\n","wordCount":"1023","inLanguage":"en","datePublished":"2021-08-06T06:27:35Z","dateModified":"2021-08-06T06:27:35Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://wangxiaohong123.github.io/posts/%E6%A1%86%E6%9E%B6/mq/kafka/7.producer%E5%88%9D%E5%A7%8B%E5%8C%96%E6%BA%90%E7%A0%81/"},"publisher":{"@type":"Organization","name":"王小红的笔记","logo":{"@type":"ImageObject","url":"https://wangxiaohong123.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wangxiaohong123.github.io/ accesskey=h title="王小红的笔记 (Alt + H)">王小红的笔记</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://wangxiaohong123.github.io/posts/ title=笔记><span>笔记</span></a></li><li><a href=https://wangxiaohong123.github.io/categories/ title=分类><span>分类</span></a></li><li><a href=https://wangxiaohong123.github.io/tags/ title=标签><span>标签</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">7.kafka源码-producer初始化</h1><div class=post-meta><span title='2021-08-06 06:27:35 +0000 UTC'>August 6, 2021</span>&nbsp;·&nbsp;5 min</div></header><div class=post-content><h3 id=producer初始化>producer初始化<a hidden class=anchor aria-hidden=true href=#producer初始化>#</a></h3><p>初始化producer，直接new KafkaProducer就可以，初始化的代码都在这个类里：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>KafkaProducer<span style=color:#ff79c6>&lt;</span>String, String<span style=color:#ff79c6>&gt;</span> producer <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> KafkaProducer<span style=color:#ff79c6>&lt;&gt;</span>(Properties);
</span></span></code></pre></td></tr></table></div></div><p>在这个构造方法里首先把我们配置的Properties转成<strong>ProducerConfig</strong>，kafka自己的配置文件，这个文件里有所有的Producer配置和默认值，还有一些属性的名字和注释在CommonClientConfigs里：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff79c6>this</span>(<span style=color:#ff79c6>new</span> ProducerConfig(ProducerConfig.<span style=color:#50fa7b>addSerializerToConfig</span>(properties, keySerializer, valueSerializer)),
</span></span><span style=display:flex><span>     keySerializer, valueSerializer, <span style=color:#ff79c6>null</span>, <span style=color:#ff79c6>null</span>);
</span></span></code></pre></td></tr></table></div></div><p>然后调用另一个构造方法初始化核心组件：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">127
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">128
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">129
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">130
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">131
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">132
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">133
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">134
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">135
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">136
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">137
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">138
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">139
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>KafkaProducer(ProducerConfig config, Serializer<span style=color:#ff79c6>&lt;</span>K<span style=color:#ff79c6>&gt;</span> keySerializer, Serializer<span style=color:#ff79c6>&lt;</span>V<span style=color:#ff79c6>&gt;</span> valueSerializer, Metadata metadata, KafkaClient kafkaClient) {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 我们自己的配置</span>
</span></span><span style=display:flex><span>        Map<span style=color:#ff79c6>&lt;</span>String, Object<span style=color:#ff79c6>&gt;</span> userProvidedConfigs <span style=color:#ff79c6>=</span> config.<span style=color:#50fa7b>originals</span>();
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>producerConfig</span> <span style=color:#ff79c6>=</span> config;
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>time</span> <span style=color:#ff79c6>=</span> Time.<span style=color:#50fa7b>SYSTEM</span>;
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 获取client.id属性，默认是空串</span>
</span></span><span style=display:flex><span>        String clientId <span style=color:#ff79c6>=</span> config.<span style=color:#50fa7b>getString</span>(ProducerConfig.<span style=color:#50fa7b>CLIENT_ID_CONFIG</span>);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (clientId.<span style=color:#50fa7b>length</span>() <span style=color:#ff79c6>&lt;=</span> 0)
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 空串的话会走到这里，producer-自增数字作为clientId，线程安全的</span>
</span></span><span style=display:flex><span>            clientId <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;producer-&#34;</span> <span style=color:#ff79c6>+</span> PRODUCER_CLIENT_ID_SEQUENCE.<span style=color:#50fa7b>getAndIncrement</span>();
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>clientId</span> <span style=color:#ff79c6>=</span> clientId;
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 核心组件，用来决定你的消息会发送到那个topic的那个分区里的</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>partitioner</span> <span style=color:#ff79c6>=</span> config.<span style=color:#50fa7b>getConfiguredInstance</span>(ProducerConfig.<span style=color:#50fa7b>PARTITIONER_CLASS_CONFIG</span>, Partitioner.<span style=color:#50fa7b>class</span>);
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// retry.backoff.ms，重试间隔，默认100ms</span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd>long</span> retryBackoffMs <span style=color:#ff79c6>=</span> config.<span style=color:#50fa7b>getLong</span>(ProducerConfig.<span style=color:#50fa7b>RETRY_BACKOFF_MS_CONFIG</span>);
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 序列组件</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (keySerializer <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>keySerializer</span> <span style=color:#ff79c6>=</span> ensureExtended(config.<span style=color:#50fa7b>getConfiguredInstance</span>(ProducerConfig.<span style=color:#50fa7b>KEY_SERIALIZER_CLASS_CONFIG</span>,
</span></span><span style=display:flex><span>                                                                             Serializer.<span style=color:#50fa7b>class</span>));
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>keySerializer</span>.<span style=color:#50fa7b>configure</span>(config.<span style=color:#50fa7b>originals</span>(), <span style=color:#ff79c6>true</span>);
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>            config.<span style=color:#50fa7b>ignore</span>(ProducerConfig.<span style=color:#50fa7b>KEY_SERIALIZER_CLASS_CONFIG</span>);
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>keySerializer</span> <span style=color:#ff79c6>=</span> ensureExtended(keySerializer);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (valueSerializer <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>valueSerializer</span> <span style=color:#ff79c6>=</span> ensureExtended(config.<span style=color:#50fa7b>getConfiguredInstance</span>(ProducerConfig.<span style=color:#50fa7b>VALUE_SERIALIZER_CLASS_CONFIG</span>,
</span></span><span style=display:flex><span>                                                                               Serializer.<span style=color:#50fa7b>class</span>));
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>valueSerializer</span>.<span style=color:#50fa7b>configure</span>(config.<span style=color:#50fa7b>originals</span>(), <span style=color:#ff79c6>false</span>);
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>            config.<span style=color:#50fa7b>ignore</span>(ProducerConfig.<span style=color:#50fa7b>VALUE_SERIALIZER_CLASS_CONFIG</span>);
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>valueSerializer</span> <span style=color:#ff79c6>=</span> ensureExtended(valueSerializer);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 拦截器组件</span>
</span></span><span style=display:flex><span>        userProvidedConfigs.<span style=color:#50fa7b>put</span>(ProducerConfig.<span style=color:#50fa7b>CLIENT_ID_CONFIG</span>, clientId);
</span></span><span style=display:flex><span>        List<span style=color:#ff79c6>&lt;</span>ProducerInterceptor<span style=color:#ff79c6>&lt;</span>K, V<span style=color:#ff79c6>&gt;&gt;</span> interceptorList <span style=color:#ff79c6>=</span> (List) (<span style=color:#ff79c6>new</span> ProducerConfig(userProvidedConfigs, <span style=color:#ff79c6>false</span>)).<span style=color:#50fa7b>getConfiguredInstances</span>(ProducerConfig.<span style=color:#50fa7b>INTERCEPTOR_CLASSES_CONFIG</span>,
</span></span><span style=display:flex><span>                                                                                                                                         ProducerInterceptor.<span style=color:#50fa7b>class</span>);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>interceptors</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ProducerInterceptors<span style=color:#ff79c6>&lt;&gt;</span>(interceptorList);
</span></span><span style=display:flex><span>        ClusterResourceListeners clusterResourceListeners <span style=color:#ff79c6>=</span> configureClusterResourceListeners(keySerializer, valueSerializer, interceptorList, reporters);
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// max.request.size，每个请求的最大大小，默认1M</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>maxRequestSize</span> <span style=color:#ff79c6>=</span> config.<span style=color:#50fa7b>getInt</span>(ProducerConfig.<span style=color:#50fa7b>MAX_REQUEST_SIZE_CONFIG</span>);
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// buffer.memory，缓冲池大小，默认32M</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>totalMemorySize</span> <span style=color:#ff79c6>=</span> config.<span style=color:#50fa7b>getLong</span>(ProducerConfig.<span style=color:#50fa7b>BUFFER_MEMORY_CONFIG</span>);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>compressionType</span> <span style=color:#ff79c6>=</span> CompressionType.<span style=color:#50fa7b>forName</span>(config.<span style=color:#50fa7b>getString</span>(ProducerConfig.<span style=color:#50fa7b>COMPRESSION_TYPE_CONFIG</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// max.block.ms缓冲区满了的阻塞时间，默认一分钟，超过1分钟会抛出异常</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>maxBlockTimeMs</span> <span style=color:#ff79c6>=</span> config.<span style=color:#50fa7b>getLong</span>(ProducerConfig.<span style=color:#50fa7b>MAX_BLOCK_MS_CONFIG</span>);
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// request.timeout.ms，请求超时时间，默认30s</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>requestTimeoutMs</span> <span style=color:#ff79c6>=</span> config.<span style=color:#50fa7b>getInt</span>(ProducerConfig.<span style=color:#50fa7b>REQUEST_TIMEOUT_MS_CONFIG</span>);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>transactionManager</span> <span style=color:#ff79c6>=</span> configureTransactionState(config, logContext, log);
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 这个应该是重试次数</span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd>int</span> retries <span style=color:#ff79c6>=</span> configureRetries(config, transactionManager <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span>, log);
</span></span><span style=display:flex><span>        <span style=color:#8be9fd>int</span> maxInflightRequests <span style=color:#ff79c6>=</span> configureInflightRequests(config, transactionManager <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span>);
</span></span><span style=display:flex><span>        <span style=color:#8be9fd>short</span> acks <span style=color:#ff79c6>=</span> configureAcks(config, transactionManager <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span>, log);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>apiVersions</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ApiVersions();
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 核心组件，缓冲池</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>accumulator</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> RecordAccumulator(logContext,
</span></span><span style=display:flex><span>                                                 config.<span style=color:#50fa7b>getInt</span>(ProducerConfig.<span style=color:#50fa7b>BATCH_SIZE_CONFIG</span>),
</span></span><span style=display:flex><span>                                                 <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>totalMemorySize</span>,
</span></span><span style=display:flex><span>                                                 <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>compressionType</span>,
</span></span><span style=display:flex><span>                                                 config.<span style=color:#50fa7b>getLong</span>(ProducerConfig.<span style=color:#50fa7b>LINGER_MS_CONFIG</span>),
</span></span><span style=display:flex><span>                                                 retryBackoffMs,
</span></span><span style=display:flex><span>                                                 metrics,
</span></span><span style=display:flex><span>                                                 time,
</span></span><span style=display:flex><span>                                                 apiVersions,
</span></span><span style=display:flex><span>                                                 transactionManager);
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// broker地址</span>
</span></span><span style=display:flex><span>        List<span style=color:#ff79c6>&lt;</span>InetSocketAddress<span style=color:#ff79c6>&gt;</span> addresses <span style=color:#ff79c6>=</span> ClientUtils.<span style=color:#50fa7b>parseAndValidateAddresses</span>(config.<span style=color:#50fa7b>getList</span>(ProducerConfig.<span style=color:#50fa7b>BOOTSTRAP_SERVERS_CONFIG</span>));
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 核心组件，维护broker的元数据信息</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (metadata <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>metadata</span> <span style=color:#ff79c6>=</span> metadata;
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>metadata</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> Metadata(retryBackoffMs, 
</span></span><span style=display:flex><span>                                         <span style=color:#6272a4>// metadata.max.age.ms，默认5分钟强制刷新一次</span>
</span></span><span style=display:flex><span>                                         config.<span style=color:#50fa7b>getLong</span>(ProducerConfig.<span style=color:#50fa7b>METADATA_MAX_AGE_CONFIG</span>),
</span></span><span style=display:flex><span>                                         <span style=color:#ff79c6>true</span>, <span style=color:#ff79c6>true</span>, clusterResourceListeners);
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 如果metadata是空需要拉取一下元数据</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>metadata</span>.<span style=color:#50fa7b>update</span>(Cluster.<span style=color:#50fa7b>bootstrap</span>(addresses), Collections.<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span>emptySet(), time.<span style=color:#50fa7b>milliseconds</span>());
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        ChannelBuilder channelBuilder <span style=color:#ff79c6>=</span> ClientUtils.<span style=color:#50fa7b>createChannelBuilder</span>(config);
</span></span><span style=display:flex><span>        Sensor throttleTimeSensor <span style=color:#ff79c6>=</span> Sender.<span style=color:#50fa7b>throttleTimeSensor</span>(metricsRegistry.<span style=color:#50fa7b>senderMetrics</span>);
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 核心组件，网络通信组件，这里初始化了一个selector</span>
</span></span><span style=display:flex><span>        KafkaClient client <span style=color:#ff79c6>=</span> kafkaClient <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>?</span> kafkaClient : <span style=color:#ff79c6>new</span> NetworkClient(
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>new</span> Selector(config.<span style=color:#50fa7b>getLong</span>(ProducerConfig.<span style=color:#50fa7b>CONNECTIONS_MAX_IDLE_MS_CONFIG</span>),
</span></span><span style=display:flex><span>                         <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>metrics</span>, time, <span style=color:#f1fa8c>&#34;producer&#34;</span>, channelBuilder, logContext),
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 这个是元数据的信息，负责元数据的增改，唤醒主线程</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>metadata</span>,
</span></span><span style=display:flex><span>            clientId,
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// max.in.flight.requests.per.connection，同时发送的消息数</span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 这个最大就是5</span>
</span></span><span style=display:flex><span>            maxInflightRequests,
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// reconnect.backoff.ms，重新建立连接的等待时长</span>
</span></span><span style=display:flex><span>            config.<span style=color:#50fa7b>getLong</span>(ProducerConfig.<span style=color:#50fa7b>RECONNECT_BACKOFF_MS_CONFIG</span>),
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// reconnect.backoff.max.ms，建立连接的最大时长</span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 连接失败的时候会重试，每次间隔reconnect.backoff.ms成倍增加，直到超过max.ms</span>
</span></span><span style=display:flex><span>            config.<span style=color:#50fa7b>getLong</span>(ProducerConfig.<span style=color:#50fa7b>RECONNECT_BACKOFF_MAX_MS_CONFIG</span>),
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// send.buffer.bytes，# 发送缓冲区的大小</span>
</span></span><span style=display:flex><span>            config.<span style=color:#50fa7b>getInt</span>(ProducerConfig.<span style=color:#50fa7b>SEND_BUFFER_CONFIG</span>),
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// receive.buffer.bytes，接收缓冲区的大小</span>
</span></span><span style=display:flex><span>            config.<span style=color:#50fa7b>getInt</span>(ProducerConfig.<span style=color:#50fa7b>RECEIVE_BUFFER_CONFIG</span>),
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// request.timeout.ms，发送的超时时间</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>requestTimeoutMs</span>,
</span></span><span style=display:flex><span>            time,
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>true</span>,
</span></span><span style=display:flex><span>            apiVersions,
</span></span><span style=display:flex><span>            throttleTimeSensor,
</span></span><span style=display:flex><span>            logContext);
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 核心组件，负责把缓冲池里的消息发送到broker上</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>sender</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> Sender(logContext,
</span></span><span style=display:flex><span>                                 client,
</span></span><span style=display:flex><span>                                 <span style=color:#6272a4>// 这个是元数据的信息，负责元数据的增改，唤醒主线程</span>
</span></span><span style=display:flex><span>                                 <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>metadata</span>,
</span></span><span style=display:flex><span>                                 <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>accumulator</span>,
</span></span><span style=display:flex><span>                                 maxInflightRequests <span style=color:#ff79c6>==</span> 1,
</span></span><span style=display:flex><span>                                 <span style=color:#6272a4>// max.request.size单次请求的最大字节</span>
</span></span><span style=display:flex><span>                                 config.<span style=color:#50fa7b>getInt</span>(ProducerConfig.<span style=color:#50fa7b>MAX_REQUEST_SIZE_CONFIG</span>),
</span></span><span style=display:flex><span>                                 acks,
</span></span><span style=display:flex><span>                                 <span style=color:#6272a4>// 重试次数</span>
</span></span><span style=display:flex><span>                                 retries,
</span></span><span style=display:flex><span>                                 metricsRegistry.<span style=color:#50fa7b>senderMetrics</span>,
</span></span><span style=display:flex><span>                                 Time.<span style=color:#50fa7b>SYSTEM</span>,
</span></span><span style=display:flex><span>                                 <span style=color:#6272a4>// 发送的超时时间</span>
</span></span><span style=display:flex><span>                                 <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>requestTimeoutMs</span>,
</span></span><span style=display:flex><span>                                 <span style=color:#6272a4>// retry.backoff.ms，重试的最大时间</span>
</span></span><span style=display:flex><span>                                 config.<span style=color:#50fa7b>getLong</span>(ProducerConfig.<span style=color:#50fa7b>RETRY_BACKOFF_MS_CONFIG</span>),
</span></span><span style=display:flex><span>                                 <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>transactionManager</span>,
</span></span><span style=display:flex><span>                                 apiVersions);
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 线程名：kafka-producer-network-thread|clientId</span>
</span></span><span style=display:flex><span>        String ioThreadName <span style=color:#ff79c6>=</span> NETWORK_THREAD_PREFIX <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; | &#34;</span> <span style=color:#ff79c6>+</span> clientId;
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 把sender放到线程里，启动</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>ioThread</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> KafkaThread(ioThreadName, <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>sender</span>, <span style=color:#ff79c6>true</span>);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>ioThread</span>.<span style=color:#50fa7b>start</span>();
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>catch</span> (Throwable t) {
</span></span><span style=display:flex><span>        close(0, TimeUnit.<span style=color:#50fa7b>MILLISECONDS</span>, <span style=color:#ff79c6>true</span>);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> KafkaException(<span style=color:#f1fa8c>&#34;Failed to construct kafka producer&#34;</span>, t);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>看拉取元数据的方法：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#6272a4>// 首先创建一个Cluster对象，把我们配置的bootstrap.servers参数传进去封装成node</span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// Cluster就是集群的元数据</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>metadata</span>.<span style=color:#50fa7b>update</span>(Cluster.<span style=color:#50fa7b>bootstrap</span>(addresses), Collections.<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span>emptySet(), time.<span style=color:#50fa7b>milliseconds</span>());
</span></span></code></pre></td></tr></table></div></div><p>在Metadata类中：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * 这个方法被加了一个锁
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * 每次更新版本号都会加1、更新刷新数据的时间戳
</span></span></span><span style=display:flex><span><span style=color:#6272a4> */</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>synchronized</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>update</span>(Cluster newCluster, Set<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span> unavailableTopics, <span style=color:#8be9fd>long</span> now) {
</span></span><span style=display:flex><span>    Objects.<span style=color:#50fa7b>requireNonNull</span>(newCluster, <span style=color:#f1fa8c>&#34;cluster should not be null&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>needUpdate</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>false</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>lastRefreshMs</span> <span style=color:#ff79c6>=</span> now;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>lastSuccessfulRefreshMs</span> <span style=color:#ff79c6>=</span> now;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>version</span> <span style=color:#ff79c6>+=</span> 1;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (topicExpiryEnabled) {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// Handle expiry of topics from the metadata refresh set.</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>for</span> (Iterator<span style=color:#ff79c6>&lt;</span>Map.<span style=color:#50fa7b>Entry</span><span style=color:#ff79c6>&lt;</span>String, Long<span style=color:#ff79c6>&gt;&gt;</span> it <span style=color:#ff79c6>=</span> topics.<span style=color:#50fa7b>entrySet</span>().<span style=color:#50fa7b>iterator</span>(); it.<span style=color:#50fa7b>hasNext</span>(); ) {
</span></span><span style=display:flex><span>            Map.<span style=color:#50fa7b>Entry</span><span style=color:#ff79c6>&lt;</span>String, Long<span style=color:#ff79c6>&gt;</span> entry <span style=color:#ff79c6>=</span> it.<span style=color:#50fa7b>next</span>();
</span></span><span style=display:flex><span>            <span style=color:#8be9fd>long</span> expireMs <span style=color:#ff79c6>=</span> entry.<span style=color:#50fa7b>getValue</span>();
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (expireMs <span style=color:#ff79c6>==</span> TOPIC_EXPIRY_NEEDS_UPDATE)
</span></span><span style=display:flex><span>                entry.<span style=color:#50fa7b>setValue</span>(now <span style=color:#ff79c6>+</span> TOPIC_EXPIRY_MS);
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (expireMs <span style=color:#ff79c6>&lt;=</span> now) {
</span></span><span style=display:flex><span>                it.<span style=color:#50fa7b>remove</span>();
</span></span><span style=display:flex><span>                log.<span style=color:#50fa7b>debug</span>(<span style=color:#f1fa8c>&#34;Removing unused topic {} from the metadata list, expiryMs {} now {}&#34;</span>, entry.<span style=color:#50fa7b>getKey</span>(), expireMs, now);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 监听器处理</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> (Listener listener: listeners)
</span></span><span style=display:flex><span>        listener.<span style=color:#50fa7b>onMetadataUpdate</span>(newCluster, unavailableTopics);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    String previousClusterId <span style=color:#ff79c6>=</span> cluster.<span style=color:#50fa7b>clusterResource</span>().<span style=color:#50fa7b>clusterId</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 这个是false，目前来看在启动的时候是不会刷新元数据的</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>needMetadataForAllTopics</span>) {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// the listener may change the interested topics, which could cause another metadata refresh.</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// If we have already fetched all topics, however, another fetch should be unnecessary.</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>needUpdate</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>false</span>;
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>cluster</span> <span style=color:#ff79c6>=</span> getClusterForCurrentTopics(newCluster);
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>cluster</span> <span style=color:#ff79c6>=</span> newCluster;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// The bootstrap cluster is guaranteed not to have any useful information</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>newCluster.<span style=color:#50fa7b>isBootstrapConfigured</span>()) {
</span></span><span style=display:flex><span>        String newClusterId <span style=color:#ff79c6>=</span> newCluster.<span style=color:#50fa7b>clusterResource</span>().<span style=color:#50fa7b>clusterId</span>();
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (newClusterId <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>?</span> previousClusterId <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> : <span style=color:#ff79c6>!</span>newClusterId.<span style=color:#50fa7b>equals</span>(previousClusterId))
</span></span><span style=display:flex><span>            log.<span style=color:#50fa7b>info</span>(<span style=color:#f1fa8c>&#34;Cluster ID: {}&#34;</span>, newClusterId);
</span></span><span style=display:flex><span>        clusterResourceListeners.<span style=color:#50fa7b>onUpdate</span>(newCluster.<span style=color:#50fa7b>clusterResource</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// 唤醒其他update线程</span>
</span></span><span style=display:flex><span>    notifyAll();
</span></span><span style=display:flex><span>    log.<span style=color:#50fa7b>debug</span>(<span style=color:#f1fa8c>&#34;Updated cluster metadata version {} to {}&#34;</span>, <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>version</span>, <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>cluster</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=sender线程初始化>sender线程初始化<a hidden class=anchor aria-hidden=true href=#sender线程初始化>#</a></h3><p>sender是一个runnable类，运行sender就是在线程里执行sender的run方法，线程设置了一下工作线程和线程名：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#50fa7b>KafkaThread</span>(<span style=color:#8be9fd;font-style:italic>final</span> String name, <span style=color:#8be9fd>boolean</span> daemon) {
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>super</span>(name);
</span></span><span style=display:flex><span>    configureThread(name, daemon);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>然后启动，sender就不断的通过KafkaClient发送请求了。</p><h3 id=selector初始化>selector初始化<a hidden class=anchor aria-hidden=true href=#selector初始化>#</a></h3><p>初始化KafkaClient的时候有一行初始化selector的代码：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff79c6>new</span> Selector(config.<span style=color:#50fa7b>getLong</span>(ProducerConfig.<span style=color:#50fa7b>CONNECTIONS_MAX_IDLE_MS_CONFIG</span>),
</span></span><span style=display:flex><span>             <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>metrics</span>, time, <span style=color:#f1fa8c>&#34;producer&#34;</span>, channelBuilder, logContext)
</span></span></code></pre></td></tr></table></div></div><p>Selector的构造方法：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#50fa7b>Selector</span>(<span style=color:#8be9fd>int</span> maxReceiveSize,
</span></span><span style=display:flex><span>                <span style=color:#8be9fd>long</span> connectionMaxIdleMs,
</span></span><span style=display:flex><span>                Metrics metrics,
</span></span><span style=display:flex><span>                Time time,
</span></span><span style=display:flex><span>                String metricGrpPrefix,
</span></span><span style=display:flex><span>                Map<span style=color:#ff79c6>&lt;</span>String, String<span style=color:#ff79c6>&gt;</span> metricTags,
</span></span><span style=display:flex><span>                <span style=color:#8be9fd>boolean</span> metricsPerConnection,
</span></span><span style=display:flex><span>                <span style=color:#8be9fd>boolean</span> recordTimePerConnection,
</span></span><span style=display:flex><span>                ChannelBuilder channelBuilder,
</span></span><span style=display:flex><span>                MemoryPool memoryPool,
</span></span><span style=display:flex><span>                LogContext logContext) {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// java nio的selector</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>nioSelector</span> <span style=color:#ff79c6>=</span> java.<span style=color:#50fa7b>nio</span>.<span style=color:#50fa7b>channels</span>.<span style=color:#50fa7b>Selector</span>.<span style=color:#50fa7b>open</span>();
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>catch</span> (IOException e) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> KafkaException(e);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 最大可以接收数据的大小</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>maxReceiveSize</span> <span style=color:#ff79c6>=</span> maxReceiveSize;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>time</span> <span style=color:#ff79c6>=</span> time;
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 保存的是brokerId和kafkaChannel，他是对java的Channel进行封装</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>channels</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> HashMap<span style=color:#ff79c6>&lt;&gt;</span>();
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 这个应该是放无法连接的Channel</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>explicitlyMutedChannels</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> HashSet<span style=color:#ff79c6>&lt;&gt;</span>();
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>outOfMemory</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>false</span>;
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 成功发送出去的请求</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>completedSends</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ArrayList<span style=color:#ff79c6>&lt;&gt;</span>();
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 已经处理完的响应</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>completedReceives</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ArrayList<span style=color:#ff79c6>&lt;&gt;</span>();
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// broker收到但是还没处理的响应</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>stagedReceives</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> HashMap<span style=color:#ff79c6>&lt;&gt;</span>();
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>immediatelyConnectedKeys</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> HashSet<span style=color:#ff79c6>&lt;&gt;</span>();
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>closingChannels</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> HashMap<span style=color:#ff79c6>&lt;&gt;</span>();
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>keysWithBufferedRead</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> HashSet<span style=color:#ff79c6>&lt;&gt;</span>();
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 建立连接的broker</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>connected</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ArrayList<span style=color:#ff79c6>&lt;&gt;</span>();
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 还没建立连接的broker</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>disconnected</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> HashMap<span style=color:#ff79c6>&lt;&gt;</span>();
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 连接失败的broker</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>failedSends</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ArrayList<span style=color:#ff79c6>&lt;&gt;</span>();
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>sensors</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> SelectorMetrics(metrics, metricGrpPrefix, metricTags, metricsPerConnection);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>channelBuilder</span> <span style=color:#ff79c6>=</span> channelBuilder;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>recordTimePerConnection</span> <span style=color:#ff79c6>=</span> recordTimePerConnection;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>idleExpiryManager</span> <span style=color:#ff79c6>=</span> connectionMaxIdleMs <span style=color:#ff79c6>&lt;</span> 0 <span style=color:#ff79c6>?</span> <span style=color:#ff79c6>null</span> : <span style=color:#ff79c6>new</span> IdleExpiryManager(time, connectionMaxIdleMs);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>memoryPool</span> <span style=color:#ff79c6>=</span> memoryPool;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>lowMemThreshold</span> <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>long</span>) (0.<span style=color:#50fa7b>1</span> <span style=color:#ff79c6>*</span> <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>memoryPool</span>.<span style=color:#50fa7b>size</span>());
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>log</span> <span style=color:#ff79c6>=</span> logContext.<span style=color:#50fa7b>logger</span>(Selector.<span style=color:#50fa7b>class</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>再看KafkaChannel的核心组件：</p><p>每个broker id对应一个网络连接，一个网络连接对应一个KafkaChannel，底层对应的是SocketChannel，SocketChannel对应的是最最底层的网络通信层面的一个Socket，套接字通信。</p><p>Send组件：要交给这个底层的Channel发送出去的请求，可能会不断的变换的，因为发送完一个请求需要发送下一个请求</p><p>NetworkReceive组件：这个Channel最近一次读出来的响应，先暂存在这里，也是会不断的变换的，因为会不断的读取新的响应数据</p><p>TransportLayer：封装了底层的Java NIO的SocketChannel</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://wangxiaohong123.github.io/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/>大数据</a></li></ul><nav class=paginav><a class=prev href=https://wangxiaohong123.github.io/posts/%E6%A1%86%E6%9E%B6/mq/kafka/6.%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/><span class=title>« Prev</span><br><span>6.常见问题</span>
</a><a class=next href=https://wangxiaohong123.github.io/posts/%E6%A1%86%E6%9E%B6/mq/kafka/8.producer%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF/><span class=title>Next »</span><br><span>8.kafka源码-producer发送消息</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share 7.kafka源码-producer初始化 on x" href="https://x.com/intent/tweet/?text=7.kafka%e6%ba%90%e7%a0%81-producer%e5%88%9d%e5%a7%8b%e5%8c%96&amp;url=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fmq%2fkafka%2f7.producer%25E5%2588%259D%25E5%25A7%258B%25E5%258C%2596%25E6%25BA%2590%25E7%25A0%2581%2f&amp;hashtags=%e5%a4%a7%e6%95%b0%e6%8d%ae"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 7.kafka源码-producer初始化 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fmq%2fkafka%2f7.producer%25E5%2588%259D%25E5%25A7%258B%25E5%258C%2596%25E6%25BA%2590%25E7%25A0%2581%2f&amp;title=7.kafka%e6%ba%90%e7%a0%81-producer%e5%88%9d%e5%a7%8b%e5%8c%96&amp;summary=7.kafka%e6%ba%90%e7%a0%81-producer%e5%88%9d%e5%a7%8b%e5%8c%96&amp;source=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fmq%2fkafka%2f7.producer%25E5%2588%259D%25E5%25A7%258B%25E5%258C%2596%25E6%25BA%2590%25E7%25A0%2581%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 7.kafka源码-producer初始化 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fmq%2fkafka%2f7.producer%25E5%2588%259D%25E5%25A7%258B%25E5%258C%2596%25E6%25BA%2590%25E7%25A0%2581%2f&title=7.kafka%e6%ba%90%e7%a0%81-producer%e5%88%9d%e5%a7%8b%e5%8c%96"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 7.kafka源码-producer初始化 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fmq%2fkafka%2f7.producer%25E5%2588%259D%25E5%25A7%258B%25E5%258C%2596%25E6%25BA%2590%25E7%25A0%2581%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 7.kafka源码-producer初始化 on whatsapp" href="https://api.whatsapp.com/send?text=7.kafka%e6%ba%90%e7%a0%81-producer%e5%88%9d%e5%a7%8b%e5%8c%96%20-%20https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fmq%2fkafka%2f7.producer%25E5%2588%259D%25E5%25A7%258B%25E5%258C%2596%25E6%25BA%2590%25E7%25A0%2581%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 7.kafka源码-producer初始化 on telegram" href="https://telegram.me/share/url?text=7.kafka%e6%ba%90%e7%a0%81-producer%e5%88%9d%e5%a7%8b%e5%8c%96&amp;url=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fmq%2fkafka%2f7.producer%25E5%2588%259D%25E5%25A7%258B%25E5%258C%2596%25E6%25BA%2590%25E7%25A0%2581%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 7.kafka源码-producer初始化 on ycombinator" href="https://news.ycombinator.com/submitlink?t=7.kafka%e6%ba%90%e7%a0%81-producer%e5%88%9d%e5%a7%8b%e5%8c%96&u=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fmq%2fkafka%2f7.producer%25E5%2588%259D%25E5%25A7%258B%25E5%258C%2596%25E6%25BA%2590%25E7%25A0%2581%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://wangxiaohong123.github.io/>王小红的笔记</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>