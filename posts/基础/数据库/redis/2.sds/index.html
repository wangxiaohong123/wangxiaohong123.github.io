<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>redis-2.SDS | 王小红的笔记</title><meta name=keywords content="redis"><meta name=description content="1.SDS结构
redis3.2之前的SDS长这样：

  
      
          free(4字节)
          len(4字节)
          buf[]
      
  
  
      
          buf剩余长度
          buf使用长度
          字符数组，最后一位是&rsquo;\0'
      
  

free+len固定需要8字节，这样有个弊端，当字符串很小的时候可能2个字节就够了，如果字符串很大可能4字节还存不下长度，所以redis5之后针对free和len改成了5种sdshdr：


sdshdr5：常量字符串，不支持扩容，使用1个字节标识，低3位表示类型(比如sdshdr5类型)，高5位表示len；


sdshdr8：他多了一个alloc记录总长度：

  
      
          len
          alloc
          flags
          buf[]
      
  
  
      
          已使用长度
          总长度
          1字节，低3位表示类型，高5位预留
          字符数组
      
  



sdshdr16、sdshdr32、sdshdr64和sdshdr8是一样的，不过len和alloc的类型不一样，分别使用uint8(无符号1字节int)、uint16、uint32、uint64。


对应的结构体：


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31


/**
 * __attribute__ ((__packed__))是优化对齐
 */
struct __attribute__ ((__packed__)) sdshdr5 {
    unsigned char flags; /* 3 lsb of type, and 5 msb of string length */
    char buf[];
};
struct __attribute__ ((__packed__)) sdshdr8 {
    uint8_t len; /* used */
    uint8_t alloc; /* excluding the header and null terminator */
    unsigned char flags; /* 3 lsb of type, 5 unused bits */
    char buf[];
};
struct __attribute__ ((__packed__)) sdshdr16 {
    uint16_t len; /* used */
    uint16_t alloc; /* excluding the header and null terminator */
    unsigned char flags; /* 3 lsb of type, 5 unused bits */
    char buf[];
};
struct __attribute__ ((__packed__)) sdshdr32 {
    uint32_t len; /* used */
    uint32_t alloc; /* excluding the header and null terminator */
    unsigned char flags; /* 3 lsb of type, 5 unused bits */
    char buf[];
};
struct __attribute__ ((__packed__)) sdshdr64 {
    uint64_t len; /* used */
    uint64_t alloc; /* excluding the header and null terminator */
    unsigned char flags; /* 3 lsb of type, 5 unused bits */
    char buf[];
};


2.创建字符串
创建字符串对应sds.c的sdsnewlen()方法："><meta name=author content><link rel=canonical href=https://wangxiaohong123.github.io/posts/%E5%9F%BA%E7%A1%80/%E6%95%B0%E6%8D%AE%E5%BA%93/redis/2.sds/><link crossorigin=anonymous href=/assets/css/stylesheet.08f7d74f0ada0f975d29ae436285b61ed7a719d05f350cb888d00341642995a2.css integrity="sha256-CPfXTwraD5ddKa5DYoW2HtenGdBfNQy4iNADQWQplaI=" rel="preload stylesheet" as=style><link rel=icon href=https://wangxiaohong123.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://wangxiaohong123.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://wangxiaohong123.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://wangxiaohong123.github.io/apple-touch-icon.png><link rel=mask-icon href=https://wangxiaohong123.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://wangxiaohong123.github.io/posts/%E5%9F%BA%E7%A1%80/%E6%95%B0%E6%8D%AE%E5%BA%93/redis/2.sds/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://wangxiaohong123.github.io/posts/%E5%9F%BA%E7%A1%80/%E6%95%B0%E6%8D%AE%E5%BA%93/redis/2.sds/"><meta property="og:site_name" content="王小红的笔记"><meta property="og:title" content="redis-2.SDS"><meta property="og:description" content="1.SDS结构 redis3.2之前的SDS长这样：
free(4字节) len(4字节) buf[] buf剩余长度 buf使用长度 字符数组，最后一位是’\0' free+len固定需要8字节，这样有个弊端，当字符串很小的时候可能2个字节就够了，如果字符串很大可能4字节还存不下长度，所以redis5之后针对free和len改成了5种sdshdr：
sdshdr5：常量字符串，不支持扩容，使用1个字节标识，低3位表示类型(比如sdshdr5类型)，高5位表示len；
sdshdr8：他多了一个alloc记录总长度：
len alloc flags buf[] 已使用长度 总长度 1字节，低3位表示类型，高5位预留 字符数组 sdshdr16、sdshdr32、sdshdr64和sdshdr8是一样的，不过len和alloc的类型不一样，分别使用uint8(无符号1字节int)、uint16、uint32、uint64。
对应的结构体：
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 /** * __attribute__ ((__packed__))是优化对齐 */ struct __attribute__ ((__packed__)) sdshdr5 { unsigned char flags; /* 3 lsb of type, and 5 msb of string length */ char buf[]; }; struct __attribute__ ((__packed__)) sdshdr8 { uint8_t len; /* used */ uint8_t alloc; /* excluding the header and null terminator */ unsigned char flags; /* 3 lsb of type, 5 unused bits */ char buf[]; }; struct __attribute__ ((__packed__)) sdshdr16 { uint16_t len; /* used */ uint16_t alloc; /* excluding the header and null terminator */ unsigned char flags; /* 3 lsb of type, 5 unused bits */ char buf[]; }; struct __attribute__ ((__packed__)) sdshdr32 { uint32_t len; /* used */ uint32_t alloc; /* excluding the header and null terminator */ unsigned char flags; /* 3 lsb of type, 5 unused bits */ char buf[]; }; struct __attribute__ ((__packed__)) sdshdr64 { uint64_t len; /* used */ uint64_t alloc; /* excluding the header and null terminator */ unsigned char flags; /* 3 lsb of type, 5 unused bits */ char buf[]; }; 2.创建字符串 创建字符串对应sds.c的sdsnewlen()方法："><meta property="og:locale" content="zh-CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:tag" content="Redis"><meta name=twitter:card content="summary"><meta name=twitter:title content="redis-2.SDS"><meta name=twitter:description content="1.SDS结构
redis3.2之前的SDS长这样：

  
      
          free(4字节)
          len(4字节)
          buf[]
      
  
  
      
          buf剩余长度
          buf使用长度
          字符数组，最后一位是&rsquo;\0'
      
  

free+len固定需要8字节，这样有个弊端，当字符串很小的时候可能2个字节就够了，如果字符串很大可能4字节还存不下长度，所以redis5之后针对free和len改成了5种sdshdr：


sdshdr5：常量字符串，不支持扩容，使用1个字节标识，低3位表示类型(比如sdshdr5类型)，高5位表示len；


sdshdr8：他多了一个alloc记录总长度：

  
      
          len
          alloc
          flags
          buf[]
      
  
  
      
          已使用长度
          总长度
          1字节，低3位表示类型，高5位预留
          字符数组
      
  



sdshdr16、sdshdr32、sdshdr64和sdshdr8是一样的，不过len和alloc的类型不一样，分别使用uint8(无符号1字节int)、uint16、uint32、uint64。


对应的结构体：


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31


/**
 * __attribute__ ((__packed__))是优化对齐
 */
struct __attribute__ ((__packed__)) sdshdr5 {
    unsigned char flags; /* 3 lsb of type, and 5 msb of string length */
    char buf[];
};
struct __attribute__ ((__packed__)) sdshdr8 {
    uint8_t len; /* used */
    uint8_t alloc; /* excluding the header and null terminator */
    unsigned char flags; /* 3 lsb of type, 5 unused bits */
    char buf[];
};
struct __attribute__ ((__packed__)) sdshdr16 {
    uint16_t len; /* used */
    uint16_t alloc; /* excluding the header and null terminator */
    unsigned char flags; /* 3 lsb of type, 5 unused bits */
    char buf[];
};
struct __attribute__ ((__packed__)) sdshdr32 {
    uint32_t len; /* used */
    uint32_t alloc; /* excluding the header and null terminator */
    unsigned char flags; /* 3 lsb of type, 5 unused bits */
    char buf[];
};
struct __attribute__ ((__packed__)) sdshdr64 {
    uint64_t len; /* used */
    uint64_t alloc; /* excluding the header and null terminator */
    unsigned char flags; /* 3 lsb of type, 5 unused bits */
    char buf[];
};


2.创建字符串
创建字符串对应sds.c的sdsnewlen()方法："><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://wangxiaohong123.github.io/posts/"},{"@type":"ListItem","position":2,"name":"redis-2.SDS","item":"https://wangxiaohong123.github.io/posts/%E5%9F%BA%E7%A1%80/%E6%95%B0%E6%8D%AE%E5%BA%93/redis/2.sds/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"redis-2.SDS","name":"redis-2.SDS","description":"1.SDS结构 redis3.2之前的SDS长这样：\nfree(4字节) len(4字节) buf[] buf剩余长度 buf使用长度 字符数组，最后一位是\u0026rsquo;\\0' free+len固定需要8字节，这样有个弊端，当字符串很小的时候可能2个字节就够了，如果字符串很大可能4字节还存不下长度，所以redis5之后针对free和len改成了5种sdshdr：\nsdshdr5：常量字符串，不支持扩容，使用1个字节标识，低3位表示类型(比如sdshdr5类型)，高5位表示len；\nsdshdr8：他多了一个alloc记录总长度：\nlen alloc flags buf[] 已使用长度 总长度 1字节，低3位表示类型，高5位预留 字符数组 sdshdr16、sdshdr32、sdshdr64和sdshdr8是一样的，不过len和alloc的类型不一样，分别使用uint8(无符号1字节int)、uint16、uint32、uint64。\n对应的结构体：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 /** * __attribute__ ((__packed__))是优化对齐 */ struct __attribute__ ((__packed__)) sdshdr5 { unsigned char flags; /* 3 lsb of type, and 5 msb of string length */ char buf[]; }; struct __attribute__ ((__packed__)) sdshdr8 { uint8_t len; /* used */ uint8_t alloc; /* excluding the header and null terminator */ unsigned char flags; /* 3 lsb of type, 5 unused bits */ char buf[]; }; struct __attribute__ ((__packed__)) sdshdr16 { uint16_t len; /* used */ uint16_t alloc; /* excluding the header and null terminator */ unsigned char flags; /* 3 lsb of type, 5 unused bits */ char buf[]; }; struct __attribute__ ((__packed__)) sdshdr32 { uint32_t len; /* used */ uint32_t alloc; /* excluding the header and null terminator */ unsigned char flags; /* 3 lsb of type, 5 unused bits */ char buf[]; }; struct __attribute__ ((__packed__)) sdshdr64 { uint64_t len; /* used */ uint64_t alloc; /* excluding the header and null terminator */ unsigned char flags; /* 3 lsb of type, 5 unused bits */ char buf[]; }; 2.创建字符串 创建字符串对应sds.c的sdsnewlen()方法：\n","keywords":["redis"],"articleBody":"1.SDS结构 redis3.2之前的SDS长这样：\nfree(4字节) len(4字节) buf[] buf剩余长度 buf使用长度 字符数组，最后一位是’\\0' free+len固定需要8字节，这样有个弊端，当字符串很小的时候可能2个字节就够了，如果字符串很大可能4字节还存不下长度，所以redis5之后针对free和len改成了5种sdshdr：\nsdshdr5：常量字符串，不支持扩容，使用1个字节标识，低3位表示类型(比如sdshdr5类型)，高5位表示len；\nsdshdr8：他多了一个alloc记录总长度：\nlen alloc flags buf[] 已使用长度 总长度 1字节，低3位表示类型，高5位预留 字符数组 sdshdr16、sdshdr32、sdshdr64和sdshdr8是一样的，不过len和alloc的类型不一样，分别使用uint8(无符号1字节int)、uint16、uint32、uint64。\n对应的结构体：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 /** * __attribute__ ((__packed__))是优化对齐 */ struct __attribute__ ((__packed__)) sdshdr5 { unsigned char flags; /* 3 lsb of type, and 5 msb of string length */ char buf[]; }; struct __attribute__ ((__packed__)) sdshdr8 { uint8_t len; /* used */ uint8_t alloc; /* excluding the header and null terminator */ unsigned char flags; /* 3 lsb of type, 5 unused bits */ char buf[]; }; struct __attribute__ ((__packed__)) sdshdr16 { uint16_t len; /* used */ uint16_t alloc; /* excluding the header and null terminator */ unsigned char flags; /* 3 lsb of type, 5 unused bits */ char buf[]; }; struct __attribute__ ((__packed__)) sdshdr32 { uint32_t len; /* used */ uint32_t alloc; /* excluding the header and null terminator */ unsigned char flags; /* 3 lsb of type, 5 unused bits */ char buf[]; }; struct __attribute__ ((__packed__)) sdshdr64 { uint64_t len; /* used */ uint64_t alloc; /* excluding the header and null terminator */ unsigned char flags; /* 3 lsb of type, 5 unused bits */ char buf[]; }; 2.创建字符串 创建字符串对应sds.c的sdsnewlen()方法：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 sds sdsnewlen(const void *init, size_t initlen) { // sds指针 void *sh; // 返回的结果，因为返回的是buf[]指针 // 所以这个就可以理解成buf[] sds s; // 根据长度确定类型 char type = sdsReqType(initlen); /* Empty strings are usually created in order to append. Use type 8 * since type 5 is not good at this. */ // 如果type是sdshdr5并且字符串是空，把类型改成sdshdr8 if (type == SDS_TYPE_5 \u0026\u0026 initlen == 0) type = SDS_TYPE_8; // 这个是当前类型的头长度，就是len、alloc、flag这些 int hdrlen = sdsHdrSize(type); unsigned char *fp; /* flags pointer. */ // 根据长度申请内存空间，头 + 体 + '\\0' sh = s_malloc(hdrlen+initlen+1); if (init==SDS_NOINIT) init = NULL; else if (!init) memset(sh, 0, hdrlen+initlen+1); if (sh == NULL) return NULL; // 把s指向buf[] s = (char*)sh+hdrlen; // buf[]的上一位就是flags的位置 fp = ((unsigned char*)s)-1; // 初始化 switch(type) { case SDS_TYPE_5: { *fp = type | (initlen \u003c\u003c SDS_TYPE_BITS); break; } case SDS_TYPE_8: { SDS_HDR_VAR(8,s); sh-\u003elen = initlen; sh-\u003ealloc = initlen; *fp = type; break; } case SDS_TYPE_16: { SDS_HDR_VAR(16,s); sh-\u003elen = initlen; sh-\u003ealloc = initlen; *fp = type; break; } case SDS_TYPE_32: { SDS_HDR_VAR(32,s); sh-\u003elen = initlen; sh-\u003ealloc = initlen; *fp = type; break; } case SDS_TYPE_64: { SDS_HDR_VAR(64,s); sh-\u003elen = initlen; sh-\u003ealloc = initlen; *fp = type; break; } } // 拷贝 if (initlen \u0026\u0026 init) memcpy(s, init, initlen); // 最后一位添加结束符 s[initlen] = '\\0'; // 返回buf[] return s; } 注意：当我们创建空字符串的时候并不会创建sdshdr5类型的SDS，因为sdshdr5是常量，redis认为如果初始化的时候是空串，很可能会对他进行修改，所以会创建一个sdshdr8类型的字符串。\n3.释放字符串 释放分两种，保留内存和释放内存，释放内存的在sdsfree()函数里：\n1 2 3 4 5 6 7 void sdsfree(sds s) { // 空就返回 if (s == NULL) return; // 先把指针指向sds的头，s指针的上一位就是flags，flags里有sds的type，根据type能计算head的长度，就可以把指针移动到sds的起始地址了 // 然后调用s_free()释放内存 s_free((char*)s-sdsHdrSize(s[-1])); } 保留内存是sdsclear()函数：\n1 2 3 4 5 6 void sdsclear(sds s) { // len赋值成0 sdssetlen(s, 0); // 清空buf[] s[0] = '\\0'; } 4.字符串拼接 字符串拼接的流程很简单，但是他需要判断是否需要扩容，拼串是sdscatsds()函数，sdscatsds()里面调用了sdscatlen()函数：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 sds sdscatlen(sds s, const void *t, size_t len) { // 当前buf[]的长度 size_t curlen = sdslen(s); // 判断是否需要扩容,需要扩容就返回扩容后的sds s = sdsMakeRoomFor(s,len); if (s == NULL) return NULL; // 拼串 memcpy(s+curlen, t, len); // 设置新串的长度 sdssetlen(s, curlen+len); // 结尾加结束符 s[curlen+len] = '\\0'; return s; } 扩容的代码：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 sds sdsMakeRoomFor(sds s, size_t addlen) { void *sh, *newsh; // 计算剩余空间 size_t avail = sdsavail(s); size_t len, newlen; // 获取type char type, oldtype = s[-1] \u0026 SDS_TYPE_MASK; int hdrlen; /* Return ASAP if there is enough space left. */ // 如果可用空间\u003e=要拼接的字符串长度直接返回 if (avail \u003e= addlen) return s; // 拿到已使用长度 len = sdslen(s); // 指向sds头的指针 sh = (char*)s-sdsHdrSize(oldtype); // 拼串之后的长度 newlen = (len+addlen); // 下面处理预留空间的 if (newlen \u003c SDS_MAX_PREALLOC) // 如果新长度小于1M，扩容成2倍 newlen *= 2; else // 否则扩容成新长度 + 1M newlen += SDS_MAX_PREALLOC; // 通过新长度计算type type = sdsReqType(newlen); /* Don't use type 5: the user is appending to the string and type 5 is * not able to remember empty space, so sdsMakeRoomFor() must be called * at every appending operation. */ // 不使用sdshdr5存储，因为5不能存空格 if (type == SDS_TYPE_5) type = SDS_TYPE_8; // 根据type计算头长度 hdrlen = sdsHdrSize(type); if (oldtype==type) { // 扩容之后类型不变扩展空间 // 应该就是重新申请内存 newsh = s_realloc(sh, hdrlen+newlen+1); if (newsh == NULL) return NULL; // 指针指向新buf[] s = (char*)newsh+hdrlen; } else { /* Since the header size changes, need to move the string forward, * and can't use realloc */ // 申请新空间 newsh = s_malloc(hdrlen+newlen+1); if (newsh == NULL) return NULL; // 拷贝数据 memcpy((char*)newsh+hdrlen, s, len+1); s_free(sh); // 修改指针 s = (char*)newsh+hdrlen; // flags赋值 s[-1] = type; // len赋值 sdssetlen(s, len); } // 设置总长度 sdssetalloc(s, newlen); // 返回buf[] return s; } 我觉得扩容之后type有没有改变都需要扩容buf[]，buf[]和头需要保持一致，那么内存地址一定会发生改变，就需要拷贝数据，但是源码里只调用了s_realloc()函数，猜测s_realloc()有复制原数据的操作。\n5.字符串的编码 字符串的编码分3种，主要也是为了省空间：\nembstr：字符串长度\u003c=44字节使用这个编码； raw：其他情况使用这个编码(数字除外)； int：整数类型字符串使用这个编码； 字符串的编码在object.c的createStringObject()函数里:\n1 2 3 4 5 6 7 8 9 10 #define OBJ_ENCODING_EMBSTR_SIZE_LIMIT 44 robj *createStringObject(const char *ptr, size_t len) { // 根据长度使用不同编码 if (len \u003c= OBJ_ENCODING_EMBSTR_SIZE_LIMIT) // 短字符串编码 return createEmbeddedStringObject(ptr,len); else // 普通字符串编码 return createRawStringObject(ptr,len); } 在进行编码之后还会判断字符串是不是可以使用int编码格式存储，在tryObjectEncoding()函数里：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 robj *tryObjectEncoding(robj *o) { long value; sds s = o-\u003eptr; size_t len; /* Make sure this is a string object, the only type we encode * in this function. Other types use encoded memory efficient * representations but are handled by the commands implementing * the type. */ serverAssertWithInfo(NULL,o,o-\u003etype == OBJ_STRING); /* We try some specialized encoding only for objects that are * RAW or EMBSTR encoded, in other words objects that are still * in represented by an actually array of chars. */ if (!sdsEncodedObject(o)) return o; // 如果这个对象被使用就不进行编码优化 if (o-\u003erefcount \u003e 1) return o; len = sdslen(s); // 长度小于20进行数字转化，转成long long if (len \u003c= 20 \u0026\u0026 string2l(s,len,\u0026value)) { if ((server.maxmemory == 0 || !(server.maxmemory_policy \u0026 MAXMEMORY_FLAG_NO_SHARED_INTEGERS)) \u0026\u0026 value \u003e= 0 \u0026\u0026 // OBJ_SHARED_INTEGERS是10000 value \u003c OBJ_SHARED_INTEGERS) { decrRefCount(o); incrRefCount(shared.integers[value]); // 根据索引返回共享的整型数组的value return shared.integers[value]; } else { // 转成其他整型 if (o-\u003eencoding == OBJ_ENCODING_RAW) sdsfree(o-\u003eptr); o-\u003eencoding = OBJ_ENCODING_INT; o-\u003eptr = (void*) value; return o; } } // 不能转换编码就简单处理返回了，代码省略 } 简单来看的话就是如果这个字符串可以转成数字，就判断内存和数字是不是小于10000，redis在启动的时候会初始化一个全局共享的0～9999数组，所以只有当索引大于等于0小于10000的时候才能在这个数组里拿到值，满足条件会返回共享数组里的value，否则就转成其他整型。\n","wordCount":"1133","inLanguage":"en","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://wangxiaohong123.github.io/posts/%E5%9F%BA%E7%A1%80/%E6%95%B0%E6%8D%AE%E5%BA%93/redis/2.sds/"},"publisher":{"@type":"Organization","name":"王小红的笔记","logo":{"@type":"ImageObject","url":"https://wangxiaohong123.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wangxiaohong123.github.io/ accesskey=h title="王小红的笔记 (Alt + H)">王小红的笔记</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://wangxiaohong123.github.io/posts/ title=笔记><span>笔记</span></a></li><li><a href=https://wangxiaohong123.github.io/categories/ title=分类><span>分类</span></a></li><li><a href=https://wangxiaohong123.github.io/tags/ title=标签><span>标签</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">redis-2.SDS</h1><div class=post-meta>6 min</div></header><div class=post-content><h5 id=1sds结构>1.SDS结构<a hidden class=anchor aria-hidden=true href=#1sds结构>#</a></h5><p>redis3.2之前的SDS长这样：</p><table><thead><tr><th>free(4字节)</th><th>len(4字节)</th><th>buf[]</th></tr></thead><tbody><tr><td>buf剩余长度</td><td>buf使用长度</td><td>字符数组，最后一位是&rsquo;\0'</td></tr></tbody></table><p>free+len固定需要8字节，这样有个弊端，当字符串很小的时候可能2个字节就够了，如果字符串很大可能4字节还存不下长度，所以redis5之后针对free和len改成了5种sdshdr：</p><ol><li><p>sdshdr5：常量字符串，不支持扩容，使用1个字节标识，低3位表示类型(比如sdshdr5类型)，高5位表示len；</p></li><li><p>sdshdr8：他多了一个alloc记录总长度：</p><table><thead><tr><th>len</th><th>alloc</th><th>flags</th><th>buf[]</th></tr></thead><tbody><tr><td>已使用长度</td><td>总长度</td><td>1字节，低3位表示类型，高5位预留</td><td>字符数组</td></tr></tbody></table></li><li><p>sdshdr16、sdshdr32、sdshdr64和sdshdr8是一样的，不过len和alloc的类型不一样，分别使用uint8(无符号1字节int)、uint16、uint32、uint64。</p></li></ol><p>对应的结构体：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * __attribute__ ((__packed__))是优化对齐
</span></span></span><span style=display:flex><span><span style=color:#6272a4> */</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>struct</span> <span style=color:#50fa7b>__attribute__</span> ((__packed__)) sdshdr5 {
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>unsigned</span> <span style=color:#8be9fd>char</span> flags; <span style=color:#6272a4>/* 3 lsb of type, and 5 msb of string length */</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>char</span> buf[];
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span><span style=color:#ff79c6>struct</span> <span style=color:#50fa7b>__attribute__</span> ((__packed__)) sdshdr8 {
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>uint8_t</span> len; <span style=color:#6272a4>/* used */</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>uint8_t</span> alloc; <span style=color:#6272a4>/* excluding the header and null terminator */</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>unsigned</span> <span style=color:#8be9fd>char</span> flags; <span style=color:#6272a4>/* 3 lsb of type, 5 unused bits */</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>char</span> buf[];
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span><span style=color:#ff79c6>struct</span> <span style=color:#50fa7b>__attribute__</span> ((__packed__)) sdshdr16 {
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>uint16_t</span> len; <span style=color:#6272a4>/* used */</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>uint16_t</span> alloc; <span style=color:#6272a4>/* excluding the header and null terminator */</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>unsigned</span> <span style=color:#8be9fd>char</span> flags; <span style=color:#6272a4>/* 3 lsb of type, 5 unused bits */</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>char</span> buf[];
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span><span style=color:#ff79c6>struct</span> <span style=color:#50fa7b>__attribute__</span> ((__packed__)) sdshdr32 {
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>uint32_t</span> len; <span style=color:#6272a4>/* used */</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>uint32_t</span> alloc; <span style=color:#6272a4>/* excluding the header and null terminator */</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>unsigned</span> <span style=color:#8be9fd>char</span> flags; <span style=color:#6272a4>/* 3 lsb of type, 5 unused bits */</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>char</span> buf[];
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span><span style=color:#ff79c6>struct</span> <span style=color:#50fa7b>__attribute__</span> ((__packed__)) sdshdr64 {
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>uint64_t</span> len; <span style=color:#6272a4>/* used */</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>uint64_t</span> alloc; <span style=color:#6272a4>/* excluding the header and null terminator */</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>unsigned</span> <span style=color:#8be9fd>char</span> flags; <span style=color:#6272a4>/* 3 lsb of type, 5 unused bits */</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>char</span> buf[];
</span></span><span style=display:flex><span>};
</span></span></code></pre></td></tr></table></div></div><h5 id=2创建字符串>2.创建字符串<a hidden class=anchor aria-hidden=true href=#2创建字符串>#</a></h5><p>创建字符串对应sds.c的sdsnewlen()方法：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>sds <span style=color:#50fa7b>sdsnewlen</span>(<span style=color:#ff79c6>const</span> <span style=color:#8be9fd>void</span> <span style=color:#ff79c6>*</span>init, <span style=color:#8be9fd>size_t</span> initlen) {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// sds指针
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#8be9fd>void</span> <span style=color:#ff79c6>*</span>sh;
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 返回的结果，因为返回的是buf[]指针
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#6272a4>// 所以这个就可以理解成buf[]
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    sds s;
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 根据长度确定类型
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#8be9fd>char</span> type <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>sdsReqType</span>(initlen);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>/* Empty strings are usually created in order to append. Use type 8
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     * since type 5 is not good at this. */</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 如果type是sdshdr5并且字符串是空，把类型改成sdshdr8
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> (type <span style=color:#ff79c6>==</span> SDS_TYPE_5 <span style=color:#ff79c6>&amp;&amp;</span> initlen <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) type <span style=color:#ff79c6>=</span> SDS_TYPE_8;
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 这个是当前类型的头长度，就是len、alloc、flag这些
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#8be9fd>int</span> hdrlen <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>sdsHdrSize</span>(type);
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>unsigned</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>fp; <span style=color:#6272a4>/* flags pointer. */</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 根据长度申请内存空间，头 + 体 + &#39;\0&#39;
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    sh <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>s_malloc</span>(hdrlen<span style=color:#ff79c6>+</span>initlen<span style=color:#ff79c6>+</span><span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (init<span style=color:#ff79c6>==</span>SDS_NOINIT)
</span></span><span style=display:flex><span>        init <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>init)
</span></span><span style=display:flex><span>        <span style=color:#50fa7b>memset</span>(sh, <span style=color:#bd93f9>0</span>, hdrlen<span style=color:#ff79c6>+</span>initlen<span style=color:#ff79c6>+</span><span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (sh <span style=color:#ff79c6>==</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) <span style=color:#ff79c6>return</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 把s指向buf[]
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    s <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>char</span><span style=color:#ff79c6>*</span>)sh<span style=color:#ff79c6>+</span>hdrlen;
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// buf[]的上一位就是flags的位置
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    fp <span style=color:#ff79c6>=</span> ((<span style=color:#8be9fd>unsigned</span> <span style=color:#8be9fd>char</span><span style=color:#ff79c6>*</span>)s)<span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 初始化
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>switch</span>(type) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>case</span> <span style=color:#8be9fd;font-style:italic>SDS_TYPE_5</span>: {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>*</span>fp <span style=color:#ff79c6>=</span> type <span style=color:#ff79c6>|</span> (initlen <span style=color:#ff79c6>&lt;&lt;</span> SDS_TYPE_BITS);
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>case</span> <span style=color:#8be9fd;font-style:italic>SDS_TYPE_8</span>: {
</span></span><span style=display:flex><span>            <span style=color:#50fa7b>SDS_HDR_VAR</span>(<span style=color:#bd93f9>8</span>,s);
</span></span><span style=display:flex><span>            sh<span style=color:#ff79c6>-&gt;</span>len <span style=color:#ff79c6>=</span> initlen;
</span></span><span style=display:flex><span>            sh<span style=color:#ff79c6>-&gt;</span>alloc <span style=color:#ff79c6>=</span> initlen;
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>*</span>fp <span style=color:#ff79c6>=</span> type;
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>case</span> <span style=color:#8be9fd;font-style:italic>SDS_TYPE_16</span>: {
</span></span><span style=display:flex><span>            <span style=color:#50fa7b>SDS_HDR_VAR</span>(<span style=color:#bd93f9>16</span>,s);
</span></span><span style=display:flex><span>            sh<span style=color:#ff79c6>-&gt;</span>len <span style=color:#ff79c6>=</span> initlen;
</span></span><span style=display:flex><span>            sh<span style=color:#ff79c6>-&gt;</span>alloc <span style=color:#ff79c6>=</span> initlen;
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>*</span>fp <span style=color:#ff79c6>=</span> type;
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>case</span> <span style=color:#8be9fd;font-style:italic>SDS_TYPE_32</span>: {
</span></span><span style=display:flex><span>            <span style=color:#50fa7b>SDS_HDR_VAR</span>(<span style=color:#bd93f9>32</span>,s);
</span></span><span style=display:flex><span>            sh<span style=color:#ff79c6>-&gt;</span>len <span style=color:#ff79c6>=</span> initlen;
</span></span><span style=display:flex><span>            sh<span style=color:#ff79c6>-&gt;</span>alloc <span style=color:#ff79c6>=</span> initlen;
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>*</span>fp <span style=color:#ff79c6>=</span> type;
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>case</span> <span style=color:#8be9fd;font-style:italic>SDS_TYPE_64</span>: {
</span></span><span style=display:flex><span>            <span style=color:#50fa7b>SDS_HDR_VAR</span>(<span style=color:#bd93f9>64</span>,s);
</span></span><span style=display:flex><span>            sh<span style=color:#ff79c6>-&gt;</span>len <span style=color:#ff79c6>=</span> initlen;
</span></span><span style=display:flex><span>            sh<span style=color:#ff79c6>-&gt;</span>alloc <span style=color:#ff79c6>=</span> initlen;
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>*</span>fp <span style=color:#ff79c6>=</span> type;
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 拷贝
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> (initlen <span style=color:#ff79c6>&amp;&amp;</span> init)
</span></span><span style=display:flex><span>        <span style=color:#50fa7b>memcpy</span>(s, init, initlen);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 最后一位添加结束符
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    s[initlen] <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;\0&#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 返回buf[]
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>return</span> s;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p><strong>注意：当我们创建空字符串的时候并不会创建sdshdr5类型的SDS，因为sdshdr5是常量，redis认为如果初始化的时候是空串，很可能会对他进行修改，所以会创建一个sdshdr8类型的字符串。</strong></p><h5 id=3释放字符串>3.释放字符串<a hidden class=anchor aria-hidden=true href=#3释放字符串>#</a></h5><p>释放分两种，保留内存和释放内存，释放内存的在sdsfree()函数里：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>sdsfree</span>(sds s) {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 空就返回
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> (s <span style=color:#ff79c6>==</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 先把指针指向sds的头，s指针的上一位就是flags，flags里有sds的type，根据type能计算head的长度，就可以把指针移动到sds的起始地址了
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#6272a4>// 然后调用s_free()释放内存
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#50fa7b>s_free</span>((<span style=color:#8be9fd>char</span><span style=color:#ff79c6>*</span>)s<span style=color:#ff79c6>-</span><span style=color:#50fa7b>sdsHdrSize</span>(s[<span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>]));
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>保留内存是sdsclear()函数：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>sdsclear</span>(sds s) {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// len赋值成0
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#50fa7b>sdssetlen</span>(s, <span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 清空buf[]
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    s[<span style=color:#bd93f9>0</span>] <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;\0&#39;</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h5 id=4字符串拼接>4.字符串拼接<a hidden class=anchor aria-hidden=true href=#4字符串拼接>#</a></h5><p>字符串拼接的流程很简单，但是他需要判断是否需要扩容，拼串是sdscatsds()函数，sdscatsds()里面调用了sdscatlen()函数：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>sds <span style=color:#50fa7b>sdscatlen</span>(sds s, <span style=color:#ff79c6>const</span> <span style=color:#8be9fd>void</span> <span style=color:#ff79c6>*</span>t, <span style=color:#8be9fd>size_t</span> len) {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 当前buf[]的长度
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#8be9fd>size_t</span> curlen <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>sdslen</span>(s);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 判断是否需要扩容,需要扩容就返回扩容后的sds
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    s <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>sdsMakeRoomFor</span>(s,len);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (s <span style=color:#ff79c6>==</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) <span style=color:#ff79c6>return</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 拼串
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#50fa7b>memcpy</span>(s<span style=color:#ff79c6>+</span>curlen, t, len);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 设置新串的长度
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#50fa7b>sdssetlen</span>(s, curlen<span style=color:#ff79c6>+</span>len);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 结尾加结束符
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    s[curlen<span style=color:#ff79c6>+</span>len] <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;\0&#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> s;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>扩容的代码：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>sds <span style=color:#50fa7b>sdsMakeRoomFor</span>(sds s, <span style=color:#8be9fd>size_t</span> addlen) {
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>void</span> <span style=color:#ff79c6>*</span>sh, <span style=color:#ff79c6>*</span>newsh;
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 计算剩余空间
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#8be9fd>size_t</span> avail <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>sdsavail</span>(s);
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>size_t</span> len, newlen;
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 获取type
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#8be9fd>char</span> type, oldtype <span style=color:#ff79c6>=</span> s[<span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>] <span style=color:#ff79c6>&amp;</span> SDS_TYPE_MASK;
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>int</span> hdrlen;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>/* Return ASAP if there is enough space left. */</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 如果可用空间&gt;=要拼接的字符串长度直接返回
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> (avail <span style=color:#ff79c6>&gt;=</span> addlen) <span style=color:#ff79c6>return</span> s;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 拿到已使用长度
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    len <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>sdslen</span>(s);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 指向sds头的指针
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    sh <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>char</span><span style=color:#ff79c6>*</span>)s<span style=color:#ff79c6>-</span><span style=color:#50fa7b>sdsHdrSize</span>(oldtype);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 拼串之后的长度
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    newlen <span style=color:#ff79c6>=</span> (len<span style=color:#ff79c6>+</span>addlen);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 下面处理预留空间的
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> (newlen <span style=color:#ff79c6>&lt;</span> SDS_MAX_PREALLOC)
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 如果新长度小于1M，扩容成2倍
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        newlen <span style=color:#ff79c6>*=</span> <span style=color:#bd93f9>2</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>else</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 否则扩容成新长度 + 1M
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        newlen <span style=color:#ff79c6>+=</span> SDS_MAX_PREALLOC;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 通过新长度计算type
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    type <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>sdsReqType</span>(newlen);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>/* Don&#39;t use type 5: the user is appending to the string and type 5 is
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     * not able to remember empty space, so sdsMakeRoomFor() must be called
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     * at every appending operation. */</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 不使用sdshdr5存储，因为5不能存空格
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> (type <span style=color:#ff79c6>==</span> SDS_TYPE_5) type <span style=color:#ff79c6>=</span> SDS_TYPE_8;
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 根据type计算头长度
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    hdrlen <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>sdsHdrSize</span>(type);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (oldtype<span style=color:#ff79c6>==</span>type) {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 扩容之后类型不变扩展空间
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#6272a4>// 应该就是重新申请内存
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        newsh <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>s_realloc</span>(sh, hdrlen<span style=color:#ff79c6>+</span>newlen<span style=color:#ff79c6>+</span><span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (newsh <span style=color:#ff79c6>==</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) <span style=color:#ff79c6>return</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 指针指向新buf[]
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        s <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>char</span><span style=color:#ff79c6>*</span>)newsh<span style=color:#ff79c6>+</span>hdrlen;
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>/* Since the header size changes, need to move the string forward,
</span></span></span><span style=display:flex><span><span style=color:#6272a4>         * and can&#39;t use realloc */</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 申请新空间
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        newsh <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>s_malloc</span>(hdrlen<span style=color:#ff79c6>+</span>newlen<span style=color:#ff79c6>+</span><span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (newsh <span style=color:#ff79c6>==</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) <span style=color:#ff79c6>return</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 拷贝数据
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#50fa7b>memcpy</span>((<span style=color:#8be9fd>char</span><span style=color:#ff79c6>*</span>)newsh<span style=color:#ff79c6>+</span>hdrlen, s, len<span style=color:#ff79c6>+</span><span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span>        <span style=color:#50fa7b>s_free</span>(sh);
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 修改指针
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        s <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>char</span><span style=color:#ff79c6>*</span>)newsh<span style=color:#ff79c6>+</span>hdrlen;
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// flags赋值
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        s[<span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>] <span style=color:#ff79c6>=</span> type;
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// len赋值
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#50fa7b>sdssetlen</span>(s, len);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 设置总长度
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#50fa7b>sdssetalloc</span>(s, newlen);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 返回buf[]
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>return</span> s;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>我觉得扩容之后type有没有改变都需要扩容buf[]，buf[]和头需要保持一致，那么内存地址一定会发生改变，就需要拷贝数据，但是源码里只调用了s_realloc()函数，猜测s_realloc()有复制原数据的操作。</p><h5 id=5字符串的编码>5.字符串的编码<a hidden class=anchor aria-hidden=true href=#5字符串的编码>#</a></h5><p>字符串的编码分3种，主要也是为了省空间：</p><ul><li>embstr：字符串长度&lt;=44字节使用这个编码；</li><li>raw：其他情况使用这个编码(数字除外)；</li><li>int：整数类型字符串使用这个编码；</li></ul><p>字符串的编码在object.c的createStringObject()函数里:</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ff79c6>#define OBJ_ENCODING_EMBSTR_SIZE_LIMIT 44
</span></span></span><span style=display:flex><span><span style=color:#ff79c6></span>robj <span style=color:#ff79c6>*</span><span style=color:#50fa7b>createStringObject</span>(<span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>ptr, <span style=color:#8be9fd>size_t</span> len) {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 根据长度使用不同编码
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> (len <span style=color:#ff79c6>&lt;=</span> OBJ_ENCODING_EMBSTR_SIZE_LIMIT)
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 短字符串编码
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>return</span> <span style=color:#50fa7b>createEmbeddedStringObject</span>(ptr,len);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>else</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 普通字符串编码
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>return</span> <span style=color:#50fa7b>createRawStringObject</span>(ptr,len);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>在进行编码之后还会判断字符串是不是可以使用int编码格式存储，在tryObjectEncoding()函数里：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>robj <span style=color:#ff79c6>*</span><span style=color:#50fa7b>tryObjectEncoding</span>(robj <span style=color:#ff79c6>*</span>o) {
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>long</span> value;
</span></span><span style=display:flex><span>    sds s <span style=color:#ff79c6>=</span> o<span style=color:#ff79c6>-&gt;</span>ptr;
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>size_t</span> len;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>/* Make sure this is a string object, the only type we encode
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     * in this function. Other types use encoded memory efficient
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     * representations but are handled by the commands implementing
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     * the type. */</span>
</span></span><span style=display:flex><span>    <span style=color:#50fa7b>serverAssertWithInfo</span>(<span style=color:#8be9fd;font-style:italic>NULL</span>,o,o<span style=color:#ff79c6>-&gt;</span>type <span style=color:#ff79c6>==</span> OBJ_STRING);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>/* We try some specialized encoding only for objects that are
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     * RAW or EMBSTR encoded, in other words objects that are still
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     * in represented by an actually array of chars. */</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span><span style=color:#50fa7b>sdsEncodedObject</span>(o)) <span style=color:#ff79c6>return</span> o;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 如果这个对象被使用就不进行编码优化
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>     <span style=color:#ff79c6>if</span> (o<span style=color:#ff79c6>-&gt;</span>refcount <span style=color:#ff79c6>&gt;</span> <span style=color:#bd93f9>1</span>) <span style=color:#ff79c6>return</span> o;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    len <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>sdslen</span>(s);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 长度小于20进行数字转化，转成long long
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> (len <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>20</span> <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#50fa7b>string2l</span>(s,len,<span style=color:#ff79c6>&amp;</span>value)) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> ((server.maxmemory <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>||</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>!</span>(server.maxmemory_policy <span style=color:#ff79c6>&amp;</span> MAXMEMORY_FLAG_NO_SHARED_INTEGERS)) <span style=color:#ff79c6>&amp;&amp;</span>
</span></span><span style=display:flex><span>            value <span style=color:#ff79c6>&gt;=</span> <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>&amp;&amp;</span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// OBJ_SHARED_INTEGERS是10000
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>            value <span style=color:#ff79c6>&lt;</span> OBJ_SHARED_INTEGERS)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#50fa7b>decrRefCount</span>(o);
</span></span><span style=display:flex><span>            <span style=color:#50fa7b>incrRefCount</span>(shared.integers[value]);
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 根据索引返回共享的整型数组的value
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>            <span style=color:#ff79c6>return</span> shared.integers[value];
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 转成其他整型
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>            <span style=color:#ff79c6>if</span> (o<span style=color:#ff79c6>-&gt;</span>encoding <span style=color:#ff79c6>==</span> OBJ_ENCODING_RAW) <span style=color:#50fa7b>sdsfree</span>(o<span style=color:#ff79c6>-&gt;</span>ptr);
</span></span><span style=display:flex><span>            o<span style=color:#ff79c6>-&gt;</span>encoding <span style=color:#ff79c6>=</span> OBJ_ENCODING_INT;
</span></span><span style=display:flex><span>            o<span style=color:#ff79c6>-&gt;</span>ptr <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>void</span><span style=color:#ff79c6>*</span>) value;
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> o;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 不能转换编码就简单处理返回了，代码省略
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>}
</span></span></code></pre></td></tr></table></div></div><p>简单来看的话就是如果这个字符串可以转成数字，就判断内存和数字是不是小于10000，<strong>redis在启动的时候会初始化一个全局共享的0～9999数组，所以只有当索引大于等于0小于10000的时候才能在这个数组里拿到值</strong>，满足条件会返回共享数组里的value，否则就转成其他整型。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://wangxiaohong123.github.io/tags/redis/>Redis</a></li></ul><nav class=paginav><a class=prev href=https://wangxiaohong123.github.io/posts/%E5%9F%BA%E7%A1%80/%E6%95%B0%E6%8D%AE%E5%BA%93/redis/1.%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/><span class=title>« Prev</span><br><span>redis-1.架构设计</span>
</a><a class=next href=https://wangxiaohong123.github.io/posts/%E5%9F%BA%E7%A1%80/%E6%95%B0%E6%8D%AE%E5%BA%93/redis/3.%E8%B7%B3%E8%A1%A8/><span class=title>Next »</span><br><span>redis-3.跳表</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share redis-2.SDS on x" href="https://x.com/intent/tweet/?text=redis-2.SDS&amp;url=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E5%259F%25BA%25E7%25A1%2580%2f%25E6%2595%25B0%25E6%258D%25AE%25E5%25BA%2593%2fredis%2f2.sds%2f&amp;hashtags=redis"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share redis-2.SDS on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E5%259F%25BA%25E7%25A1%2580%2f%25E6%2595%25B0%25E6%258D%25AE%25E5%25BA%2593%2fredis%2f2.sds%2f&amp;title=redis-2.SDS&amp;summary=redis-2.SDS&amp;source=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E5%259F%25BA%25E7%25A1%2580%2f%25E6%2595%25B0%25E6%258D%25AE%25E5%25BA%2593%2fredis%2f2.sds%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share redis-2.SDS on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E5%259F%25BA%25E7%25A1%2580%2f%25E6%2595%25B0%25E6%258D%25AE%25E5%25BA%2593%2fredis%2f2.sds%2f&title=redis-2.SDS"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share redis-2.SDS on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E5%259F%25BA%25E7%25A1%2580%2f%25E6%2595%25B0%25E6%258D%25AE%25E5%25BA%2593%2fredis%2f2.sds%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share redis-2.SDS on whatsapp" href="https://api.whatsapp.com/send?text=redis-2.SDS%20-%20https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E5%259F%25BA%25E7%25A1%2580%2f%25E6%2595%25B0%25E6%258D%25AE%25E5%25BA%2593%2fredis%2f2.sds%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share redis-2.SDS on telegram" href="https://telegram.me/share/url?text=redis-2.SDS&amp;url=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E5%259F%25BA%25E7%25A1%2580%2f%25E6%2595%25B0%25E6%258D%25AE%25E5%25BA%2593%2fredis%2f2.sds%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share redis-2.SDS on ycombinator" href="https://news.ycombinator.com/submitlink?t=redis-2.SDS&u=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E5%259F%25BA%25E7%25A1%2580%2f%25E6%2595%25B0%25E6%258D%25AE%25E5%25BA%2593%2fredis%2f2.sds%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://wangxiaohong123.github.io/>王小红的笔记</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>