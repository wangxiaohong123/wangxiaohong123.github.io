---
title: 线上问题排查
tags:
  - linux
categories: 基础
copyright: true
---

### 服务器

1.   **端口号被占用**

     启动服务发现端口号被占用可以使用netstat或者lsof查看占用端口号进程，没有用就杀掉

     ```shell
     netstat -tunlp | grep 80
     lsof -i:80
     kill -9 [pid]
     ```

2.   **磁盘**

     当磁盘不足的时候可能会收到类似**java.io.IOException: 磁盘空间不足**这种信息，可以先使用以下指令查看磁盘状态

     ```shell
     df -h
     ```

     比如显示下面的信息就表示/目录下的磁盘占用很大

     ![](https://tva1.sinaimg.cn/large/008i3skNly1gszxofoan2j30se06gmy2.jpg)

     就要去/下面查看文件夹大小，一层一层一直找到大文件

     ```shell
     du -sh *
     # 然后可以使用ls查看文件大小
     ls -lh
     
     # 或者直接找到大文件，max-depth就是查找文件夹的深度
     du -h --max-depth=1 | sort -n 
     ```

     或者直接使用find命令把大文件筛选出来

     ```shell
     # 找到超过800M的文件
     find / -type f -size +800M 
     ```

3.   **CPU过高**

使用top命令查看CPU占用过高的进程

```shell
# -n 指定结果的输出次数
# -p 指定查看的进程id
top
# 按N是以进程id排序
# 按M是以内存使用率排序
# 按P是以CPU使用率排序
```

### java应用

1.   **应用CPU过高**

     这个步骤时固定的，类似把大象装冰箱需要几步

     ```shell
     # 首先按进程负载排序找到  axLoad(pid)
     top oder by with P:1040
     # 找到相关负载 线程PID
     top -Hp [进程PID]
     # 将线程PID转换为 16进制，为后面查找 jstack 日志做准备
     printf "0x%x\n" [线程PID]
     # 例如：jstack 1040|vim +/0x431 -
     jstack  [进程PID] | vim +/[十六进制线程PID] -
     ```

     推荐一个工具：show-busy-java-threads.sh，github：https://github.com/oldratlee/useful-scripts

     快速安装：

     ```shell
     source <(curl -fsSL https://raw.githubusercontent.com/oldratlee/useful-scripts/master/test-cases/self-installer.sh)
     ```

     直接执行就可以

     ```shell
     show-busy-java-threads.sh -p <指定的Java Process>
     ```

2.   **内存**

     把OOM日志down下来之后使用mat分析

3.   **GC**

     频繁GC需要查看GC日志

4.   **搜索命令**

     **tail**：

     ```shell
     # 倒数300行并进入实时监听文件写入模式
     tail -300f shopbase.log
     ```

     **grep**：

     ```shell
     # 文件查找
     grep forest f.txt
     # 多文件查找
     grep forest f.txt cpf.txt
     # 目录下查找所有符合关键字的文件
     grep 'log' /home/admin -r -n
     cat f.txt | grep -i shopbase
     # 指定文件后缀
     grep 'shopbase' /home/admin -r -n --include *.{vm,java}
     # 反匹配
     grep 'shopbase' /home/admin -r -n --exclude *.{vm,java}
     # 上匹配
     seq 10 | grep 5 -A 3
     # 下匹配
     seq 10 | grep 5 -B 3
     # 上下匹配，平时用这个就妥了
     seq 10 | grep 5 -C 3
     cat f.txt | grep -c 'SHOPBASE'
     ```

     **jps**:

     ```shell
     # 我只用1条命令
     sudo -u jps -mlvV
     ```

5.   **排查工具**

     arthas、

### MySQL

1.   **慢SQL**

     查看查询计划，优化

2.   **连接过多**

     **too many connections**，可以增加数据库的连接数

     ```mysql
     set global max_connections=XXX
     ```

     也可以杀死过多的连接

     ```mysql
     show processlist
     ```

     排序数据库链接的命令

     ```shell
     mysql -h127.0.0.0.1 -uabc_test -pXXXXX -P3306 -A -e 'show processlist'| awk '{print $4}'|sort|uniq -c|sort -rn|head -10
     ```

     

3.   **死锁**

     MySQL开始报DeadLock相关异常的时候，就发生死锁了，先查看一下数据库隔离级别，一般都是可重复读

     ```mysql
     select @@tx_isolation
     ```

     查看死锁日志

     ```mysql
     show engine innodb status
     ```

     在日志中找到相关SQL，在定位到代码，分析问题

4.   MySQL常用命令

     ```mysql
     # 查询慢SQL查询是否开启
     show variables like 'slow_query_log';
     # 查询慢SQL的时间
     show variables like 'long_query_time';
     # 查看慢SQL存放路径，一般：/home/mysql/data3016/mysql/slow_query.log
     show variables like 'slow_query_log_file';
     
     # 查看数据库的事务隔离级别,RDS:READ-COMMITTED   Mysql:Repeatable read
     show variables like 'tx_isolation'; 
      # innodb数据页大小  16384
     show variables like 'innodb_page_size'; 
     
     show status  like 'innodb_row_%';
     
     # 查看慢SQL
     SHOW SLOW limit 10;
     show full slow limit 10;
     
     # 查看autocommit配置
     select @@autocommit; 
      # 同上
     show variables like 'autocommit'; 
     #设置SQL自动提交模式  1:默认,自动提交   0:需要手动触发commit,否则不会生效
     set autocommit=1;　　
     # 查看默认的搜索引擎
     show variables like '%storage_engine%'; 
     
     # 设置事务隔离级别
     SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ;
     ```

### redis

1.   **内存不足**

     系统尽量保留1/4，因为redis复制数据什么的也需要内存。内存不足可以适当加大内存

     ```shell
     # 设置内存
     config set  maxmemory xxxxx
     
     # 配置文件中修改内存
     maxmemory xxxxxx
     # 配置文件设置缓存淘汰策略
     maxmemory-policy allkeys-lru
     ```

     查看大key，安装dbatools redisTools，执行一下命令列出最大的前3个key，结果是每种数据类型的前3个大key

     ```shell
     /data/program/dbatools-master/redisTools/redis-cli-new -h <ip> -p <port> --bigkeys --bigkey-numb 3
     ```

     

2.   **连接数过多**

     配置连接数

     ```shell
     # 服务器上配置连接数
     config set maxclients xxx
     
     # 配置文件里设置连接数
     maxclients 10000
     ```

     

3.   **慢命令**

     首先需要配置慢查询记录

     ```shell
     # 执行时间大于多少微秒(microsecond，1秒 = 1,000,000 微秒)的查询进行记录。
     slowlog-log-lower-than 1000
     # 最多能保存多少条日志
     slowlog-max-len 200
     ```

     查看慢命令

     ```redis
     slowlog get
     ```

### 网络

当Server上有大量半连接状态且源IP地址是随机的，则可以断定遭到SYN攻击了，使用如下命令可以让之现行

```shell
netstat -n|grep SYN_RECV
```

查看连接数是否正常

```shell
# 查看8000端口
netstat -anoe|grep 8000|wc -l
```

然后利用如下命令判断各个状态的连接数是否正常：

```shell
netstat -n | awk '/^tcp/ {++S[$NF]} END {for(a in S) print a, S[a]}'
```

如果是TIME_WAIT状态过多，可以在查看CLOSE_WAIT状态最多的ip地址

```shell
netstat -n|grep TIME_WAIT|awk '{print $5}'|awk -F: '{print $1}'|sort|uniq -c|sort -nr|head -10
```

如果CLOSE_WAIT状态过多基本上就是SYN攻击了。