---
title: 1.记一次生产服务堆外内存泄露
tags:
  - 线上问题
categories: 线上问题
copyright: true
---

除夕放假前一天运营跟我说app用不了，赶紧起来查看，线上监控使用的阿里arms并没有报警信息，应用状态也都正常。
怀疑那个中间件欠费导致，但是没找到。
然后又去看了下管理后台是可用的，因为我们后台和app的代码是分开的，并没有使用app的网关，所以猜测网关除了问题，在进入arms查看果然网关掉线了。

登录网关服务器检查oom日志和GC日志，并没有OOM日志，GC也都正常，然后进入/var/log/查看messages文件看看是不是操作系统把进程杀死，果然看到了日志：
![](https://tva1.sinaimg.cn/large/008i3skNly1gz9e109wjoj31sy0nqdri.jpg)
操作系统内存溢出把网关进程杀死，anon-rss就是网关进程malloc出来的内存，可以理解成实际使用内存，7个G很高了，但是total-vm更高，先看一下服务的启动参数，看到堆内存分配了6个G，元数据空间256M，再加上栈什么的7个G也差不多，然后我把堆内存调成4G，重启网关，并在arms中添加内存报警规则，启动之前我在启动参数中增加参数：

```shell
# 打开NMT会带来5%－10%的性能损耗
# 可以使用jcmd 5687 VM.native_memory shutdown关闭NMT
-XX:NativeMemoryTracking=detail
```
因为total-vm过大，而网关进程已经被杀死，防止不是堆内存问题导致的操作系统OOM到时候可以使用**jcmd pid VM.native_memory detail scale=MB >temp.txt**查看内存分布。

果然没过几天突然收到内存报警，还是网关，使用top命令查看内存使用已经快6个G了：
<img src="https://tva1.sinaimg.cn/large/008i3skNly1gz9ehe6wnwj30yy09sdj5.jpg"  />
virt是申请的大小，res是实际使用的大小，这两个不管那个都很大，然后我使用一下命令把内存分布输出到文件里:

```shell
jcmd 5687 VM.native_memory detail scale=MB > temp.txt
```

![](/Users/xiaohong/Desktop/008i3skNly1gz9ft62f7uj30u00xj42r.png)
可以看到Internal占用很大，使用命令**jmap -heap 5687**看一下是否是元数据空间过大，但是并没有，怀疑是堆外内存溢出。

如果不是堆外内存的问题可以使用以下命令分析内存快照，使用mat分析：

```shell
jmap -dump:live,format=b,file=gateway.hprof 5687
```

##### 排查堆外内存泄露

使用strace追踪申请内存请求：

```shell
strace -Ff -ebrk,mmap,munmap -p 5687
```

![](https://tva1.sinaimg.cn/large/008i3skNly1gz9l9zxpthj315q0fm44l.jpg)
这里看不出来异常申请，而且在系统运行几天之后才会出现内存泄漏，所以尝试使用pmap查看内存分配情况：

```shell
# 以第3列正序排序
pmap -x 5687 | sort -k3 -n > pmap.txt
```

![](https://tva1.sinaimg.cn/large/008i3skNly1gz9meryc4fj30v80u00yr.jpg)

第2列是内存占用字节数，第3列是常驻内存，可以理解成实际使用内存，第4列是脏页内存，虽然有很多64M内存，但是使用都是0，应该是释放了，那个2459920k的内存就很可疑，大约2.3个G，去smaps里找到这个内存的地址：

```shell
less /proc/5687/smaps
```

按d向下翻页：
<img src="https://tva1.sinaimg.cn/large/008i3skNly1gz9msd404dj30uo0gq40b.jpg"  />

使用gdb命令dump内存，注意dump过程会挂起进程，所以我在另一台服务器上启动一个新的网关，把nginx代理到另一台服务器上
执行以下命令进行dump操作：

```shell
# 安装gdb
yum install -y gdb
# 连接程序
gdb -pid 5687
# mem.bin是内存dump出来的文件，后面是地址
dump memory mem.bin 0x7fbe514bf000 0x7fbf0166d000
# 将二进制文件读取成字符串并输出到文件，方便查阅
strings mem.bin > mem.log
```

从文件里就可以看到是哪个线程那个方法申请的内存了，但是由于我这里内存不够没法dump出来，所以我把网关放到了内存更大的服务器上，并且安装了gperftools：



使用gperftools并没有看出啥东西来，还是使用strace，打印一段时间后发现部分申请内存没有释放的线程，比如：
![](https://tva1.sinaimg.cn/large/008i3skNly1gze7phpm8rj318a0a4td9.jpg)
线程1860申请了16781312也就是16M的内存但是没有释放