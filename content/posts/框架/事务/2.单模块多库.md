---
title: 事务-2.XA事务
tags:
  - 事务
categories: 框架
copyright: true
---

一般项目刚上线不久，数据量稍微有点大的时候，但是还没到分库分表的数据量，会把不同的表放到不同的数据库中，但是这个时候@transactional注解垮裤不会生效了。这时候就要用到XA规范和2PC、3PC理论。

### XA规范

![](../images/XA事务.png)

TM和RM通信的规范就是XA，TM就相当于是引入的一个组件。

XA规范流程：connect -> closed，start -> end，prepare -> commit/rollback。

一般的TM用的都是Atomikos

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-jta-atomikos</artifactId>
</dependency>
```

### 2PC（Tow Phase Commit）

2PC是一套基于XA的理论，两阶段提交，第一个阶段TM发送prepare消息，让RM先把操作数据库的语句跑完，但是不提交，操作完后给TM结果，如果TM收到的结果全是成功就在告诉RM进行提交，如果有失败的或者超时的就会通知RM回滚。

#### 问题：

在第二阶段提交之前，资源会一直锁定，这样别人在对资源加独占锁的时候会同步阻塞住；

在第一阶段后单点的TM挂了，这时候资源就会被一直占用着；

在TM发送commit消息的时候，一台服务器挂了，TM也挂了，这时候在选举一个TM出来也不知道哪个消息commit成功了；

脑裂问题，所有主从都有脑裂问题；

### 3PC

第一阶段：TM发送CanCommit消息，各个库确认环境是否OK；

第二阶段：发送PreCommit消息，相当于2PC的第一阶段；

第三阶段：发送DoCommit消息，2PC的第二阶段；

每个库有一个超时机制，如果在PreCommit之后过一段时间没接收到DoCommit的消息，就会回滚，关键还有一个CanCommit阶段，因为能到PreCommit消息说明所有库都在CanCommit阶段返回成功了，那么这么长时间还没有DoCommit或者abort消息，应该就是TM挂了。

MySQL支持的是2PC协议。

### JTA事务

J2EE中的概念，单库的的事务是基于jdbc的，多库的事务是JTA事务，也是基于DTP那一套玩的。

### 全局事务

x/Open组织定义了一套分布式事务的模型和规范，叫做DTP，就是图中的TM、RM等等。全局事务就是DTP模型中的一个概念，图里也写到了。

