---
title: transactional
tags:
  - 事务
categories: 框架
copyright: true
---

在Spring中如果想使用注解声明的事务需要添加@EnableTransactionManagement注解，从这个注解进去是个ImportSelector类，然后进入ProxyTransactionManagementConfiguration，这是个全配置类，里面创建了一个Bean：TransactionInterceptor，他是AOP事务的增强逻辑。

被transactional修饰的方法会被spring生成一个动态代理对象，controller注入的bean也是被代理过的，代理对象的方法中调用方法之前会使用transactional.start()启动一个MySQL的事务，如果执行法法的过程中有报错就会调用MySQL的事务回滚，方法执行完之后会调用MySQL的事务提交。

被transactional修饰的类就是一个切面。spring的事务的核心逻辑都在spring-tx的jar包下。

调用@transactional修饰的方法之前先会走TransactionInterceptor（org.springframework.transaction.interceptor包下），这个类下的invoke()方法是事务控制的核心，这个方法中调用了invokeWithinTransaction()。这个方法是父类（TransactionAspectSupport）的方法，核心就是这行代码：

```java
// 这段代码实在动态代理的类执行时候进行拦截的
// 创建事务，在点进去看到是用PlatformTransactionManager开启事务，这是jpa里的代码
TransactionInfo txInfo = createTransactionIfNecessary(tm, txAttr, joinpointIdentification);
Object retVal = null;
try {
    // This is an around advice: Invoke the next interceptor in the chain.
    // This will normally result in a target object being invoked.
    // 执行代码逻辑
    retVal = invocation.proceedWithInvocation();
}
catch (Throwable ex) {
    // target invocation exception
    // 回滚事务，在抛出异常
    completeTransactionAfterThrowing(txInfo, ex);
    throw ex;
}
finally {
    cleanupTransactionInfo(txInfo);
}
// 提交事务
commitTransactionAfterReturning(txInfo);
```

代码很好找，一直往下跟就行，看到底层可以看到是基于hibernate来实现的。最后的找到的最最最底层的代码在AbstractLogicalConnectionImplementor（org.hibernate.resource.jdbc.internal）里：

```java
@Override
public void begin() {
    try {
        log.trace( "Preparing to begin transaction via JDBC Connection.setAutoCommit(false)" );
        // getConnectionForTransactionManagement应该就是获取一个连接了
        // 把自动提交设置为false：setAutoCommit( false )就是开始事务了
        getConnectionForTransactionManagement().setAutoCommit( false );
        status = TransactionStatus.ACTIVE;
        log.trace( "Transaction begun via JDBC Connection.setAutoCommit(false)" );
    }
    catch( SQLException e ) {
        throw new TransactionException( "JDBC begin transaction failed: ", e );
    }
}
// commit和rollback也在这个类里，就在下面
```

