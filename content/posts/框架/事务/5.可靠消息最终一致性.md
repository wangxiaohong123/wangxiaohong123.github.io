---
title: 事务-可靠消息最终一致性事务
tags:
  - 事务
categories: 框架
copyright: true
---

一些耗时的操作可以使用这个。

![](../images/可靠消息最终一致性流程.png)

步骤5.1失败了：

1.  可靠消息服务更新状态为已发送：一直会有一条状态时待确认的消息；
2.  可靠消息服务删除消息失败：一直会有一条状态是待确认的消息；

不管是那种情况操作失败了，都是比较尴尬的。

步骤7失败：可靠消息服务一直有一条状态是已发送的消息；

可以看出来出现尴尬问题的点都在可靠消息服务上。

解决步骤5.1失败：回调机制，可靠消息服务后台线程定时扫描超时的待确认消息，然后回调上游服务，上游服务返回这条消息对应的业务处理结果是成功还是失败，如果失败就删掉这条消息，如果是成功就执行步骤5.2。

解决步骤6、7失败：可靠消息服务后台线程定时扫描超时的已发送消息，重新投递到消息队列中，不过下游消息要做好幂等性。

一般做这种事务都不要太依赖mq，mq只是作为存储消息的中间件，这样mq的bug不会影响到我们系统，而且以后想换mq或者升级也不会受到影响。

这套方案的缺陷非常明显，可靠消息服务全部基于MySQL，扛不住高并发。数据量也很大，可以用redis或者zk来代替MySQL，定时清理数据。