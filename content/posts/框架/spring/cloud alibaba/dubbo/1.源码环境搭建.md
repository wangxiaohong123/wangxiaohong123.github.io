---
title: 1.dubbo-源码环境
tags:
  - 源码
categories: Dubbo
copyright: true
---

先在github上找到dubbo：https://github.com/apache/dubbo，然后把3.0的源码下载到本地。之前dubbo使用的最普及的是2.7，但是现在3.0用的也很多，而且3.0的源码变化有点大。

接着进入到下载的源码目录执行mvn安装：

```shell
mvn install -Dmaven.test.skip=true
# 为idea准备dubbo的工程目录
mvn idea:idea
```

然后用idea打开项目，然后我们就可以通过dubbo自带的demo：dubbo-demo作为入口，跟着功能进行断点，一点一点分析源码。dubbbo-demo下面有很多demo模块，是不同的使用方式，我只看dubbo-demo-api就可以，dubbo-demo-api下面又有两个模块，一个请求消费，一个请求发送。

因为dubbo-demo-api-consumer和dubbo-demo-api-provider都有两种模式，我使用经典模式，需要设置启动参数是classic：

```java
public static void main(String[] args) throws Exception {
    if (isClassic(args)) {
        startWithExport();
    } else {
        startWithBootstrap();
    }
}
// 参数中有classic就是经典模式
private static boolean isClassic(String[] args) {
    return args.length > 0 && "classic".equalsIgnoreCase(args[0]);
}
```

![](https://tva1.sinaimg.cn/large/008i3skNly1gvymyngwy3j311q0u0mzj.jpg)

最后在本地跑起来一个单机的zk，先启动dubbo-demo-api-provider，在启动dubbo-demo-api-consumer

### consumer启动的时候也会作为服务提供者，会报端口号冲突

简单看一下启动的代码，provider：

```java
private static void startWithExport() throws InterruptedException {
    // service是一个服务，每个服务对外暴露很多接口
    // DemoServiceImpl就是接口的具体实现
    ServiceConfig<DemoServiceImpl> service = new ServiceConfig<>();
    // 设置服务暴露出去的接口
    service.setInterface(DemoService.class);
    // 明确设置暴露接口的实现代码
    service.setRef(new DemoServiceImpl());
    // 服务名
    service.setApplication(new ApplicationConfig("dubbo-demo-api-provider"));
    // 注册中心zk的地址
    // 这样zk就是到每个服务有几个实例，每个实例的地址等
    service.setRegistry(new RegistryConfig("zookeeper://127.0.0.1:2181"));
    // 元数据上报的zk地址
    service.setMetadataReportConfig(new MetadataReportConfig("zookeeper://127.0.0.1:2181"));
    // 这个方法里可能就有网络监听的实现
    // 还有注册，添加zk监听等操作
    service.export();

    System.out.println("dubbo service started");
    // 夯住
    new CountDownLatch(1).await();
}
```

consumer：

```java
private static void runWithRefer() {
    // reference是要调用的实例
    // 为每个实例创建一个reference
    ReferenceConfig<DemoService> reference = new ReferenceConfig<>();
    // 配置和provider差不多
    reference.setApplication(new ApplicationConfig("dubbo-demo-api-consumer"));
    reference.setRegistry(new RegistryConfig("zookeeper://127.0.0.1:2181"));
    reference.setMetadataReportConfig(new MetadataReportConfig("zookeeper://127.0.0.1:2181"));
    reference.setInterface(DemoService.class);
    // 通过reference的get，拿到的可能是DemoService的动态代理
    // 调用代理的方法，就会实现和目标接口的建立连接、序列化、发送请求等等
    DemoService service = reference.get();
    String message = service.sayHello("dubbo");
    System.out.println(message);
}
```

看到这就可以确定这次源码需要看什么了，基础功能的就是provider、consumer启动和发送接收消息，还有怎么进行网络通讯，最后在看一些高阶功能。