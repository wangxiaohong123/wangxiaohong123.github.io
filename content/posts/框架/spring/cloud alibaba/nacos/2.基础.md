---
title: nacos-2.基础
tags:
  - nacos
categories: 框架
copyright: true
---

##### 一 概念

1.   命名空间：用来区分不同的开发环境，生产(prod)、预发布(staging)、联调测试(test)、开发自测(beta)、开发(dev) 分开，防止配置、服务错乱。
2.   分组：一个完整的大系统由很多服务组成，一般分组名称由系统名称命名。
3.   健康探测机制：dubbo服务注册到nacos时，如果ephemeral是true表示临时节点(默认)：
     *   临时节点：每个服务都会定时向nacos发送心跳，默认5s，如果15s没收到心跳就会把这个实例标记成不健康实例，30s没收到心跳会摘除这个服务实例。
     *   持久节点：nacos每20s主动探测实例是否可用，如果不可用标记成不健康状态，不会摘除实例。
4.   保护阈值：比如一个下游服务的实例中宕机了一半，这个时候剩下的一半也可能因为流量变大被打死，保护阈值的作用是健康实例的比例低于这个阈值就会让不健康的服务实例也参与被调用，可以防止服务雪崩，取值范围是0~1。触发保护阈值虽然可以保证可用性，但是会导致一致性问题，因为会有部分请求打到不可用的服务上，如果这个时候触发了熔断降级，拿到的数据就是不一致的。

##### 二 元数据

每个服务、集群、实例都有自己的元数据，格式就是key=value。默认服务、集群的元数据是空，实例的元数据：

```properties
# dubbo服务url元数据
dubbo.metadata-service.urls=[ "dubbo://172.30.60.105:20886/com.alibaba.cloud.dubbo.service.DubboMetadataService?anyhost=true&application=stars-report-service&bind.ip=172.30.60.105&bind.port=20886&deprecated=false&dubbo=2.0.2&dynamic=true&generic=false&group=stars-report-service&interface=com.alibaba.cloud.dubbo.service.DubboMetadataService&metadata-type=remote&methods=getAllServiceKeys,getServiceRestMetadata,getExportedURLs,getAllExportedURLs&pid=8518&qos.enable=false&release=2.7.8&revision=2.2.6.RELEASE&service.filter=customerExceptionFilter&side=provider&timestamp=1664088868313&version=1.0.0" ]

dubbo.metadata.revision=722115F0F6F280A931188D6CEB16F05C

dubbo.protocols.dubbo.port=20886

preserved.register.source=SPRING_CLOUD
```

##### 三 distro协议（ap，保证最终一致）

nacos集群需要维护服务实例的信息、状态等数据，但是服务实例找那个nacos节点发起注册？实例数据存储在哪个nacos节点上？服务发现的时候去找那个nacos节点？nacos自研的distro分布式一致性协议就是解决这3个问题的。

###### 1.注册流程

服务在启动的时候会随机拿到一个nacos实例的地址发起注册请求，nacos收到注册请求之后根据服务实例的ip+port计算这个服务应该由哪个nacos节点负责，然后转发给对应的nacos实例。目标nacos会把服务实例信息缓存到内存里，然后返回响应给转发的nacos节点，转发的nacos节点在把响应返回给服务实例。

###### 2.数据分片和订阅处理

按照注册的流程，每个nacos节点只会保存一部分服务实例的数据，这样的话会有两个问题，服务实例获取订阅节点信息怎么获取，怎么订阅；nacos节点宕机怎么办。

distro的实现是nacos节点会定时把自己的服务数据发送给其他节点，也会收到其他节点上的服务信息，**相当于是推模式的全量保存实现了最终一致性**。订阅时随机选择一个nacos节点，这里可能有个时间差：当服务刚注册的时候，其他nacos节点时没有这个服务的信息的，此时获取服务信息的请求会失败，然后添加一个监听，数据同步完之后会去回调监听。

###### 3.数据补偿

nacos各个节点之间会定期发送心跳，当发现自己保存的其他节点上的数据和发心跳这个节点的数据不一致，会全量同步一下，这样可以解决网络分区导致的长时间定时同步失败的情况。

##### 四 raft协议（弱cp，保证一致）

raft协议下要求nacos集群选举一个leader，只能leader写入，但是当节点写完之后需要全量同步所有服务信息到其他节点，当过半节点都成功了之后才会返回注册成功，这样会大大降低nacos的吞吐。弱cp就是因为过半而不是全量。

