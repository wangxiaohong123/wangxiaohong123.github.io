---
title: 2.zk安装
tags:
  - 框架
categories: zookeeper
copyright: ture
---

##### 集群搭建

下载压缩包，用的最多的应该就是3.4.5，解压然后配置zoo.cfg：

```properties
# zk里的最小时间单位，2000毫秒，2s，其他参数会以这个来设置
# 比如tickTime * 3
tickTime=2000
# 主要是放zk里的数据快照，停机重启之后可以恢复数据
dataDir=/Users/xiaohong/data/zookeeper/data
# 放一些日志数据，比如proposal，这个最好挂SSD，这样会提高写性能
dataLogDir=/Users/xiaohong/data/zookeeper/log
clientPort=2181
# leader启动后会等待follower跟自己建立连接，同步数据，这个就是等待时间
# 10的意思就是10 * tickTime就是20s
# 如果zk里存的数据比较大，follower同步数据需要的时间比较长，可以调大这个参数
initLimit=10
# leader跟follower的心跳超时
# 5 * tickTime就是10s
# 超过10s没收到心跳就认为follower死掉了
syncLimit=5
# 每执行多少个事务就把内存的数据创建一份磁盘快照，用默认的就可以
snapCount=100000
# 一台机器最多有多少个客户端连接，默认60
# 一台机器上不能无限制搞很多客户端，搞了也连不上
maxClientCnxns=60
# 一个znode最大存储的字节数，默认1兆
jute.maxbuffer=1048575
# 每1个小时执行一次数据清理
# 0就是不自动清理
autopurge.purgeInterval=1
# 每次清理保留3个日志文件和数据快照文件
autopurge.snapRetainCount=3
# 在2PC的第一个阶段是没有把proposal写到磁盘的，而是写到了os cache中，然后在commit的时候在去执行刷盘操作
# 如果设置成false就是不执行刷盘操作
forceSync=yes
# leader是否接收客户端的连接
leaderServers=yes
# leader选举的时候和3888端口建立连接的超时时间
cnxTimeout=5000
```

一般集群都是3台或者5台机器，集群比单机的多了一个参数：

```properties
# 3888是恢复模式的选举投票用的
# 2888是leader和follower通信用的
server.1=192.168.31.218:2888:3888
server.2=192.168.31.219:2888:3888
server.3=192.168.31.220:2888:3888
```

每个节点都需要有一个id，在你指定datadir里创建一个myid的文件，然后在里面写进去自己的编号，从1或者0开始都可以，上面的配置就是说编号1的节点在那台机器上，编号2的节点在那台机器上，编号3的节点在那台机器上。

1.   配置

     如果不用zk的分布式锁，平时的元数据管理什么的并发并不会太高，而且它本身有不支持写并发的线性扩展，但是考虑到他是底层的架构，可能整个公司都用这一套，一般最少就8c16g，单台机器抗几万的读QPS没啥问题。

2.   jvm参数

     jvm参数在zkServer.sh的脚本里，找到start参数对应的逻辑：

     ```shell
     start)
         echo  -n "Starting zookeeper ... "
         if [ -f $ZOOPIDFILE ]; then
           if kill -0 `cat $ZOOPIDFILE` > /dev/null 2>&1; then
              echo $command already running as process `cat $ZOOPIDFILE`. 
              exit 0
           fi
         fi
         # 参数加到下面
         nohup $JAVA "-Dzookeeper.log.dir=${ZOO_LOG_DIR}" "-Dzookeeper.root.logger=${ZOO_LOG4J_PROP}" \
         -cp "$CLASSPATH" $JVMFLAGS $ZOOMAIN "$ZOOCFG" > "$_ZOO_DAEMON_OUT" 2>&1 < /dev/null &
         ……
     ```

     如果是生产的话需要设置堆内存、占内存、元数据空间内存，垃圾回收器，gc日志、oom日志等等，在运行的前几天需要在高峰的时候jstat查看jvm的状态适当调优。

##### 一些命令

使用echo [命令] | nc localhost 2181查看zk的一些状态，比如查看配置：

```shell
echo conf | nc localhost 2181
```

相关的命令有conf（查看配置）、cons（查看连接）、crst（重置客户端统计）、dump（输出会话）、envi（查看环境）、ruok（检查是否在运行）、stat（查看运行时状态）、srst（重置服务器统计）、wchs（查看watcher信息）、wchc（输出watche详细信息）、wchp（输出watcher，以znode为单位分组）、mntr（输出比stat更详细的）。

##### 设置observer

增加配置：

```properties
peerType=observer
```

然后在所有机器的配置增加配置：

```properties
server.3=192.168.31.220:2888:3888:observer
```

和上面比多了一个observer标志，这样的其他节点就都知道他是observer了。

执行zkCli.sh直接就通过cli默认连接localhost:2181，一般都是运维的时候会用到。

创建一个节点：create

查看目录：ls

读取数据：get

更新数据：set

删除节点：delete