---
title: 2.集群搭建
date: 2021-08-06 06:27:35
tags:
  - 大数据
categories: kafka
copyright: true
---

首先安装3台虚拟机，需要密码登录。在/etc/hosts配置本机的hostname到ip地址的映射，然后配置yum：

```shell
yum clean all
yum makecache
yum install -y wget
```

因为集群内部需要通信，所以需要关闭防火墙或者设置开放端口：

```shell
systemctl stop firewalld.service
systemctl disable firewalld.service
```

安装jdk，把rpm包上传到虚拟机，安装：

```shell
rpm -ivh jdk-8u181-linux-x64.rpm
```

在~/ .bashrc中配置jdk的环境变量：

```shell
export JAVA_HOME=/usr/java/latest
export PATH=$PATH:$JAVA_HOME/bin
```

每台虚拟机的hosts文件配置其他两台机器的ip映射，类似这样：

```shell
172.24.5.218    cluster01
172.24.5.217    cluster03
```

设置虚拟机互相免密登陆

```shell
# 生成公钥，一直敲回车就行
ssh-keygen -t rsa
cd /root/.ssh
# 将公钥复制为authorized_keys文件
cp id_rsa.pub authorized_keys

# 复制当前虚拟机公钥到另外两台虚拟机上
ssh-copy-id -i cluster02
……
```

### zk安装

把压缩包传到虚拟机的/home/apps目录并解压，配置zk环境变量

```shell
vi /etc/profile

export ZOOKEEPER_HOME=/home/apps/zookeeper-3.4.9 
export PATH=$PATH:$ZOOKEEPER_HOME/bin

source /etc/profile
```

进入zk的conf目录，复制一份zoo_simple.cfg到zoo.cfg，配置以下信息：

```shell
tickTime=2000
initLimit=10
syncLimit=5

dataDir=/home/data/zkdata
dataLogDir=/home/log/zk

server.1=cluster01:2888:3888
server.2=cluster02:2888:3888
server.3=cluster03:2888:3888

clientPort=2181
```

创建**/home/data/zkdata**和**/home/log/zk**两个目录，进入/home/data/zkdata，输入**echo 1 > myid**。

启动：

```shell
# 启动
zkServer.sh start

# 停止
zkServer.sh stop

# 查看集群状态
zkServer.sh status
```

### kafka安装

上传压缩包解压，重命名，创建数据目录：

```shell
tar -zxvf kafka_2.11-1.1.0.tgz
mv kafka_2.11-1.1.0 kafka
mkdir /home/data/kafka
```

进入kafka的config目录，配置server.properties:

```shell
broker.id=0
# 下面还有一个监听是外网的配置
listeners=PLAINTEXT://cluster01:9092
num.network.threads=3
num.io.threads=8
log.dirs=/home/data/kafka
zookeeper.connect=cluster01:2181,cluster02:2181,cluster03:2181
zookeeper.connection.timeout.ms=6000
```

把配好的kafka文件夹拷贝到cluster02和03上去：

```shell
scp -r kafka/ cluster02:/home/apps
scp -r kafka/ cluster03:/home/apps
```

修改server.properties：

```shell
broker.id=1
listeners=PLAINTEXT://cluster02:9092
```

最后修改一下启动脚本：vim kafka-server-start.sh，因为我的虚拟机只有1G的内存，要把kafka的堆内存改成512M。

启动：

```shell
# JMX是对kafka进行监控的
JMX_PORT=9997 ./kafka-server-start.sh -daemon /home/apps/kafka/config/server.properties
```

停止：

```shell
./kafka-server-stop.sh
```

测试

```shell
# 创建1个test-topic，3个分区，两个副本
./kafka-topics.sh --zookeeper cluster01:2181,cluster02:2181,cluster03:2181 --create --topic test-topic --partitions 3 --replication-factor 2
# 查看topic
./kafka-topics.sh --zookeeper cluster01:2181,cluster02:2181,cluster03:2181 -list
# 查看topic具体信息
./kafka-topics.sh --zookeeper cluster01:2181,cluster02:2181,cluster03:2181 --describe --topic test-topic
		# broker0上的partition，leader在broker2上 副本在broker2和broker0上，ISR列表时broker2和broker0
		# Topic: test-topic       Partition: 0    Leader: 2       Replicas: 2,0   Isr: 2,0
        # Topic: test-topic       Partition: 1    Leader: 0       Replicas: 0,1   Isr: 0,1
        # Topic: test-topic       Partition: 2    Leader: 1       Replicas: 1,2   Isr: 1,2
# 启动broker
./kafka-console-producer.sh --broker-list cluster01:9092,cluster02:9092,cluster03:9092 --topic test-topic
# 启动consumer
./kafka-console-consumer.sh --bootstrap-server cluster01:9092,cluster02:9092,cluster03:9092 --topic test-topic

# 压测发送50w消息，每条消息200字节
./kafka-producer-perf-test.sh --topic test-topic --num-records 500000 --record-size 200 --throughput -1 --producer-props bootstrap.servers=cluster01:9092,cluster02:9092,cluster03:9092 acks=-1
# 压测接收消息
./kafka-consumer-perf-test.sh --broker-list cluster01:9092,cluster02:9092,cluster03:9092 --fetch-size 2000 --messages 500000 --topic test-topic
```

