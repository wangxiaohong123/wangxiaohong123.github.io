---
title: 15.kafka源码-常见问题
date: 2021-09-27 06:27:35
tags:
  - kafka
categories: 消息队列
copyright: ture
---

##### 消息丢失问题

###### broker写入消息丢失

如果leader里写入一条数据，此时还没同步到follower，然后leader崩溃了，这个时候重新选举出来的leader里的数据并不是最新的，也就是unclear leader election，要想解决这个问题就要保证所有insync状态的副本都写成功才能让consumer消费到，如果配置了`unclear.leader.election.enable=false`参数当所有follower都不是最新数据的时候这个topic就不允许写消息了，此时可以保证一致性，但是可用性会降低。

发生上面的topic不可用的问题就是没有同步成功的follower，所以当写如消息的时候要最少保证一个follower要同步成功才算是写成功，通过两个参数配合实现：

`min.insync.replicas=2`，保证一个leader和最少一个follower的数据是insync的，也就是同步的。
producer端设置acks=all，保证所有insync的副本写成功才算成功。
在配合`unclear.leader.election.enable=false`，这样broker写入就不会丢失了。

###### consumer端消息丢失

有时候consumer拿到一批数据后会交给线程池异步处理，然后consumer会自动提交偏移量，auto commit，这样不管消息消费成不成功broker都会认为他消费成功。

在consumer里添加`enable.auto.commit=false`的配置，关闭自动提交。使用consumer.commitSync()手动提交。

##### consumer重复消费问题

不管手动还是自动提交offset都会有重复消费的问题

如果设置成手动提交，当一部分消息还没来得及提交offset，此时又去拉取数据，这个时候就可能拉取到还没来得及提交offset的消息。

如果是自动提交，如果重启服务器或者服务器宕机，这个时候也会有消费完的数据还没来得及auto commit。

