---
title: nginx-2.配置
tags:
  - nginx
categories: 网络
copyright: true
---

### http语法

```nginx
http {
	### 定义日志格式
	log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';
                      
	# 打开传输压缩
	gzip on;
	# 小于多少字节的内容就不进行压缩
	gzip_min_length 1k;
	# 压缩级别，1-9，数字越大压缩的越好，也越占用CPU时间
	gzip_comp_level 1;
	# 进行压缩的文件类型。javascript有多种形式。其中的值可以在 mime.types 文件中找到。
	gzip_types text/plain application/javascript text/css application/xml text/javascript application/x-httpd-php image/bmp application/x-bmp image/x-ms-bmp application/vnd.ms-fontobject font/ttf font/opentype font/x-woff image/jpeg image/gif image/png;
    upstream local {
        server 127.0.0.1:9000;
    }
}
```

### server语法

```nginx
server {
	# 监听端口
	listen 80;
    server_name www.orderorigin.com orderorigin.com;
    rewrite ^(.*) https://www.orderorigin.com$1 permanent;
    
    # 日志地址，main就是上面配置的日志格式
    access_log  logs/access.log  main;

    # 代理静态页面
    location / {
        # alias不会把location的路径带下来
        alias       /data/server/website/pc/;
        # 使用autoindex模块，他会把这个目录下的文件放在页面上展示，共享静态资源
        autoindex	on;
        # 限制nginx向浏览器响应的速度
        set			$limit_rate 1m;
        index  index.html;
    }
    
    # 反向代理
    location ^~/app/ {
        # 代理路径，local就是上面配置的upstream
        proxy_pass http://local;
		proxy_read_timeout  1000;
        proxy_connect_timeout   1000;
        proxy_redirect  off;

        proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header    Host          $host;
        proxy_set_header    X-Real-IP     $remote_addr;
    }
}

# https
server{
    listen              443 ssl;
    server_name         59.110.156.68;
   
    # 设置长连接
    keepalive_timeout   70;

    # 启用三次握手缓存，在建立连接后的1440m内再次连接是不用握手的
    ssl_session_cache shared:le_nginx_SSL:5m;
    ssl_session_timeout: 1440m;
    
	# 证书文件
    ssl_certificate     4683730__orderorigin.com.pem;
    # 私钥文件
    ssl_certificate_key 4683730__orderorigin.com.key;

    ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;
    # 定义算法
    ssl_ciphers         HIGH:!aNULL:!MD5;

    ssl_prefer_server_ciphers  on;
 
    # 减少点击劫持
    add_header X-Frame-Options DENY;
    # 禁止服务器自动解析资源类型
    add_header X-Content-Type-Options nosniff;
    # 防XSS攻擊
    add_header X-Xss-Protection 1;

    error_log   /data/nginx/logs/orderorigin.com/error.log;
    access_log /data/nginx/logs/orderorigin.com/access.log main;
    location / {
        root       /data/server/website/pc/;
        index  index.html;
    }
    location /wap {
        alias       /data/server/website/wap/;
        index  index.html;
    }
    location /qy {
        alias       /data/server/website/icp_use/;
        index  index.html;
    }
    localtion /status {
        # 状态监控
    	stub_status;
    }
}
```

可以使用letsencrypt安装免费的证书。

***

nginx的进程结构：

nginx支持多进程，一个master和多个worker，真正处理业务的是worker进程，多进程是为了保证nginx的高可用和高性能。还有cache manager和cache loader进程，负责处理缓存，进程间通信通过共享内存实现。所以通常worker需要配置和CPU核数相同的数量，还需要将worker进程和CPU进行绑核。 