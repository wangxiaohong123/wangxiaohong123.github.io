---
title: 1.activiti-核心组件
tags:
  - activiti
categories: activiti
copyright: true
---

### 1.核心类

##### 1.1 Deployment

添加资源文件，获取部署信息、部署时间。

通过Deployment类部署流程：

```java
@Resource
private RepositoryService repositoryService;

public void initDeployment() {
    // 部署流程，其实就是持久化流程图到数据库
    Deployment deployment = repositoryService.createDeployment()
        .addClassPathResource("bpmn文件路径")
        .name("流程部署")
        .deploy();
    
    // 查询所有流程
    List<Deployment> allDeployment = repositoryService.createDeploymentQuery().list();
    // 删除流程，true表示删除该流程的历史之类的
    repositoryService.deleteDeployment("deploymentId", true);
}
```

###### 1.2 ProcessDefinition

他和Deployment类都是记录资源信息，ProcessDefinition记录版本号、资源名称、部署id(用来关联Deployment表)。

通过ProcessDefinition获取流程信息：

```java
@Resource
private RepositoryService repositoryService;

public void getDefinitions() {
    List<ProcessDefinition> list = repositoryService.createProcessDefinitionQurey().list();
    for (ProcessDefinition pd : list) {
        log.info("名称：", pd.getName());
        log.info("key：", pd.getKey());
        log.info("资源名：", pd.getResourceName());
        log.info("Deployment主键：", pd.getDeploymentId());
        log.info("版本：", pd.getVersion());
    }
}
```

##### 1.3 ProcessInstnce

他是对流程的具体实现。

```java
@Resource
private RuntimeService runtimeService;

/**
 * 	初始化流程实例
 */
public void initProcessInstnce() {
    // 1.获取页面表单内容，比如请假时间、请假原因
    // 2.将表单内容入库
    // 第一个参数是ProcessDefinition的key
    // 第二个参数是第二步得到的业务主键，这样的业务和流程实例才能关联起来
    ProcessInstnce processInstnce = runtimeService.startProcessInstnceByKey("key", "bKey");
}

/**
 * 	获取流程实例
 */
public void initProcessInstnce() {
    List<ProcessInstnce> list = runtimeService.createProcessInstnceQuery().list();
}

/**
 * 	暂停/激活流程实例
 */
public void activateProcessInstnce() {
    // 挂起实例
    runtimeService.suspendProcessInstnceById("ProcessInstnceId");
    // 激活实例
    runtimeService.activateProcessInstnceById("ProcessInstnceId");
}

/**
 * 	删除流程实例
 */
public void initProcessInstnce() {
    runtimeService.deleteProcessInstnce("ProcessInstnceId", "删除原因");
}
```

##### 1.4 Task类

任务里最重要的就是用户任务，用户任务有4个常用属性：

*   Assignee：执行人；
*   Candidate Users：候选人
*   Candidate Groups：候选组
*   Due Date：任务到期时间，用来触发边缘事件的，比如超过3天没审批就自动到其他部门

```java
@Resource
private TaskService taskService;

public void getTasks() {
    // 获取所有任务
    List<Task> list = taskService.createTaskQuery().list();
    // 查询用户的任务
    List<Task> list = taskService.createTaskQuery().taskAssignee("userId").list();
    // 完成任务
    taskService.cpmpleteTask("taskId");
    
    // 拾取任务
    taskService.claim("taskId", "userId");
    // 归还任务,第二个参数也是用户id，不传空就是指定任务的执行人
    taskService.setAssignee("taskId", null);
}
```

##### 1.5 History

```java
@Resource
private HistoryService historyService;

// 查询用户历史
historyService.createHistoricTaskInstanceQuery()
    .taskAssignee("userId")
    // 执行排序规则
    .orderByHistoricTaskInstanceEndTime().desc()
    .list();

// 查询实例全部历史
historyService.createHistoricTaskInstanceQuery()
    .processInstanceId("userId")
    // 执行排序规则
    .orderByHistoricTaskInstanceEndTime().acs()
    .list();
```

### 2.UEL表达式

activiti中的UEL以'\$\{'开头，'}'结尾，支持逻辑运算符，比如'=='。

使用UEL动态指定执行人：

```java
// 创建BPMN流成文件的时候不指定执行人，而是使用${user}
// 启动实例的时候传入实例启动参数：
Map<String, Object> variables = new HashMap<>();
// 如果有多个候选人就使用逗号拼接:variables.put("user", "真实的userId1,真实的userId2");
// 指定多个候选人需要拾取任务
variables.put("user", "真实的userId");
// 这样就会把bpmn文件中的${user}替换为真实的userId
runtimeService.startProcessInstnceByKey("key", "bKey", variables);
```

**在启动实例、完成任务中都可以带参数，并且参数可以是业务类的实体，但是实体中的对象名不能有大写字母**

### 3.网关

*   并行网关(加号)：把任务拆分成多路，最后在合并成1路，用在需要多人审核时；
*   排他网关(乘号)：执行到网关进行条件判断，如果满足多个条件，只执行第一个条件；
*   包容网关(圆圈)：能添加条件的并行网关；
*   事件网关(五边形)：处理事件，并且事件必须>=2个；
