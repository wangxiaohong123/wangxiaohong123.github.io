---
title: 持久化
tags:
  - redis
categories: 数据库
copyright: true
---

### RDB和AOF的区别

rdb是每达到一定条件就生成一个新的文件快照，快照内容是redis中当前内容的全量数据，文件名是dump.rdb，配置文件中的属性如下：

```shell
save 900 1
save 300 10
save 60 10000
```

意思是达到60s并且数据变化超过10000条或者300s数据变化超过10条或者900s数据变化超过1条就生成一个新的dump.rdb文件，生成完成后覆盖老的快照文件。

aof存储的向redis中写入数据的指令，以append-only的模式追加，默认关闭，aof备份文件名是appendonly.aof，redis先将指令写入os cache中，然后根据配置将os cache中的指令写入aof文件，当aof文件很大时会执行rewrite操作，此时会新生成一个新的aof文件，基于当前redis中的数据向新aof文件中写入指令，如果redis中数据发生变化，会追加到老aof文件中，当新aof文件追加结束再把新增的指令追加到新aof中，追加结束后删除老aof文件，aof相关配置如下：

```shell
# 是否开启aof
appendonly no
# aof备份名称
appendfilename "appendonly.aof"

# aof备份模式

# 每次redis中写入数据就同步写入到磁盘
# appendfsync always
# 每秒执行一次写入
appendfsync everysec
# 将写入指令放到os cache中不管，由操作系统控制
# appendfsync no

#rewirte条件，当下面两个条件都满足时进行rewrite操作
# aof文件大小超过上次rewrite之后大小的100%
auto-aof-rewrite-percentage 100
# aof文件最小64m
auto-aof-rewrite-min-size 64mb
```

### RDB优缺点

* rdb中数据可能不是最全的，但是恢复是最快的，因为存储的是数据，直接放到redis中就可以了；
* 如果redis中数据很多每次生成快照文件时可能导致redis服务暂停一段时间，类似jvm的stop the world；
* 很适合配合脚本做冷备份，比如传到oss上容灾；

### AOF优缺点

* 最多只有1s的数据丢失；
* 每次都要写入os cache，但比写磁盘快很多；
* 回复数据慢；

### 使用

* 一般都是同时开启RDB和AOF，这样，aof可以保证数据不丢，aof损坏时可以使用rdb的冷备快速恢复，防止雪崩；

* 如果redis在append数据到AOF文件时，机器宕机了，可能会导致AOF文件破损，可以使用redis-check-aof --fix命令来修复破损的AOF文件；

* 如果RDB在生成快照文件，那么redis不会执行AOF rewrite; 如果redis再执行AOF rewrite，那么就不会生成快照文件；

* redis重启的时候，会优先使用AOF进行数据恢复，所以在aof文件损坏时，需要关闭aof配置，再启动redis，在使用rdb恢复数据后，因为没有开启aof，所以需要进入redis-cli执行`config set appendonly yes`命令行热开启aof，在aof数据同步后进入配置文件开启aof，然后重启redis；