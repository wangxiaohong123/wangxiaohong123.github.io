---
title: MySQL-2.压测
tags:
  - MySQL
categories: 数据库
copyright: true
---

### sysbench

执行以下命令安装sysbench：

```shell
curl -s https://packagecloud.io/install/repositories/akopytov/sysbench/script.rpm.sh | sudo bash
sudo yum install -y sysbench
# 查看版本
sysbench --version
```

可以创建测试用户和测试库，我只创建个测试库，5.6创建用户烦得很。

构建测试表和测试数据

```shell
sysbench --db-driver=mysql --time=300 --threads=10 --report-interval=1 --mysql-host=192.168.0.6 --mysql-port=3306 --mysql-user=root --mysql-password=root --mysql-db=test_db --tables=20 --table_size=100000 oltp_read_write --db-ps-mode=disable prepare

####################参数说明####################

--db-driver=mysql									基于mysql驱动链接mysql
--time=300											连续访问300秒
--threads=10										10个线程
--report-interval=1									每隔1秒输出一下压测情况
--mysql-host=192.168.0.6 --mysql-port=3306 --mysql-user=root --mysql-password=root 数据库连接参数
--mysql-db=test_db --tables=20 --table_size=100000	在test_db中创建20张表，每个表10万条数据
oltp_read_write										执行oltp数据库的读写测试，除了读写还有很多，比如删除、只读、只写、索引等等
--db-ps-mode=disable 								禁止ps模式
prepare												准备，还有run运行、cleanup清除测试数据
在run之前先prepare，run之后cleanup
```

分析结果

```shell
[ 303s ] thds: 10 tps: 0.00 qps: 42.97 (r/w/o: 10.99/31.98/0.00) lat (ms,95%): 0.00 err/s: 0.00 reconn/s: 0.00

thds: 10					10个线程并发
tps: 0.00					每秒执行0个事务
qps: 42.97					每秒执行了42.97个请求
(r/w/o: 10.99/31.98/0.00)	42.97个请求中，10.99个读，31.98个写，没有其他请求
lat (ms,95%): 0.00			95%的请求在0毫秒内 ？？？？？？？？？
err/s: 0.00					这秒内没有错误
reconn/s: 0.00				没有重连

#下面会生成一个报告
queries performed:
    read:	10780 # 执行了10780次读请求
    write:	3080 # 3080次写
    other:	1540 # 1540次其他请求
    total:	15400 # 一共15400次
    transactions:	770    (2.54 per sec.) # 一共执行了770个事务，每秒2.54个
    queries:		15400  (50.80 per sec.) # 一共执行了15400次查询
    ignored errors:	0      (0.00 per sec.) # 没有错误
    reconnects:		0      (0.00 per sec.) # 没有重连

General statistics:
    total time:		303.1352s # 一共执行了303.1352秒
    total number of events:	770 # 一共执行了770个事务

Latency (ms):
    min:					305.91 # 延迟最小的是305.91毫秒
    avg:					3933.24 # 平均3933.24毫秒，3秒多。。
    max:					15032.05 # 延迟最高的15032.05毫秒，15秒哈哈哈哈哈
    95th percentile:		8638.96 # 95%的请求在8秒多内完成
    sum: 					3028591.26 # 一共花了3028591.26毫秒
```

在压测的时候使用top查看CPU和内存信息

```shell
top

# CPU情况
top - 22:50:50 up  1:38,  5 users,  load average: 2.11, 3.22, 3.08
22:50:50	当前时间
up  1:38	机器运行时间
5 users		5个用户在使用（应该是2啊，有点扯了）
load average: 2.11, 3.22, 3.08	CPU在1分钟、5分钟、15分钟的负载，因为我是1核虚拟机，所以这个负载超过1就说明是满符负荷了，很多进程在排队等待执行

# 内存情况
KiB Mem :  1014972 total,    75036 free,   402896 used,   537040 buff/cache
1014972 total	一共1G
75036 free		多少剩余
402896 used		多少使用
537040 buff/cache	多少内存在OS内核的缓冲区
```

使用dstat查看磁盘和网卡信息，我没安命令

```shell
# 查看存储IO吞吐量
dstat -d

-dsk/total-
read write
3k    2k		# 每秒读3k，写2k
0     1k

# 查看随机读写次数
dstat -r

--io/total-
read write
0.25  31.9		# 每秒随机读写次数，一两百次都可以接受
0     253

# 查看网卡流量
dstat -n

-net/total-
recv send
1k    2k
```

