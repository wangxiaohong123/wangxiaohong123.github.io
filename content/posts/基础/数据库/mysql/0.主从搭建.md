---
title: MySQL-0.主从搭建
tags:
  - MySQL
categories: 数据库
copyright: true
---

安装mysql5.7：<https://www.cnblogs.com/hsbt2333/p/9915616.html>

首先在主库上创建一个用于主从复制的账号：

```mysql
create user 'backup_user'@'%' identified by 'qiyuan1502';
grant replication slave on *.* to 'backup_user'@'%';
flush privileges;
```

如果是新增从库需要让系统停机，对外不可用，然后全量备份一下主库：

```shell
# 先把主从库的的binlog打开，修改my.cnf，在mysqld下添加，一定要在这个下面，两个库的server-id=1不能一样
log-bin=mysql-bin
server-id=1
# --master-data=2是记录binlog和position，主从需要
/usr/local/mysql/bin/mysqldump --single-transaction -uroot -proot --master-data=2 -A > /usr/local/mysql/backup.sql
```

然后在新的从库上执行sql文件。

从库上执行命令绑定主库

```mysql
# MASTER_LOG_FILE和MASTER_LOG_POS在backup.sql中获取
CHANGE MASTER TO MASTER_HOST='59.110.156.68',MASTER_USER='backup_user',MASTER_PASSWORD='qiyuan1502',MASTER_LOG_FILE='mysql-bin.000001',MASTER_LOG_POS=154;

# 开始主从
start slave;
# 查看主从状态，看到slave io running和slave copy tunning就可以了
show slave status;
```

5.7默认是半同步方式。

```shell
# 在主库上运行：
show global status like '%semi%';
# 如果看到了Rpl_semi_sync_master_status的状态是ON，那么就是半同步

# 设置半同步，主从库都安装
install plugin rpl_semi_sync_master soname 'semisync_master.so';
set global rpl_semi_sync_master_enabled=on;
show plugins;
# 然后重启从库io线程
stop slave io_thread;
start slave io_thread;
```

要保证自动选举的功能需要搭建个MHA工具。

