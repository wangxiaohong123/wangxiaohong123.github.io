---
title: 1.概念
tags:
  - elasticsearch
categories: 数据库
copyright: true
---

#### 什么是搜索

当我们在百度里搜索关键词的时候就是一个搜索的过程，但是搜索不光是百度，还有一些垂直搜索（站内搜索）比如淘宝里搜一下商品关键字，比如OA系统搜个打卡统计之类的。简单来说就是在任何场景下输入关键字会返回一些想要的信息。

#### 倒排索引

就是把数据拆成词，每个词对应着一条数据的id之类的东西。
比如有3条数据：1 生化危机电影，2 生化危机海报， 3 生化危机新闻，这3条数据生成的倒排索引就类似下面这样：

| 关键词   | ids   |
| -------- | ----- |
| 生化     | 1,2,3 |
| 危机     | 1,2,3 |
| 生化危机 | 1,2,3 |
| 海报     | 2     |
| 新闻     | 3     |
| 电影     | 1     |

如果不考虑搜索优化，假设我们使用es或者lucene进行所有的时候，倒排索引的结构也要比MySQL全表扫描的模糊查询要快很多，因为这里相当于对关键词进行equals比较，而模糊搜索要检查是否包含。

#### 全文检索

全文检索包括把数据插入倒排索引，然后把搜索条件拆词，每个词都去倒排索引中查找数据。 

#### Lucene

就是一个jar包，里面封装好了很多建立倒排索引和全文检索的算法。用lucene可以把现有的数据在磁盘上建立索引，并且Lucene会帮我们组织索引的数据结构，还可用Lucene提供的api对磁盘上的索引数据进行搜索。

#### elasticsearch

Lucene可以实现全文检索功能，但是他有很大的弊端：比如它不支持分布式，api有点复杂。
当我们的数据量在一台机器上放不下的时候，每次查询需要我们自己去各个Lucene机器上搜索，插入数据时也要自己维护索引所在机器，当某一台机器宕机，那这台机器上的数据就全搜不出来了。

所以分布式的搜索引擎elasticsearch就诞生了，对比Lucene而言，他自动冗余数据备份，更高可用，分布式存储更多的数据，自动维护数据到多个节点的索引，还封装了更多高级的功能。

### ES功能

*   数据分析：比如查看最近七天的牙膏的销量前十的商家，每个商品分类下有多少商品。
*   数据搜索：全文检索和结构化检索，结构化检索就是根据类型，比如搜索日用品类型的商品。
*   搜索推荐、自动补全这些。

他是一个分布式的海量数据的近实时搜索引擎。

### 核心概念

1.  Near Realtime（NRT），近实时，有两个意思，第1个是从写入到可查询到是秒级的延迟，第2个是搜索和分析也是秒级的延迟。
2.  Cluster和Node，集群和节点，集群和节点都可以设置名字的，集群的默认名字是elasticsearch，节点的默认名字随机分配，如果节点没有配置集群的名字就会默认加入到elasticsearch集群中。
3.  Document：es里的最小数据单元，就是一条数据。
4.  field：document中的数据字段。
5.  Index：索引，一个index包含很多document，index中是所有类似或者相同的document。
6.  type：index中的document的逻辑分类，比如说index中有10000个document，1到3000个document的field一样，3001到6000的filed一样，6001到10000的id一样，那么就可以定义index中有三个type，type更像是MySQL中的一样表，而index像是一类数据库，新版本中废弃了，因为在es中存储是不区分type的。
7.  shard：一个index可以包含多个shard，这些shared会散落在多台服务器上，这样搜索可以在多个服务器上并行执行，提升吞吐量。扩容时新创建一个更多的shard的index，把数据重新导入进去就可以了，他也叫primary shard，可以接受读写请求。
8.  replica：就是shard的副本，也叫replica shard，每个shard可以有多个replica。replica也可以提供读的请求。

默认情况下每个index有5个shard，每个shard有一个replic，es规定了shard和replica不能在同一节点上，也就是说要部署在两台机器上。使用replica的第一个好处就是分摊查询的压力，提高吞吐，第2个好处就是保证高可用，shard宕机时进行切换。

es是面向文档的数据格式。

### 锁

es有三个粒度的锁，全局锁（加在索引上）；document锁；读写锁（共享锁和排它锁）；