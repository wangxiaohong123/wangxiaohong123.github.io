---
title: 10.es-数据导入
tags:
  - elasticsearch
categories: 数据库
copyright: true
---

新建索引：

```json
PUT /stars_web_search_user_conditions_1
{
  "settings": {
    "number_of_shards": 1,
    "number_of_replicas": 0,
    // 索引刷盘间隔，默认1s，导入数据要求不高，先设置120s
    "index.refresh_interval":"120s",
    // 是否同步到replica和同步提交translog
    // 如果是request(默认)同步复制到replica和同步刷盘
    // 如果是async则每次在index.translog.sync_interval的时候同步和刷盘
    "index.translog.durability":"async",
    // translog的刷盘间隔
    "index.translog.sync_interval":"120s",
    // 刷盘的translog大小，这个和index.translog.sync_interval满足一个条件时就会刷盘(默认512mb)
    "index.translog.flush_threshold_size":"2048mb"
  },
  "mappings": {
    "_source": {"enabled": false},
    "properties": {
      "_all": {"enabled": false},
      "userId": {
        "type": "long"
      },
      "nickname": {
        "type": "text",
        "analyzer": "ik_max_word",
        "search_analyzer": "ik_smart"
      },
      "mobile": {
        "type": "text",
        "analyzer": "whitespace"
      },
      "gender": {
        "type": "keyword"
      },
      "idealGender": {
        "type": "keyword"
      },
      "registrationTime": {
        "type": "long"
      },
      "lastImChangeTime": {
        "type": "long"
      },
      "pornLevel": {
        "type": "keyword"
      },
      "sendAndReceiveExploreMsgNum": {
        "type": "integer"
      },
      "momentsNum": {
        "type": "integer"
      },
      "lastLoginPlatform": {
        "type": "keyword"
      },
      "vipStatus": {
        "type": "keyword"
      },
      "adChannel": {
        "type": "keyword"
      },
      "downloadChannel": {
        "type": "keyword"
      },
      "adId": {
        "type": "keyword"
      },
      "frozen": {
        "type": "boolean"
      }
    }
  }
}
```

查看设置是否生效：

```http
GET /stars_web_search_user_conditions_1/_settings
```

导入数据结束后把设置还原：

```json
PUT /stars_web_search_user_conditions_1/_settings
{
  "settings": {
    "number_of_replicas": 1,
    "index.refresh_interval":"1s",
    "index.translog.durability":"request",
    "index.translog.sync_interval":"5s",
    "index.translog.flush_threshold_size":"512mb"
  }
}
```

然后修改别名指向：

```json
POST /_aliases
{
  "actions": [
    {
      "remove": {
        "index": "stars_web_search_user_conditions1",
        "alias": "stars_web_search_user_conditions"
      }
    },
    {  "add": {
        "index": "stars_web_search_user_conditions_1",
        "alias": "stars_web_search_user_conditions"
      }
    }
  ]
}
```

确认功能没有问题后删除旧索引：

```http
DELETE /stars_web_search_user_conditions1
```

数据导入如果因为磁盘不够出现cluster_block_exception，可以扩容或者关闭只读：

```json
PUT _settings
{
    "index": {
        "blocks": {
            "read_only_allow_delete": "false"
        }
    }
}
```

