---
title: 建模
tags:
  - elasticsearch
categories: 数据库
copyright: true
---

建模有普通建模，就是逻辑外键、冗余建模，一对多的关系放在一个document下，父子关系建模（要求父子在一个shard中）。

#### 父子关系建模

```json
PUT /company
{
  "mappings": {
    "rd_center": {}, // 研发中心type
    "employee": { // 员工type
      "_parent": { // 指定parent是研发中心
        "type": "rd_center" 
      }
    }
  }
}

// 添加员工时指定parent就OK，指定了parent之后会使用parentid路由，这样就会保证父子数据在同一shard中
PUT /company/employee/1?parent=1 
{
  "name":  "张三",
  "birthday":   "1970-10-24",
  "hobby": "爬山"
}
```

#### 父子关系查询

##### 根据child查询parent

```json
// 查询有员工在1980-01-01以后出生的研发中心
GET /company/rd_center/_search
{
  "query": {
    "has_child": {
      "type": "employee",
      "query": {
        "range": {
          "birthday": {
            "gte": "1980-01-01"
          }
        }
      }
    }
  }
}
// 查询至少有两个员工的研发中心
GET /company/rd_center/_search
{
  "query": {
    "has_child": {
      "type": "employee",
      "min_children": 2,
      "query": {
        "match_all": {}
      }
    }
  }
}
```

##### 根据parent查询child

```json
// 查询研发中心在中国的员工信息
GET /company/employee/_search
{
  "query": {
    "has_parent": {
      "parent_type": "rd_center",
      "query": {
        "term": {
          "country.keyword": "中国"
        }
      }
    }
  }
}
```

##### 聚合统计

```json
// 统计每个国家的员工爱好，及爱好人数
GET /company/rd_center/_search
{
  "size": 0, 
  "aggs": {
    "group_by_country": {
      "terms": {
        "field": "country.keyword"
      },
      "aggs": {
        "group_by_children_employee": {
          "children": {
            "type": "employee"
          },
          "aggs": {
            "group_by_hobby": {
              "terms": {
                "field": "hobby.keyword"
              }
            }
          }
        }
      }
    }
  }
}
```

如果是三代，在添加数据的时候只指定parent，那么就不能保证祖孙三代都路由到同一shard上，需要使用routing，指定祖先id。