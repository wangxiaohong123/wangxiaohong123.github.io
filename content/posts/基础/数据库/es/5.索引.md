---
title: 5.索引
tags:
  - elasticsearch
categories: 数据库
copyright: true
---

##### mapping

有的时候查询的结果和我们想的不一样，可能会多查或者少查，这是因为添加document的时候es会自动帮我们创建type对应的mapping(dynamic mapping)，mapping中有分词规则、field类型等等，使用**GET /{index}/_mapping/**查看index下的type对应的mapping。

###### 1.核心的数据类型

*   keyword、text
*   byte、short、integer、long
*   float、double
*   date
*   boolean
*   multivalue：类似数组，要求元素类型必须相同
*   empty：null,[],[null]这种
*   object：jsonObject

text、multivalue field会触发分词操作，可以指定分词器或者设置不分词，在旧版本中设置index: not\_analyzer表示不分词，新版本中只需要把type设置成keyword就表示不分词。
手动建立mapping，不能修改已存在的field的mapping，下面的语句是创建index时指定mapping：

```http
PUT /website
{
  "settings" : {
    // 1个primary shard
    "number_of_shards": 1,
    // 每个primary shard有0个replica shard
    "number_of_replicas": 0
  },
  "mappings": {
    "properties": {
      "content": {
        "type": "text",
        "analyzer": "english" // 指定特殊语言分词
      },
      "post_date": {
        "type": "date"
      },
      "title": {
        "type": "text"
      },
      "publisher_id": {
        "type": "keyword", // 不分词的的field
        "index": false // false表示这个字段不能被当作搜索条件
      }
    }
  }
}
```

如果想要新增field的mapping执行`PUT /{index}/_mapping`命令：

```http
PUT /website/_mapping
{
  "properties": {
    "tags": {
      "type": "text"
    }
  }
}
```

###### 2.root object

root object就是index对应的mapping json，里面包含properties、metadata(\_id、\_source)、settings。

properties里包含字段信息比如type是字段类型，index是要不要分词，analyzer是分词器。

\_scource就是原始的数据对象，如果不想保存原始对象：

```json
PUT /{index}
{
    "mappings": {
        "_source": {"enabled": false}
    }
}
```

\_all就是前面说得所有字段拼在一起的字段，关掉\_all：

```json
PUT /{index}/_mapping
{
    "_all": {"enabled": false}
}
```

##### 重建索引

首先需要把索引创建别名：

```http
PUT /{index}/_alias/{index别名}
```

在java程序中的操作都是使用别名，然后新建一个索引，通过scroll或者search_after查询一批数据，使用bulk批量写入新索引，重复这个步骤直到数据完全同步，再将别名指向新的索引(删除旧索引的别名，添加新索引的别名)：

```http
POST /_aliases
{
  "actions": [
    {
      "remove": {
        "index": "旧索引",
        "alias": "别名"
      }
    },
    {  "add": {
        "index": "新索引",
        "alias": "别名"
      }
    }
  ]
}
```

