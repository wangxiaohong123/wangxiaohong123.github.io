---
title: filter
tags:
  - elasticsearch
categories: 数据库
copyright: true
---

**查看分词**

```json
// 查看forum索引下的field为articleID内容是XHDK-A-1293-#fJ3的分词
GET /forum/_analyze
{
  "field": "articleID",
  "text": "XHDK-A-1293-#fJ3"
}
```

5版本以后如果field的类型是text，会多建一个field，原field是分词的，es创建的field.keyword是不分词的，类型是keyword，默认保存256个字符。

**term语法**：

```json
GET /forum/article/_search
{
  "query": {
    "constant_score": { // 使用filter需要把匹配度分数设置成1，必须要写constant_score
      "filter": {
        "term": { // term搜索，不会对term中的条件进行分词
          "articleID" : "XHDK-A-1293-#fJ3"
        }
      }
    }
  }
}
// 如果条件的field是分词的，那么这个查询时查不出结果的，可以使用es自动创建的部分词field查询
{
  "query": {
    "constant_score": {
      "filter": {
        "term": {
          "articleID.keyword" : "XHDK-A-1293-#fJ3"
        }
      }
    }
  }
}
// term还可以写成terms，相当于SQL的in，类似于这样："term": {"articleID" : ["a","b","c"]}
```

**filter执行原理**

filter在query之前执行。首先把拆分的词分别去倒排索引中查找，得到一堆bitset，每个词对应一个，bit数组中存放的是document中是否包含这个词，不包含就是0，然后再获取1最少的bit数组，去别的数组中找到都是1的doc，然后就可以把筛选出来的document返回给客户端了，es在返回之后还会把bit数组放在缓存中，如果在最近的256次查询中，某个条件的查询超过一定次数，并且segment大于index数据量的3%，就会把bit数组缓存，而且在document发生改变的时候，bit数组也会跟着变。

**filter复杂查询例子**

```json
// bool中可以包含should、must、must_not、filter

// 查询发帖日期为2017-01-01，或者帖子ID为XHDK-A-1293-#fJ3的帖子，同时要求帖子的发帖日期绝对不为2017-01-02
GET /forum/article/_search
{
  "query": {
    "constant_score": {
      "filter": {
        "bool": {
          "should": [{
            "term": {
              "postDate": "2017-01-01"
            }
          },
          {
            "term": {
              "articleID": "XHDK-A-1293-#fJ3"
            }
          }],
          "must_not": {
            "term": {
              "postDate": "2017-01-02"
            }
          }
        }
      }
    }
  }
}

// filter和range
// 查询view_cnt在30到60之间的document
GET /forum/article/_search
{
  "query": {
    "constant_score": {
      "filter": {
        "range": {
          "view_cnt": {
            "gte": 30,
            "lte": 60
          }
        }
      }
    }
  }
}
// 获取四年前到今天发过的帖子
GET /forum/article/_search
{
  "query": {
    "constant_score": {
      "filter": {
        "range": {
          "postDate": {
            "gt": "now-1y" // 还可以写成"gt": "2020-08-10||-1y"
          }
        }
      }
    }
  }
}
```

