---
title: 参数
tags:
  - elasticsearch
categories: 数据库
copyright: true
---



如果是单台机器上启动多个es，他们会把自己绑定在127.0.0.1（回环地址）上，然后去扫描9300~9305端口，自己就可以维护集群了，生产环境不能这么玩，要想和其他服务器的几点通信需要绑定在非回环地址上，es是peer2peer的分布式系统架构，master负责维护集群信息和其他元数据，把变更的信息推送到其他node（data node）。

```yml
# 集群名称，node的这个属性一样才是集群的基本条件，线上一定要修改，否则其他测试node可能会不小心加入这个集群
cluster.name: elasticsearch-prod
# 节点名称
node.name: node-elasticsearch-01
# 绑定地址，多机器一定要配这个
network.host: 192.168.0.10
# 这个配置的是master eligible node，在master宕机的时候从eligible node中选出来一个master，默认就是true
node.master: true
# 这个是是不是存储数据的节点，如果集群很大的时候可以设置3个节点为专门的eligible node，不存存储数据，这个就设成false
node.data: true
# unicast的中间节点host列表，其他node会和这几个节点通信然后加入集群，一般写三个就够了，有eligible node优先把eligible node写进去
discovery.zen.ping.unicast.hosts: ["host1", "host2"]
# ping的超时时间，可以防止网络问题导致的master选举过慢
discovery.zen.ping_timeout: 3s
# 选举之后其他data节点发送一个join加入集群，配置超时时间，超时会重试
discovery.zen.join_timeout: 60s
# 强制区分候选节点，避免node.master: false的节点发来请求参与master选举
discovery.zen.master_election.ignore_non_master_pings: true

# 这些路径不嫩放在es目录下，方便以后升级
# 存放日志文件
path.logs: /var/log/elasticsearch
# 存放数据文件
path.data: /var/data/elasticsearch

# 选举的时候最少要求多少候选节点通过，设置为候选节点的quorum（num / 2 + 1）数量
# 三个节点的集群quorum就是2，如果只有两个节点，quorum还是2，有一台机器宕机的时候就不能完成选举
# 如果两个节点，参数设置成1，那么就会随便发生脑裂，因为一个机器一下就把自己变成master了
discovery.zen.minimum_master_nodes: 2

# shard recover操作：当有一些几点无法启动或者还没启动的时候，es检测到已经启动的节点上的shard不正常，比如没有primary，
# 就会复制出primary shard，当剩下节点启动之后，发现自己的shard过期就会把shard删除，
# 集群发现shard分配不均匀，因为有些机器上一个shard没有，这时候又会把别的节点上的shard转到新启动的节点上，这样是很坑的

# 这三个参数是一起的，意思是在2个node上线之后开始计时，如果1分钟内节点数达到3个就OK，没达到就执行shard recover操作
gateway.recover_after_nodes: 2
gateway.expected_nodes: 3
gateway.recover_after_time: 1m

# 锁定jvm内存，防止swaping
bootstrap.memory_lock: true

# 慢查询日志
index.search.slowlog.threshold.query.warn: 10s
index.search.slowlog.threshold.query.info: 5s
index.search.slowlog.threshold.query.debug: 2s
index.search.slowlog.threshold.query.trace: 500ms

index.search.slowlog.threshold.fetch.warn: 1s
index.search.slowlog.threshold.fetch.info: 800ms
index.search.slowlog.threshold.fetch.debug: 500ms
index.search.slowlog.threshold.fetch.trace: 200ms

index.indexing.slowlog.threshold.index.warn: 10s
index.indexing.slowlog.threshold.index.info: 5s
index.indexing.slowlog.threshold.index.debug: 2s
index.indexing.slowlog.threshold.index.trace: 500ms
index.indexing.slowlog.level: info
index.indexing.slowlog.source: 1000
```

在启动的时候指定配置文件地址，-d后台启动：

```shell
./bin/elasticsearch -d -Epath.conf=/etc/elasticsearch
```

kill -SIGTERM  [pid] 优雅退出

在log4j2.properties中修改日志配置

```properties
appender.rolling.strategy.type = DefaultRolloverStrategy
appender.rolling.strategy.action.type = Delete
appender.rolling.strategy.action.basepath = ${sys:es.logs.base_path}
appender.rolling.strategy.action.condition.type = IfLastModified
# 保留七天日志
appender.rolling.strategy.action.condition.age = 7D
appender.rolling.strategy.action.PathConditions.type = IfFileName
appender.rolling.strategy.action.PathConditions.glob = ${sys:es.logs.cluster_name}-*
```

修改/etc/fstab文件，把所有包含swap的行都注释掉，因为swap会把没用的jvm内存放到磁盘中，下次在使用的时候又要加载到内存里，很耗时，需要禁用掉。

修改/etc/security/limits.conf中的nproc，让用户能尽可能的创建更多的线程池，一般设置成2048。

/etc/security/limits.conf中，设置nofile为65536。