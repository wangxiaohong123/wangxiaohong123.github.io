---
title: atomic
tags:
  - java
  - 并发
categories: 基础
copyright: true
---

底层基于jdk内部使用UnSafe类，这个类只能在jdk内部用，他把构造函数私有了，并且验证类加载器，如果是应用程序加载器就报错，在类中使用offect记录当前值，自增时调用CompareAndSwap操作，并且是在while循环中。

CPU可以保证在一个线程执行UnSafe的CAS时，其他线程不能执行。

缺点：

*   ABA问题：可以使用AtomicStampedReference解决，我记着这个类是通过增加时间戳比较来解决的。
*   无限循环问题：会让CPU负载过高，可以使用jdk1.8的LongAdder来解决

LongAdder在线程很多的时候会使用分段CAS，把多个线程的CAS操作打散到一个cell[]数组上，如果一个线程在一个cell上多次空旋，会去别的cell上操作。获取的时候会把base的值和所有cell的值加到一起。

CAS在修改数据的时候就是把cache entry的flag变成E，然后执行查找在比较在修改操作，修改完了把flag变成M，就结束了。