---
title: Threadlocal
tags:
  - java源码
  - 并发
categories: 基础
copyright: true
---



线程变量的副本。每个Thread内部有一个ThreadLocalMap，这个map是一个Entry数组，只能是线程自己内部使用，因为他就是内部的变量嘛，Entry中有两个变量，一个是k（ThreadLocal类型），一个是value（自己定义类型）

set

```java
public void set(T value) {
    Thread t = Thread.currentThread();
    // 获取线程内部的ThreadLocalMap
    ThreadLocalMap map = getMap(t);
    // 如果map已经创建了就添加元素
    if (map != null)
        map.set(this, value);
    // 不存在就创建
    else
        createMap(t, value);
}
```

get

```java
public T get() {
    Thread t = Thread.currentThread();
    // 获取ThreadLocalMap
    ThreadLocalMap map = getMap(t);
    if (map != null) {
        // getEntry根据当前ThreadLocalMap的hashcode定位到Entry数组中的索引
        // 根据索引返回Entry
        ThreadLocalMap.Entry e = map.getEntry(this);
        if (e != null) {
            @SuppressWarnings("unchecked")
            T result = (T)e.value;
            return result;
        }
    }
    return setInitialValue();
}
```

