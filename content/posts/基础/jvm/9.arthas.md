---
title: jvm-9.arthas
tags:
  - JVM
categories: 基础
copyright: true
---

##### 1.定位

他的定位是监控、排查故障以及性能优化。

##### 2.用法

###### a.启动

启动方式有两种，第一种下载jar包[https://arthas.aliyun.com/arthas-boot.jar]，下载完直接使用jar包的方式启动：

```shell
# telnet-port 指定arthas监听的telnet端口，用来和arthas shell通信
# -1表示不监听，0表示随机
# 相关配置在arthas.properties里
java -jar arthas-boot.jar --telnet-port 4659 <pid>
```

启动之后可以看到监听端口

![arthas启动成功](https://raw.githubusercontent.com/wangxiaohong123/p-bed/main/uPic/arthas启动成功.png)

第二种下载arthas远程客户端(启动远程客户端需要先安装telnet)

```shell
curl -L https://arthas.aliyun.com/install.sh | sh

# 启动并指定监听进程的ip和端口，这里设置的是Web Console页面的ip和端口
./as.sh --target-ip 127.0.0.1 --target-port 8888 <pid>
```

不管哪种方式启动，如果启动时没有指定进程id，会列出所有java进程：

![Xnip2023-07-27_08-54-03](https://raw.githubusercontent.com/wangxiaohong123/p-bed/main/uPic/Xnip2023-07-27_08-54-03.png)

只要选择前面的序号就可以选择对应的java进程，如果觉得每次重启java进程之后pid都会发生变化可以使用select指定进程名：

```shell
java -jar arthas-boot.jar --select com.example.Main
```

启动之后可以使用指定的target-ip+target-port在浏览器中访问。

###### b.基本命令

| 命令        | 说明                                                   | 命令        | 说明                                     |
| ----------- | ------------------------------------------------------ | ----------- | ---------------------------------------- |
| dashboard   | 实时系统数据面板，可以看到线程、内存信息               | getstatic   | 查看类的静态属性，可以背ognl替代         |
| heapdump    | 导出内存快照                                           | jvm         | 查看jvm信息                              |
| logger      | 查看 logger 信息，更新 logger level                    | mbean       | 查看mbean信息                            |
| memory      | 查看内存信息                                           | ognl        | 执行ognl表达式(之前的groovy可能内存泄漏) |
| perfcounter | 查看当前JVM的Performance Counter(性能技术器)信息       | sysenv      | 查看系统变量                             |
| sysprop     | 查看系统属性                                           | thread      | 查看线程堆栈信息                         |
| vmoption    | 查看或更新vm诊断参数                                   | vmtool      | 利用jvmti接口查询内存对象或者强制GC      |
| classloader | 查看或使用类加载器                                     | dump        | 把加载完的字节码文件dump到指定目录       |
| jad         | 反编译已加载的类的源码                                 | mc          | 编译java文件成class文件                  |
| readfine    | 动态修改已经加载的类(不能修改类的结构和正在运行的函数) | retransform | 和readfine功能相同，更灵活               |
| sc          | 打印已加载的类信息                                     | sm          | 打印已加载类的方法信息                   |
| monitor     | 方法执行监控                                           | stack       | 查看方法的被调用堆栈信息                 |
| trace       | 输出方法内部节点路径上的节点耗时                       | tt          | 打印方法的入参、出参和耗时               |
| watch       | 和tt类似，更灵活，但是使用更复杂                       | profiler    | 针对cpu、对向分配、锁等信息生成火焰图    |
| jfr         | 使用jfr诊断工具                                        | auth        | 开启或关闭会话验证                       |
| options     | 全局设置                                               | base64      | 进行base64编解码                         |
| cat         | 打印文件内容                                           | cls         | 清空屏幕                                 |
| echo        | 打印命令或者文本                                       | grep        |                                          |
| help        |                                                        | history     |                                          |
| keymap      | 输出命令的快捷键映射表                                 | pwd         |                                          |
| quit        | 退出客户端                                             | reset       | 重制被arthas增强的类                     |
| session     | 显示会话信息                                           | stop        | 关闭arthas服务端                         |
| tee         |                                                        | version     |                                          |

###### c. 利用Arthas进行性能分析

-   分析消耗CPU的代码

    首先开启profiler：

    ```shell
    # 默认采样cpu，支持采样cpu, alloc(对象分配), lock(锁竞争), cache-misses(cpu缓存未命中信息)
    profiler start -e cpu
    ```

    然后执行方法：

    ```java
    public void hCPU() {
        for (int i = 0; i < 100; i++) {
            fib(i);
        }
    }
    
    private int fib(int n) {
        if (n <= 1) return n;
        return fib(n-1) + fib(n-2);
    }
    ```

    方法执行完后停止profiler：

    ```shell
    # 如果是生成html的文件可以直接在浏览器中访问，默认是html格式
    profiler stop --format html
    ```

    生成完火焰图可以直接打开或者访问http://127.0.0.1:8563/arthas-output/查看生成的火焰图，找到了占用CPU最高的方法fib()，之后就可以使用trace命令查看方法的内部调用路径，查看方法内部节点耗时：

    ```shell
    trace com.example.DemoService fib
    ```

-   排查内存泄漏问题

    

-   排查内存溢出

-   进行代码热替换

### IV. Arthas工作原理

A. 类加载和字节码增强

1.  Java类加载的基本原理