---
title: 3.DDD框架之cola
date: 2021-06-24 06:27:35
tags:
  - 研发效能
categories: DDD
copyright: true
---

COLA是一个应用架构，作者对应用架构的解释是处理模块（Module）、组件（Component）、包（Package）和类（Class）之间的关系，让系统有章法，有结构。提倡以业务为核心，解耦外部依赖，分离业务复杂度和技术复杂度。

##### COLA架构

![68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f36353439323330633637323334343866623361623531636137343832396538302e706e67](https://raw.githubusercontent.com/wangxiaohong123/p-bed/main/uPic/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f36353439323330633637323334343866623361623531636137343832396538302e706e67.png)

* 适配层（Adapter Layer）：负责对前端展示（web，wireless，wap）的路由和适配，相当于MVC中的controller，主要用来解释用户指令；
* 应用层（Application Layer）：主要负责获取输入，组装上下文，参数校验，调用领域层做业务处理，如果需要的话，发送消息通知等，其实就是**对业务编排**。层次是开放的，应用层也可以绕过领域层，直接访问基础实施层；
* 领域层（Domain Layer）：主要是封装了核心业务逻辑，并通过领域服务（Domain Service）和领域对象（Domain Entity）的方法对App层提供业务实体和业务逻辑计算。领域是应用的核心，**不依赖任何其他层次**；
* 基础实施层（Infrastructrue Layer）：主要负责技术细节问题的处理，比如数据库的CRUD、搜索引擎、文件系统、分布式服务的RPC等。此外，领域防腐的重任也落在这里，外部依赖需要通过gateway的转义处理，才能被上面的App层和Domain层使用。

可以看出来COLA和DDD的分层是一模一样的，只不过对于一些组件比如防腐层什么的所在的层级做了一些改动，这三种架构的普适性都是针对前端需求的变和领域模型的不变。

#### COLA的包结构

##### Adapter层

*   mobile：文档上写的是wireless，但是生成的代码里叫mobile，就是app端对应的controller接口；
*   web：电脑端页面对应的controller；
*   wap：移动端页面对应的controller；

##### App层

*   executor：处理request，包括command和query；
*   consumer：处理外部message，就是对应的事件消费者；
*   scheduler：处理定时任务；

##### Domain层

*   model：领域模型，就是实体、聚合这些东西；
*   ability：领域能力，就是领域服务；
*   gateway：领域网关，

##### Infra层

*   gatewayimpl：网关实现；
*   mapper：ibatis数据库映射；
*   config：配置信息；

##### Client层

*   api：服务对外暴露的api接口；
*   dto：服务对外的DTO；

##### Start层

里面只有服务的配置和启动类；

其实不管我们用不用DDD的模型设计都可以用这一套包架构，只不过就是model里有没有东西的事儿。

##### 对于领域层和基础层的gateway包说明：

这里的gateway并不是微服务的网关，而是代表DDD中的防腐层或者仓储，操作数据库时，通过仓储+po和实体的转换实现解耦，rpc调用其他服务或者三方的时候通过防腐层进行实体转换，给我的感觉都是一样的，只要有依赖就有耦合，这几个做法都是为了降低耦合的可接受成都，主要的思想也都是一样的。cola中的gatewayImpl就是他的防腐层，他把数据库、es这些也定义成了外部依赖，这样做不管是应用层还是领域层都可以调用三方服务了。

### 基于DDD+cola改造开发

##### 分析方法

DDD的分析方法有三种，事件风暴、领域故事陈述和4色建模：

*   事件风暴：类似于大家在一起的头脑风暴，每个人针对业务都想说什么说什么，然后有一个人专门根据大家的发言提炼出业务流、事件和命令，然后在根据事件的语义划分出实体、聚合、子域以及限界上下文。
*   领域故事陈述：梳理出每个业务的流程图

### COLA相关修改

1.   COLA中每一层就是一个模块，每一个子域对应一个工程，这样对人少的团队会增加维护成本，我们还是一个项目对应一个工程对应多个子域，每个子域只有两个服务，业务服务和api服务，api专门堆外暴露接口，其他层使用包的方式存在业务服务中。
2.   在COLA中client层除了对外的接口和dto还有命令和事件，我们把client层去掉后，把命令放到了app层，事件放到了领域层，事件的处理(publisher、subscriber)也在app层，还有一种方式是对于事件的publisher组件放到了gateway中，这么做是考虑下层不应该调用上层，publisher组件放到了gateway中方便在domain层调用。
3.   COLA的应用服务接口也放到了Client层，我觉得没必要，也没必要设计成依赖倒置的，所以我们直接在app层创建一个应用服务用来编排命令，app的executor包下有cmd和qry的包对应查询和命令的处理逻辑。
4.   COLA中并没有出现工厂的概念，我们需要，也放在app层，同时infra层需要convertor实现实体和其他dto或者do转换。