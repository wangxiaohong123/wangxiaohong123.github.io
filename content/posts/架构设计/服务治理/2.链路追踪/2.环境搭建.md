---
title: 链路追踪-2.环境搭建
tags:
  - 链路追踪
categories: 服务治理
copyright: true
---

首先去官网[https://archive.apache.org/dist/skywalking/]点击8.5.0/，下载apache-skywalking-apm-es7-8.5.0.tar.gz，因为这个版本的和我们的es版本一致。下载之后解压，解压后的主要目录：

*   agent⽬录将来要拷⻉到各服务所在机器上⽤作探针 
*   bin⽬录是服务启动脚本
*   config⽬录是配置⽂件
*   oap-libs⽬录是oap服务运⾏所需的jar包
*   webapp⽬录是web服务运⾏所需的jar包

**确保es7.8.5可用**

### 单机版

进入解压后的目录中。

修改config/application.yml配置文件：

```shell
vim config/application.yml
```

修改存储方式是es7，并修改elasticsearch7的配置：

```yaml
storage:
  selector: ${SW_STORAGE:elasticsearch7}
  elasticsearch7:
  	# 这个感觉是es集群名称
  	nameSpace: ${SW_NAMESPACE:"escluster"}
  	# 默认是9200，改成我们自己的es的端口，es集群的多个地址用逗号分割
  	clusterNodes: ${SW_STORAGE_ES_CLUSTER_NODES:127.0.0.1:9300}
```

修改jvm配置：

```shell
vim bin/oapService.sh
```

调整堆内存大小：

```shell
JAVA_OPTS="${JAVA_OPTS:-  -Xms512M -Xmx512M}"
```

启动oap服务：

```shell
sh bin/oapService.sh
# 启动之后会提示SkyWalking OAP started successfully!
```

查看日志检查是否启动成功：

```shell
tail -500 logs/skywalking-oap-server.log
```

修改ui界面的端口号：

```shell
vim webapp/webapp.yml
```

```yaml
server:
  # 8080被其他服务占用，这里改成18080
  port: 18080
```

启动Sky Walking UI

```shell
sh bin/webappService.sh
```

检查是否启动成功：

```shell
 tail -500 logs/webapp.log
```

skywalking自己的日志是100m一个，最多30个，在config/log4j2.xml中配置。

### 集群搭建

生产上用单机也可以，这个监控挂了重启就行，对业务没啥影响，部署集群还是单机主要看公司抠不抠。

使用nacos作为skywalking的注册中心。

###### 搭建oap集群

和单机版相比，修改了application.yml，增加注册中心信息：

```yaml
cluster:
  selector: ${SW_CLUSTER:nacos}
  nacos:
  	# 两个节点的serviceName在nacos上没有显示两个实例，不知道为什么
  	# 这里可以每个节点的serviceName取不一样的值
  	serviceName: ${SW_SERVICE_NAME:"Stars_SkyWalking_OAP_Cluster"}
    hostPort: ${SW_CLUSTER_NACOS_HOST_PORT:http://39.98.179.24:80}
    # Nacos Configuration namespace
    namespace: ${SW_CLUSTER_NACOS_NAMESPACE:"prod"}
    # Nacos auth username
    username: ${SW_CLUSTER_NACOS_USERNAME:"nacos"}
    password: ${SW_CLUSTER_NACOS_PASSWORD:"nacos"}
    # Nacos auth accessKey
    accessKey: ${SW_CLUSTER_NACOS_ACCESSKEY:""}
    secretKey: ${SW_CLUSTER_NACOS_SECRETKEY:""}
```

es地址的话可以两个单机(每个oap节点对应一个es节点)，也可以一个集群，其他的没变。

修改UI配置的oap server地址：

```yaml
server:
  port: 18080

collector:
  path: /graphql
  ribbon:
    ReadTimeout: 10000
    # 两个节点的地址
    listOfServers: 127.0.0.1:12800,127.0.0.1:12800
```

agentConfig、对应的项目启动参数里也配置集群的多个节点信息。

##### 监控vms

首先需要在每台被监控的机器上安装node_exports，参考prometheus监控系统笔记。

然后安装[OpenTelemetry receiver](https://skywalking.apache.org/docs/main/v8.5.0/en/setup/backend/backend-receivers#opentelemetry-receiver)

```bash
sudo yum update
sudo yum -y install wget systemctl
wget https://github.com/open-telemetry/opentelemetry-collector-releases/releases/download/v0.44.0/otelcol_0.44.0_linux_amd64.rpm
rpm -ivh otelcol_0.44.0_linux_amd64.rpm
```

安装完之后会默认带着参数**--config=/etc/otelcol/config.yaml**启动。自定义参数需要修改**/etc/otelcol/otelcol.conf**，修改otel collector的配置：

```bash
vim /etc/otelcol/config.yaml
```

```yaml
receivers:
  prometheus:
    config:
      scrape_configs:
        - job_name: "otel-collector"
          scrape_interval: 5s
          static_configs:
          	# 这里配置的是node_export所在服务的ip和node_exporter服务对应端口(默认9100)
            - targets: ["172.30.60.105:9100"]
            - targets: ["172.30.60.105:9100"]

processors:
  batch:

exporters:
  opencensus:
  	# oap服务地址
    endpoint: "172.30.60.105:11800"
    insecure: true
  # 这里配置成debug会导致磁盘爆满
  logging:
    logLevel: error

service:
  pipelines:
    metrics:
      receivers: [prometheus]
      processors: [batch]
      exporters: [opencensus,logging]
```

修改改配置或者参数后执行下面命令重启：

```bash
# 重启
sudo systemctl restart otelcol
# 查看输出
sudo journalctl -u otelcol
```

###### 配置skywalking

修改sky walking配置文件，找到receiver-otel，修改为下面：

```yaml
receiver-otel:
  selector: ${SW_OTEL_RECEIVER:default}
  default:
    enabledHandlers: ${SW_OTEL_RECEIVER_ENABLED_HANDLERS:"oc"}
    # 具体规则在otel-oc-rules目录下，多条rule用逗号分隔
    enabledOcRules: ${SW_OTEL_RECEIVER_ENABLED_OC_RULES:"vm"}
```

