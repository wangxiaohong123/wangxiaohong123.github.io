---
title: 链路追踪-3.使用
tags:
  - 链路追踪
categories: 服务治理
copyright: true
---

[agent配置信息大全](https://skywalking.apache.org/docs/main/v8.5.0/en/setup/service-agent/java-agent/readme/#table-of-agent-configuration-properties)

##### 启动脚本配置

###### intellij启动

进入edit configurations配置界面，配置vm options：

```shell
-javaagent:[agent目录]/agent/skywalking-agent.jar
```

Environment variables添加配置：

```shell
SW_AGENT_COLLECTOR_BACKEND_SERVICES=ip:11800;SW_AGENT_NAME=[服务名]
```

###### 生产环境启动

启动脚本中添加如下配置：

```shell
# skywalking-agent.jar所在位置
-javaagent:${AGENT_ADDR}
# oap服务的ip:端口
-Dskywalking.collector.backend_service=${OAP_SERVER}
-Dskywalking.agent.service_name=${APP_NAME}
```

##### 为接口添加注解

项目中添加依赖：

```xml
<dependency>
    <groupId>org.apache.skywalking</groupId>
    <artifactId>apm-toolkit-trace</artifactId>
    <version>${skywalking.version}</version>
</dependency>
<dependency>
    <groupId>org.apache.skywalking</groupId>
    <artifactId>apm-toolkit-opentracing</artifactId>
    <version>${skywalking.version}</version>
    <scope>provided</scope>
</dependency>
```

然后在service接口上添加@Trace和@Tags注解，@Tags里面传@Tag数组，入下图，arg[0]表示方法第一个参数，returnedObj表示方法的返回值，这两个注解可以帮助我们在查看链路时的方法中标记入参和返回值：
![](https://tva1.sinaimg.cn/large/e6c9d24ely1h1yu88nf0pj21160dgq5t.jpg)

##### 配置日志

添加依赖：

```xml
<dependency>
    <groupId>org.apache.skywalking</groupId>
    <artifactId>apm-toolkit-logback-1.x</artifactId>
    <version>${skywalking.version}</version>
</dependency>
```

修改logback配置文件，[官方文档](https://skywalking.apache.org/docs/main/v8.5.0/en/setup/service-agent/java-agent/application-toolkit-logback-1.x/)，增加如下配置：

```xml
<appender name="grpc-log" class="org.apache.skywalking.apm.toolkit.log.logback.v1.x.log.GRPCLogClientAppender">
    <encoder class="ch.qos.logback.core.encoder.LayoutWrappingEncoder">
        <layout class="org.apache.skywalking.apm.toolkit.log.logback.v1.x.mdc.TraceIdMDCPatternLogbackLayout">
            <pattern>
                %d{yyyy-MM-dd HH:mm:ss.SSS} [%X{tid}] %-5level [%.15thread] [%file.%M:%line] %msg%n
            </pattern>
        </layout>
        <charset>UTF-8</charset>
    </encoder>
</appender>
```

输出到文件的appender修改成如下：

```xml
<encoder class="ch.qos.logback.core.encoder.LayoutWrappingEncoder">
    <!-- pattern节点，用来设置日志的输入格式 -->
    <layout class="org.apache.skywalking.apm.toolkit.log.logback.v1.x.TraceIdPatternLogbackLayout">
        <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%tid] %-5level [%.15thread] [%file.%M:%line] %msg%n</pattern>
    </layout>
    <!-- 记录日志的编码:此处设置字符集 - -->
    <charset>UTF-8</charset>
</encoder>
```

agent/config目录下的agent.config文件中增加日志上报配置：

```properties
# 报告⽇志数据的grpc服务器的主机
plugin.toolkit.log.grpc.reporter.server_host=${SW_GRPC_LOG_SERVER_HOST:127.0.0.1}
# 报告⽇志数据的grpc服务器的端⼝
plugin.toolkit.log.grpc.reporter.server_port=${SW_GRPC_LOG_SERVER_PORT:11800}
# 指定grpc客户端要报告的⽇志数据的最⼤值
plugin.toolkit.log.grpc.reporter.max_message_size=${SW_GRPC_LOG_MAX_MESSAG E_SIZE:10485760}
# 客户端向上游发送数据时将超时多⻓时间。单位是秒
plugin.toolkit.log.grpc.reporter.upstream_timeout=${SW_GRPC_LOG_GRPC_UPSTR EAM_TIMEOUT:30}
```

##### 网关接入skyWalking

网关接入需要把agent/optional-plugins⽬录下的apm-spring-cloud-gateway-2.1.x-plugin-8.5.0.jar包移动到agent/plugins⽬录下，然后正常配置启动参数即可。

##### 忽略某些接口

把agent/optional-plugins⽬录下的apm-trace-ignore-plugin-8.5.0.jar包移动到agent/plugins⽬录下，然后启动脚本增加参数：

```shell
-Dskywalking.trace.ignore_path=Jedis/**,Mysql/JDBI/**
```

##### 告警

告警规则配置在config/alarm-settings.yml⽂件中，告警配置分成两部分：

1.   告警规则：定义了应该在什么情况下触发告警。 
2.   Webhook（⽹络钩⼦）：定义当警告触发时，需要通知到哪⾥去。

告警规则配置项：

-   Rule name：规则名称，告警信息中显示的唯⼀名称。要以_rule结尾，前缀可⾃定义。
-   Metrics name：度量条件，对应config/oal/*.aol脚本中的统计。
-   Include names：该规则作⽤于哪些实体名称，⽐如服务名，终端名（可选，默认为全部）。
-   Exclude names：该规则作不⽤于哪些实体名称，⽐如服务名，终端名（可选，默认为空）。
-   Threshold：阈值。
-   OP： 操作符，⽬前⽀持 >、<、= 、<=、>=。
-   Period：多久告警规则需要被核实⼀下。
-   Count：在⼀个Period窗⼝中，如果values超过Threshold值（按op），达到Count值，需要发送告警。
-   Silence period：在时间N中触发报警后，在TN -> TN + period这个阶段不告警。 默认情况下，它和Period⼀样，意思是相同的告警在同⼀个Period内只会触发⼀次。
-   message：告警消息 

###### 默认告警规则：

```yaml
rules:
  # 最近10分钟内，存在3分钟内服务平均响应时间超过1秒
  service_resp_time_rule:
    metrics-name: service_resp_time
    op: ">"
    threshold: 1000
    period: 10
    count: 3
    silence-period: 5
    message: Response time of service {name} is more than 1000ms in 3 minutes of last 10 minutes.
  # 最近10分钟内，存在2分钟内服务接口成功率低于80%
  service_sla_rule:
    metrics-name: service_sla
    op: "<"
    threshold: 8000
    period: 10
    count: 2
    silence-period: 3
    message: Successful rate of service {name} is lower than 80% in 2 minutes of last 10 minutes
  # 最近3分钟内服务响应时间超过1s的百分⽐。
  service_resp_time_percentile_rule:
    metrics-name: service_percentile
    op: ">"
    threshold: 1000,1000,1000,1000,1000
    period: 10
    count: 3
    silence-period: 5
    message: Percentile response time of service {name} alarm in 3 minutes of last 10 minutes, due to more than one condition of p50 > 1000, p75 > 1000, p90 > 1000, p95 > 1000, p99 > 1000
  # 最近2分钟内端点平均响应时间超过1秒
  service_instance_resp_time_rule:
    metrics-name: service_instance_resp_time
    op: ">"
    threshold: 1000
    period: 10
    count: 2
    silence-period: 5
    message: Response time of service instance {name} is more than 1000ms in 2 minutes of last 10 minutes
  # 最近2分钟内数据库访问平均响应时间超过1秒
  database_access_resp_time_rule:
    metrics-name: database_access_resp_time
    threshold: 1000
    op: ">"
    period: 10
    count: 2
    message: Response time of database access {name} is more than 1000ms in 2 minutes of last 10 minutes
  # 最近2分钟内端点关系平均响应时间超过1秒
  endpoint_relation_resp_time_rule:
    metrics-name: endpoint_relation_resp_time
    threshold: 1000
    op: ">"
    period: 10
    count: 2
    message: Response time of endpoint relation {name} is more than 1000ms in 2 minutes of last 10 minutes
  # 这个是监控端点响应时间的，但是接口的数据比服务要多得多，所以更花费内存和CPU
#  endpoint_avg_rule:
#    metrics-name: endpoint_avg
#    op: ">"
#    threshold: 1000
#    period: 10
#    count: 2
#    silence-period: 5
#    message: Response time of endpoint {name} is more than 1000ms in 2 minutes of last 10 minutes
```

调用链路的告警我们只用响应时间。

###### Webhook

这个就是我们配置好接口，发生告警时，skywalking回去回调这个接口发送告警信息，可以配置发送邮件和短信的接口，SkyWalking的告警消息会通过HTTP请求进⾏发送，请求⽅法为 POST，Content-Type为application/json，其JSON 数据实基于 org.apache.skywalking.oap.server.core.alarm.AlarmMessage进⾏序列化的。例如：

```json
[
    {
        "scopeId": 1,
        "scope": "SERVICE",
        // 服务告警规则就是服务名，断点告警就是接口名
        "name": "serviceA",
        "id0": "1",
        // 保留字段
        "id1": "",
        "ruleName": "service_resp_time_rule",
        "alarmMessage": "alarmMessage 。。。",
        // 告警时间
        "startTime": 1643116391715
    },
    {
        "scopeId": 1,
        "scope": "SERVICE",
        "name": "serviceB",
        "id0": "200",
        "id1": "",
        "ruleName": "service_resp_time_rule",
        "alarmMessage": "alarmMessage 。。。",
        "startTime": 1643116391715
    }
]
```

Webhook支持多种配置，微信、钉钉、飞书，简单使用飞书作为告警hook，在飞书中添加自定义机器人，参考[飞书添加自定义机器人](https://open.feishu.cn/document/ukTMukTMukTM/ucTM5YjL3ETO24yNxkjN)，然后把添加机器人时获取到的url和token配置到webhooks中，完整配置如下：

```yaml
rules:
  service_instance_resp_time_rule:
    metrics-name: service_instance_resp_time
    op: ">="
    threshold: 3000
    period: 10
    count: 3
    message: Response time of service instance {name} is more than 3s in 3 minutes of last 10 minutes
webhooks:
#  - http://127.0.0.1/notify/
#  - http://127.0.0.1/go-wechat/

feishuHooks:
  textTemplate: |-
    {
      "msg_type": "text",
      "content": {
        "text": "服务实例告警: \n %s."
      },
      # 这个是@人
      # "ats":"feishu_user_id_1,feishu_user_id_2"
    }
  webhooks:
    - url: https://open.feishu.cn/open-apis/bot/v2/hook/b2e69bec-0855-4835-b1c3-6f4fca5ccf46
      secret: ENii7DgtiRyySz8e4qVnbg
```

