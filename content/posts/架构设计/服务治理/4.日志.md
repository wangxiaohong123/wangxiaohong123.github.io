---
title: 服务治理-4.日志
tags:
  - 日志
categories: 服务治理
copyright: true
---

##### 日志规范

*   接口的入口和出口需要有日志，包括controller和service，级别是info。
*   关键步骤也需要有日志。
*   抛出异常前也需要打印日志，级别视情况而定，可以是info，也可以是error。
*   catch中也要打印日志，并且要输出异常信息，级别是error。
*   遇到if else分支时尽量打印日志。
*   核心功能模块建议打印完整日志。

##### 统一系统、操作日志组件

参考美团文档[[如何优雅地记录操作日志？](https://tech.meituan.com/2021/09/16/operational-logbook.html)]

系统日志和操作日志是不一样的，系统日志是各个功能运行流转过程中，打印出来的各种日志，能够根据日志还原出来运行的完整过程；操作日志是某个用户执行某些重要操作的时候，把操作日志记录持久化，后续可以随时查询操作。

##### ELK搭建

es和kibana安装参考之前笔记。

###### Logstash部署

需要采集的日志服务器都需要安装。

到[官网](https://www.elastic.co/cn/downloads/past-releases/logstash-7-9-3)下载安装包，创建目录：

```bash
mkdir -p /app/logstash
```

上传到目录下解压，进入解压后的bin目录，安装logstash json插件：

```bash
./logstash-plugin install logstash-codec-json_lines
```

创建用户，修改/app/logstash的属组和属主：

```bash
useradd logstash
passwd logstash
chown -R logstash:logstash /app/logstash
```

在config目录下创建logstash.conf：

```json
input {
    # 输⼊
    file {
    	# ⽇志路径
    	path => "/app/logstash/logs/test.log"
    	# 从头开始
    	start_position => "beginning"
    	# 设置多⻓时间扫描⽬录发现新⽂件
		discover_interval => 600
    	# 设置多⻓时间检测⽂件是否修改,默认是 1 秒
    	stat_interval => 1
	}
}
filter{
    # 对数据进⾏各种处理，如过滤，切割等
	# grok和date是解决Kibana显示时间与应⽤⽇志时间不⼀致问题，还需要在kibana中选择Stack Management-->高级设置-->时区选择UTC
	grok {
        # 提取⽇志中的时间并设置为临时变量
		match => {
            "message" => "%{TIMESTAMP_ISO8601:logdate}"
        }
	}
	date {
        # 设置变量的时间格式
		match => [ "logdate", "YYYY-MM-dd HH:mm:ss.SSS" ]
		# 需要替换的⽬标字段
		target => "@timestamp"
		timezone =>"+00:00"
	}
	multiline {
        # 时间正则表达式，合并多⾏⽇志
		pattern => "^\d{4}-\d{1,2}-\d{1,2}\s\d{1,2}:\d{1,2}:\d{1,2}"
		negate => true
		# 向前合并
		what => "previous"
	}
}
output {
    # 输出
    elasticsearch {
    hosts => ["http://172.19.17.29:9200","http://172.19.17.28:9200","http://172.19.17.2 7:9200"]
	# 指定索引名称
	index => "stars-log-%{+YYYY.MM.dd}"
}
```

logstash：

```bash
su logstash
#指定配置⽂件启动，可以在命令最后加&进⾏后台启动
nohup /app/logstash/logstash-7.9.3/bin/logstash -f /app/logstash/logstash- 7.9.3/config/logstash.conf &
```

###### kibana配置索引模式

选择Management中的stack Management，选择索引模式-->创建索引模式。

第一步输⼊stars-log-*点击下⼀步，第二部选择时间字段创建索引。

然后就可以在kibana的discover里看到日志了。

