---
title: 服务治理-3.监控系统
tags:
  - 监控系统
categories: 服务治理
copyright: true
---

##### 监控系统选型

prometheus、zabbis、nagios、open-falcon进行选型

| 监控系统    | 语言    | 成熟度 | 扩展性 | 性能 | 社区活跃 | 容器支持 | 企业使用 |
| ----------- | ------- | ------ | ------ | ---- | -------- | -------- | -------- |
| zabbix      | c + php | 高     | 高     | 低   | 中       | 低       | 高       |
| nagios      | c       | 高     | 中     | 中   | 低       | 低       | 低       |
| open-falcon | go      | 中     | 高     | 高   | 中       | 中       | 中       |
| prometheus  | go      | 中     | 高     | 高   | 高       | 高       | 高       |

zabbis和nagios的成熟度、企业使用高是因为他俩诞生的造，已经超过20年了。但是zabbix存储使用MySQL是硬伤，他不适合大规模的集群监控，nagios使用的是一个环形数据库，性能会稍微高一点，open-falcon底层是opensTSDB和基于graph分片存储的RRD环形数据库，prometheus是自研的时序数据库，也可以指定其他数据库。prometheus的社区活跃、国内外企业使用都非常高，open-falcon一般是小米(他就是小米开源的)、美团、滴滴这些大厂在用。

##### prometheus环境搭建

###### 安装prometheus

到[官网](https://prometheus.io/download/)下载最新版本的prometheus，上传到服务器并解压：

```shell
tar -zxvf prometheus-2.35.0.linux-amd64.tar.gz
```

修改包名：

```shell
mv prometheus-2.35.0.linux-amd64 prometheus
```

进入prometheus目录验证版本：

```shell
./prometheus --version
```

prometheus默认的配置在prometheus.yml中：

```yaml
global:
  # 抓取数据的时间间隔，默认1分钟
  scrape_interval: 15s
  # prometheus重新评估⼀次规则的时间间隔，默认1分钟
  evaluation_interval: 15s
  # scrape_timeout is set to the global default (10s).

# 警报管理器Alertmanager的配置项
alerting:
  alertmanagers:
    - static_configs:
        - targets:
          # - alertmanager:9093

# 记录规则和警报规则的⻆⾊列表
rule_files:
  # - "first_rules.yml"
  # - "second_rules.yml"

# 指定prometheus抓取的端点数据
# 抓取指标的数据源叫做：端点
scrape_configs:
  # 指定抓取prometheus机器本身的作业数据
  - job_name: "prometheus"
    # # 从本机的9090端⼝抓取数据并追加到 http://localhost:9090/metrics
    static_configs:
      - targets: ["localhost:9090"]
```

启动prometheus：

```shell
nohup ./prometheus --config.file=prometheus.yml &
```

查看nohup记录，**Server is ready to receive web requests**表示启动成功：

```shell
tail -f nohup.out
```

这个时候可以浏览器访问**ip:9090/metrics(数据采集地址)**和**ip:9090/graph(可视化界面)**查看.

>   注：如果浏览器报时间警告可能是服务器时间和浏览器时间不匹配，执行以下命令更新服务器时间：
>
>   ```shell
>   yum -y install ntpdate
>   ntpdate -u ntp.api.bz
>   ```

###### 安装grafana

打开grafana[官网](https://grafana.com/grafana/download)，找到centosOS安装命令执行：

```bash
wget https://dl.grafana.com/enterprise/release/grafana-enterprise-8.5.2-1.x86_64.rpm
sudo yum install grafana-enterprise-8.5.2-1.x86_64.rpm
```

执行以下命令启动服务：

```bash
sudo systemctl daemon-reload
sudo systemctl start grafana-server
# 查看服务状态
sudo systemctl status grafana-server
# 设置开机启动
sudo systemctl enable grafana-server
```

浏览器访问**ip:3000**登录grafana，默认的用户名和密码都是admin。

###### 安装指标采集器node_exporter

exporter⽤于采集⽬标主机的各种数据，将各种主机和应⽤服务上的监控指标数据输出给Prometheus，exporters⽬前总体上分为两种：⼀种是Prometheus官⽅在GitHub上维护的，另⼀种的其他的第三⽅开发提供给⼤众使⽤的，不同的exporter可以采集不同的数据信息。采集Linux系统主机参数和硬件指标的exporter叫做Node exporter，是⼀款⽤Go编写，可收集包括CPU、内存、磁盘等数据信息的主机指标采集库。

>   注：需要采集哪台主机的指标数据，就部署在哪台机器上

先在prometheus机器上安装一个node_exporter，到prometheus下载页面找到node_exporter并下载，传到服务器上解压：

```bash
tar -zxvf node_exporter-1.3.0.linux-amd64.tar.gz
mv node_exporter-1.3.0.linux-amd64 node_exporter
```

查看参数列表：

```bash
cd node_exporter
./node_exporter --help
```

能看到默认端口号是9100。

启动node_exporter:

```shell
nohup ./node_exporter &
```

###### prometheus新增抓取node_exporter的作业

修改prometheus.yml文件，增加作业，targets配置的是当前⽬标主机的IP和node_exporter运⾏端⼝：

```yaml
- job_name: "node_exporter"
  static_configs:
    - targets: ["172.30.60.105:9100"]
```

重启prometheus，直接ps找到进程杀死，然后在启动，这个时候就可以在prometheus控制台看到刚刚添加的作业了：
![](https://tva1.sinaimg.cn/large/e6c9d24ely1h23dp6stlkj21w40u0ag3.jpg)

###### 配置可视化数据监控⼤盘

打开grafana控制台找到data source选项：
![](https://tva1.sinaimg.cn/large/e6c9d24ely1h23drv6x8aj21cn0u0413.jpg)

点击Add data source，选第一个prometheus，然后填name和prometheus的url(http://ip:9090)点击保存。

打开[grafana数据大盘官网](https://grafana.com/grafana/dashboards/ )，选择一个合适的大盘，这里我选择 1 Node Exporter for Prometheus Dashboard CN v20200628，数据⼤盘的导⼊分为通过ID导⼊和JSON格式⽂件导⼊两种，点击进入详情页，复制这个大盘的id：
![](https://tva1.sinaimg.cn/large/e6c9d24ely1h23e2ecydnj22180n6n1c.jpg)

回到grafana，找到import：
![image-20220510162954429](/Users/xiaohong/Library/Application Support/typora-user-images/image-20220510162954429.png)

然后输入刚才的id，在下个界面的数据源选择prometheus：
![image-20220510163159347](/Users/xiaohong/Library/Application Support/typora-user-images/image-20220510163159347.png)

###### 配置jvm监控

首先在项目的总pom中添加依赖：

```xml
<dependency>
    <groupId>io.github.mweirauch</groupId>
    <artifactId>micrometer-jvm-extras</artifactId>
    <version>0.2.2</version>
</dependency>
```

然后在子项目中引入依赖：

```xml
<!-- prometheus 监控 -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-actuator</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-actuator-autoconfigure</artifactId>
</dependency>
<dependency>
    <groupId>io.micrometer</groupId>
    <artifactId>micrometer-registry-prometheus</artifactId>
</dependency>
<dependency>
    <groupId>io.github.mweirauch</groupId>
    <artifactId>micrometer-jvm-extras</artifactId>
</dependency>
```

然后添加配置：

```yaml
management:
  health:
    db:
      enabled: false
  endpoints:
        web:
          exposure:
            include: 'info,health,prometheus'
  metrics:
        export:
          prometheus:
            enabled: true
  endpoint:
    prometheus:
      enabled: true
    metrics:
      enabled: true
```

启动类中增加配置：

```java
/**
 * prometheus监控JVM参数
 *
 * @param applicationName 服务应⽤名称
 */
@Bean
MeterRegistryCustomizer<MeterRegistry> configurer(@Value("${spring.application.name}") String applicationName) {
    return registry -> registry.config().commonTags("application", applicationName);
}
```

然后重启服务。

在prometheus配置文件中增加job配置：

```yaml
  - job_name: "jvm"
    # 采集数据的路径
    metrics_path: '/actuator/prometheus'
    static_configs:
      # 监控机器的ip和端口
      - targets: ["ip:port"]
```

最后进入Grafana界⾯按照之前的import步骤引入监控，JVM监控⼤盘ID是**12856**。

###### 配置邮件告警

