在nginx应用层安装lua-resty-kafka：

```shell
cd /usr/local
wget https://github.com/doujiang24/lua-resty-kafka/archive/master.zip
unzip master.zip
cd /usr/hello_nginx/lualib/
cp -rf /usr/local/lua-resty-kafka-master/lib/resty /usr/hello_nginx/lualib
cd /usr/servers/nginx/conf/
vi nginx.conf
# http部分添加dns解析：resolver 8.8.8.8;
```

修改/usr/hello_nginx/lua下的product.lua：

```lua
-- 之前下面定义了一个cjson，把它拿到上面来
local cjson = require("cjson")
-- 声明kafka的producer
local producer = require("resty.kafka.producer")
local broker_list = {
    { host = "192.168.0.3", port = 9092 },
    { host = "192.168.0.5", port = 9092 },
    { host = "192.168.0.6", port = 9092 }
}
local log_json = {}
log_json["request_module"] = "product_detail_info"
log_json["headers"] = ngx.req.get_headers()
log_json["uri_args"] = ngx.req.get_uri_args()
log_json["body"] = ngx.req.read_body()
log_json["http_version"] = ngx.req.http_version()
log_json["method"] =ngx.req.get_method()
log_json["raw_reader"] = ngx.req.raw_header()
log_json["body_data"] = ngx.req.get_body_data()
local message = cjson.encode(log_json);
local productId = ngx.req.get_uri_args()["productId"]
-- 异步发送
local async_producer = producer:new(broker_list, { producer_type = "async" })
-- 发送消息
local ok, err = async_producer:send("access-log", productId, message)

if not ok then
    ngx.log(ngx.ERR, "kafka send err:", err)
    return
end
```

