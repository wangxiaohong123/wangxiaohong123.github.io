

```java
public class ZookeeperSession {

	private static CountDownLatch connectedSemaphore = new CountDownLatch(1);

	private ZooKeeper zooKeeper;

	public ZookeeperSession() {
		try {
			// 建立zk连接，异步建立，需要些一个WatchedEvent监听回调
			zooKeeper = new ZooKeeper("192.168.0.3:2181,192.168.0.5:2181,192.168.0.6:2181", 5000, new ZookeeperWatcher());
			log.info("zk连接状态:{}", zooKeeper.getState());
			connectedSemaphore.await();
			log.info("zk连接成功");
		} catch (IOException e) {
			e.printStackTrace();
		} catch (InterruptedException e) {
			e.printStackTrace();
		}
	}

	/**
	 * zk连接回调
	 */
	public class ZookeeperWatcher implements Watcher {

		@Override
		public void process(WatchedEvent watchedEvent) {
			log.info("Receive watched event: " + watchedEvent.getState());
			if(Event.KeeperState.SyncConnected == watchedEvent.getState()) {
				connectedSemaphore.countDown();
			}
		}
	}

	/**
	 * 获取分布式锁
	 * @param id
	 */
	public void acpuireDistributeLock(String id) {
		String path = "/produt-lock-" + id;
		try{
			// 创建一个临时节点
			zooKeeper.create(path, // 节点路径
					"".getBytes(), // 节点数据
					ZooDefs.Ids.OPEN_ACL_UNSAFE, // 节点权限
					CreateMode.EPHEMERAL // 临时节点
			);
			log.info("成功创建分布式锁节点:{}", path);
		}catch(KeeperException e){
			int count = 0;
			while(true){
				try{
					Thread.sleep(20);
					zooKeeper.create(path, "".getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);
				}catch(InterruptedException e1){
					e.printStackTrace();
				}catch(KeeperException e1){
					count++;
					continue;
				}
				log.info("重试:{}次后成功创建分布式锁节点:{}", count, path);
				break;
			}

		}catch(InterruptedException e){
			e.printStackTrace();
		}
	}

	/**
	 * 释放分布式锁
	 * @param id
	 */
	public void releaseDistributeLock(String id) {
		String path = "/produt-lock-" + id;
		try {
			zooKeeper.delete(path, -1);
		} catch (InterruptedException e) {
			e.printStackTrace();
		} catch (KeeperException e) {
			e.printStackTrace();
		}
	}

	/**
	 * 单例实现静态内部类
	 */
	private static class Singleton {
		private static ZookeeperSession zookeeperSession;

		static {
			zookeeperSession = new ZookeeperSession();
		}
		public static ZookeeperSession getZookeeperSession() {
			return zookeeperSession;
		}
	}

	public static ZookeeperSession getInstance() {
		return Singleton.getZookeeperSession();
	}

	public static void init() {
		getInstance();
	}
}
```

