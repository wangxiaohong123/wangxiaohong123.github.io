---
title: 云原生-2.容器理论
date: 2021-06-24 06:27:35
tags:
  - 架构
categories: 云原生
copyright: true
---

##### 为什么要用容器

简化环境部署:比如要安装一个管理系统可能需要安装MySQL、php、nginx，修改系统的DB配置；使用docker只需要配置docker-compose文件即可，这样还能保证多个服务的环境一致性。
持续集成：快速的镜像构建和部署，支持通过镜像回滚。

Docker是基于go语言开发的开源容器项目，他的构想是对应用的封装、分发、部署、运行生命周期进行管理，一次构建，到处运行。

#### 1.安装

docker安装分成2部分，docker和docker compose。

[Docker官方文档](https://docs.docker.com/get-docker/)，没啥坑。

docker compose是用python开发客户端，所以需要安装python以及python-pip。

mac的话到[python官网](https://www.python.org/downloads/macos/)下载最新的pkg文件，他自动配置环境变量，装完执行命令查看安装结果：

```shell
python --version
```

重新打开终端后安装python-pip

```shell
curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
python3 get-pip.py
```

使用pip安装docker-compose：

```shell
pip install docker-compose
```

装完之后查看doccker-compose版本检查是否安装成功：

```shell
docker-compose -v
```

#### 2.概念

##### 2.1 镜像

docker的镜像可以是传统的操作系统镜像，也可以是应用级的镜像(比如开发的某一个服务的镜像)，镜像就是停止运行的容器，内部就是一个精简的操作系统+应用运行需要的文件和依赖。

镜像有很多层，每个层都是只读的，但是所有镜像层都起始于一个基础镜像层， 然后每次安装新环境

##### 2.2 容器

容器是启动之后的镜像，一个镜像可以启动多个容器，每个容器相互独立。

###### 2.2.1 容器生命周期

![容器生命周期](https://raw.githubusercontent.com/wangxiaohong123/p-bed/main/uPic/容器生命周期.png)

##### 2.3 仓库

仓库是存放镜像的地方，分为公共仓库和私有仓库。存放仓库的地方叫注册服务器。

docker运行中使用的默认仓库是Docker Hub公共仓库。如果想要使用自己的私有仓库需要执行命令登录：

```shell
docker login
```

使用docker push 把test/nginx镜像推送到远程仓库：

```shell
# test是用户名
docker push test/nginx
```

可以开通阿里云的镜像服务(个人版)提高docker镜像的下载速度，免费的，开通之后他会有文档告诉你怎么替换远程公共仓库地址。

#### 3 架构

##### 3.1 架构图

![docker架构](https://raw.githubusercontent.com/wangxiaohong123/p-bed/main/uPic/docker架构.png)

Dockerd进程包括了docker的守护进程(Daemon)、驱动管理组件(Driver)和镜像管理组件(Graph)。

libcontainer是基于linux特性实现的资源隔离解决方案，比如利用linux的cgroup可以实现CPU最高使用核数限制等等，处理通过Docker的驱动，K8s可以直接操作libcontainer组件。

##### 3.2 libcontainer

###### 3.2.2 namespace

namespace是对全局资源的隔离，不同namespace下的进程拥有不同的系统资源，进到proc/进程号/ns目录下查看资源信息：

![qnYpjT](https://raw.githubusercontent.com/wangxiaohong123/p-bed/main/uPic/qnYpjT.png)

资源说明：

![linux-namespace资源说明](https://raw.githubusercontent.com/wangxiaohong123/p-bed/main/uPic/linux-namespace资源说明.png)

###### 3.2.3 cgroup

cgroup是linux限制、分离进程的资源，比如可以限制一个进程只能使用CPU的2个核、限制进程只能使用4G的内存或者其他的网络资源限制。可以进到/sys/fs/cgroup目录下查看cgroup可以限制的资源：

![RpDlqi](https://raw.githubusercontent.com/wangxiaohong123/p-bed/main/uPic/RpDlqi.png)

###### 3.2.4 网络

docker通过桥接模式实现宿主机和容器以及容器和容器之间的网络通信。