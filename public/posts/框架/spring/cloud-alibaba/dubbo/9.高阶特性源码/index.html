<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>9.dubbo-高阶特性源码 | 王小红的笔记</title><meta name=keywords content="源码"><meta name=description content="一、triple协议
使用triple协议时DubboProtocol会被替换成TripleProtocol。TripleProtocol的export()方法和DubboProtocol的区别就是调用的是PortUnificationExchanger的bind()方法：


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12


/**
 * PortUnificationExchanger
 */
public static void bind(URL url) {
    servers.computeIfAbsent(url.getAddress(), addr -> {
        // 构建server
        final PortUnificationServer server = new PortUnificationServer(url);
        // 启动server，这里还是使用netty
        server.bind();
        return server;
    });
}


server.bind();方法就是启动netty服务，但是使用的handler和Dubbo协议不一样，triple使用的handler是PortUnificationServerHandler。"><meta name=author content><link rel=canonical href=https://wangxiaohong123.github.io/posts/%E6%A1%86%E6%9E%B6/spring/cloud-alibaba/dubbo/9.%E9%AB%98%E9%98%B6%E7%89%B9%E6%80%A7%E6%BA%90%E7%A0%81/><link crossorigin=anonymous href=/assets/css/stylesheet.08f7d74f0ada0f975d29ae436285b61ed7a719d05f350cb888d00341642995a2.css integrity="sha256-CPfXTwraD5ddKa5DYoW2HtenGdBfNQy4iNADQWQplaI=" rel="preload stylesheet" as=style><link rel=icon href=https://wangxiaohong123.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://wangxiaohong123.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://wangxiaohong123.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://wangxiaohong123.github.io/apple-touch-icon.png><link rel=mask-icon href=https://wangxiaohong123.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://wangxiaohong123.github.io/posts/%E6%A1%86%E6%9E%B6/spring/cloud-alibaba/dubbo/9.%E9%AB%98%E9%98%B6%E7%89%B9%E6%80%A7%E6%BA%90%E7%A0%81/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://wangxiaohong123.github.io/posts/%E6%A1%86%E6%9E%B6/spring/cloud-alibaba/dubbo/9.%E9%AB%98%E9%98%B6%E7%89%B9%E6%80%A7%E6%BA%90%E7%A0%81/"><meta property="og:site_name" content="王小红的笔记"><meta property="og:title" content="9.dubbo-高阶特性源码"><meta property="og:description" content="一、triple协议 使用triple协议时DubboProtocol会被替换成TripleProtocol。TripleProtocol的export()方法和DubboProtocol的区别就是调用的是PortUnificationExchanger的bind()方法：
1 2 3 4 5 6 7 8 9 10 11 12 /** * PortUnificationExchanger */ public static void bind(URL url) { servers.computeIfAbsent(url.getAddress(), addr -> { // 构建server final PortUnificationServer server = new PortUnificationServer(url); // 启动server，这里还是使用netty server.bind(); return server; }); } server.bind();方法就是启动netty服务，但是使用的handler和Dubbo协议不一样，triple使用的handler是PortUnificationServerHandler。"><meta property="og:locale" content="zh-CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:tag" content="源码"><meta name=twitter:card content="summary"><meta name=twitter:title content="9.dubbo-高阶特性源码"><meta name=twitter:description content="一、triple协议
使用triple协议时DubboProtocol会被替换成TripleProtocol。TripleProtocol的export()方法和DubboProtocol的区别就是调用的是PortUnificationExchanger的bind()方法：


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12


/**
 * PortUnificationExchanger
 */
public static void bind(URL url) {
    servers.computeIfAbsent(url.getAddress(), addr -> {
        // 构建server
        final PortUnificationServer server = new PortUnificationServer(url);
        // 启动server，这里还是使用netty
        server.bind();
        return server;
    });
}


server.bind();方法就是启动netty服务，但是使用的handler和Dubbo协议不一样，triple使用的handler是PortUnificationServerHandler。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://wangxiaohong123.github.io/posts/"},{"@type":"ListItem","position":2,"name":"9.dubbo-高阶特性源码","item":"https://wangxiaohong123.github.io/posts/%E6%A1%86%E6%9E%B6/spring/cloud-alibaba/dubbo/9.%E9%AB%98%E9%98%B6%E7%89%B9%E6%80%A7%E6%BA%90%E7%A0%81/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"9.dubbo-高阶特性源码","name":"9.dubbo-高阶特性源码","description":"一、triple协议 使用triple协议时DubboProtocol会被替换成TripleProtocol。TripleProtocol的export()方法和DubboProtocol的区别就是调用的是PortUnificationExchanger的bind()方法：\n1 2 3 4 5 6 7 8 9 10 11 12 /** * PortUnificationExchanger */ public static void bind(URL url) { servers.computeIfAbsent(url.getAddress(), addr -\u0026gt; { // 构建server final PortUnificationServer server = new PortUnificationServer(url); // 启动server，这里还是使用netty server.bind(); return server; }); } server.bind();方法就是启动netty服务，但是使用的handler和Dubbo协议不一样，triple使用的handler是PortUnificationServerHandler。\n","keywords":["源码"],"articleBody":"一、triple协议 使用triple协议时DubboProtocol会被替换成TripleProtocol。TripleProtocol的export()方法和DubboProtocol的区别就是调用的是PortUnificationExchanger的bind()方法：\n1 2 3 4 5 6 7 8 9 10 11 12 /** * PortUnificationExchanger */ public static void bind(URL url) { servers.computeIfAbsent(url.getAddress(), addr -\u003e { // 构建server final PortUnificationServer server = new PortUnificationServer(url); // 启动server，这里还是使用netty server.bind(); return server; }); } server.bind();方法就是启动netty服务，但是使用的handler和Dubbo协议不一样，triple使用的handler是PortUnificationServerHandler。\n消费端也是一样的，会走到TripleProtocol的refer()方法。\n但是看源码的时候好像没看到triple协议使用了Exchanger和Transporter。\n二、三大中心源码 1.注册中心 注册中心分成5层：\n第一层接口层（Registry、RegistryService等），订阅、取消订阅、注册、下线等方法； 第二层抽象层（AbstractRegistry），公共方法的默认实现，数据的磁盘缓存处理； 第三层重试层（FailbackRegistry），负责订阅、取消订阅、注册、下线等任务的失败重试； 第四层缓存层（CacheableFailbackRegistry），基于内存缓存节点信息； 第五层实现层（ZookeeperRegistry、NacosRegistry等），主要负责和注册中心的交互； 1）ZookeeperRegistry源码 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 public ZookeeperRegistry(URL url, ZookeeperTransporter zookeeperTransporter) { // 传进来的url是zk的注册地址 // 初始化缓存、构建缓存清理定时任务、构造重试时间轮、创建磁盘缓存文件，如果文件已经存在还会读取磁盘缓存 super(url); if (url.isAnyHost()) { throw new IllegalStateException(\"registry address == null\"); } String group = url.getGroup(DEFAULT_ROOT); if (!group.startsWith(PATH_SEPARATOR)) { group = PATH_SEPARATOR + group; } this.root = group; // 基于zookeeperTransporter构建zk客户端 // zookeeperTransporter是在ZookeeperRegistryFactory中通过SPI获取的 // 这里需要注意创建Curator5ZookeeperClient的时候添加的监听里解决了zk网络抖动导致节点消失的bug zkClient = zookeeperTransporter.connect(url); zkClient.addStateListener((state) -\u003e { if (state == StateListener.RECONNECTED) { // 重连之后尝试拉取provider最新的集群地址 // 这里不会重新注册，因为短暂的网络断开不会删除临时节点 logger.warn(\"Trying to fetch the latest urls, in case there're provider changes during connection loss.\\n\" + \" Since ephemeral ZNode will not get deleted for a connection lose, \" + \"there's no need to re-register url of this instance.\"); ZookeeperRegistry.this.fetchLatestAddresses(); } else if (state == StateListener.NEW_SESSION_CREATED) { // 经历SESSION_LOST并且重新连接之后 // 需要重新注册和监听 // 因为zk可能因为网络抖动+延迟删除节点，导致我们在注册时提示节点已存在 // 但是过一会zk把节点删除，这样就会导致节点丢失 // 这个recover()就是调用FailbackRegistry把注册和定于添加定时任务，到时候会执行这个类的doRegister方法 logger.warn(\"Trying to re-register urls and re-subscribe listeners of this instance to registry...\"); try { ZookeeperRegistry.this.recover(); } catch (Exception e) { logger.error(e.getMessage(), e); } } else if (state == StateListener.SESSION_LOST) { // 连接断开的时间超过了阈值，此时会话过期，zk端会把当前客户端创建的临时节点删除 // 客户端户收到一个SESSION_LOST的监听回调 logger.warn(\"Url of this instance will be deleted from registry soon. \" + \"Dubbo client will try to re-register once a new session is created.\"); } else if (state == StateListener.SUSPENDED) { } else if (state == StateListener.CONNECTED) { } }); } ZookeeperRegistry的构造方法中会调用CacheableFailbackRegistry的构造方法：\n1 2 3 4 5 6 7 8 9 10 public CacheableFailbackRegistry(URL url) { // 初始化重试时间轮 super(url); extraParameters = new HashMap\u003c\u003e(8); extraParameters.put(CHECK_KEY, String.valueOf(false)); // 定时缓存清理使用单线程线程池 cacheRemovalScheduler = url.getOrDefaultApplicationModel().getExtensionLoader(ExecutorRepository.class).getDefaultExtension().nextScheduledExecutor(); cacheRemovalTaskIntervalInMillis = getIntConfig(url.getScopeModel(), CACHE_CLEAR_TASK_INTERVAL, 2 * 60 * 1000); cacheClearWaitingThresholdInMillis = getIntConfig(url.getScopeModel(), CACHE_CLEAR_WAITING_THRESHOLD, 5 * 60 * 1000); } CacheableFailbackRegistry的构造方法会调用FailbackRegistry的构造方法：\n1 2 3 4 5 6 7 8 9 public FailbackRegistry(URL url) { // 拿到这个url先去创建磁盘缓存文件，如果文件已经存在还会读取磁盘缓存 super(url); // 设置重试间隔，默认5s this.retryPeriod = url.getParameter(REGISTRY_RETRY_PERIOD_KEY, DEFAULT_REGISTRY_RETRY_PERIOD); // 初始化时间轮 retryTimer = new HashedWheelTimer(new NamedThreadFactory(\"DubboRegistryRetryTimer\", true), retryPeriod, TimeUnit.MILLISECONDS, 128); } FailbackRegistry的构造方法最后会调AbstractRegistry的构造方法：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 public AbstractRegistry(URL url) { setUrl(url); // 从Model组件里获取Bean工厂，在获取RegistryManager registryManager = url.getOrDefaultApplicationModel().getBeanFactory().getBean(RegistryManager.class); // 是否开启本地磁盘缓存 localCacheEnabled = url.getParameter(REGISTRY_LOCAL_FILE_CACHE_ENABLED, true); // 获取共享线程池 registryCacheExecutor = url.getOrDefaultApplicationModel().getDefaultExtension(ExecutorRepository.class).getSharedExecutor(); if (localCacheEnabled) { // 开启刷盘定时任务 // 同步刷盘，默认是false syncSaveFile = url.getParameter(REGISTRY_FILESAVE_SYNC_KEY, false); // 获取缓存文件的目录和文件名 String defaultFilename = System.getProperty(USER_HOME) + DUBBO_REGISTRY + url.getApplication() + \"-\" + url.getAddress().replaceAll(\":\", \"-\") + CACHE; String filename = url.getParameter(FILE_KEY, defaultFilename); // 获取file对象和创建目录 File file = null; if (ConfigUtils.isNotEmpty(filename)) { file = new File(filename); if (!file.exists() \u0026\u0026 file.getParentFile() != null \u0026\u0026 !file.getParentFile().exists()) { if (!file.getParentFile().mkdirs()) { throw new IllegalArgumentException(\"Invalid registry cache file \" + file + \", cause: Failed to create directory \" + file.getParentFile() + \"!\"); } } } this.file = file; // 先把磁盘缓存读取出来 // 为了远程订阅失败的容错 loadProperties(); // 先拿到备用的url，备用的url里最少也要有一个当前url自己 // 启动的时候这步什么都没干 notify(url.getBackupUrls()); } } 父类的构造方法调用完了之后就开始建立zk的链接并且添加状态监听，调用Curator5ZookeeperTransporter的connect()方法，通过双重检查建立一个curator的客户端，初始化curator客户端的源码：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 public Curator5ZookeeperClient(URL url) { super(url); try { // 连接超时时间和会话过期时间 int timeout = url.getParameter(TIMEOUT_KEY, DEFAULT_CONNECTION_TIMEOUT_MS); int sessionExpireMs = url.getParameter(ZK_SESSION_EXPIRE_KEY, DEFAULT_SESSION_TIMEOUT_MS); CuratorFrameworkFactory.Builder builder = CuratorFrameworkFactory.builder() .connectString(url.getBackupAddress()) .retryPolicy(new RetryNTimes(1, 1000)) // 连接失败过1s再重试1次 .connectionTimeoutMs(timeout) .sessionTimeoutMs(sessionExpireMs); String authority = url.getAuthority(); if (authority != null \u0026\u0026 authority.length() \u003e 0) { builder = builder.authorization(\"digest\", authority.getBytes()); } client = builder.build(); // 添加状态监听 client.getConnectionStateListenable().addListener(new CuratorConnectionStateListener(url)); client.start(); // 阻塞等待结果 boolean connected = client.blockUntilConnected(timeout, TimeUnit.MILLISECONDS); if (!connected) { throw new IllegalStateException(\"zookeeper not connected\"); } } catch (Exception e) { throw new IllegalStateException(e.getMessage(), e); } } 注册的方法并没有重写父类的，所以注册会先进到FailbackRegistry的register()方法：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 public void register(URL url) { if (!acceptable(url)) { return; } super.register(url); // 把这个url相关的失败注册、下线任务清理 removeFailedRegistered(url); removeFailedUnregistered(url); try { // 这里调用具体子类的逻辑 doRegister(url); } catch (Exception e) { Throwable t = e; // 配置check参数是false才会重试 boolean check = getUrl().getParameter(Constants.CHECK_KEY, true) \u0026\u0026 url.getParameter(Constants.CHECK_KEY, true) \u0026\u0026 !(url.getPort() == 0); boolean skipFailback = t instanceof SkipFailbackWrapperException; if (check || skipFailback) { if (skipFailback) { t = t.getCause(); } throw new IllegalStateException(\"Failed to register \" + url + \" to registry \" + getUrl().getAddress() + \", cause: \" + t.getMessage(), t); } else { logger.error(\"Failed to register \" + url + \", waiting for retry, cause: \" + t.getMessage(), t); } // 注册失败向时间轮中添加失败任务 addFailedRegistered(url); } } doRegister()就是用zkClient创建临时节点：\n1 2 3 4 5 6 7 8 9 10 11 12 @Override public void doRegister(URL url) { try { // 这个就是检查zkClient有没有被初始化 checkDestroyed(); // 把URL转成目录，创建临时节点 // 目录类似于/dubbo/接口路径/categoryPath[provider,consumer]/ip…… zkClient.create(toUrlPath(url), url.getParameter(DYNAMIC_KEY, true)); } catch (Throwable e) { throw new RpcException(\"Failed to register \" + url + \" to zookeeper \" + getUrl() + \", cause: \" + e.getMessage(), e); } } 创建临时节点就是调用curator的api：\n1 2 3 4 5 6 7 8 9 10 11 12 13 public void createEphemeral(String path) { try { client.create().withMode(CreateMode.EPHEMERAL).forPath(path); } catch (NodeExistsException e) { logger.warn(\"ZNode \" + path + \" already exists, since we will only try to recreate a node on a session expiration, this duplication might be caused by a delete delay from the zk server, which means the old expired session may still holds this ZNode and the server just hasn't got time to do the deletion. In this case, we can just try to delete and create again.\", e); // 如果重复创建，要先删掉这个节点，在重新注册 // 这个就是解决zk因为网络抖动节点丢失的问题 deletePath(path); createEphemeral(path); } catch (Exception e) { throw new IllegalStateException(e.getMessage(), e); } } 下线的操作和注册差不多。\n订阅也是走到了FailbackRegistry的subscribe()方法:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 public void subscribe(URL url, NotifyListener listener) { // 调用父类的订阅方法 // 把传进来的监听器放到set里 super.subscribe(url, listener); // 移除失败的订阅任务 removeFailedSubscribed(url, listener); try { // Sending a subscription request to the server side // 这里就是执行订阅的代码，直接走到了zkRegistry中 doSubscribe(url, listener); } catch (Exception e) { Throwable t = e; // 如果失败的话尝试拿到之前从磁盘缓存读取出来的url信息容错处理 List\u003cURL\u003e urls = getCacheUrls(url); if (CollectionUtils.isNotEmpty(urls)) { notify(url, listener, urls); } else { // 没有缓存并且配置check参数是false才会重试 boolean check = getUrl().getParameter(Constants.CHECK_KEY, true) \u0026\u0026 url.getParameter(Constants.CHECK_KEY, true); boolean skipFailback = t instanceof SkipFailbackWrapperException; if (check || skipFailback) { if (skipFailback) { t = t.getCause(); } throw new IllegalStateException(\"Failed to subscribe \" + url + \", cause: \" + t.getMessage(), t); } } // Record a failed registration request to a failed list, retry regularly addFailedSubscribed(url, listener); } } doSubscribe()又会调到ZookeeperRegistry里：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 public void doSubscribe(final URL url, final NotifyListener listener) { try { checkDestroyed(); if (ANY_VALUE.equals(url.getServiceInterface())) { String root = toRootPath(); boolean check = url.getParameter(CHECK_KEY, false); ConcurrentMap\u003cNotifyListener, ChildListener\u003e listeners = zkListeners.computeIfAbsent(url, k -\u003e new ConcurrentHashMap\u003c\u003e()); ChildListener zkListener = listeners.computeIfAbsent(listener, k -\u003e (parentPath, currentChilds) -\u003e { for (String child : currentChilds) { child = URL.decode(child); if (!anyServices.contains(child)) { anyServices.add(child); subscribe(url.setPath(child).addParameters(INTERFACE_KEY, child, Constants.CHECK_KEY, String.valueOf(check)), k); } } }); zkClient.create(root, false); List\u003cString\u003e services = zkClient.addChildListener(root, zkListener); if (CollectionUtils.isNotEmpty(services)) { for (String service : services) { service = URL.decode(service); anyServices.add(service); subscribe(url.setPath(service).addParameters(INTERFACE_KEY, service, Constants.CHECK_KEY, String.valueOf(check)), listener); } } } else { // 正常来说都是针对指定的接口进行监听 CountDownLatch latch = new CountDownLatch(1); try { List\u003cURL\u003e urls = new ArrayList\u003c\u003e(); // toCategoriesPath()拿到的是/dubbo/接口路径/provider // 拿到这个节点之后就可以监听这个节点下的子节点了 for (String path : toCategoriesPath(url)) { ConcurrentMap\u003cNotifyListener, ChildListener\u003e listeners = zkListeners.computeIfAbsent(url, k -\u003e new ConcurrentHashMap\u003c\u003e()); // ChildListener是zk的子节点监听 ChildListener zkListener = listeners.computeIfAbsent(listener, k -\u003e new RegistryChildListenerImpl(url, path, k, latch)); if (zkListener instanceof RegistryChildListenerImpl) { ((RegistryChildListenerImpl) zkListener).setLatch(latch); } // 创建持久节点 // 其实是对/dubbo/接口路径/provider路径的检查 zkClient.create(path, false); // 对子节点监听 List\u003cString\u003e children = zkClient.addChildListener(path, zkListener); if (children != null) { // 每个children都是一个子节点字符串，把他们转成具体的服务URL // 而且toUrlsWithEmpty调用的是CacheableFailbackRegistry父类 urls.addAll(toUrlsWithEmpty(url, path, children)); } } // 这里是对每个实例的客户端建立netty连接 // 这个类里的notify()就是调用父类的notify() notify(url, listener, urls); } finally { // tells the listener to run only after the sync notification of main thread finishes. latch.countDown(); } } } catch (Throwable e) { throw new RpcException(\"Failed to subscribe \" + url + \" to zookeeper \" + getUrl() + \", cause: \" + e.getMessage(), e); } } 调用toUrlsWithEmpty()进行raw url -\u003e URL的时候，使用父类进行缓存优化。\nnotify()方法会去调用抽象父类AbstractRegistry里：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 protected void notify(URL url, NotifyListener listener, List\u003cURL\u003e urls) { // 上面是一堆校验 // keep every provider's category. Map\u003cString, List\u003cURL\u003e\u003e result = new HashMap\u003c\u003e(); for (URL u : urls) { if (UrlUtils.isMatch(url, u)) { String category = u.getCategory(DEFAULT_CATEGORY); List\u003cURL\u003e categoryList = result.computeIfAbsent(category, k -\u003e new ArrayList\u003c\u003e()); categoryList.add(u); } } if (result.size() == 0) { return; } Map\u003cString, List\u003cURL\u003e\u003e categoryNotified = notified.computeIfAbsent(url, u -\u003e new ConcurrentHashMap\u003c\u003e()); // 遍历 回调listener的notify() for (Map.Entry\u003cString, List\u003cURL\u003e\u003e entry : result.entrySet()) { String category = entry.getKey(); List\u003cURL\u003e categoryList = entry.getValue(); categoryNotified.put(category, categoryList); listener.notify(categoryList); if (localCacheEnabled) { // 缓存数据刷盘 saveProperties(url); } } } listener.notify()，这个listener是NotifyListener类型，这里的notify()走到了RegistryDirectory里，因为RegistryDirectory继承了DynamicDirectory，而DynamicDirectory是实现了NotifyListener接口的。就是在RegistryDirectory里进行了netty连接+DubboInvoker封装。\n2）NacosRegistry源码 NacosRegistry是直接注册FailbackRegistry的，没有row url -\u003e URL的转换。和zk的registry思路一样，只不多他使用的是nacos提供的api。\n3）DNSRegistry 使用dns当注册中心，那么dns保存的就不是域名和ip的映射了，保存的应该是接口名称和ip的映射。\ndubbo中没有实现DNSRegistry，里面都是空方法。但是他有个DNSServiceDiscovery。\n2.配置中心 获取具体的配置中心是根据配置中心的url中的protocol属性，protocol可以是nacos、zookeeper、appllo。\n配置中心没有什么代码，都是别人声明一个监听，然后来调用配置中心添加监听器，这样配置发生变化的时候，对应的关注这个配置的类就会收到监听。\n1）ZookeeperDynamicConfiguration 看下构造方法：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 ZookeeperDynamicConfiguration(URL url, ZookeeperTransporter zookeeperTransporter) { // 这个url就是zk的链接地址 // super(url)里也没干啥，就是创建了个线程池 super(url); this.url = url; rootPath = getRootPath(url); // 这个就是缓存每个节点对应的所有监听器的 this.cacheListener = new CacheListener(rootPath); final String threadName = this.getClass().getSimpleName(); // 又搞了个线程池 this.executor = new ThreadPoolExecutor(DEFAULT_ZK_EXECUTOR_THREADS_NUM, DEFAULT_ZK_EXECUTOR_THREADS_NUM, THREAD_KEEP_ALIVE_TIME, TimeUnit.MILLISECONDS, new LinkedBlockingQueue\u003cRunnable\u003e(DEFAULT_QUEUE), new NamedThreadFactory(threadName, true), new AbortPolicyWithReport(threadName, url)); // 基于ZookeeperTransporter创建zk客户端 zkClient = zookeeperTransporter.connect(url); boolean isConnected = zkClient.isConnected(); if (!isConnected) { throw new IllegalStateException(\"Failed to connect with zookeeper, pls check if url \" + url + \" is correct.\"); } } 添加监听：\n1 2 3 4 5 6 7 8 9 10 /** * 这个方法在MeshRuleManager和MigrationRuleListener初始化的时候会调用CompositeDynamicConfiguration的addListener() * 然后调到这个方法添加监听 * 当监听到节点有变化时就会反过来调用监听 */ @Override protected void doAddListener(String pathKey, ConfigurationListener listener) { cacheListener.addListener(pathKey, listener); zkClient.addDataListener(pathKey, cacheListener, executor); } 2）nacos和apollo配置中心 他俩和zk的思路一样，都是维护一堆监听，收到对应配置中心回调的时候再去回调维护的监听，而且都有现成的api。\n3）元数据中心 以provider启动来说，在ServiceConfig的init()方法中会获取ModelDeployer，然后调用他的start()方法，然后调用ApplicationDeployer的initialize()方法，这个方法里会初始化配置中心和元数据中心。就是把接口的属性、版本号什么赋值，然后在发布的时候，判断需要远程发布的下面有一行代码是上报元数据的：\n1 MetadataUtils.publishServiceDefinition(url); 最终会调用到AbstractMetadataReport的storeProviderMetadataTask()：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 private void storeProviderMetadataTask(MetadataIdentifier providerMetadataIdentifier, ServiceDefinition serviceDefinition) { try { if (logger.isInfoEnabled()) { logger.info(\"store provider metadata. Identifier : \" + providerMetadataIdentifier + \"; definition: \" + serviceDefinition); } allMetadataReports.put(providerMetadataIdentifier, serviceDefinition); failedReports.remove(providerMetadataIdentifier); // 把元数据转成json Gson gson = new Gson(); String data = gson.toJson(serviceDefinition); // 调用对应的元数据上报实现，上报元数据 // 比如zookeeper就是ZookeeperMetadataReport doStoreProviderMetadata(providerMetadataIdentifier, data); saveProperties(providerMetadataIdentifier, data, true, !syncReport); } catch (Exception e) { // retry again. If failed again, throw exception. failedReports.put(providerMetadataIdentifier, serviceDefinition); metadataReportRetry.startRetryTask(); logger.error(\"Failed to put provider metadata \" + providerMetadataIdentifier + \" in \" + serviceDefinition + \", cause: \" + e.getMessage(), e); } } 三、启动时检查 启动时检查的配置有3个\n1 2 3 4 5 6 # 关闭具体服务的启动时检查，没有提供者时不报错 dubbo.reference.具体的接口路径.check=false # 关闭所有服务的启动时检查 dubbo.consumer.check=false # 关闭注册中心的启动时检查，关闭这个如果注册订阅失败也允许启动，会在后台定时重试 dubbo.registry.check=false 前两个都是针对consumer的，对应的代码在ReferenceConfig的checkInvokerAvailable()里：\n1 2 3 4 5 6 7 8 private void checkInvokerAvailable() throws IllegalStateException { // shouldCheck()就是上面的参数，具体的还没看 // invoker.isAvailable()就是通过netty判断是否连接 if (shouldCheck() \u0026\u0026 !invoker.isAvailable()) { invoker.destroy(); throw new IllegalStateException(\"Should has at least one way to know which services this interface belongs to,\" + \" subscription url: \" + invoker.getUrl()); } } 四、多注册中心 多注册中心的源码对应MultipleRegistry，代码都差不多，就是用for循环注册、订阅什么的。\n","wordCount":"1862","inLanguage":"en","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://wangxiaohong123.github.io/posts/%E6%A1%86%E6%9E%B6/spring/cloud-alibaba/dubbo/9.%E9%AB%98%E9%98%B6%E7%89%B9%E6%80%A7%E6%BA%90%E7%A0%81/"},"publisher":{"@type":"Organization","name":"王小红的笔记","logo":{"@type":"ImageObject","url":"https://wangxiaohong123.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wangxiaohong123.github.io/ accesskey=h title="王小红的笔记 (Alt + H)">王小红的笔记</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://wangxiaohong123.github.io/posts/ title=笔记><span>笔记</span></a></li><li><a href=https://wangxiaohong123.github.io/tags/ title=标签><span>标签</span></a></li><li><a href=https://wangxiaohong123.github.io/categories/ title=分类><span>分类</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">9.dubbo-高阶特性源码</h1><div class=post-meta>9 min</div></header><div class=post-content><h3 id=一triple协议>一、triple协议<a hidden class=anchor aria-hidden=true href=#一triple协议>#</a></h3><p>使用triple协议时DubboProtocol会被替换成TripleProtocol。TripleProtocol的export()方法和DubboProtocol的区别就是调用的是PortUnificationExchanger的bind()方法：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * PortUnificationExchanger
</span></span></span><span style=display:flex><span><span style=color:#6272a4> */</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>bind</span>(URL url) {
</span></span><span style=display:flex><span>    servers.<span style=color:#50fa7b>computeIfAbsent</span>(url.<span style=color:#50fa7b>getAddress</span>(), addr <span style=color:#ff79c6>-&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 构建server</span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>final</span> PortUnificationServer server <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> PortUnificationServer(url);
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 启动server，这里还是使用netty</span>
</span></span><span style=display:flex><span>        server.<span style=color:#50fa7b>bind</span>();
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> server;
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>server.bind();方法就是启动netty服务，但是使用的handler和Dubbo协议不一样，triple使用的handler是PortUnificationServerHandler。</p><p>消费端也是一样的，会走到TripleProtocol的refer()方法。</p><p>但是看源码的时候好像没看到triple协议使用了Exchanger和Transporter。</p><h3 id=二三大中心源码>二、三大中心源码<a hidden class=anchor aria-hidden=true href=#二三大中心源码>#</a></h3><h5 id=1注册中心>1.注册中心<a hidden class=anchor aria-hidden=true href=#1注册中心>#</a></h5><p>注册中心分成5层：</p><ol><li>第一层接口层（Registry、RegistryService等），订阅、取消订阅、注册、下线等方法；</li><li>第二层抽象层（AbstractRegistry），公共方法的默认实现，数据的磁盘缓存处理；</li><li>第三层重试层（FailbackRegistry），负责订阅、取消订阅、注册、下线等任务的失败重试；</li><li>第四层缓存层（CacheableFailbackRegistry），基于内存缓存节点信息；</li><li>第五层实现层（ZookeeperRegistry、NacosRegistry等），主要负责和注册中心的交互；</li></ol><h6 id=1zookeeperregistry源码>1）ZookeeperRegistry源码<a hidden class=anchor aria-hidden=true href=#1zookeeperregistry源码>#</a></h6><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#50fa7b>ZookeeperRegistry</span>(URL url, ZookeeperTransporter zookeeperTransporter) {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 传进来的url是zk的注册地址</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 初始化缓存、构建缓存清理定时任务、构造重试时间轮、创建磁盘缓存文件，如果文件已经存在还会读取磁盘缓存</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>super</span>(url);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (url.<span style=color:#50fa7b>isAnyHost</span>()) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> IllegalStateException(<span style=color:#f1fa8c>&#34;registry address == null&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    String group <span style=color:#ff79c6>=</span> url.<span style=color:#50fa7b>getGroup</span>(DEFAULT_ROOT);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>group.<span style=color:#50fa7b>startsWith</span>(PATH_SEPARATOR)) {
</span></span><span style=display:flex><span>        group <span style=color:#ff79c6>=</span> PATH_SEPARATOR <span style=color:#ff79c6>+</span> group;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>root</span> <span style=color:#ff79c6>=</span> group;
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 基于zookeeperTransporter构建zk客户端</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// zookeeperTransporter是在ZookeeperRegistryFactory中通过SPI获取的</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 这里需要注意创建Curator5ZookeeperClient的时候添加的监听里解决了zk网络抖动导致节点消失的bug</span>
</span></span><span style=display:flex><span>    zkClient <span style=color:#ff79c6>=</span> zookeeperTransporter.<span style=color:#50fa7b>connect</span>(url);
</span></span><span style=display:flex><span>    zkClient.<span style=color:#50fa7b>addStateListener</span>((state) <span style=color:#ff79c6>-&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (state <span style=color:#ff79c6>==</span> StateListener.<span style=color:#50fa7b>RECONNECTED</span>) {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 重连之后尝试拉取provider最新的集群地址</span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 这里不会重新注册，因为短暂的网络断开不会删除临时节点</span>
</span></span><span style=display:flex><span>            logger.<span style=color:#50fa7b>warn</span>(<span style=color:#f1fa8c>&#34;Trying to fetch the latest urls, in case there&#39;re provider changes during connection loss.\n&#34;</span> <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34; Since ephemeral ZNode will not get deleted for a connection lose, &#34;</span> <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;there&#39;s no need to re-register url of this instance.&#34;</span>);
</span></span><span style=display:flex><span>            ZookeeperRegistry.<span style=color:#50fa7b>this</span>.<span style=color:#50fa7b>fetchLatestAddresses</span>();
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (state <span style=color:#ff79c6>==</span> StateListener.<span style=color:#50fa7b>NEW_SESSION_CREATED</span>) {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 经历SESSION_LOST并且重新连接之后</span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 需要重新注册和监听</span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 因为zk可能因为网络抖动+延迟删除节点，导致我们在注册时提示节点已存在</span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 但是过一会zk把节点删除，这样就会导致节点丢失</span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 这个recover()就是调用FailbackRegistry把注册和定于添加定时任务，到时候会执行这个类的doRegister方法</span>
</span></span><span style=display:flex><span>            logger.<span style=color:#50fa7b>warn</span>(<span style=color:#f1fa8c>&#34;Trying to re-register urls and re-subscribe listeners of this instance to registry...&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>                ZookeeperRegistry.<span style=color:#50fa7b>this</span>.<span style=color:#50fa7b>recover</span>();
</span></span><span style=display:flex><span>            } <span style=color:#ff79c6>catch</span> (Exception e) {
</span></span><span style=display:flex><span>                logger.<span style=color:#50fa7b>error</span>(e.<span style=color:#50fa7b>getMessage</span>(), e);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (state <span style=color:#ff79c6>==</span> StateListener.<span style=color:#50fa7b>SESSION_LOST</span>) {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 连接断开的时间超过了阈值，此时会话过期，zk端会把当前客户端创建的临时节点删除</span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 客户端户收到一个SESSION_LOST的监听回调</span>
</span></span><span style=display:flex><span>            logger.<span style=color:#50fa7b>warn</span>(<span style=color:#f1fa8c>&#34;Url of this instance will be deleted from registry soon. &#34;</span> <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;Dubbo client will try to re-register once a new session is created.&#34;</span>);
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (state <span style=color:#ff79c6>==</span> StateListener.<span style=color:#50fa7b>SUSPENDED</span>) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (state <span style=color:#ff79c6>==</span> StateListener.<span style=color:#50fa7b>CONNECTED</span>) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>ZookeeperRegistry的构造方法中会调用CacheableFailbackRegistry的构造方法：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#50fa7b>CacheableFailbackRegistry</span>(URL url) {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 初始化重试时间轮</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>super</span>(url);
</span></span><span style=display:flex><span>    extraParameters <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> HashMap<span style=color:#ff79c6>&lt;&gt;</span>(8);
</span></span><span style=display:flex><span>    extraParameters.<span style=color:#50fa7b>put</span>(CHECK_KEY, String.<span style=color:#50fa7b>valueOf</span>(<span style=color:#ff79c6>false</span>));
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 定时缓存清理使用单线程线程池</span>
</span></span><span style=display:flex><span>    cacheRemovalScheduler <span style=color:#ff79c6>=</span> url.<span style=color:#50fa7b>getOrDefaultApplicationModel</span>().<span style=color:#50fa7b>getExtensionLoader</span>(ExecutorRepository.<span style=color:#50fa7b>class</span>).<span style=color:#50fa7b>getDefaultExtension</span>().<span style=color:#50fa7b>nextScheduledExecutor</span>();
</span></span><span style=display:flex><span>    cacheRemovalTaskIntervalInMillis <span style=color:#ff79c6>=</span> getIntConfig(url.<span style=color:#50fa7b>getScopeModel</span>(), CACHE_CLEAR_TASK_INTERVAL, 2 <span style=color:#ff79c6>*</span> 60 <span style=color:#ff79c6>*</span> 1000);
</span></span><span style=display:flex><span>    cacheClearWaitingThresholdInMillis <span style=color:#ff79c6>=</span> getIntConfig(url.<span style=color:#50fa7b>getScopeModel</span>(), CACHE_CLEAR_WAITING_THRESHOLD, 5 <span style=color:#ff79c6>*</span> 60 <span style=color:#ff79c6>*</span> 1000);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>CacheableFailbackRegistry的构造方法会调用FailbackRegistry的构造方法：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#50fa7b>FailbackRegistry</span>(URL url) {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 拿到这个url先去创建磁盘缓存文件，如果文件已经存在还会读取磁盘缓存</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>super</span>(url);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 设置重试间隔，默认5s</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>retryPeriod</span> <span style=color:#ff79c6>=</span> url.<span style=color:#50fa7b>getParameter</span>(REGISTRY_RETRY_PERIOD_KEY, DEFAULT_REGISTRY_RETRY_PERIOD);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 初始化时间轮</span>
</span></span><span style=display:flex><span>    retryTimer <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> HashedWheelTimer(<span style=color:#ff79c6>new</span> NamedThreadFactory(<span style=color:#f1fa8c>&#34;DubboRegistryRetryTimer&#34;</span>, <span style=color:#ff79c6>true</span>), retryPeriod, TimeUnit.<span style=color:#50fa7b>MILLISECONDS</span>, 128);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>FailbackRegistry的构造方法最后会调AbstractRegistry的构造方法：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#50fa7b>AbstractRegistry</span>(URL url) {
</span></span><span style=display:flex><span>    setUrl(url);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 从Model组件里获取Bean工厂，在获取RegistryManager</span>
</span></span><span style=display:flex><span>    registryManager <span style=color:#ff79c6>=</span> url.<span style=color:#50fa7b>getOrDefaultApplicationModel</span>().<span style=color:#50fa7b>getBeanFactory</span>().<span style=color:#50fa7b>getBean</span>(RegistryManager.<span style=color:#50fa7b>class</span>);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 是否开启本地磁盘缓存</span>
</span></span><span style=display:flex><span>    localCacheEnabled <span style=color:#ff79c6>=</span> url.<span style=color:#50fa7b>getParameter</span>(REGISTRY_LOCAL_FILE_CACHE_ENABLED, <span style=color:#ff79c6>true</span>);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 获取共享线程池</span>
</span></span><span style=display:flex><span>    registryCacheExecutor <span style=color:#ff79c6>=</span> url.<span style=color:#50fa7b>getOrDefaultApplicationModel</span>().<span style=color:#50fa7b>getDefaultExtension</span>(ExecutorRepository.<span style=color:#50fa7b>class</span>).<span style=color:#50fa7b>getSharedExecutor</span>();
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (localCacheEnabled) {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 开启刷盘定时任务</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 同步刷盘，默认是false</span>
</span></span><span style=display:flex><span>        syncSaveFile <span style=color:#ff79c6>=</span> url.<span style=color:#50fa7b>getParameter</span>(REGISTRY_FILESAVE_SYNC_KEY, <span style=color:#ff79c6>false</span>);
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 获取缓存文件的目录和文件名</span>
</span></span><span style=display:flex><span>        String defaultFilename <span style=color:#ff79c6>=</span> System.<span style=color:#50fa7b>getProperty</span>(USER_HOME) <span style=color:#ff79c6>+</span> DUBBO_REGISTRY <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>            url.<span style=color:#50fa7b>getApplication</span>() <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;-&#34;</span> <span style=color:#ff79c6>+</span> url.<span style=color:#50fa7b>getAddress</span>().<span style=color:#50fa7b>replaceAll</span>(<span style=color:#f1fa8c>&#34;:&#34;</span>, <span style=color:#f1fa8c>&#34;-&#34;</span>) <span style=color:#ff79c6>+</span> CACHE;
</span></span><span style=display:flex><span>        String filename <span style=color:#ff79c6>=</span> url.<span style=color:#50fa7b>getParameter</span>(FILE_KEY, defaultFilename);
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 获取file对象和创建目录</span>
</span></span><span style=display:flex><span>        File file <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (ConfigUtils.<span style=color:#50fa7b>isNotEmpty</span>(filename)) {
</span></span><span style=display:flex><span>            file <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> File(filename);
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>file.<span style=color:#50fa7b>exists</span>() <span style=color:#ff79c6>&amp;&amp;</span> file.<span style=color:#50fa7b>getParentFile</span>() <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!</span>file.<span style=color:#50fa7b>getParentFile</span>().<span style=color:#50fa7b>exists</span>()) {
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>file.<span style=color:#50fa7b>getParentFile</span>().<span style=color:#50fa7b>mkdirs</span>()) {
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> IllegalArgumentException(<span style=color:#f1fa8c>&#34;Invalid registry cache file &#34;</span> <span style=color:#ff79c6>+</span> file <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;, cause: Failed to create directory &#34;</span> <span style=color:#ff79c6>+</span> file.<span style=color:#50fa7b>getParentFile</span>() <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;!&#34;</span>);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>file</span> <span style=color:#ff79c6>=</span> file;
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 先把磁盘缓存读取出来</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 为了远程订阅失败的容错</span>
</span></span><span style=display:flex><span>        loadProperties();
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 先拿到备用的url，备用的url里最少也要有一个当前url自己</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 启动的时候这步什么都没干</span>
</span></span><span style=display:flex><span>        notify(url.<span style=color:#50fa7b>getBackupUrls</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>父类的构造方法调用完了之后就开始建立zk的链接并且添加状态监听，调用Curator5ZookeeperTransporter的connect()方法，通过双重检查建立一个curator的客户端，初始化curator客户端的源码：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#50fa7b>Curator5ZookeeperClient</span>(URL url) {
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>super</span>(url);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 连接超时时间和会话过期时间</span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd>int</span> timeout <span style=color:#ff79c6>=</span> url.<span style=color:#50fa7b>getParameter</span>(TIMEOUT_KEY, DEFAULT_CONNECTION_TIMEOUT_MS);
</span></span><span style=display:flex><span>        <span style=color:#8be9fd>int</span> sessionExpireMs <span style=color:#ff79c6>=</span> url.<span style=color:#50fa7b>getParameter</span>(ZK_SESSION_EXPIRE_KEY, DEFAULT_SESSION_TIMEOUT_MS);
</span></span><span style=display:flex><span>        CuratorFrameworkFactory.<span style=color:#50fa7b>Builder</span> builder <span style=color:#ff79c6>=</span> CuratorFrameworkFactory.<span style=color:#50fa7b>builder</span>()
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>connectString</span>(url.<span style=color:#50fa7b>getBackupAddress</span>())
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>retryPolicy</span>(<span style=color:#ff79c6>new</span> RetryNTimes(1, 1000)) <span style=color:#6272a4>// 连接失败过1s再重试1次</span>
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>connectionTimeoutMs</span>(timeout)
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>sessionTimeoutMs</span>(sessionExpireMs);
</span></span><span style=display:flex><span>        String authority <span style=color:#ff79c6>=</span> url.<span style=color:#50fa7b>getAuthority</span>();
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (authority <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> authority.<span style=color:#50fa7b>length</span>() <span style=color:#ff79c6>&gt;</span> 0) {
</span></span><span style=display:flex><span>            builder <span style=color:#ff79c6>=</span> builder.<span style=color:#50fa7b>authorization</span>(<span style=color:#f1fa8c>&#34;digest&#34;</span>, authority.<span style=color:#50fa7b>getBytes</span>());
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        client <span style=color:#ff79c6>=</span> builder.<span style=color:#50fa7b>build</span>();
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 添加状态监听</span>
</span></span><span style=display:flex><span>        client.<span style=color:#50fa7b>getConnectionStateListenable</span>().<span style=color:#50fa7b>addListener</span>(<span style=color:#ff79c6>new</span> CuratorConnectionStateListener(url));
</span></span><span style=display:flex><span>        client.<span style=color:#50fa7b>start</span>();
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 阻塞等待结果</span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd>boolean</span> connected <span style=color:#ff79c6>=</span> client.<span style=color:#50fa7b>blockUntilConnected</span>(timeout, TimeUnit.<span style=color:#50fa7b>MILLISECONDS</span>);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>connected) {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> IllegalStateException(<span style=color:#f1fa8c>&#34;zookeeper not connected&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>catch</span> (Exception e) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> IllegalStateException(e.<span style=color:#50fa7b>getMessage</span>(), e);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p><strong>注册</strong>的方法并没有重写父类的，所以注册会先进到FailbackRegistry的register()方法：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>register</span>(URL url) {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>acceptable(url)) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>super</span>.<span style=color:#50fa7b>register</span>(url);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 把这个url相关的失败注册、下线任务清理</span>
</span></span><span style=display:flex><span>    removeFailedRegistered(url);
</span></span><span style=display:flex><span>    removeFailedUnregistered(url);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 这里调用具体子类的逻辑</span>
</span></span><span style=display:flex><span>        doRegister(url);
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>catch</span> (Exception e) {
</span></span><span style=display:flex><span>        Throwable t <span style=color:#ff79c6>=</span> e;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 配置check参数是false才会重试</span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd>boolean</span> check <span style=color:#ff79c6>=</span> getUrl().<span style=color:#50fa7b>getParameter</span>(Constants.<span style=color:#50fa7b>CHECK_KEY</span>, <span style=color:#ff79c6>true</span>)
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>&amp;&amp;</span> url.<span style=color:#50fa7b>getParameter</span>(Constants.<span style=color:#50fa7b>CHECK_KEY</span>, <span style=color:#ff79c6>true</span>)
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!</span>(url.<span style=color:#50fa7b>getPort</span>() <span style=color:#ff79c6>==</span> 0);
</span></span><span style=display:flex><span>        <span style=color:#8be9fd>boolean</span> skipFailback <span style=color:#ff79c6>=</span> t <span style=color:#ff79c6>instanceof</span> SkipFailbackWrapperException;
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (check <span style=color:#ff79c6>||</span> skipFailback) {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (skipFailback) {
</span></span><span style=display:flex><span>                t <span style=color:#ff79c6>=</span> t.<span style=color:#50fa7b>getCause</span>();
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> IllegalStateException(<span style=color:#f1fa8c>&#34;Failed to register &#34;</span> <span style=color:#ff79c6>+</span> url <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; to registry &#34;</span> <span style=color:#ff79c6>+</span> getUrl().<span style=color:#50fa7b>getAddress</span>() <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;, cause: &#34;</span> <span style=color:#ff79c6>+</span> t.<span style=color:#50fa7b>getMessage</span>(), t);
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>            logger.<span style=color:#50fa7b>error</span>(<span style=color:#f1fa8c>&#34;Failed to register &#34;</span> <span style=color:#ff79c6>+</span> url <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;, waiting for retry, cause: &#34;</span> <span style=color:#ff79c6>+</span> t.<span style=color:#50fa7b>getMessage</span>(), t);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 注册失败向时间轮中添加失败任务</span>
</span></span><span style=display:flex><span>        addFailedRegistered(url);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>doRegister()就是用zkClient创建临时节点：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>@Override
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>doRegister</span>(URL url) {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 这个就是检查zkClient有没有被初始化</span>
</span></span><span style=display:flex><span>        checkDestroyed();
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 把URL转成目录，创建临时节点</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 目录类似于/dubbo/接口路径/categoryPath[provider,consumer]/ip……</span>
</span></span><span style=display:flex><span>        zkClient.<span style=color:#50fa7b>create</span>(toUrlPath(url), url.<span style=color:#50fa7b>getParameter</span>(DYNAMIC_KEY, <span style=color:#ff79c6>true</span>));
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>catch</span> (Throwable e) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> RpcException(<span style=color:#f1fa8c>&#34;Failed to register &#34;</span> <span style=color:#ff79c6>+</span> url <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; to zookeeper &#34;</span> <span style=color:#ff79c6>+</span> getUrl() <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;, cause: &#34;</span> <span style=color:#ff79c6>+</span> e.<span style=color:#50fa7b>getMessage</span>(), e);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>创建临时节点就是调用curator的api：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>createEphemeral</span>(String path) {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>        client.<span style=color:#50fa7b>create</span>().<span style=color:#50fa7b>withMode</span>(CreateMode.<span style=color:#50fa7b>EPHEMERAL</span>).<span style=color:#50fa7b>forPath</span>(path);
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>catch</span> (NodeExistsException e) {
</span></span><span style=display:flex><span>        logger.<span style=color:#50fa7b>warn</span>(<span style=color:#f1fa8c>&#34;ZNode &#34;</span> <span style=color:#ff79c6>+</span> path <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; already exists, since we will only try to recreate a node on a session expiration, this duplication might be caused by a delete delay from the zk server, which means the old expired session may still holds this ZNode and the server just hasn&#39;t got time to do the deletion. In this case, we can just try to delete and create again.&#34;</span>, e);
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 如果重复创建，要先删掉这个节点，在重新注册</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 这个就是解决zk因为网络抖动节点丢失的问题</span>
</span></span><span style=display:flex><span>        deletePath(path);
</span></span><span style=display:flex><span>        createEphemeral(path);
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>catch</span> (Exception e) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> IllegalStateException(e.<span style=color:#50fa7b>getMessage</span>(), e);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>下线的操作和注册差不多。</p><p><strong>订阅</strong>也是走到了FailbackRegistry的subscribe()方法:</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>subscribe</span>(URL url, NotifyListener listener) {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 调用父类的订阅方法</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 把传进来的监听器放到set里</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>super</span>.<span style=color:#50fa7b>subscribe</span>(url, listener);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 移除失败的订阅任务</span>
</span></span><span style=display:flex><span>    removeFailedSubscribed(url, listener);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// Sending a subscription request to the server side</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 这里就是执行订阅的代码，直接走到了zkRegistry中</span>
</span></span><span style=display:flex><span>        doSubscribe(url, listener);
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>catch</span> (Exception e) {
</span></span><span style=display:flex><span>        Throwable t <span style=color:#ff79c6>=</span> e;
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 如果失败的话尝试拿到之前从磁盘缓存读取出来的url信息容错处理</span>
</span></span><span style=display:flex><span>        List<span style=color:#ff79c6>&lt;</span>URL<span style=color:#ff79c6>&gt;</span> urls <span style=color:#ff79c6>=</span> getCacheUrls(url);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (CollectionUtils.<span style=color:#50fa7b>isNotEmpty</span>(urls)) {
</span></span><span style=display:flex><span>            notify(url, listener, urls);
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 没有缓存并且配置check参数是false才会重试</span>
</span></span><span style=display:flex><span>            <span style=color:#8be9fd>boolean</span> check <span style=color:#ff79c6>=</span> getUrl().<span style=color:#50fa7b>getParameter</span>(Constants.<span style=color:#50fa7b>CHECK_KEY</span>, <span style=color:#ff79c6>true</span>)
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>&amp;&amp;</span> url.<span style=color:#50fa7b>getParameter</span>(Constants.<span style=color:#50fa7b>CHECK_KEY</span>, <span style=color:#ff79c6>true</span>);
</span></span><span style=display:flex><span>            <span style=color:#8be9fd>boolean</span> skipFailback <span style=color:#ff79c6>=</span> t <span style=color:#ff79c6>instanceof</span> SkipFailbackWrapperException;
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (check <span style=color:#ff79c6>||</span> skipFailback) {
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>if</span> (skipFailback) {
</span></span><span style=display:flex><span>                    t <span style=color:#ff79c6>=</span> t.<span style=color:#50fa7b>getCause</span>();
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> IllegalStateException(<span style=color:#f1fa8c>&#34;Failed to subscribe &#34;</span> <span style=color:#ff79c6>+</span> url <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;, cause: &#34;</span> <span style=color:#ff79c6>+</span> t.<span style=color:#50fa7b>getMessage</span>(), t);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// Record a failed registration request to a failed list, retry regularly</span>
</span></span><span style=display:flex><span>        addFailedSubscribed(url, listener);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>doSubscribe()又会调到ZookeeperRegistry里：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>doSubscribe</span>(<span style=color:#8be9fd;font-style:italic>final</span> URL url, <span style=color:#8be9fd;font-style:italic>final</span> NotifyListener listener) {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>        checkDestroyed();
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (ANY_VALUE.<span style=color:#50fa7b>equals</span>(url.<span style=color:#50fa7b>getServiceInterface</span>())) {
</span></span><span style=display:flex><span>            String root <span style=color:#ff79c6>=</span> toRootPath();
</span></span><span style=display:flex><span>            <span style=color:#8be9fd>boolean</span> check <span style=color:#ff79c6>=</span> url.<span style=color:#50fa7b>getParameter</span>(CHECK_KEY, <span style=color:#ff79c6>false</span>);
</span></span><span style=display:flex><span>            ConcurrentMap<span style=color:#ff79c6>&lt;</span>NotifyListener, ChildListener<span style=color:#ff79c6>&gt;</span> listeners <span style=color:#ff79c6>=</span> zkListeners.<span style=color:#50fa7b>computeIfAbsent</span>(url, k <span style=color:#ff79c6>-&gt;</span> <span style=color:#ff79c6>new</span> ConcurrentHashMap<span style=color:#ff79c6>&lt;&gt;</span>());
</span></span><span style=display:flex><span>            ChildListener zkListener <span style=color:#ff79c6>=</span> listeners.<span style=color:#50fa7b>computeIfAbsent</span>(listener, k <span style=color:#ff79c6>-&gt;</span> (parentPath, currentChilds) <span style=color:#ff79c6>-&gt;</span> {
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>for</span> (String child : currentChilds) {
</span></span><span style=display:flex><span>                    child <span style=color:#ff79c6>=</span> URL.<span style=color:#50fa7b>decode</span>(child);
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>anyServices.<span style=color:#50fa7b>contains</span>(child)) {
</span></span><span style=display:flex><span>                        anyServices.<span style=color:#50fa7b>add</span>(child);
</span></span><span style=display:flex><span>                        subscribe(url.<span style=color:#50fa7b>setPath</span>(child).<span style=color:#50fa7b>addParameters</span>(INTERFACE_KEY, child,
</span></span><span style=display:flex><span>                            Constants.<span style=color:#50fa7b>CHECK_KEY</span>, String.<span style=color:#50fa7b>valueOf</span>(check)), k);
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            });
</span></span><span style=display:flex><span>            zkClient.<span style=color:#50fa7b>create</span>(root, <span style=color:#ff79c6>false</span>);
</span></span><span style=display:flex><span>            List<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span> services <span style=color:#ff79c6>=</span> zkClient.<span style=color:#50fa7b>addChildListener</span>(root, zkListener);
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (CollectionUtils.<span style=color:#50fa7b>isNotEmpty</span>(services)) {
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>for</span> (String service : services) {
</span></span><span style=display:flex><span>                    service <span style=color:#ff79c6>=</span> URL.<span style=color:#50fa7b>decode</span>(service);
</span></span><span style=display:flex><span>                    anyServices.<span style=color:#50fa7b>add</span>(service);
</span></span><span style=display:flex><span>                    subscribe(url.<span style=color:#50fa7b>setPath</span>(service).<span style=color:#50fa7b>addParameters</span>(INTERFACE_KEY, service,
</span></span><span style=display:flex><span>                        Constants.<span style=color:#50fa7b>CHECK_KEY</span>, String.<span style=color:#50fa7b>valueOf</span>(check)), listener);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 正常来说都是针对指定的接口进行监听</span>
</span></span><span style=display:flex><span>            CountDownLatch latch <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> CountDownLatch(1);
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>                List<span style=color:#ff79c6>&lt;</span>URL<span style=color:#ff79c6>&gt;</span> urls <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ArrayList<span style=color:#ff79c6>&lt;&gt;</span>();
</span></span><span style=display:flex><span>                <span style=color:#6272a4>// toCategoriesPath()拿到的是/dubbo/接口路径/provider</span>
</span></span><span style=display:flex><span>                <span style=color:#6272a4>// 拿到这个节点之后就可以监听这个节点下的子节点了</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>for</span> (String path : toCategoriesPath(url)) {
</span></span><span style=display:flex><span>                    ConcurrentMap<span style=color:#ff79c6>&lt;</span>NotifyListener, ChildListener<span style=color:#ff79c6>&gt;</span> listeners <span style=color:#ff79c6>=</span> zkListeners.<span style=color:#50fa7b>computeIfAbsent</span>(url, k <span style=color:#ff79c6>-&gt;</span> <span style=color:#ff79c6>new</span> ConcurrentHashMap<span style=color:#ff79c6>&lt;&gt;</span>());
</span></span><span style=display:flex><span>                    <span style=color:#6272a4>// ChildListener是zk的子节点监听</span>
</span></span><span style=display:flex><span>                    ChildListener zkListener <span style=color:#ff79c6>=</span> listeners.<span style=color:#50fa7b>computeIfAbsent</span>(listener, k <span style=color:#ff79c6>-&gt;</span> <span style=color:#ff79c6>new</span> RegistryChildListenerImpl(url, path, k, latch));
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>if</span> (zkListener <span style=color:#ff79c6>instanceof</span> RegistryChildListenerImpl) {
</span></span><span style=display:flex><span>                        ((RegistryChildListenerImpl) zkListener).<span style=color:#50fa7b>setLatch</span>(latch);
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                    <span style=color:#6272a4>// 创建持久节点</span>
</span></span><span style=display:flex><span>                    <span style=color:#6272a4>// 其实是对/dubbo/接口路径/provider路径的检查</span>
</span></span><span style=display:flex><span>                    zkClient.<span style=color:#50fa7b>create</span>(path, <span style=color:#ff79c6>false</span>);
</span></span><span style=display:flex><span>                    <span style=color:#6272a4>// 对子节点监听</span>
</span></span><span style=display:flex><span>                    List<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span> children <span style=color:#ff79c6>=</span> zkClient.<span style=color:#50fa7b>addChildListener</span>(path, zkListener);
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>if</span> (children <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>                        <span style=color:#6272a4>// 每个children都是一个子节点字符串，把他们转成具体的服务URL</span>
</span></span><span style=display:flex><span>                        <span style=color:#6272a4>// 而且toUrlsWithEmpty调用的是CacheableFailbackRegistry父类</span>
</span></span><span style=display:flex><span>                        urls.<span style=color:#50fa7b>addAll</span>(toUrlsWithEmpty(url, path, children));
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#6272a4>// 这里是对每个实例的客户端建立netty连接</span>
</span></span><span style=display:flex><span>                <span style=color:#6272a4>// 这个类里的notify()就是调用父类的notify()</span>
</span></span><span style=display:flex><span>                notify(url, listener, urls);
</span></span><span style=display:flex><span>            } <span style=color:#ff79c6>finally</span> {
</span></span><span style=display:flex><span>                <span style=color:#6272a4>// tells the listener to run only after the sync notification of main thread finishes.</span>
</span></span><span style=display:flex><span>                latch.<span style=color:#50fa7b>countDown</span>();
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>catch</span> (Throwable e) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> RpcException(<span style=color:#f1fa8c>&#34;Failed to subscribe &#34;</span> <span style=color:#ff79c6>+</span> url <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; to zookeeper &#34;</span> <span style=color:#ff79c6>+</span> getUrl() <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;, cause: &#34;</span> <span style=color:#ff79c6>+</span> e.<span style=color:#50fa7b>getMessage</span>(), e);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>调用toUrlsWithEmpty()进行raw url -> URL的时候，使用父类进行缓存优化。</p><p>notify()方法会去调用抽象父类AbstractRegistry里：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>protected</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>notify</span>(URL url, NotifyListener listener, List<span style=color:#ff79c6>&lt;</span>URL<span style=color:#ff79c6>&gt;</span> urls) {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 上面是一堆校验</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// keep every provider&#39;s category.</span>
</span></span><span style=display:flex><span>    Map<span style=color:#ff79c6>&lt;</span>String, List<span style=color:#ff79c6>&lt;</span>URL<span style=color:#ff79c6>&gt;&gt;</span> result <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> HashMap<span style=color:#ff79c6>&lt;&gt;</span>();
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> (URL u : urls) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (UrlUtils.<span style=color:#50fa7b>isMatch</span>(url, u)) {
</span></span><span style=display:flex><span>            String category <span style=color:#ff79c6>=</span> u.<span style=color:#50fa7b>getCategory</span>(DEFAULT_CATEGORY);
</span></span><span style=display:flex><span>            List<span style=color:#ff79c6>&lt;</span>URL<span style=color:#ff79c6>&gt;</span> categoryList <span style=color:#ff79c6>=</span> result.<span style=color:#50fa7b>computeIfAbsent</span>(category, k <span style=color:#ff79c6>-&gt;</span> <span style=color:#ff79c6>new</span> ArrayList<span style=color:#ff79c6>&lt;&gt;</span>());
</span></span><span style=display:flex><span>            categoryList.<span style=color:#50fa7b>add</span>(u);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (result.<span style=color:#50fa7b>size</span>() <span style=color:#ff79c6>==</span> 0) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    Map<span style=color:#ff79c6>&lt;</span>String, List<span style=color:#ff79c6>&lt;</span>URL<span style=color:#ff79c6>&gt;&gt;</span> categoryNotified <span style=color:#ff79c6>=</span> notified.<span style=color:#50fa7b>computeIfAbsent</span>(url, u <span style=color:#ff79c6>-&gt;</span> <span style=color:#ff79c6>new</span> ConcurrentHashMap<span style=color:#ff79c6>&lt;&gt;</span>());
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 遍历 回调listener的notify()</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> (Map.<span style=color:#50fa7b>Entry</span><span style=color:#ff79c6>&lt;</span>String, List<span style=color:#ff79c6>&lt;</span>URL<span style=color:#ff79c6>&gt;&gt;</span> entry : result.<span style=color:#50fa7b>entrySet</span>()) {
</span></span><span style=display:flex><span>        String category <span style=color:#ff79c6>=</span> entry.<span style=color:#50fa7b>getKey</span>();
</span></span><span style=display:flex><span>        List<span style=color:#ff79c6>&lt;</span>URL<span style=color:#ff79c6>&gt;</span> categoryList <span style=color:#ff79c6>=</span> entry.<span style=color:#50fa7b>getValue</span>();
</span></span><span style=display:flex><span>        categoryNotified.<span style=color:#50fa7b>put</span>(category, categoryList);
</span></span><span style=display:flex><span>        listener.<span style=color:#50fa7b>notify</span>(categoryList);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (localCacheEnabled) {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 缓存数据刷盘</span>
</span></span><span style=display:flex><span>            saveProperties(url);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>listener.notify()，这个listener是NotifyListener类型，这里的notify()走到了RegistryDirectory里，因为RegistryDirectory继承了DynamicDirectory，而DynamicDirectory是实现了NotifyListener接口的。就是在RegistryDirectory里进行了netty连接+DubboInvoker封装。</p><h6 id=2nacosregistry源码>2）NacosRegistry源码<a hidden class=anchor aria-hidden=true href=#2nacosregistry源码>#</a></h6><p>NacosRegistry是直接注册FailbackRegistry的，没有row url -> URL的转换。和zk的registry思路一样，只不多他使用的是nacos提供的api。</p><h6 id=3dnsregistry>3）DNSRegistry<a hidden class=anchor aria-hidden=true href=#3dnsregistry>#</a></h6><p>使用dns当注册中心，那么dns保存的就不是域名和ip的映射了，保存的应该是接口名称和ip的映射。</p><p>dubbo中没有实现DNSRegistry，里面都是空方法。但是他有个DNSServiceDiscovery。</p><h5 id=2配置中心>2.配置中心<a hidden class=anchor aria-hidden=true href=#2配置中心>#</a></h5><p>获取具体的配置中心是根据配置中心的url中的protocol属性，protocol可以是nacos、zookeeper、appllo。</p><p>配置中心没有什么代码，都是别人声明一个监听，然后来调用配置中心添加监听器，这样配置发生变化的时候，对应的关注这个配置的类就会收到监听。</p><h6 id=1zookeeperdynamicconfiguration>1）ZookeeperDynamicConfiguration<a hidden class=anchor aria-hidden=true href=#1zookeeperdynamicconfiguration>#</a></h6><p>看下构造方法：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>ZookeeperDynamicConfiguration(URL url, ZookeeperTransporter zookeeperTransporter) {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 这个url就是zk的链接地址</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// super(url)里也没干啥，就是创建了个线程池</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>super</span>(url);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>url</span> <span style=color:#ff79c6>=</span> url;
</span></span><span style=display:flex><span>    rootPath <span style=color:#ff79c6>=</span> getRootPath(url);
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// 这个就是缓存每个节点对应的所有监听器的</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>cacheListener</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> CacheListener(rootPath);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>final</span> String threadName <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>getClass</span>().<span style=color:#50fa7b>getSimpleName</span>();
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 又搞了个线程池</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>executor</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ThreadPoolExecutor(DEFAULT_ZK_EXECUTOR_THREADS_NUM, DEFAULT_ZK_EXECUTOR_THREADS_NUM,
</span></span><span style=display:flex><span>            THREAD_KEEP_ALIVE_TIME, TimeUnit.<span style=color:#50fa7b>MILLISECONDS</span>,
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>new</span> LinkedBlockingQueue<span style=color:#ff79c6>&lt;</span>Runnable<span style=color:#ff79c6>&gt;</span>(DEFAULT_QUEUE),
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>new</span> NamedThreadFactory(threadName, <span style=color:#ff79c6>true</span>),
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>new</span> AbortPolicyWithReport(threadName, url));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 基于ZookeeperTransporter创建zk客户端</span>
</span></span><span style=display:flex><span>    zkClient <span style=color:#ff79c6>=</span> zookeeperTransporter.<span style=color:#50fa7b>connect</span>(url);
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>boolean</span> isConnected <span style=color:#ff79c6>=</span> zkClient.<span style=color:#50fa7b>isConnected</span>();
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>isConnected) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> IllegalStateException(<span style=color:#f1fa8c>&#34;Failed to connect with zookeeper, pls check if url &#34;</span> <span style=color:#ff79c6>+</span> url <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; is correct.&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>添加监听：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * 这个方法在MeshRuleManager和MigrationRuleListener初始化的时候会调用CompositeDynamicConfiguration的addListener()
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * 然后调到这个方法添加监听
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * 当监听到节点有变化时就会反过来调用监听
</span></span></span><span style=display:flex><span><span style=color:#6272a4> */</span>
</span></span><span style=display:flex><span>@Override
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>protected</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>doAddListener</span>(String pathKey, ConfigurationListener listener) {
</span></span><span style=display:flex><span>    cacheListener.<span style=color:#50fa7b>addListener</span>(pathKey, listener);
</span></span><span style=display:flex><span>    zkClient.<span style=color:#50fa7b>addDataListener</span>(pathKey, cacheListener, executor);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h6 id=2nacos和apollo配置中心>2）nacos和apollo配置中心<a hidden class=anchor aria-hidden=true href=#2nacos和apollo配置中心>#</a></h6><p>他俩和zk的思路一样，都是维护一堆监听，收到对应配置中心回调的时候再去回调维护的监听，而且都有现成的api。</p><h6 id=3元数据中心>3）元数据中心<a hidden class=anchor aria-hidden=true href=#3元数据中心>#</a></h6><p>以provider启动来说，在ServiceConfig的init()方法中会获取ModelDeployer，然后调用他的start()方法，然后调用ApplicationDeployer的initialize()方法，这个方法里会初始化配置中心和元数据中心。就是把接口的属性、版本号什么赋值，然后在发布的时候，判断需要远程发布的下面有一行代码是上报元数据的：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>MetadataUtils.<span style=color:#50fa7b>publishServiceDefinition</span>(url);
</span></span></code></pre></td></tr></table></div></div><p>最终会调用到AbstractMetadataReport的storeProviderMetadataTask()：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>storeProviderMetadataTask</span>(MetadataIdentifier providerMetadataIdentifier, ServiceDefinition serviceDefinition) {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (logger.<span style=color:#50fa7b>isInfoEnabled</span>()) {
</span></span><span style=display:flex><span>            logger.<span style=color:#50fa7b>info</span>(<span style=color:#f1fa8c>&#34;store provider metadata. Identifier : &#34;</span> <span style=color:#ff79c6>+</span> providerMetadataIdentifier <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;; definition: &#34;</span> <span style=color:#ff79c6>+</span> serviceDefinition);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        allMetadataReports.<span style=color:#50fa7b>put</span>(providerMetadataIdentifier, serviceDefinition);
</span></span><span style=display:flex><span>        failedReports.<span style=color:#50fa7b>remove</span>(providerMetadataIdentifier);
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 把元数据转成json</span>
</span></span><span style=display:flex><span>        Gson gson <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> Gson();
</span></span><span style=display:flex><span>        String data <span style=color:#ff79c6>=</span> gson.<span style=color:#50fa7b>toJson</span>(serviceDefinition);
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 调用对应的元数据上报实现，上报元数据</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 比如zookeeper就是ZookeeperMetadataReport</span>
</span></span><span style=display:flex><span>        doStoreProviderMetadata(providerMetadataIdentifier, data);
</span></span><span style=display:flex><span>        saveProperties(providerMetadataIdentifier, data, <span style=color:#ff79c6>true</span>, <span style=color:#ff79c6>!</span>syncReport);
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>catch</span> (Exception e) {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// retry again. If failed again, throw exception.</span>
</span></span><span style=display:flex><span>        failedReports.<span style=color:#50fa7b>put</span>(providerMetadataIdentifier, serviceDefinition);
</span></span><span style=display:flex><span>        metadataReportRetry.<span style=color:#50fa7b>startRetryTask</span>();
</span></span><span style=display:flex><span>        logger.<span style=color:#50fa7b>error</span>(<span style=color:#f1fa8c>&#34;Failed to put provider metadata &#34;</span> <span style=color:#ff79c6>+</span> providerMetadataIdentifier <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; in  &#34;</span> <span style=color:#ff79c6>+</span> serviceDefinition <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;, cause: &#34;</span> <span style=color:#ff79c6>+</span> e.<span style=color:#50fa7b>getMessage</span>(), e);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=三启动时检查>三、启动时检查<a hidden class=anchor aria-hidden=true href=#三启动时检查>#</a></h3><p>启动时检查的配置有3个</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#6272a4># 关闭具体服务的启动时检查，没有提供者时不报错</span>
</span></span><span style=display:flex><span><span style=color:#50fa7b>dubbo.reference.具体的接口路径.check</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>false</span>
</span></span><span style=display:flex><span><span style=color:#6272a4># 关闭所有服务的启动时检查</span>
</span></span><span style=display:flex><span><span style=color:#50fa7b>dubbo.consumer.check</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>false</span>
</span></span><span style=display:flex><span><span style=color:#6272a4># 关闭注册中心的启动时检查，关闭这个如果注册订阅失败也允许启动，会在后台定时重试</span>
</span></span><span style=display:flex><span><span style=color:#50fa7b>dubbo.registry.check</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>false</span>
</span></span></code></pre></td></tr></table></div></div><p>前两个都是针对consumer的，对应的代码在ReferenceConfig的checkInvokerAvailable()里：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>checkInvokerAvailable</span>() <span style=color:#8be9fd;font-style:italic>throws</span> IllegalStateException {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// shouldCheck()就是上面的参数，具体的还没看</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// invoker.isAvailable()就是通过netty判断是否连接</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (shouldCheck() <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!</span>invoker.<span style=color:#50fa7b>isAvailable</span>()) {
</span></span><span style=display:flex><span>        invoker.<span style=color:#50fa7b>destroy</span>();
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> IllegalStateException(<span style=color:#f1fa8c>&#34;Should has at least one way to know which services this interface belongs to,&#34;</span> <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; subscription url: &#34;</span> <span style=color:#ff79c6>+</span> invoker.<span style=color:#50fa7b>getUrl</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=四多注册中心>四、多注册中心<a hidden class=anchor aria-hidden=true href=#四多注册中心>#</a></h3><p>多注册中心的源码对应MultipleRegistry，代码都差不多，就是用for循环注册、订阅什么的。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://wangxiaohong123.github.io/tags/%E6%BA%90%E7%A0%81/>源码</a></li></ul><nav class=paginav><a class=prev href=https://wangxiaohong123.github.io/posts/ai/8.nlp/><span class=title>« Prev</span><br><span>8.自然语言处理-nlp</span>
</a><a class=next href=https://wangxiaohong123.github.io/posts/ai/9.%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BE%AE%E8%B0%83/><span class=title>Next »</span><br><span>9.大模型微调</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share 9.dubbo-高阶特性源码 on x" href="https://x.com/intent/tweet/?text=9.dubbo-%e9%ab%98%e9%98%b6%e7%89%b9%e6%80%a7%e6%ba%90%e7%a0%81&amp;url=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fspring%2fcloud-alibaba%2fdubbo%2f9.%25E9%25AB%2598%25E9%2598%25B6%25E7%2589%25B9%25E6%2580%25A7%25E6%25BA%2590%25E7%25A0%2581%2f&amp;hashtags=%e6%ba%90%e7%a0%81"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 9.dubbo-高阶特性源码 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fspring%2fcloud-alibaba%2fdubbo%2f9.%25E9%25AB%2598%25E9%2598%25B6%25E7%2589%25B9%25E6%2580%25A7%25E6%25BA%2590%25E7%25A0%2581%2f&amp;title=9.dubbo-%e9%ab%98%e9%98%b6%e7%89%b9%e6%80%a7%e6%ba%90%e7%a0%81&amp;summary=9.dubbo-%e9%ab%98%e9%98%b6%e7%89%b9%e6%80%a7%e6%ba%90%e7%a0%81&amp;source=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fspring%2fcloud-alibaba%2fdubbo%2f9.%25E9%25AB%2598%25E9%2598%25B6%25E7%2589%25B9%25E6%2580%25A7%25E6%25BA%2590%25E7%25A0%2581%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 9.dubbo-高阶特性源码 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fspring%2fcloud-alibaba%2fdubbo%2f9.%25E9%25AB%2598%25E9%2598%25B6%25E7%2589%25B9%25E6%2580%25A7%25E6%25BA%2590%25E7%25A0%2581%2f&title=9.dubbo-%e9%ab%98%e9%98%b6%e7%89%b9%e6%80%a7%e6%ba%90%e7%a0%81"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 9.dubbo-高阶特性源码 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fspring%2fcloud-alibaba%2fdubbo%2f9.%25E9%25AB%2598%25E9%2598%25B6%25E7%2589%25B9%25E6%2580%25A7%25E6%25BA%2590%25E7%25A0%2581%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 9.dubbo-高阶特性源码 on whatsapp" href="https://api.whatsapp.com/send?text=9.dubbo-%e9%ab%98%e9%98%b6%e7%89%b9%e6%80%a7%e6%ba%90%e7%a0%81%20-%20https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fspring%2fcloud-alibaba%2fdubbo%2f9.%25E9%25AB%2598%25E9%2598%25B6%25E7%2589%25B9%25E6%2580%25A7%25E6%25BA%2590%25E7%25A0%2581%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 9.dubbo-高阶特性源码 on telegram" href="https://telegram.me/share/url?text=9.dubbo-%e9%ab%98%e9%98%b6%e7%89%b9%e6%80%a7%e6%ba%90%e7%a0%81&amp;url=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fspring%2fcloud-alibaba%2fdubbo%2f9.%25E9%25AB%2598%25E9%2598%25B6%25E7%2589%25B9%25E6%2580%25A7%25E6%25BA%2590%25E7%25A0%2581%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 9.dubbo-高阶特性源码 on ycombinator" href="https://news.ycombinator.com/submitlink?t=9.dubbo-%e9%ab%98%e9%98%b6%e7%89%b9%e6%80%a7%e6%ba%90%e7%a0%81&u=https%3a%2f%2fwangxiaohong123.github.io%2fposts%2f%25E6%25A1%2586%25E6%259E%25B6%2fspring%2fcloud-alibaba%2fdubbo%2f9.%25E9%25AB%2598%25E9%2598%25B6%25E7%2589%25B9%25E6%2580%25A7%25E6%25BA%2590%25E7%25A0%2581%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://wangxiaohong123.github.io/>王小红的笔记</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>