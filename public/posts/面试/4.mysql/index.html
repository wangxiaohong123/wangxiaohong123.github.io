<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>面试-4.MySQL | 王小红的笔记</title>
<meta name="keywords" content="面试专题">
<meta name="description" content="1.MyISAM和InnoDB的区别
MyISAM不支持事务，不支持外键，索引文件和数据文件分开，并且他没有行锁。
InnoDB有自己的redo log，他要求必须要有一个自增的主键，如果我们没有指定他会自己生成一个，默认情况会有一个根据主键的B&#43;树索引，叫做聚簇索引，这个索引的叶子节点就是数据文件。
2.索引为什么不用二叉树、平衡二叉树、B树，而是使用B&#43;树
二叉树容易造成节点不平衡，影响查找速度；就算他改成了平衡二叉树，深度太大也会影响查找速度；B树的子节点也会存储数据，因为MySQL的数据页是16k固定大小，如果子节点存储数据，那么他能存储的子节点个数就会变少(子节点的个数也叫阶数)，也会影响深度，B&#43;树就是让这个索引结构更矮更胖，深度减少相对的磁盘IO就会减少。
B&#43;树种的叶子节点有两个前后指针，让叶子节点组成了一个双向链表，这像排序和范围查也更快。
2.1 B&#43;树能存储多少数据
以深度为3的B&#43;树举例，首先算出第二层子节点的个数=16k / (6b &#43; 8b)，其中6字节是指针大小，8字节是表的主键为bigint类型，得到第二层子节点的个数是1170个，这1170个子节点都会有1170个叶子节点，能够得到叶子节点的个数=1170*1170，假设一行数据是0.5k，如果不考虑数据页的其他信息，每个数据页能够存储16k / 0.5 = 32条数据，所以深度为3的B&#43;树能够存储1170 * 1170 * 32 = 4380万条。
3.事务
事务的特性(ACID)原子性、一致性、隔离性、持久用。可以理解成用原子性&#43;隔离性&#43;持久性来保证一致性，也就是使用AID来保证C。
1）什么是脏读、脏写、不可重复读、幻读

脏写：事务A把id=10的数据对应的列x改成1，此时事务B对id=10的数据对应的列x改成2然后提交事务，然后事务A在执行后面的业务时发生异常把id=10的数据对应的列x回滚成了初始值0，事务B就发生了脏写。
脏读：事务A先读取一次id=10的数据对应的列x，然后去处理其他业务，此时事务B把id=10的数据对应的列x的值改成NULL，但是没有提交事务，然后事务A又回来读取一次id=10的数据对应的列x发现和之前的值不一样，事务A发生了脏读。
不可重复读：他和脏读的情况很像，只不过事务B提交了修改id=10的数据对应的列x的事务，此时事务A两次读到的数据是不一样的，我觉得这种情况可以算问题，也可以不算。
幻读：由于其他事物增加或者删除了一些数据，导致在同一个事物中前后两次查询的结果条数不一致。

2）事务的隔离级别

读未提交：要求可以读到没提交事务的数据，脏读、不可重复读、幻读的问题还在。
读已提交：要求不能读到没提交事务的数据，会有不可重复读和幻读的问题。
可重复读：要求同一事物中多次读取同一条数据一致，会有幻读问题，MySQL里可重复读级别没有幻读问题！
串行化：只能有一个线程操作数据库。

3）MySQL默认的隔离级别及原理
默认使用可重复读，在MySQL中每个事物的事务id是全局递增的。MySQL使用readView&#43;undo log实现了MVCC(多版本并发控制)机制，在readView中有当前操作这个数据的事务id集合，还有集合中的最大、最小事务id，还有当前事物id，读取数据时会从undo log链里找到第一个创建数据的事务id比当前事务id小的undo log去读取数据；修改的时候会插入一条新的undo log，然后会增加独占锁。这样会保证读取数据的事务不会读到比自己id大的事务操作后的数据。
在MySQL中每条数据会有两个隐藏列，一个是插入数据的事务id，还有一个删除数据的事务id。
4）项目里基于Spring的事务是怎么做的？事务传播是怎么设置的？
Spring的事务有声明式和注解式，现在使用的都是注解式，在需要开启事务的方法上增加@Transactional注解，一般传播属性使用的默认的required_new就可以。如果有业务需要考虑某块代码不需要回滚之类的根据业务设置。
4.优化SQL的步骤
互联网公司的SQL都不会出现join这种，一般都是很简单的SQL，因为SQL的资源很宝贵，可以把复杂查询的操作放到业务里处理。

测试前会统一创建索引，索引不超过4个，多了会影响增删改性能，保证每个SQL都是使用索引，注意索引失效情况(最左匹配原则、查询条件使用函数或者计算、有些时候or、not null、不等于这些关键字也会染索引失效)。
查询时返回的字段尽可能少，第一是为了减少回表(如果查询的字段都在非聚簇索引中就不需要回表)，第二是减少占用网络带宽。
平时需要观察慢SQL，找到对应的慢SQL使用explain分析，保证type在index级别一下，rows尽可能小。

5.in和exists的区别
比如select * from a where id in (select a_id from b where ……)会先执行后面in条件中的语句，select * from a where id exist (select a_id from b where ……)exists先执行前面的语句。">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/posts/%E9%9D%A2%E8%AF%95/4.mysql/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.08f7d74f0ada0f975d29ae436285b61ed7a719d05f350cb888d00341642995a2.css" integrity="sha256-CPfXTwraD5ddKa5DYoW2HtenGdBfNQy4iNADQWQplaI=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/%E9%9D%A2%E8%AF%95/4.mysql/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<link rel="stylesheet" href="/katex/katex.min.css">
<script defer src="/katex/katex.min.js"></script>
<script defer src="/katex/auto-render.min.js" onload="renderMathInElement(document.body);"></script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    renderMathInElement(document.body, {
      delimiters: [
        {left: "$$", right: "$$", display: true},
        {left: "$", right: "$", display: false},
        {left: "\\(", right: "\\)", display: false},
        {left: "\\[", right: "\\]", display: true}
      ]
    });
  });
</script>

</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="王小红的笔记 (Alt + H)">王小红的笔记</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/posts/" title="笔记">
                    <span>笔记</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/categories/" title="分类">
                    <span>分类</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="标签">
                    <span>标签</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      面试-4.MySQL
    </h1>
    <div class="post-meta">1 min

</div>
  </header> 
  <div class="post-content"><h5 id="1myisam和innodb的区别">1.MyISAM和InnoDB的区别<a hidden class="anchor" aria-hidden="true" href="#1myisam和innodb的区别">#</a></h5>
<p>MyISAM不支持事务，不支持外键，索引文件和数据文件分开，并且他没有行锁。</p>
<p>InnoDB有自己的redo log，他要求必须要有一个自增的主键，如果我们没有指定他会自己生成一个，默认情况会有一个根据主键的B+树索引，叫做聚簇索引，这个索引的叶子节点就是数据文件。</p>
<h5 id="2索引为什么不用二叉树平衡二叉树b树而是使用b树">2.索引为什么不用二叉树、平衡二叉树、B树，而是使用B+树<a hidden class="anchor" aria-hidden="true" href="#2索引为什么不用二叉树平衡二叉树b树而是使用b树">#</a></h5>
<p>二叉树容易造成节点不平衡，影响查找速度；就算他改成了平衡二叉树，深度太大也会影响查找速度；B树的子节点也会存储数据，因为MySQL的数据页是16k固定大小，如果子节点存储数据，那么他能存储的子节点个数就会变少(子节点的个数也叫阶数)，也会影响深度，B+树就是让这个索引结构更矮更胖，深度减少相对的磁盘IO就会减少。</p>
<p>B+树种的叶子节点有两个前后指针，让叶子节点组成了一个双向链表，这像排序和范围查也更快。</p>
<h5 id="21-b树能存储多少数据">2.1 B+树能存储多少数据<a hidden class="anchor" aria-hidden="true" href="#21-b树能存储多少数据">#</a></h5>
<p>以深度为3的B+树举例，首先算出第二层子节点的个数=16k / (6b + 8b)，其中6字节是指针大小，8字节是表的主键为bigint类型，得到第二层子节点的个数是1170个，这1170个子节点都会有1170个叶子节点，能够得到叶子节点的个数=1170*1170，假设一行数据是0.5k，如果不考虑数据页的其他信息，每个数据页能够存储16k / 0.5 = 32条数据，所以深度为3的B+树能够存储1170 * 1170 * 32 = 4380万条。</p>
<h5 id="3事务">3.事务<a hidden class="anchor" aria-hidden="true" href="#3事务">#</a></h5>
<p>事务的特性(ACID)原子性、一致性、隔离性、持久用。可以理解成用原子性+隔离性+持久性来保证一致性，也就是使用AID来保证C。</p>
<h6 id="1什么是脏读脏写不可重复读幻读">1）什么是脏读、脏写、不可重复读、幻读<a hidden class="anchor" aria-hidden="true" href="#1什么是脏读脏写不可重复读幻读">#</a></h6>
<ul>
<li>脏写：事务A把id=10的数据对应的列x改成1，此时事务B对id=10的数据对应的列x改成2然后提交事务，然后事务A在执行后面的业务时发生异常把id=10的数据对应的列x回滚成了初始值0，事务B就发生了脏写。</li>
<li>脏读：事务A先读取一次id=10的数据对应的列x，然后去处理其他业务，此时事务B把id=10的数据对应的列x的值改成NULL，但是没有提交事务，然后事务A又回来读取一次id=10的数据对应的列x发现和之前的值不一样，事务A发生了脏读。</li>
<li>不可重复读：他和脏读的情况很像，只不过事务B提交了修改id=10的数据对应的列x的事务，此时事务A两次读到的数据是不一样的，我觉得这种情况可以算问题，也可以不算。</li>
<li>幻读：由于其他事物增加或者删除了一些数据，导致在同一个事物中前后两次查询的结果条数不一致。</li>
</ul>
<h6 id="2事务的隔离级别">2）事务的隔离级别<a hidden class="anchor" aria-hidden="true" href="#2事务的隔离级别">#</a></h6>
<ul>
<li>读未提交：要求可以读到没提交事务的数据，脏读、不可重复读、幻读的问题还在。</li>
<li>读已提交：要求不能读到没提交事务的数据，会有不可重复读和幻读的问题。</li>
<li>可重复读：要求同一事物中多次读取同一条数据一致，会有幻读问题，MySQL里可重复读级别没有幻读问题！</li>
<li>串行化：只能有一个线程操作数据库。</li>
</ul>
<h6 id="3mysql默认的隔离级别及原理">3）MySQL默认的隔离级别及原理<a hidden class="anchor" aria-hidden="true" href="#3mysql默认的隔离级别及原理">#</a></h6>
<p>默认使用可重复读，在MySQL中每个事物的事务id是全局递增的。MySQL使用readView+undo log实现了MVCC(多版本并发控制)机制，在readView中有当前操作这个数据的事务id集合，还有集合中的最大、最小事务id，还有当前事物id，读取数据时会从undo log链里找到第一个创建数据的事务id比当前事务id小的undo log去读取数据；修改的时候会插入一条新的undo log，然后会增加独占锁。这样会保证读取数据的事务不会读到比自己id大的事务操作后的数据。</p>
<p>在MySQL中每条数据会有两个隐藏列，一个是插入数据的事务id，还有一个删除数据的事务id。</p>
<h6 id="4项目里基于spring的事务是怎么做的事务传播是怎么设置的">4）项目里基于Spring的事务是怎么做的？事务传播是怎么设置的？<a hidden class="anchor" aria-hidden="true" href="#4项目里基于spring的事务是怎么做的事务传播是怎么设置的">#</a></h6>
<p>Spring的事务有声明式和注解式，现在使用的都是注解式，在需要开启事务的方法上增加@Transactional注解，一般传播属性使用的默认的required_new就可以。如果有业务需要考虑某块代码不需要回滚之类的根据业务设置。</p>
<h5 id="4优化sql的步骤">4.优化SQL的步骤<a hidden class="anchor" aria-hidden="true" href="#4优化sql的步骤">#</a></h5>
<p>互联网公司的SQL都不会出现join这种，一般都是很简单的SQL，因为SQL的资源很宝贵，可以把复杂查询的操作放到业务里处理。</p>
<ul>
<li>测试前会统一创建索引，索引不超过4个，多了会影响增删改性能，保证每个SQL都是使用索引，注意索引失效情况(最左匹配原则、查询条件使用函数或者计算、有些时候or、not null、不等于这些关键字也会染索引失效)。</li>
<li>查询时返回的字段尽可能少，第一是为了减少回表(如果查询的字段都在非聚簇索引中就不需要回表)，第二是减少占用网络带宽。</li>
<li>平时需要观察慢SQL，找到对应的慢SQL使用explain分析，保证type在index级别一下，rows尽可能小。</li>
</ul>
<h5 id="5in和exists的区别">5.in和exists的区别<a hidden class="anchor" aria-hidden="true" href="#5in和exists的区别">#</a></h5>
<p>比如select * from a where id in (select a_id from b where ……)会先执行后面in条件中的语句，select * from a where id exist (select a_id from b where ……)exists先执行前面的语句。</p>
<h5 id="6锁出现死锁了怎么办">6.锁，出现死锁了怎么办<a hidden class="anchor" aria-hidden="true" href="#6锁出现死锁了怎么办">#</a></h5>
<p>行锁、表锁（MyISAM用的多）InnoDB的表锁是表级意向锁、页锁，查询数据时指定悲观锁是在后面增加 for update，指定添加共享锁需要再语句后面增加lock in share model。</p>
<p>发生死锁时，show engine innodb status，找到latest deadLock分析原因，测试环境重现之后修改问题，一般出现死锁时MySQL会自动回滚一个事务，如果死锁没有自动解决的话可以通过show processList找到对应的进程，kill掉。</p>
<h5 id="7分库分表">7.分库分表<a hidden class="anchor" aria-hidden="true" href="#7分库分表">#</a></h5>
<h6 id="1为什么要分库分表">1）为什么要分库分表<a hidden class="anchor" aria-hidden="true" href="#1为什么要分库分表">#</a></h6>
<p>分库分表是两个概念，并不一定同时存在。</p>
<p>当并发量很高，并且写请求跟多，肖峰之后还有几千的请求打到MySQL上，或者很多写请求对实时性要求比较高的时候需要分库，分担写的压力，当单表数据量达到几百万条的时候需要分表。</p>
<h6 id="2分库分表的中间件">2）分库分表的中间件<a hidden class="anchor" aria-hidden="true" href="#2分库分表的中间件">#</a></h6>
<p>client层的sharding-jdbc（当当开源的）支持很多语法，分库分表，读写分离，分布式事务，现在shardingSphere也支持proxy层了；
proxy层的mycat，cobar改造的，功能也很全；
client层的优点是不需要独立部署，缺点是升级很麻烦，需要涉及到的系统重新发布，耦合度很高。中小型公司使用sharding，维护成本更低。</p>
<p>分库分表之后需要对业务进行大量改动，比如会出现垮裤跨表的复杂差查询或者分页，需要借助es或者clickHouse。</p>
<p>分库分表之后需要一个控制台来管理数据库的DDL操作，比如分了128个库，当有新需求的时候不可能手动去128个库里创建表，同时还要监听这些库表的状态，比如总共多少条数据、每张表多少条数据、监控状态、当需要迁移表的时候也要在控制台执行对应的脚本。</p>
<h6 id="3数据库拆分">3）数据库拆分<a hidden class="anchor" aria-hidden="true" href="#3数据库拆分">#</a></h6>
<p>垂直：一张表的列拆分出来，数据的行数不变，把访问量多的列放到单独的一张表里，因为数据库的查询是要把数据读到缓冲池中，一行数据占的小可以让buffer pool多存写数据，减少刷盘。</p>
<p>水平：表结构不变，把不常用的数据拆到其他表中，能让查询更快。拆出来的表可以在一个库里叫不同的名字，也可以在不同的库里或者同时多个库，每个库里多个表。分库分表说得也是水平拆分，垂直拆分实在数据库设计的时候直接拆出来的。</p>
<h6 id="4不停机单库单表迁移到分库分表">4）不停机单库单表迁移到分库分表<a hidden class="anchor" aria-hidden="true" href="#4不停机单库单表迁移到分库分表">#</a></h6>
<p>不停机迁移方案首先要有几个系统：数据迁移系统+canal系统+数据同步系统。canal程序监听新系统和旧系统的binlog，旧系统的binlog发送到数据迁移系统，新系统的binlog发送到数据同步系统用来写入es，数据迁移系统会全量查询就数据库的数据，同时还要运行一个数据对比程序，当新老数据库数据完全一致时修改nginx把请求转发到新系统，停掉老系统和数据迁移系统：</p>
<p><img alt="全量+增量串行数据迁移" loading="lazy" src="https://raw.githubusercontent.com/wangxiaohong123/p-bed/main/uPic/%E5%85%A8%E9%87%8F+%E5%A2%9E%E9%87%8F%E4%B8%B2%E8%A1%8C%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB.png"></p>
<h6 id="5动态扩容缩容分库分表方案">5）动态扩容缩容分库分表方案<a hidden class="anchor" aria-hidden="true" href="#5动态扩容缩容分库分表方案">#</a></h6>
<p>最简单的：数据库设计时就设计好16个库，每个库里16张表，或者32个库，都可以，一定要是2的倍数，这样才好扩容，比如刚开始有四台数据库服务器，每个服务器上4个库，每个库16张表，如果并发很高，比如一万并发，因为一台数据库服务器也就抗个2000左右的并发，这时候就需要更多的数据库服务器，或者数据量很大，单表一两千万，但是4 * 16张表的数据加起来让服务器磁盘满了，这两种情况就需要扩容了，扩容也很简单，在加四台机器，把每个机器抽出来两个库，放到新的服务器中就可以了，这里只需要修改分库分表中间件的路由方案即可，比如原来路由是和4取模，现在就需要跟8取模。</p>
<h5 id="8读写分离">8.读写分离<a hidden class="anchor" aria-hidden="true" href="#8读写分离">#</a></h5>
<h6 id="1原理">1）原理<a hidden class="anchor" aria-hidden="true" href="#1原理">#</a></h6>
<p>什么时候会使用主从数据库：一般就是大量读的情况，比如redis刚启动，没有预热数据，这时候大部分请求会打到数据库上，或者并发量很高，redis放不下数据频繁的LRU淘汰，也会有大量的请求打在MySQL上。</p>
<p>MySQL原生就支持主从复制，主库和从库的后台都有个IO线程，从库去请求主库，然后主库读出来binlog日志给从库，从库把日志写到relay日志，还有一个专门的线程根据relay日志变更数据。整个过程是串行的，<strong>可能会出现主从延迟问题</strong>。</p>
<h6 id="2主从同步延时问题">2）主从同步延时问题<a hidden class="anchor" aria-hidden="true" href="#2主从同步延时问题">#</a></h6>
<p>从库的延时是跟主库的写并发有关，1000并发可能会有几毫秒的延时。</p>
<p>在从库上执行show status可以看到有一个seconds behind master，表示同步落后了主库多长时间；</p>
<p>如果是并发不高，只是丢数据的问题，可以开启semi-sync机制，这个机制是说至少有一台从库确定写入了relay log之后才算成功，这样可以保证数据99.99%不丢，主要就是保证延时导致的数据丢失。</p>
<p>如果是因为高并发首先要开启并行复制（5.7以后），这个东西作用不大，因为他是从库开启多个MySQL线程，每个线程对应一个库，根据28法则，高并发的时候大部分的请求可能都落在一个库中，但是开启这个复制多少会有点作用，如果真碰到读写分离出现延时导致数据出问题，先去修改代码，避免主库写完从库就去读，如果解决不了就分库分表，或者就个别接口是这样的，那么就让这个接口的读直连主库。</p>
<h5 id="9mysql是怎么实现事物的">9.mysql是怎么实现事物的<a hidden class="anchor" aria-hidden="true" href="#9mysql是怎么实现事物的">#</a></h5>
<p>首先事物有4个特性，原子性，隔离性，持久性，一致性，个人觉得原子性+隔离性+持久性是为一致性服务的。</p>
<ul>
<li>mysql中通过undo log实现的原子性，当数据库没有宕机的情况下想要回滚直接读取undo log即可，如果发生宕机但是事物没有提交，此时undo log的状态时uncommited，也会保证数据的原子性。</li>
<li>通过mvcc机制+锁实现的隔离性，mvcc可以实现多个线程读和一个线程写多个线程读情况下的隔离性，如果出现多个线程写就需要通过锁来控制只能有一个线程写。</li>
<li>bin log + redo log + 双写缓冲区实现持久性，其中bin log + redo log通过两阶段提交实现刷盘，双写缓冲区是指当缓存中脏页刷盘时会先同步写入双写缓冲区，在异步更新数据文件，这样可以提高性能，由随机写变成顺序写+异步随机写，同时如果刷盘时服务器宕机虽然双写缓冲区文件损坏，但只是少量数据，可以通过redo log文件进行修复，如果没有双写缓冲区就是数据文件损坏，需要通过bin log + redo log进行修复，很麻烦。</li>
</ul>
<h5 id="10索引失效">10.索引失效<a hidden class="anchor" aria-hidden="true" href="#10索引失效">#</a></h5>
<ul>
<li>查询条件或者排序、分组条件中使用函数</li>
<li>不符合最左匹配原则</li>
<li>索引时数字格式的字符串，但是查询条件没有使用引号</li>
<li>表的数据量太小</li>
</ul>
<p>其实就是数据库引擎会预估这条sql的执行计划成本，比如把1个数据页加载到内存需要消耗1，在内存中计算条件、排序什么的消耗0.2，通过计算使用2级索引的成本和全表扫描的成本比较，决定是否使用索引。</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/%E9%9D%A2%E8%AF%95%E4%B8%93%E9%A2%98/">面试专题</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/posts/%E9%9D%A2%E8%AF%95/3.%E7%BD%91%E7%BB%9C/">
    <span class="title">« Prev</span>
    <br>
    <span>面试-3.网络</span>
  </a>
  <a class="next" href="http://localhost:1313/posts/%E9%9D%A2%E8%AF%95/5.spring/">
    <span class="title">Next »</span>
    <br>
    <span>面试-5.Spring</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 面试-4.MySQL on x"
            href="https://x.com/intent/tweet/?text=%e9%9d%a2%e8%af%95-4.MySQL&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2f%25E9%259D%25A2%25E8%25AF%2595%2f4.mysql%2f&amp;hashtags=%e9%9d%a2%e8%af%95%e4%b8%93%e9%a2%98">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 面试-4.MySQL on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2f%25E9%259D%25A2%25E8%25AF%2595%2f4.mysql%2f&amp;title=%e9%9d%a2%e8%af%95-4.MySQL&amp;summary=%e9%9d%a2%e8%af%95-4.MySQL&amp;source=http%3a%2f%2flocalhost%3a1313%2fposts%2f%25E9%259D%25A2%25E8%25AF%2595%2f4.mysql%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 面试-4.MySQL on reddit"
            href="https://reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fposts%2f%25E9%259D%25A2%25E8%25AF%2595%2f4.mysql%2f&title=%e9%9d%a2%e8%af%95-4.MySQL">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 面试-4.MySQL on facebook"
            href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fposts%2f%25E9%259D%25A2%25E8%25AF%2595%2f4.mysql%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 面试-4.MySQL on whatsapp"
            href="https://api.whatsapp.com/send?text=%e9%9d%a2%e8%af%95-4.MySQL%20-%20http%3a%2f%2flocalhost%3a1313%2fposts%2f%25E9%259D%25A2%25E8%25AF%2595%2f4.mysql%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 面试-4.MySQL on telegram"
            href="https://telegram.me/share/url?text=%e9%9d%a2%e8%af%95-4.MySQL&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2f%25E9%259D%25A2%25E8%25AF%2595%2f4.mysql%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 面试-4.MySQL on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=%e9%9d%a2%e8%af%95-4.MySQL&u=http%3a%2f%2flocalhost%3a1313%2fposts%2f%25E9%259D%25A2%25E8%25AF%2595%2f4.mysql%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">王小红的笔记</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
