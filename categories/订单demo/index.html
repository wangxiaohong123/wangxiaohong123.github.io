<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>订单demo | 王小红的笔记</title><meta name=keywords content><meta name=description content><meta name=author content><link rel=canonical href=https://wangxiaohong123.github.io/categories/%E8%AE%A2%E5%8D%95demo/><link crossorigin=anonymous href=/assets/css/stylesheet.08f7d74f0ada0f975d29ae436285b61ed7a719d05f350cb888d00341642995a2.css integrity="sha256-CPfXTwraD5ddKa5DYoW2HtenGdBfNQy4iNADQWQplaI=" rel="preload stylesheet" as=style><link rel=icon href=https://wangxiaohong123.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://wangxiaohong123.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://wangxiaohong123.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://wangxiaohong123.github.io/apple-touch-icon.png><link rel=mask-icon href=https://wangxiaohong123.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=https://wangxiaohong123.github.io/categories/%E8%AE%A2%E5%8D%95demo/index.xml><link rel=alternate hreflang=en href=https://wangxiaohong123.github.io/categories/%E8%AE%A2%E5%8D%95demo/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=/katex/katex.min.css><script defer src=/katex/katex.min.js></script><script defer src=/katex/auto-render.min.js onload=renderMathInElement(document.body)></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script><meta property="og:url" content="https://wangxiaohong123.github.io/categories/%E8%AE%A2%E5%8D%95demo/"><meta property="og:site_name" content="王小红的笔记"><meta property="og:title" content="订单demo"><meta property="og:locale" content="zh-CN"><meta property="og:type" content="website"><meta name=twitter:card content="summary"><meta name=twitter:title content="订单demo"><meta name=twitter:description content></head><body class=list id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wangxiaohong123.github.io/ accesskey=h title="王小红的笔记 (Alt + H)">王小红的笔记</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://wangxiaohong123.github.io/posts/ title=笔记><span>笔记</span></a></li><li><a href=https://wangxiaohong123.github.io/categories/ title=分类><span>分类</span></a></li><li><a href=https://wangxiaohong123.github.io/tags/ title=标签><span>标签</span></a></li></ul></nav></header><main class=main><header class=page-header><h1>订单demo</h1></header><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>1.环境搭建</h2></header><div class=entry-content><p>1.安装jdk jdk版本：8u191
把rpm包传到虚拟机，执行命令安装：
1 rpm -ivh jdk-8u191-linux-x64.rpm 默认的安装目录是**/usr/java/**
配置环境变量，编辑.bash_profile文件：
1 vi ~/.bash_profile 在文件中添加JAVA_HOME：
1 2 export JAVA_HOME=/usr/java/latest export PATH=$PATH:$JAVA_HOME/bin 保存退出，刷新配置文件：
1 source ~/.bash_profile 2.安装MySQL 使用yum仓库安装mysql5.7版本：
1 2 3 4 5 wget http://repo.mysql.com//mysql57-community-release-el7-11.noarch.rpm yum localinstall mysql57-community-release-el7-11.noarch.rpm yum install -y mysql-community-server.x86_64 启动MySQL server：
...</p></div><footer class=entry-footer>3 min</footer><a class=entry-link aria-label="post link to 1.环境搭建" href=https://wangxiaohong123.github.io/posts/%E6%A1%86%E6%9E%B6/spring/cloud-alibaba/cloud-alibaba-demo%E4%B9%8B%E8%AE%A2%E5%8D%95/1.%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>2.代码规范</h2></header><div class=entry-content><p>整体的规范是基于阿⾥巴巴的《Java开发⼿册》，额外补充：
方法命名规范 总的原则是⽤动词做前缀，名词在后⾯。 获取单个对象的时候使⽤get做前缀。 获取多个对象的时候使⽤list做前缀，复数形式结尾如:listOrders。 获取统计值的时候使⽤count做前缀。 插⼊数据的时候使⽤save/insert做前缀。 删除数据的时候使⽤remove/delete做前缀。 修改数据的时候使⽤update做前缀。 POJO类命名规范 数据对象用xxxDO，使用DDD时用xxxPO。 Controller层返回结果，展示对象⽤xxxVO，请求⼊参的命名格式⽤xxxRequest，查询条件封装对象⽤xxxQuery。 API层返回结果，返回对象⽤xxxDTO，请求的命名格式为xxxRequest，查询条件封装对象⽤xxxQuery。 业务层内部的数据传输对象⼀般⽤xxxDTO，不做强制规定，怎么⽅便怎么来。 每个POJO继承承AbstractObject.java，可以实现不同POJO属性之间的克隆，AbstractObject.java类中包含浅克隆、深克隆、对象集合克隆。 统一异常处理 common模块的exception包下定义了GlobalExceptionHandler组件，该组件通过添加@RestControllerAdvice注解，作为默认的Controller全局异常处理增强组件，在这个组件中分别对系统级别未知系统、客户端异常、服务端异常 都分别做了统⼀处理。 其次是BaseBizException⾃定义基础业务异常类，在业务代码的开发中，可以直接抛出这个异常类，也可以在具体的业务代码⼯程新建⼀个异常类继承BaseBizException，然后抛出⾃定义的异常类。
common模块中还有⼀个CommonErrorCodeEnum枚举类，他继承了BaseErrorCodeEnum，BaseErrorCodeEnum是一个错误信息枚举接⼝，也是供各个业务服务⾃定义错误枚举信息时继承⽤的，通过在抛业务的时候统⼀使⽤枚举定义错误信息，CommonErrorCodeEnum中定义了⼤量框架级别通⽤的常⻅错误信息枚举值。
对于Service层，程序需要中断的逻辑，统⼀抛BaseBizException或其⼦类业务异常。 DAO层不要显示的抛任何业务异常，统⼀由Service来抛异常。 Controller层不需要显示的try..catch..Service层的业务异常，因为会由GlobalExceptionHandler组件来统⼀处理异常。 抛业务异常时，建议对异常信息定义⼀个枚举值，这个枚举类要继承com.ruyuan.eshop.common.exception.BaseErrorCodeEnum。 统一返回结果处理 接口返回结果统一使用JsonResponse组件作为返回值，当接口返回值不为JsonResponse时由GlobalResponseBodyAdvice统一拦截处理，如果不想使用JsonResponse作为返回值，可以返回JsonMap组件。
GlobalResponseBodyAdvice，通过实现ResponseBodyAdvice接⼝并添加@RestControllerAdvice注解，来实现了全局默认的Controller⽅法返回结果统⼀格式处理，处理逻辑都在beforeBodyWrite()⽅法中。</p></div><footer class=entry-footer>1 min</footer><a class=entry-link aria-label="post link to 2.代码规范" href=https://wangxiaohong123.github.io/posts/%E6%A1%86%E6%9E%B6/spring/cloud-alibaba/cloud-alibaba-demo%E4%B9%8B%E8%AE%A2%E5%8D%95/2.%E4%BB%A3%E7%A0%81%E8%A7%84%E8%8C%83/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>3.seata解决圣诞链路数据不一致问题</h2></header><div class=entry-content><p>订单号规则 订单号是一个19位的字符串，由4部分组成例如：
10 20211218 00000001 012
|类型|日期|序列号|用户id后3位|
前两位是订单类型，10表示正向，20标识逆向(比如退款)，中间6位是⽇期，日期后8位是序列号(不够补0)，最后3位是用户id后3位(不够补0)。
生单链路数据不一致问题 创建订单时需要先进行风控检查，然后获取商品信息，计算订单价格，然后锁定优惠券，锁定库存，最后在数据库中插入订单信息，这里最少设计到3个服务对数据库做出了修改，营销服务、库存服务、订单服务，而订单服务在插入订单时可能涉及到拆单问题，并且需要操作的表有订单表、订单条目表、配送信息表、支付信息表、订单费用表、订单费用明细表、订单状态变更日志表、订单快照数据表等，任何一条sql出错都需要整个生单链路的所有对mysql的操作进行回滚，正常的本地事务没法保证订单、营销、库存里任何一个服务发生异常，其他服务回滚数据。
seata原理 AT模式原理 首先有一个Seata Server负责控制事务的提交和回滚，每个服务里需要引入seata client负责监听sql，并声称对应的undo_log，undo_log存储在表里，并且操作本地数据和插入undo_log在同一本地事务中，当服务完成本地事务后需要高速Seata Server分支事务提交成功，所有分支事务都完成后(那个角色提交？)向Seata Server提交事务并释放全局锁，如果存在某个服务发生异常，此时Seata Server会想提交分支事务成功的服务发送执行回滚日志消息，再有seata client执行对应的undo_log。
读写隔离原理 seata的隔离级别是读未提交，未提交指的是分布式事务没有提交，并不是本地事务。
首先完整的流程如下图，在提交本地事务前必须要通过Seata Server获取全局锁，其他分布式事务在没有拿到全局锁前不能提交本地事务，如果没有全局锁会导致多个分布式事务同时操作一条数据，发生回滚时数据错乱的问题，但是引入的全局锁会让性能下降的严重，所以AT模式的分布式事务只用在很钱相关的操作里，其他时候如果需要用到分布式事务可以使用mq的软事务。
死锁问题 比如上图两个事务操作同一条数据，事务1中服务A的操作执行完成并且提交了本地事务，此时事务2开始执行服务A的操作，此时全局锁在事务1上，所以事务2的服务A没法提交本地事务，他会等待拿到全局锁，但是这个时候他是持有11001的本地锁的，事务1在执行服务B操作的时候发生异常需要回滚，服务A收到回滚消息需要拿到11001的本地锁，出现了事务1持有事务2需要的全局锁，事务2持有事务1需要的本地锁，循环等待了，seata为了解决这个死锁问题在获取全局锁的时候加了个超时机制，如果超时会回滚数据并释放锁。
使用seata 前提：Seata Server启动好，每个服务对应的库创建好undo_log表。
pom中添加依赖：
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 &lt;!-- 引入seata整合分布式事务 --> &lt;dependency> &lt;groupId>com.alibaba.cloud&lt;/groupId> &lt;artifactId>spring-cloud-starter-alibaba-seata&lt;/artifactId> &lt;exclusions> &lt;exclusion> &lt;groupId>io.seata&lt;/groupId> &lt;artifactId>seata-spring-boot-starter&lt;/artifactId> &lt;/exclusion> &lt;/exclusions> &lt;/dependency> &lt;!-- 跟安装的seata-server需要保持版本一致 --> &lt;dependency> &lt;groupId>io.seata&lt;/groupId> &lt;artifactId>seata-spring-boot-starter&lt;/artifactId> &lt;version>1.3.0&lt;/version> &lt;/dependency> 添加配置：
...</p></div><footer class=entry-footer>4 min</footer><a class=entry-link aria-label="post link to 3.seata解决圣诞链路数据不一致问题" href=https://wangxiaohong123.github.io/posts/%E6%A1%86%E6%9E%B6/spring/cloud-alibaba/cloud-alibaba-demo%E4%B9%8B%E8%AE%A2%E5%8D%95/3.seata%E8%A7%A3%E5%86%B3%E7%94%9F%E5%8D%95%E9%93%BE%E8%B7%AF%E6%95%B0%E6%8D%AE%E4%B8%8D%E4%B8%80%E8%87%B4%E9%97%AE%E9%A2%98/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>4.支付成功到履约相关问题</h2></header><div class=entry-content><p>支付成功之前进行的预支付和取消订单的延迟消息处理需要用到分布式锁，防止在处理订单超时时，用户支付，不同业务可能还要加上在支付回调中检测订单取消后发起退款
同时为了防止发送延时消息失败需要有一个定时任务，定时扫描超过30分钟没有支付的订单，执行超时操作
在支付成功后订单系统会受到一条回调，这个时候需要把订单状态更新成已支付，然后发送支付完成消息，发出去消息后再由订单系统自己来消费这个消息，为什么要发消息，第一履约执行很耗时间，通过mq解耦加快支付成功的响应时间，然后其他服务需要监听支付成功不需要通过api，直接消费消息就好了。
当收到支付成功事件后，先调用履约系统，调用履约系统成功后再把订单改成已履约，流程如下图，红线表示可能出现问题的步骤：
发送支付成功消息失败 收到回调并且修改完订单状态，此时如果发送mq消息失败，需要回滚数据，这里用到的是rocket的事务消息，他的事务消息使用的是TransactionMQProducer，使用**TransactionSendResult result = transactionMQProducer.sendMessageInTransaction(mq, orderInfoDO);**发送消息，每次发送消息之前producer都需要设置监听，用来处理发送消息成功和失败的情况，例如：
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 transactionMQProducer.setTransactionListener(new TransactionListener() { @Override public LocalTransactionState executeLocalTransaction(Message message, Object o) { try { // 正常的业务逻辑代码 return LocalTransactionState.COMMIT_MESSAGE; } catch (BaseBizException e) { throw e; } catch (Exception e) { log.error("system error", e); return LocalTransactionState.ROLLBACK_MESSAGE; } } @Override public LocalTransactionState checkLocalTransaction(MessageExt messageExt) { // 这个回调只有mq检测到存在长时间没提交的half消息时调用 // 逻辑就是判断之前的的正常业务代码有没有执行完 // 执行完就返回COMMIT_MESSAGE，没执行完就返回ROLLBACK_MESSAGE if(true) { return LocalTransactionState.COMMIT_MESSAGE; } return LocalTransactionState.ROLLBACK_MESSAGE; } }); 消费支付成功消息 调用履约系统失败 调用履约失败只要消费者返回Action.RECONSUME_LATER就可以了，返回这个rocket就会把消息放到重试队列里，重试超过16次会把消息放到死信队列里，这个时候需要在起一个消费者负责消费私信队列。
...</p></div><footer class=entry-footer>4 min</footer><a class=entry-link aria-label="post link to 4.支付成功到履约相关问题" href=https://wangxiaohong123.github.io/posts/%E6%A1%86%E6%9E%B6/spring/cloud-alibaba/cloud-alibaba-demo%E4%B9%8B%E8%AE%A2%E5%8D%95/4.%E6%94%AF%E4%BB%98%E6%88%90%E5%8A%9F%E5%88%B0%E5%B1%A5%E7%BA%A6%E7%9A%84%E7%9B%B8%E5%85%B3%E9%97%AE%E9%A2%98/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>5.压测</h2></header><div class=entry-content><p>首先去Apache官网下载最新版jMeter，Mac下载tgz，windows下载zip然后解压。
进入bin目录双击ApacheJMeter.jar运行。
解决中文乱码 编辑bin目录下的jmeter.properties文件，设置属性：
1 sampleresult.default.encoding=UTF-8 创建测试请求 在测试计划下创建线程组
在线程组下添加http请求
填写请求信息
![image-20220106163135849](/Users/xiaohong/Library/Application Support/typora-user-images/image-20220106163135849.png)
根据需要配置Content-Type属性，我们接口基本上都是application/json的：
在线程组下添加“查看结果树”，⽤于查看运⾏结果：
运行脚本，点击结果树可以查看到结果。
添加断言判断接口结果，这里添加json断言
创建多个请求 多个请求直接在线程组下添加多个http就可以，但是如果存在请求需要用到上一个接口的数据，需要添加json提取器，拿到接口的返回值
match no表示匹配第几个，-1表示全部匹配，0表示随机。
压测 在线程组下添加汇总报告和聚合报告：
然后配置线程数，启动：</p></div><footer class=entry-footer>1 min</footer><a class=entry-link aria-label="post link to 5.压测" href=https://wangxiaohong123.github.io/posts/%E6%A1%86%E6%9E%B6/spring/cloud-alibaba/cloud-alibaba-demo%E4%B9%8B%E8%AE%A2%E5%8D%95/5.%E5%8E%8B%E6%B5%8B/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>6.限流熔断</h2></header><div class=entry-content><p>限流、熔断降级使用alibaba的sentinel。
基础概念 不管是那种规则，触发之后抛出的都是BlockException，BlockException的子类会区分各种，比如DegradeException。
流控、熔断这两个没啥好说的。
热点规则就是根据接口的参数来限制并发。
授权规则就是黑背名单。
系统规则就是说可以根据rt、线程数、CPU使用率这些来限制，一般都是根据CPU，比如说CPU达到了80%就会进行限流，使用这个实现自适应限流的效果，需要注意的是如果是系统规则要把资源做成EntryType.IN方式，默认是OUT的，可以在dubbo和MVC的拦截器里对所有请求处理。我觉得自适应限流加不加都可以，一般的厂子都是在上线前进行压测，然后根据每个接口的调用比例及服务的并发最大值做集群限流+网关的限流，集群限流需要单独一台机器充当token server，控制台可以配置集群流控服务的地址和端口，集群流控服务就搞一个springboot服务然后加两个依赖：
1 2 3 4 5 6 7 8 9 10 11 &lt;dependency> &lt;groupId>com.alibaba.csp&lt;/groupId> &lt;artifactId>sentinel-cluster-client-default&lt;/artifactId> &lt;version>1.7.1&lt;/version> &lt;/dependency> &lt;dependency> &lt;groupId>com.alibaba.csp&lt;/groupId> &lt;artifactId>sentinel-cluster-server-default&lt;/artifactId> &lt;version>1.7.1&lt;/version> &lt;/dependency> 使用 Sentinel是自带控制台的，但是控制台只把配置放到了内存里，每次重启数据就会丢失，官网推荐把配置持久化到nacos中，但是控制台又不支持？好在控制台的测试代码有持久化到nacos的例子，进行控制台的代码需要二次开发：
...</p></div><footer class=entry-footer>4 min</footer><a class=entry-link aria-label="post link to 6.限流熔断" href=https://wangxiaohong123.github.io/posts/%E6%A1%86%E6%9E%B6/spring/cloud-alibaba/cloud-alibaba-demo%E4%B9%8B%E8%AE%A2%E5%8D%95/6.%E9%99%90%E6%B5%81%E7%86%94%E6%96%AD/></a></article></main><footer class=footer><span>&copy; 2025 <a href=https://wangxiaohong123.github.io/>王小红的笔记</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>